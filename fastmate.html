<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fastmate - ê´€ë¦¬í•˜ëŠ” ë‹¨ì‹ </title>
    <link rel="icon" href="/favicon.ico" sizes="any">
     
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="manifest" href="/manifest.json">
    <!-- Firebase SDK -->
 <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script src="/firebase-init.js"></script>
<link rel="stylesheet" href="./styles.css">

</head>
<body>
  <div id="splash-screen">
    <div class="splash-content">
      <h1 class="splash-title">fastmate</h1>
      <div class="spinner"></div>
    </div>
  </div>
  <main class="page-content">
    </main>
    <!-- ì•± ë©”ì¸ ì»¨í…ì¸  -->
    <div class="container">
        <div id="userChip" class="user-chip" style="display:none">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            <span id="userChipName">-</span>ë‹˜
        </div>

        <h1 class="main-title">fastmate</h1>
        
        <div class="ring-wrap">
            <svg class="ring" viewBox="0 0 120 120">
     <defs>
    <linearGradient id="trackGrad"><stop stop-color="var(--gauge-track-color)"/></linearGradient>
    <linearGradient id="progGrad" x1="0%" y1="0%" x2="0%" y2="100%">
        <stop offset="0%" stop-color="var(--gauge-start-color)"/>
        <stop offset="100%" stop-color="var(--primary-color)"/>
    </linearGradient>
    <linearGradient id="overtimeGrad" x1="0%" y1="0%" x2="0%" y2="100%">
        <stop offset="0%" stop-color="#FF690B"/>
        <stop offset="100%" stop-color="var(--gauge-start-color)"/>
    </linearGradient>
</defs>
                <circle cx="60" cy="60" r="54" stroke="url(#trackGrad)" stroke-width="12" fill="none"/>
                <circle id="progressArc" cx="60" cy="60" r="54" stroke="url(#progGrad)" stroke-width="12" fill="none" stroke-linecap="round" pathLength="100" stroke-dasharray="0 100" transform="rotate(-90 60 60)"/>
            </svg>
            <div class="timer-display">
                <div class="label">ë‚¨ì€ ì‹œê°„</div>
                <div id="remainingTime" class="time">00:00:00</div>
            </div>
        </div>

        <div id="status-message" class="status-message">ë‹¨ì‹ ê³„íšì„ ì„ íƒí•˜ê³  ì‹œì‘í•˜ì„¸ìš”.</div>

        <div class="time-info">
            <div id="startTimeBox" class="time-box" title="í´ë¦­í•˜ì—¬ ì‹œê°„ ë³€ê²½">
                <span class="label">ì‹œì‘ ì‹œê°„</span>
                <span id="startTimeValue" class="value">-</span>
                <svg class="edit-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
            </div>
            <div class="time-box">
                <span class="label">ì¢…ë£Œ ì˜ˆì •</span>
                <span id="endTimeValue" class="value">-</span>
            </div>
        </div>
        <div id="timePickerModal" style="display:none; position:fixed; inset:0; z-index:1900; background:rgba(0,0,0,.5); align-items:center; justify-content:center; padding:20px; box-sizing:border-box;">
        <div class="time-picker-content">
            <h3 class="onb-title">ì‹œì‘ ì‹œê°„ ì„ íƒ</h3>
            <div class="date-selector">
                <button id="dayBeforeBtn" type="button" class="date-btn">ì–´ì œ</button>
                <button id="todayBtn" type="button" class="date-btn active">ì˜¤ëŠ˜</button>
            </div>
            <div class="time-selector">
                <select id="ampmSelect">
                    <option>AM</option>
                    <option>PM</option>
                </select>
                <select id="hourSelect"></select>
                <span>:</span>
                <select id="minuteSelect"></select>
            </div>
            <div class="onb-actions">
                <button type="button" data-close="timePickerModal" class="onb-btn onb-ghost">ì·¨ì†Œ</button>
                <button id="saveTimeBtn" type="button" class="onb-btn onb-primary">í™•ì¸</button>
            </div>
        </div>
    </div>
        <div id="completionOverlay" class="completion-overlay">
        <div class="completion-content">
            <div class="confetti"></div>
            <div class="confetti"></div>
            <div class="confetti"></div>
            <div class="confetti"></div>
            <div class="confetti"></div>
            <div class="confetti"></div>
            <h2>ëª©í‘œ ë‹¬ì„±!</h2>
            <p>ì¶•í•˜í•©ë‹ˆë‹¤! ì„±ê³µì ìœ¼ë¡œ ë‹¨ì‹ì„ ë§ˆì³¤ìŠµë‹ˆë‹¤.</p>
        </div>
    </div>
    
        <div id="salt-tip" class="salt-tip">ğŸ’¡ <strong>íŒ:</strong> 48ì‹œê°„ ì´ìƒ ì¥ê¸° ë‹¨ì‹ ì‹œì—ëŠ” ë¯¸ë„¤ë„ ë³´ì¶©ì„ ìœ„í•´ ì•½ê°„ì˜ ì†Œê¸ˆì„ ì„­ì·¨í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.</div>

        <div class="controls">
            <select id="fastingModelSelect">
              <option value="8">8:16 (8ì‹œê°„ ë‹¨ì‹,ì•¼ì‹ëŠê¸°)</option>  
              <option value="12">12:12 (12ì‹œê°„ ë‹¨ì‹,ì´ˆë³´)</option>  
              <option value="16">16:8 (16ì‹œê°„ ë‹¨ì‹,ì¸ê¸°)</option>
                <option value="18">18:6 (18ì‹œê°„ ë‹¨ì‹,ì¸ê¸°)</option>
                <option value="20">20:4 (20ì‹œê°„ ë‹¨ì‹,ê³ ê¸‰)</option>
                <option value="24">24ì‹œê°„ (1ì¼ ë‹¨ì‹,ê³ ê¸‰)</option>
                <option value="36">36ì‹œê°„(1.5ì¼ ë‹¨ì‹,ê³ ê¸‰)</option>
                <option value="48">48ì‹œê°„ (2ì¼ ë‹¨ì‹,ê³ ê¸‰)</option>
                <option value="72">72ì‹œê°„ (3ì¼ ë‹¨ì‹,ê³ ê¸‰)</option>
            </select>
            <div class="button-group">
                <button id="startBtn" class="start-btn">ë‹¨ì‹ ì‹œì‘</button>
                <button id="stopBtn" class="stop-btn">ë‹¨ì‹ ì¢…ë£Œ</button>
            </div>
        </div>

        <div class="bottom-nav">
               <button class="nav-btn" id="weightBtn">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 3L2 9l10 6 10-6-10-6zM2 15l10 6 10-6"></path><path d="M2 9v6"></path><path d="M22 9v6"></path><path d="M12 21v-6"></path>
        </svg>
        <span>ì²´ì¤‘ ê¸°ë¡</span>
            </button>
            <button class="nav-btn" id="bloodSugarBtn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>
                <span>í˜ˆë‹¹ ê¸°ë¡</span>
            </button>
            <button class="nav-btn" id="ketoneBtn">
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M12 2v20"/><path d="M7 7h10"/><path d="M7 17h10"/></svg>
  <span>ì¼€í†¤ ê¸°ë¡</span>
</button>

<button class="nav-btn" id="exerciseBtn">
  <svg xmlns="http://www.w3.org/2000/svg" 
       viewBox="0 0 24 24" fill="none" 
       stroke="currentColor" stroke-width="2" 
       stroke-linecap="round" stroke-linejoin="round">
    <path d="M6 6v12M18 6v12"/>
    <path d="M3 10v4M21 10v4"/>
    <path d="M6 12h12"/>
  </svg>
  <span>ìš´ë™ ê¸°ë¡</span>
</button>
        </div>

       
        <!-- ì²´ì¤‘ ê¸°ë¡ ëª¨ë‹¬ -->
<div id="weightModal" style="display:none; position:fixed; inset:0; z-index:1900; background:rgba(0,0,0,.5); align-items:center; justify-content:center; padding:20px; box-sizing:border-box;">
  <div style="width:100%; max-width:420px; background:var(--card-bg); border:1px solid var(--border-color); border-radius:16px; box-shadow:0 16px 60px rgba(0,0,0,.2); padding:24px;">
    <h3 class="onb-title" style="margin-bottom:8px;">ì²´ì¤‘ ê¸°ë¡</h3>
    <p class="onb-desc">í˜„ì¬ ì²´ì¤‘(kg)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
    <input id="weightInput" class="onb-input" type="number" step="0.1" min="0" placeholder="ì˜ˆ. 65.5" />
    <div class="onb-actions" style="margin-top:20px;">
      <button type="button" data-close="weightModal" class="onb-btn onb-ghost">ì·¨ì†Œ</button>
      <button id="saveWeightBtn" type="button" class="onb-btn onb-primary">ì €ì¥</button>
    </div>
  </div>
</div>

       
       
        <!-- ì¼€í†¤ ê¸°ë¡ ëª¨ë‹¬ -->
<div id="ketoneModal" style="display:none; position:fixed; inset:0; z-index:1900; background:rgba(0,0,0,.5); align-items:center; justify-content:center; padding:20px; box-sizing:border-box;">
  <div style="width:100%; max-width:420px; background:var(--card-bg); border:1px solid var(--border-color); border-radius:16px; box-shadow:0 16px 60px rgba(0,0,0,.2); padding:24px;">
    <h3 class="onb-title" style="margin-bottom:8px;">ì¼€í†¤ ê¸°ë¡</h3>
    <p class="onb-desc">ì¼€í†¤ ìˆ˜ì¹˜(mmOL/L)ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
    <input id="ketoneInput" class="onb-input" type="number" step="0.1" min="0" placeholder="ì˜ˆ. 1.2" />
    <div class="onb-actions" style="margin-top:20px;">
      <button type="button" data-close="ketoneModal" class="onb-btn onb-ghost">ì·¨ì†Œ</button>
      <button id="saveKetoneBtn" type="button" class="onb-btn onb-primary">ì €ì¥</button>
    </div>
  </div>
</div>


    <!-- í˜ˆë‹¹ ê¸°ë¡ ëª¨ë‹¬ -->
<div id="bloodSugarModal" style="display:none; position:fixed; inset:0; z-index:1900; background:rgba(0,0,0,.5); align-items:center; justify-content:center; padding:20px; box-sizing:border-box;">
  <div style="width:100%; max-width:420px; background:var(--card-bg); border:1px solid var(--border-color); border-radius:16px; box-shadow:0 16px 60px rgba(0,0,0,.2); padding:24px;">
    <h3 class="onb-title" style="margin-bottom:8px;">í˜ˆë‹¹ ê¸°ë¡</h3>
    <p class="onb-desc">í˜ˆë‹¹ ìˆ˜ì¹˜ì™€ ì¸¡ì • ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
    
    <label class="onb-label" style="margin-top:20px; margin-bottom: 5px; text-align: left;">í˜ˆë‹¹ (mg/dL)</label>
    <input id="bloodSugarInput" class="onb-input" type="number" step="1" min="1" placeholder="ì˜ˆ. 92" />

    <label class="onb-label" style="margin-top:15px; margin-bottom: 5px; text-align: left;">ì¸¡ì • ì‹œê°„</label>
    <input id="bloodSugarTimestampInput" class="onb-input" type="datetime-local" />

    <div class="onb-actions" style="margin-top:20px;">
      <button type="button" data-close="bloodSugarModal" class="onb-btn onb-ghost">ì·¨ì†Œ</button>
      <button id="saveBloodSugarBtn" type="button" class="onb-btn onb-primary">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- ìš´ë™ ê¸°ë¡ ëª¨ë‹¬ -->
<div id="exerciseModal" style="display:none; position:fixed; inset:0; z-index:1900; background:rgba(0,0,0,.5); align-items:center; justify-content:center; padding:20px; box-sizing:border-box;">
  <div style="width:100%; max-width:420px; background:var(--card-bg); border:1px solid var(--border-color); border-radius:16px; box-shadow:0 16px 60px rgba(0,0,0,.2); padding:24px;">
    <h3 class="onb-title" style="margin-bottom:8px;">ìš´ë™ ê¸°ë¡</h3>
    <p class="onb-desc">ìš´ë™ ì¢…ë¥˜ì™€ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>

    <!-- ê¸°ì¡´ íƒœê·¸ ìŠ¤íƒ€ì¼ ì¬ì‚¬ìš© -->
    <div id="exerciseType" class="tag-cloud" style="margin-bottom:12px;">
      <button type="button" class="tag" data-value="ê±·ê¸°">ê±·ê¸°</button>
      <button type="button" class="tag" data-value="ë‹¬ë¦¬ê¸°">ë‹¬ë¦¬ê¸°</button>
      <button type="button" class="tag" data-value="ìš”ê°€">ìš”ê°€</button>
      <button type="button" class="tag" data-value="ê·¼ë ¥ìš´ë™">ê·¼ë ¥ìš´ë™</button>
      <button type="button" class="tag" data-value="ìˆ˜ì˜">ìˆ˜ì˜</button>
      <button type="button" class="tag" data-value="ìì „ê±°">ìì „ê±°</button>
      <button type="button" class="tag" data-value="ë“±ì‚°">ë“±ì‚°</button>
      <button type="button" class="tag" data-value="ì¤„ë„˜ê¸°">ì¤„ë„˜ê¸°</button>
      <button type="button" class="tag" data-value="í•„ë¼í…ŒìŠ¤">í•„ë¼í…ŒìŠ¤</button>
      <button type="button" class="tag" data-value="ëŒ„ìŠ¤">ëŒ„ìŠ¤</button>
      <button type="button" class="tag" data-value="ë“±ì‚°">ë“±ì‚°</button>
      <button type="button" class="tag" data-value="íƒ€ë°”íƒ€">íƒ€ë°”íƒ€</button>
      <button type="button" class="tag" data-value="ê³„ë‹¨">ê³„ë‹¨ìš´ë™</button>
      <button type="button" class="tag" data-value="ê¸°íƒ€">ê¸°íƒ€</button>
    </div>

    <input id="exerciseDuration" class="onb-input" type="number" min="1" placeholder="ìš´ë™ ì‹œê°„(ë¶„)" style="margin-bottom:10px;" />
    <input id="exerciseCalories" class="onb-input" type="number" min="0" placeholder="ì†Œëª¨ ì¹¼ë¡œë¦¬(kcal, ì„ íƒ)" />

    <div class="onb-actions" style="margin-top:20px;">
      <button type="button" data-close="exerciseModal" class="onb-btn onb-ghost">ì·¨ì†Œ</button>
      <button id="saveExerciseBtn" type="button" class="onb-btn onb-primary">ì €ì¥</button>
    </div>
  </div>
</div>


        <footer class="app-footer">
            <a href="#" id="privacyPolicyLink">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
            <p>Â© 2025 2e-studio. All rights reserved.</p>
             <!-- â–¼â–¼â–¼ FAQ ë§í¬ ì¶”ê°€ â–¼â–¼â–¼ -->
    <p class="faq-link">
      <a href="https://www.notion.so/maenglionworld/FASTMATE-FAQ-256bcdc037cd80de887dfb24a7cae5a1?source=copy_link" target="_blank" rel="noopener noreferrer">
        ì´ìš©ì´ ì–´ë ¤ìš°ì‹ ê°€ìš”? (FAQ)
      </a>
    </p>
    <!-- â–²â–²â–² FAQ ë§í¬ ì¶”ê°€ â–²â–²â–² -->
        </footer>
    </div>
    
    <!-- ì˜¨ë³´ë”© ëª¨ë‹¬ (í™”ë©´ ì „ì²´ë¥¼ ë®ëŠ” ë°°ê²½ í¬í•¨) -->
    <div id="appShield">
        <div id="onboardingModal">
            <h3 class="onb-title">ì²˜ìŒ ì˜¤ì…¨êµ°ìš”! ğŸ‘‹</h3>
            <p class="onb-desc">fastmateì˜ ëª¨ë“  ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ë‹‰ë„¤ì„ê³¼ ê°€ì… ëª©ì ì„ ì•Œë ¤ì£¼ì„¸ìš”.</p>
    
            <label class="onb-label" for="onbNickname">ë‹‰ë„¤ì„</label>
            <input id="onbNickname" class="onb-input" type="text" placeholder="ì˜ˆ.ê±´ê°•í•œ ë¼ì´ì–¸" />
    
            <label class="onb-label" style="margin-top: 20px;">ê°€ì… ëª©ì  (1ê°œ ì´ìƒ ì„ íƒ)</label>
            <div id="onbGoals" class="tag-cloud">
                <button type="button" class="tag" data-value="ì²´ì¤‘ê´€ë¦¬">ì²´ì¤‘ê´€ë¦¬</button>
                <button type="button" class="tag" data-value="í˜ˆë‹¹ ê´€ë¦¬">í˜ˆë‹¹ê´€ë¦¬</button>
                <button type="button" class="tag" data-value="ìê°€í¬ì‹(ì˜¤í† íŒŒì§€)">ìê°€í¬ì‹(ì˜¤í† íŒŒì§€)</button>
                <button type="button" class="tag" data-value="ìœ„ì¥íœ´ì‹Â·ì†Œí™”ê°œì„ ">ìœ„ì¥íœ´ì‹Â·ì†Œí™”ê°œì„ </button>
                <button type="button" class="tag" data-value="ì—ë„ˆì§€Â·ì§‘ì¤‘ë ¥ ê°œì„ ">ì—ë„ˆì§€Â·ì§‘ì¤‘ë ¥ ê°œì„ </button>
                <button type="button" class="tag" data-value="ê¸°íƒ€">ê¸°íƒ€</button>
            </div>
    
            <div class="onb-actions">
                <button id="onbCancel" type="button" class="onb-btn onb-ghost">ë‚˜ì¤‘ì— í• ê²Œìš”</button>
                <button id="onbSave" type="button" class="onb-btn onb-primary">ì €ì¥í•˜ê³  ì‹œì‘</button>
            </div>
        </div>
    </div>

    <!-- Toast Alert -->
    <div id="toast"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {

// 'ì„ ì¥'ì´ ì¤€ë¹„í•´ ë‘” ê³µìš© ë„êµ¬ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
    const auth = window.fastmateApp.auth;
    const db = window.fastmateApp.db;
    const getUserDoc = window.fastmateApp.getUserDoc;
    let currentUser = null; // ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì •ë³´ë¥¼ ì•ˆì •ì ìœ¼ë¡œ ì €ì¥í•  ë³€ìˆ˜  

    // ì´ í˜ì´ì§€ì—ì„œ ì‚¬ìš©í•  DOM ìš”ì†Œë“¤ì„ ë¯¸ë¦¬ ì°¾ì•„ë‘¡ë‹ˆë‹¤.
    const userChip = document.getElementById('userChip');
    const userChipName = document.getElementById('userChipName');
     const progressArc      = document.getElementById('progressArc');
  const completionOverlay = document.getElementById('completionOverlay');
  const remainingTimeEl  = document.getElementById('remainingTime');
  const statusMessage    = document.getElementById('status-message');
  const saltTip          = document.getElementById('salt-tip');
  const startBtn         = document.getElementById('startBtn');
  const stopBtn          = document.getElementById('stopBtn');
  const modelSelect      = document.getElementById('fastingModelSelect');
  const startTimeBox     = document.getElementById('startTimeBox');
  const startTimeValue   = document.getElementById('startTimeValue');
  const endTimeValue     = document.getElementById('endTimeValue');
  const timePickerModal  = document.getElementById('timePickerModal');
  const dayBeforeBtn     = document.getElementById('dayBeforeBtn');
  const todayBtn         = document.getElementById('todayBtn');
  const hourSelect       = document.getElementById('hourSelect');
  const minuteSelect     = document.getElementById('minuteSelect');
  const ampmSelect       = document.getElementById('ampmSelect');
  const saveTimeBtn      = document.getElementById('saveTimeBtn');
  const confirmChangeModal = document.getElementById('confirmChangeModal');
  const confirmMessage     = document.getElementById('confirmMessage');
  const confirmYesBtn      = document.getElementById('confirmYesBtn');
  const confirmNoBtn       = document.getElementById('confirmNoBtn');
  const bloodSugarBtn    = document.getElementById('bloodSugarBtn');
  const ketoneBtn        = document.getElementById('ketoneBtn');
  const exerciseBtn      = document.getElementById('exerciseBtn');
  const bloodSugarModal  = document.getElementById('bloodSugarModal');
  const saveBloodSugarBtn= document.getElementById('saveBloodSugarBtn');
  const bloodSugarInput  = document.getElementById('bloodSugarInput');
  const ketoneModal      = document.getElementById('ketoneModal');
  const saveKetoneBtn    = document.getElementById('saveKetoneBtn');
  const ketoneInput      = document.getElementById('ketoneInput');
  const exerciseModal    = document.getElementById('exerciseModal');
  const exerciseTypeWrap = document.getElementById('exerciseType');
  const exerciseDuration = document.getElementById('exerciseDuration');
  const exerciseCalories = document.getElementById('exerciseCalories');
  const saveExerciseBtn  = document.getElementById('saveExerciseBtn');
  const privacyPolicyLink= document.getElementById('privacyPolicyLink');
  const toast            = document.getElementById('toast');
  const weightBtn        = document.getElementById('weightBtn');
  const weightModal      = document.getElementById('weightModal');
  const saveWeightBtn    = document.getElementById('saveWeightBtn');
  const weightInput      = document.getElementById('weightInput');
  const milestones = { 10:false, 25:false, 50:false, 75:false, 90:false, 110:false, 120:false, 150:false, 200:false };

  /* =========================
   * 2) ìƒíƒœ/ìœ í‹¸
   * ========================= */
  let timePickerUsed = false; // <-- ì´ ì¤„ì„ ì¶”ê°€!
  let fastingInterval  = null;
  let targetHours      = 16;
  let fastingState     = 'idle';
  let selectedStartTime= new Date();
  let pendingTargetHours = null;
  let toastTimeout     = null;
  let completionFired = false; // ëª©í‘œ ë‹¬ì„± ì´ë²¤íŠ¸ê°€ í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ë„ë¡ í•˜ëŠ” ê¹ƒë°œ



function showToast(msg) {
    if (!toast) return;
    clearTimeout(toastTimeout);
    toast.textContent = msg;
    toast.classList.add('show');
    toastTimeout = setTimeout(() => toast.classList.remove('show'), 1800);
  }

// [í—¬í¼] 1íšŒì„± ë°ì´í„° ì´ì‚¬ í•¨ìˆ˜
  async function migrateLegacyFast(uid) {
    const legacyStartTime = localStorage.getItem('fastingStartTime');
    const legacyTargetHours = localStorage.getItem('fastingTargetHours');
    if (legacyStartTime && legacyTargetHours) {
      console.log("ì˜›ë‚  ë‹¨ì‹ ë°ì´í„°ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤. Firestoreë¡œ ì˜®ê¹ë‹ˆë‹¤...");
      try {
        await db.collection('users').doc(uid).set({
          currentFasting: {
            startTime: new Date(legacyStartTime),
            targetHours: parseFloat(legacyTargetHours)
          }
        }, { merge: true });
        localStorage.removeItem('fastingStartTime');
        localStorage.removeItem('fastingTargetHours');
        console.log("ë°ì´í„° ì´ì‚¬ ì™„ë£Œ!");
      } catch (error) {
        console.error("ë°ì´í„° ì´ì‚¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
      }
    }
  }


// fastmate.htmlì˜ <script> ì•ˆì—ì„œ updateUIState í•¨ìˆ˜ë¥¼ ì°¾ì•„ êµì²´
function updateUIState() {
    const running = fastingState === 'running';
    if (startBtn) {
        startBtn.disabled = running;
        startBtn.textContent = running ? 'ë‹¨ì‹ì¤‘' : 'ë‹¨ì‹ ì‹œì‘';
        startBtn.style.backgroundColor = running ? 'var(--gauge-start-color)' : 'var(--primary-color)';
        // â–¼â–¼â–¼ [ìˆ˜ì •] 'ë‹¨ì‹ì¤‘'ì¼ ë•Œ ê¸€ììƒ‰ì„ ì–´ë‘ìš´ ìƒ‰ìœ¼ë¡œ ê³ ì •í•©ë‹ˆë‹¤. â–¼â–¼â–¼
        startBtn.style.color = running ? '#333' : '#fff';
    }
    if (stopBtn) { 
        stopBtn.disabled = !running; 
        stopBtn.style.opacity = running ? '1' : '0.5'; 
    }
}


  /* =========================
   * ë‹¨ì‹ íƒ€ì´ë¨¸
   * ========================= */
  function updateTimeDisplays() {
    const start = selectedStartTime;
    const duration = fastingState === 'running'
  ? parseFloat(targetHours)
  : parseInt(modelSelect.value || targetHours, 10);
    const end = new Date(start.getTime() + duration * 3600000);
    const fmt = (d) => `${d.getMonth()+1}/${d.getDate()} ${d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true})}`;
    if (startTimeValue) startTimeValue.textContent = fmt(start);
    if (endTimeValue)   endTimeValue.textContent   = fmt(end);
  }


// fastmate.htmlì˜ <script> ì•ˆì—ì„œ updateTimer í•¨ìˆ˜ë¥¼ ì°¾ì•„ êµì²´
// updateTimer í•¨ìˆ˜ë¥¼ ì´ ì½”ë“œë¡œ í†µì§¸ë¡œ êµì²´í•´ì£¼ì„¸ìš”.
function updateTimer() {
    const now = new Date();
    const elapsed = now - selectedStartTime;
    const target  = parseFloat(targetHours) * 3600000;
    const progress = Math.min((elapsed / target) * 100, 100);

    const timerLabel = document.querySelector('.timer-display .label');

    
  // âœ… [ì¶”ê°€] ì‹œì‘/ì¢…ë£Œ í‘œì‹œê°€ ë¹„ì–´ìˆì„ ë•Œ í•œ ë²ˆ ì±„ì›Œì£¼ê¸°
  if ((startTimeValue?.textContent === '-' || endTimeValue?.textContent === '-') && selectedStartTime) {
    const fmt = (d) => `${d.getMonth()+1}/${d.getDate()} ${d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true})}`;
    startTimeValue.textContent = fmt(selectedStartTime);
    endTimeValue.textContent = fmt(
  new Date(selectedStartTime.getTime() + (parseFloat(targetHours) * 3600000))
);
  }

    // --- ëª©í‘œ ë‹¬ì„± ì „/í›„ UI ì—…ë°ì´íŠ¸ ---
    if (elapsed < target) {
        // ëª©í‘œ ë‹¬ì„± ì „
        if(timerLabel) timerLabel.textContent = 'ë‚¨ì€ ì‹œê°„';
        if(progressArc) progressArc.setAttribute('stroke', 'url(#progGrad)');

        const remain = target - elapsed;
        const h = Math.floor(remain / 3600000);
        const m = Math.floor((remain % 3600000) / 60000);
        const s = Math.floor((remain % 60000) / 1000);
        if (remainingTimeEl) remainingTimeEl.textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;

        if (statusMessage) {
            statusMessage.innerHTML = `<span style="color: var(--primary-color); font-weight: 700;">${targetHours}ì‹œê°„</span> ë‹¨ì‹ ì§„í–‰ì¤‘...`;
        }
    } else {
        // ëª©í‘œ ë‹¬ì„± í›„ (ì´ˆê³¼ ì‹œê°„)
        if(timerLabel) timerLabel.textContent = 'ì´ˆê³¼ ì‹œê°„';
        if(progressArc) progressArc.setAttribute('stroke', 'url(#overtimeGrad)');

        const overtime = elapsed - target;
        const h = Math.floor(overtime / 3600000);
        const m = Math.floor((overtime % 3600000) / 60000);
        const s = Math.floor((overtime % 60000) / 1000);
        if (remainingTimeEl) remainingTimeEl.textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        
        if (statusMessage) statusMessage.textContent = "ëª©í‘œ ë‹¬ì„±! ëŒ€ë‹¨í•´ìš”!";
    }

    // --- ê³µí†µ ë¡œì§ ---
    if (progressArc) progressArc.style.strokeDasharray = `${progress} 100`;
    checkMilestones(progress);
    
    // [ìˆ˜ì •] ëª©í‘œ ë‹¬ì„± ì‹œ, ì• ë‹ˆë©”ì´ì…˜ë§Œ 1íšŒ ë³´ì—¬ì£¼ê³  ë‹¨ì‹ì€ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤.
    if (progress >= 100 && !completionFired) {
        completionFired = true; // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
        
        // ìë™ìœ¼ë¡œ stopFasting()ì„ í˜¸ì¶œí•˜ëŠ” ì½”ë“œë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.
        if (completionOverlay) {
            completionOverlay.classList.add('show');
            // 4ì´ˆ í›„ ì• ë‹ˆë©”ì´ì…˜ë§Œ ìˆ¨ê¹ë‹ˆë‹¤.
            setTimeout(() => {
                completionOverlay.classList.remove('show');
            }, 4000);
        }
    }
}

// ë‹¨ì‹ ì‹œì‘ ë° ì¢…ë£Œ

// ğŸ”§ êµì²´: ê¸°ì¡´ startFasting ì „ë¶€ ì‚­ì œí•˜ê³  ì•„ë˜ë¡œ êµì²´
async function startFasting() {
  if (fastingState === 'running') return showToast("ì´ë¯¸ ë‹¨ì‹ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.");
  if (!currentUser) return showToast("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); // â† ensureSignedIn() ëŒ€ì‹  í•œ ì¤„ ì²´í¬

  // 1) ì‹œì‘ ì‹œê°„ í™•ì •
  if (!timePickerUsed) selectedStartTime = new Date();

  // 2) ìƒíƒœ ê°’ ë°˜ì˜
  fastingState = 'running';
  targetHours = parseFloat(modelSelect.value || targetHours);

  // 3) í™”ë©´ì„ 'ì¦‰ì‹œ' ê°±ì‹  (DB ì €ì¥ ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ)
  updateTimeDisplays();
  updateUIState();
  updateSelectOptions();

  // 4) íƒ€ì´ë¨¸ ì•ˆì „ ì¬ì‹œì‘
  if (fastingInterval) clearInterval(fastingInterval);
  fastingInterval = setInterval(updateTimer, 1000);
  updateTimer();

  // 5) ì„œë²„ ì €ì¥ (ë°±ê·¸ë¼ìš´ë“œ)
  try {
    await db.collection('users').doc(currentUser.uid).set({
      currentFasting: {
        startTime: selectedStartTime,           // Date ê·¸ëŒ€ë¡œ ì €ì¥(Firestoreê°€ Timestampë¡œ ë³€í™˜)
        targetHours: targetHours
      }
    }, { merge: true });
    showToast(`${targetHours}ì‹œê°„ ë‹¨ì‹ì„ ì‹œì‘í•©ë‹ˆë‹¤!`);
  } catch (err) {
    console.error("Firestore ì €ì¥ ì‹¤íŒ¨:", err);
    showToast("ë‹¨ì‹ ì‹œì‘ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    // ì‹¤íŒ¨ ì‹œ UI ì›ë³µ
    clearInterval(fastingInterval);
    fastingState = 'idle';
    updateUIState();
    resetSelectOptions();
  } finally {
    timePickerUsed = false;
  }
}


// ğŸ”§ êµì²´: ê¸°ì¡´ stopFasting ì „ë¶€ ì‚­ì œí•˜ê³  ì•„ë˜ë¡œ êµì²´
async function stopFasting() {
  if (fastingState === 'idle') return showToast("ì‹œì‘ëœ ë‹¨ì‹ì´ ì—†ìŠµë‹ˆë‹¤.");

  clearInterval(fastingInterval);
  fastingState = 'idle';

  // ì‚¬ìš©ì ì²´í¬(ensureSignedIn() ì‚­ì œ)
  if (!currentUser) {
    // ì‚¬ìš©ì ì—†ìœ¼ë©´ UIë§Œ ì´ˆê¸°í™”
    if (progressArc)     progressArc.style.strokeDasharray = '0 100';
    if (remainingTimeEl) remainingTimeEl.textContent = '00:00:00';
    if (statusMessage)   statusMessage.textContent = 'ë‹¨ì‹ ê³„íšì„ ì„ íƒí•˜ê³  ì‹œì‘í•˜ì„¸ìš”.';
    if (saltTip)         saltTip.style.display = 'none';
    initializeTime();
    updateUIState();
    resetSelectOptions();
    return showToast("ì‚¬ìš©ì ì •ë³´ê°€ ì—†ì–´ ê¸°ë¡ ì €ì¥ì„ ê±´ë„ˆëœë‹ˆë‹¤.");
  }

  const record = {
    startTime: selectedStartTime,
    endTime: new Date(),
    targetHours: parseFloat(targetHours),
    actualDurationHours: (new Date() - selectedStartTime) / 3600000
  };

  try {
    // ê¸°ë¡ ì €ì¥
    await db.collection('users').doc(currentUser.uid)
      .collection('fastingHistory').add({
        startTime: record.startTime,
        endTime: record.endTime,
        targetHours: record.targetHours,
        actualDurationHours: record.actualDurationHours,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

    // ì§„í–‰ì¤‘ ìƒíƒœ ì œê±°
    await db.collection('users').doc(currentUser.uid).update({
      currentFasting: firebase.firestore.FieldValue.delete()
    });
  } catch (e) {
    console.error('ë‹¨ì‹ ê¸°ë¡ ì €ì¥/ìƒíƒœ ì‚­ì œ ì‹¤íŒ¨:', e);
    showToast("ê¸°ë¡ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    // ì‹¤íŒ¨í•´ë„ UIëŠ” ì´ˆê¸°í™” ìœ ì§€ (ì›í•˜ë©´ ì—¬ê¸°ì„œ ë¡¤ë°± ê°€ëŠ¥)
  }

  // UI ì´ˆê¸°í™”
  if (progressArc)     progressArc.style.strokeDasharray = '0 100';
  if (remainingTimeEl) remainingTimeEl.textContent = '00:00:00';
  if (statusMessage)   statusMessage.textContent = 'ë‹¨ì‹ ê³„íšì„ ì„ íƒí•˜ê³  ì‹œì‘í•˜ì„¸ìš”.';
  if (saltTip)         saltTip.style.display = 'none';

  initializeTime();
  updateUIState();
  resetSelectOptions();
  showToast("ë‹¨ì‹ì„ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤. ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤!");
}

  function getSignedInUser() {
  return (typeof currentUser !== 'undefined' && currentUser) || (auth && auth.currentUser) || null;
}

  function handleModelChange(e) {
    const newTarget = parseInt(e.target.value, 10);
    if (fastingState === 'running' && newTarget !== targetHours) {
      pendingTargetHours = newTarget;
      if (confirmChangeModal && confirmMessage) {
        confirmMessage.textContent = `ë‹¨ì‹ ëª©í‘œë¥¼ ${targetHours}ì‹œê°„ì—ì„œ ${newTarget}ì‹œê°„ìœ¼ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
        confirmChangeModal.style.display = 'flex';
      }
      e.target.value = targetHours;
    } else if (fastingState !== 'running') {
      targetHours = newTarget;
      updateTimeDisplays();
    }
  }

/* =========================
 * ì‹œê°„ ì„ íƒ ì´ˆê¸°í™”
 * ========================= */
function initializeTimePicker() {
    if (!timePickerModal) return;
    
    hourSelect.innerHTML = '';
    for (let i = 1; i <= 12; i++) hourSelect.innerHTML += `<option value="${i}">${i}</option>`;
    
    minuteSelect.innerHTML = '';
    for (let i = 0; i < 60; i++) minuteSelect.innerHTML += `<option value="${i}">${String(i).padStart(2, '0')}</option>`;

    startTimeBox?.addEventListener('click', () => {
        if (fastingState === 'running') {
            // ë‹¨ì‹ ì¤‘ì—ë„ ëª¨ë‹¬ì„ ì—´ ìˆ˜ ìˆë„ë¡ í—ˆìš© (ì´ì „ ìˆ˜ì • ì‚¬í•­ ë°˜ì˜)
        }
        const now = selectedStartTime;
        let h = now.getHours();
        const ampm = h >= 12 ? 'PM' : 'AM';
        h = h % 12;
        h = h ? h : 12;
        hourSelect.value = h;
        minuteSelect.value = now.getMinutes();
        ampmSelect.value = ampm;
        timePickerModal.style.display = 'flex';
    });

    dayBeforeBtn?.addEventListener('click', () => {
        dayBeforeBtn.classList.add('active');
        todayBtn.classList.remove('active');
    });

    todayBtn?.addEventListener('click', () => {
        todayBtn.classList.add('active');
        dayBeforeBtn.classList.remove('active');
    });

    saveTimeBtn?.addEventListener('click', async () => { // <-- ì—¬ê¸°ì— async ì¶”ê°€!
        timePickerUsed = true; // ì‚¬ìš©ìê°€ ì‹œê°„ ì„ íƒ ëª¨ë‹¬ì„ ì‚¬ìš©í–ˆë‹¤ëŠ” ê¹ƒë°œì„ ì„¸ì›€

        let hour = parseInt(hourSelect.value, 10);
        const minute = parseInt(minuteSelect.value, 10);
        const isPM = ampmSelect.value === 'PM';
        if (isPM && hour < 12) hour += 12;
        if (!isPM && hour === 12) hour = 0;

        const newDate = new Date();
        if (dayBeforeBtn?.classList.contains('active')) newDate.setDate(newDate.getDate() - 1);
        newDate.setHours(hour, minute, 0, 0);

        selectedStartTime = newDate;
        updateTimeDisplays();
        timePickerModal.style.display = 'none';

        // â–¼â–¼â–¼ [ë²„ê·¸ ìˆ˜ì •] ì‹œê°„ ì •ì • ë¡œì§ â–¼â–¼â–¼
            if (fastingState === 'running') {
                if (!currentUser) return showToast("ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                
                try {
                    // localStorageê°€ ì•„ë‹Œ Firestoreì— ì§ì ‘ ì—…ë°ì´íŠ¸
                    await db.collection('users').doc(currentUser.uid).set({
                        currentFasting: { 
                            startTime: selectedStartTime, // ìƒˆë¡œ ì„ íƒëœ ì‹œê°„
                            targetHours: targetHours 
                        }
                    }, { merge: true });

                    updateTimer(); // DB ì—…ë°ì´íŠ¸ ì„±ê³µ í›„ íƒ€ì´ë¨¸ ì¦‰ì‹œ ê°±ì‹ 
                    showToast('ì§„í–‰ ì¤‘ì¸ ë‹¨ì‹ì˜ ì‹œì‘ ì‹œê°„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');

                } catch (error) {
                    console.error("Error updating start time in Firestore:", error);
                    showToast("ì‹œê°„ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            }
        });
    }


/* =========================
   * 5) ì´ë²¤íŠ¸ ë°”ì¸ë”© (1íšŒ)
   * ========================= */
  let eventsWired = false;
  function wireEventsOnce() {
    if (eventsWired) return;
    eventsWired = true;

    startBtn?.addEventListener('click', startFasting);
    stopBtn?.addEventListener('click', stopFasting);
    modelSelect?.addEventListener('change', handleModelChange);

    userChip?.addEventListener('click', () => {
    // TODO: ì‹¤ì œ ë§ˆì´í˜ì´ì§€ ê²½ë¡œë¡œ ìˆ˜ì •í•˜ì„¸ìš”.
    window.location.href = '/mypage.html'; 
    });
    // â–²â–²â–² ì—¬ê¸°ê¹Œì§€ ì¶”ê°€ â–²â–²â–²

    confirmYesBtn?.addEventListener('click', () => {
      if (pendingTargetHours == null) return;
      targetHours = pendingTargetHours; pendingTargetHours = null;
      modelSelect.value = targetHours;
      localStorage.setItem('fastingTargetHours', targetHours);
      updateTimeDisplays(); updateTimer();
      if (saltTip) saltTip.style.display = targetHours >= 48 ? 'block' : 'none';
      showToast("ë‹¨ì‹ ëª©í‘œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
      confirmChangeModal.style.display = 'none';
    });
    confirmNoBtn?.addEventListener('click', () => {
      modelSelect.value = targetHours;
      confirmChangeModal.style.display = 'none';
    });
    
    // --- ì²´ì¤‘ ê¸°ë¡ ---
    weightBtn?.addEventListener('click', () => weightModal && (weightModal.style.display='flex'));
    saveWeightBtn?.addEventListener('click', async () => {
      const v = parseFloat(weightInput?.value);
      if (!v || v <= 0) return showToast("ì˜¬ë°”ë¥¸ ì²´ì¤‘ì„ ì…ë ¥í•˜ì„¸ìš”.");
      const user = getSignedInUser();
if (!user) { showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
      try {
        await db.collection('users').doc(user.uid).collection('measurements').doc('weight').collection('items').add({ date: new Date(), value: v, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      } catch (e) {
        console.error('save weight failed:', e);
        showToast('ì„œë²„ ì €ì¥ ì‹¤íŒ¨(ì²´ì¤‘)â€¦ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }
      weightInput.value = '';
      weightModal.style.display = 'none';
      showToast("ì²´ì¤‘ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    });
    
    // --- í˜ˆë‹¹ ê¸°ë¡ ---
    bloodSugarBtn?.addEventListener('click', () => {
      if (bloodSugarModal) {
        bloodSugarModal.style.display = 'flex';
   // [ì¶”ê°€] ì‹œê°„ ì…ë ¥ì°½ì— í˜„ì¬ ì‹œê°„ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
        const timestampInput = document.getElementById('bloodSugarTimestampInput');
        if (timestampInput) {
            const now = new Date();
            // YYYY-MM-DDTHH:mm í˜•ì‹ì— ë§ê²Œ ì‹œê°„ ì˜¤í”„ì…‹ì„ ì¡°ì •í•©ë‹ˆë‹¤.
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            timestampInput.value = now.toISOString().slice(0, 16);
        }
       
      } else {
        const v = parseFloat(prompt('í˜ˆë‹¹ ìˆ˜ì¹˜ (mg/dL)ë¥¼ ì…ë ¥í•˜ì„¸ìš”:') || '');
        if (v > 0) {
          saveLocalList('bloodSugarData', { date:new Date().toISOString(), value:v });
          showToast('í˜ˆë‹¹ ìˆ˜ì¹˜ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
      }
    });
    // wireEventsOnce í•¨ìˆ˜ ì•ˆ

saveBloodSugarBtn?.addEventListener('click', async () => {
    const v = parseFloat(bloodSugarInput?.value);
    if (!v || v <= 0) return showToast("ì˜¬ë°”ë¥¸ í˜ˆë‹¹ ìˆ˜ì¹˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

    // [ì¶”ê°€] ì‹œê°„ ì…ë ¥ì°½ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
    const timestampInput = document.getElementById('bloodSugarTimestampInput');
    const timestamp = timestampInput.value;

    if (!timestamp) return showToast("ì¸¡ì • ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    
    // [ìˆ˜ì •] ì…ë ¥ëœ ì‹œê°„ ë¬¸ìì—´ì„ Date ê°ì²´ë¡œ ë³€í™˜
    const recordDate = new Date(timestamp);

  const user = getSignedInUser();
if (!user) { showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }

    saveLocalList('bloodSugarData', { date: recordDate.toISOString(), value: v });

    try {
        await db.collection('users').doc(user.uid)
            .collection('measurements').doc('bloodSugar')
            .collection('items').add({
                date: recordDate, // [ìˆ˜ì •] new Date() ëŒ€ì‹  ì„ íƒí•œ ì‹œê°„ìœ¼ë¡œ ì €ì¥
                value: v,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
    } catch (e) {
        console.error('save blood sugar failed:', e);
        showToast('ì„œë²„ ì €ì¥ ì‹¤íŒ¨(í˜ˆë‹¹)â€¦ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    }

    bloodSugarInput.value = '';
    bloodSugarModal.style.display = 'none';
    showToast("í˜ˆë‹¹ ìˆ˜ì¹˜ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
});

    // --- ì¼€í†¤ ê¸°ë¡ ---
    ketoneBtn?.addEventListener('click', () => ketoneModal && (ketoneModal.style.display='flex'));
    saveKetoneBtn?.addEventListener('click', async () => {
      const v = parseFloat(ketoneInput?.value);
      if (v == null || isNaN(v) || v < 0) return showToast("ì˜¬ë°”ë¥¸ ì¼€í†¤ ìˆ˜ì¹˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
     const user = getSignedInUser();
if (!user) { showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
      saveLocalList('ketoneData', { date: new Date().toISOString(), value: v });
      try {
        await db.collection('users').doc(user.uid).collection('measurements').doc('ketone').collection('items').add({ date: new Date(), value: v, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      } catch (e) {
        console.error('save ketone failed:', e);
        showToast('ì„œë²„ ì €ì¥ ì‹¤íŒ¨(ì¼€í†¤)â€¦ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }
      ketoneInput.value = '';
      ketoneModal.style.display = 'none';
      showToast("ì¼€í†¤ ìˆ˜ì¹˜ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    });

    // --- ìš´ë™ ê¸°ë¡ ---
    exerciseBtn?.addEventListener('click', () => exerciseModal && (exerciseModal.style.display='flex'));
    exerciseTypeWrap?.addEventListener('click', (e) => {
      if (!e.target.classList.contains('tag')) return;
      const prev = exerciseTypeWrap.querySelector('.tag.active');
      if (prev) prev.classList.remove('active');
      e.target.classList.add('active');
    });
    saveExerciseBtn?.addEventListener('click', async () => {
      const sel = exerciseTypeWrap?.querySelector('.tag.active');
      const duration = parseInt(exerciseDuration?.value,10);
      const calories = exerciseCalories?.value === '' ? null : parseInt(exerciseCalories.value,10);
      if (!sel) return showToast("ìš´ë™ ì¢…ë¥˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
      if (!duration || duration<=0) return showToast("ì˜¬ë°”ë¥¸ ìš´ë™ ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš”.");
      if (calories !== null && calories < 0) return showToast("ì¹¼ë¡œë¦¬ëŠ” 0 ì´ìƒìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”.");
 const user = getSignedInUser();
if (!user) { showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
      const rec = { date:new Date().toISOString(), type: sel.dataset.value, duration, calories };
      saveLocalList('exerciseData', rec);
      try {
        await db.collection('users').doc(user.uid).collection('measurements').doc('exercise').collection('items').add({ date: new Date(), type: rec.type, duration: rec.duration, calories: rec.calories ?? 0, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      } catch (e) {
        console.error('save exercise failed:', e);
        showToast('ì„œë²„ ì €ì¥ ì‹¤íŒ¨(ìš´ë™)â€¦ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }
      sel.classList.remove('active');
      exerciseDuration.value = '';
      exerciseCalories.value = '';
      exerciseModal.style.display = 'none';
      showToast("ìš´ë™ ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    });

    // --- ê¸°íƒ€ ë§í¬ ë° ê³µí†µ ì´ë²¤íŠ¸ ---
    privacyPolicyLink?.addEventListener('click', (e) => {
      e.preventDefault();
      showToast("ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤. (ê°œë°œ ì¤‘)");
    });
  }

  // --- ê³µí†µ ëª¨ë‹¬ ë‹«ê¸° ë¡œì§ ---
  document.addEventListener('click', (e) => {
    const closeId = e.target?.getAttribute?.('data-close');
    if (closeId) {
      const el = document.getElementById(closeId);
      if (el) el.style.display = 'none';
    }
  });


  window.addEventListener('click', (e) => {
    [timePickerModal, confirmChangeModal, bloodSugarModal, ketoneModal, exerciseModal, weightModal]
      .filter(Boolean)
      .forEach(modal => { if (e.target === modal) modal.style.display = 'none'; });
  });



// [í—¬í¼] ë‹‰ë„¤ì„ ì¹© ì—…ë°ì´íŠ¸ + í‘œì‹œ
  function setUserChip(name) {
    if (!userChip || !userChipName) return;
    userChipName.textContent = (name && String(name).trim()) || 'ì‚¬ìš©ì';
    userChip.style.display = 'flex';
  }

  
    

 async function initializeAppForUser(user) {
      console.log(user.uid, "ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤. ì•± ì´ˆê¸°í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.");

      try {
        const profile = await getUserDoc(user.uid);
        console.log("Firestore í”„ë¡œí•„ ì •ë³´:", profile);

        // 1. ë‹‰ë„¤ì„ ë¬¸ì œ í•´ê²°: Firestore í”„ë¡œí•„ì˜ ë‹‰ë„¤ì„ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        const nickname = profile?.displayName || user.displayName || 'ì‚¬ìš©ì';
        if (userChip && userChipName) {
          userChipName.textContent = nickname;
          userChip.style.display = 'flex';
        }

        // 2. ë§ˆì´í˜ì´ì§€ ì´ë™ ë¬¸ì œ í•´ê²°: userChipì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
        if (userChip) {
          userChip.addEventListener('click', () => {
            // TODO: ë§ˆì´í˜ì´ì§€ ê²½ë¡œë¥¼ ì‹¤ì œ ê²½ë¡œë¡œ ìˆ˜ì •í•˜ì„¸ìš” (ì˜ˆ: /mypage.html)
            window.location.href = '/mypage.html'; 
          });
        }

        // 3. Firestoreì—ì„œ ì €ì¥ëœ ë‹¨ì‹ ì •ë³´ê°€ ìˆìœ¼ë©´ íƒ€ì´ë¨¸ ì‹œì‘
        const savedFasting = profile?.currentFasting;
        if (savedFasting) {
          // TODO: ë‹¨ì‹ ì •ë³´ë¡œ íƒ€ì´ë¨¸ ì‹œì‘í•˜ëŠ” ë¡œì§
        } else {
          // TODO: ë‹¨ì‹ ì¤‘ ì•„ë‹ ë•Œì˜ ì´ˆê¸° UI ì„¤ì • ë¡œì§
        }

        // TODO: ë‚˜ë¨¸ì§€ ëª¨ë“  ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì—°ê²°
        // wireEventsOnce();

      } catch (error) {
        console.error("ì•± ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        alert("ì•±ì„ ì´ˆê¸°í™”í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      }
    
    initializeTimePicker();
}

   // =================================================================
    // 6. ë©”ì¸ ë¡œì§: ì¸ì¦ ìƒíƒœ ë¦¬ìŠ¤ë„ˆ (ëª¨ë“  ì‘ì—…ì˜ ë‹¨ì¼ ì‹œì‘ì )
    // =================================================================
auth.onAuthStateChanged(async user => {
    if (!user) {
        // ... (ë¡œê·¸ì•„ì›ƒ ìƒíƒœ ë¡œì§ì€ ë™ì¼)
        currentUser   = null;
        fastingState  = 'idle';
        initializeTime();
        resetSelectOptions(); // ë¡œê·¸ì•„ì›ƒ ì‹œì—ë„ ì´ˆê¸°í™”
        updateUIState();
        return;
    }

    currentUser = user;

    try {
        const profile = await getUserDoc(user.uid);

        const nickname = profile?.nickname || profile?.displayName || user.displayName || 'ì‚¬ìš©ì';
        if (userChipName) userChipName.textContent = nickname;
        if (userChip) userChip.style.display = 'flex';

        const savedFasting = profile?.currentFasting;

        if (savedFasting?.startTime) {
            // [ìƒíƒœ 1] ì €ì¥ëœ ë‹¨ì‹ì´ ìˆì„ ë•Œ (ì§„í–‰ ì¤‘)
            fastingState = 'running';
            selectedStartTime = savedFasting.startTime.toDate();
            targetHours = Number(savedFasting.targetHours) || 16;
            
            if (modelSelect) modelSelect.value = String(targetHours);

            if (fastingInterval) clearInterval(fastingInterval);
            fastingInterval = setInterval(updateTimer, 1000);

            // [ê°œì„  1] UI ì—…ë°ì´íŠ¸ ë¡œì§ì„ ì´ ë¸”ë¡ ì•ˆìœ¼ë¡œ ì´ë™
            updateTimer();          // íƒ€ì´ë¨¸ UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
            updateTimeDisplays();   // ì‹œê°„ í‘œì‹œë¶€ ì—…ë°ì´íŠ¸
            updateSelectOptions();  // ë“œë¡­ë‹¤ìš´ì— '(ì§„í–‰ì¤‘)' í‘œì‹œ
            
        } else {
            // [ìƒíƒœ 2] ì €ì¥ëœ ë‹¨ì‹ì´ ì—†ì„ ë•Œ (íœ´ì‹ ì¤‘)
            fastingState = 'idle';

            // [ê°œì„  2] UI ì´ˆê¸°í™” ë¡œì§ì„ ëª…í™•í•˜ê²Œ ê·¸ë£¹í™”
            initializeTime();       // ì‹œê°„ ê´€ë ¨ ë³€ìˆ˜ ì´ˆê¸°í™”
            updateTimeDisplays();   // ì‹œê°„ í‘œì‹œë¶€ ì´ˆê¸°í™”ëœ ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸
            resetSelectOptions();   // ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
        }

        // [ê°œì„  3] ì „ì²´ì ì¸ UI ìƒíƒœ (ë²„íŠ¼ í™œì„±í™” ë“±)ëŠ” ë§ˆì§€ë§‰ì— í•œ ë²ˆë§Œ í˜¸ì¶œ
        updateUIState();
        if (saltTip) saltTip.style.display = (fastingState === 'running' && targetHours >= 48) ? 'block' : 'none';

        wireEventsOnce();

    } catch (error) {
        console.error("ì•± ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜:", error);
        alert("ì•± ì´ˆê¸°í™” ì‹¤íŒ¨. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.");
    }
});

  
  function saveLocalList(key, data) {
    const arr = JSON.parse(localStorage.getItem(key) || '[]');
    arr.unshift(data);
    localStorage.setItem(key, JSON.stringify(arr));
  }


function checkMilestones(progress) {
    const messages = {
      10: "ì‹œì‘ì´ ë°˜! ë¬¼ í•œ ì”ìœ¼ë¡œ ëª¸ì„ ê¹¨ì›Œì£¼ì„¸ìš”. ğŸ’§",
      25: "25% ë‹¬ì„±! ìˆœì¡°ë¡­ê²Œ ì§„í–‰ ì¤‘ì´ì—ìš”.",
      50: "ì ˆë°˜ì´ë‚˜ ì™”ì–´ìš”! ì •ë§ ëŒ€ë‹¨í•´ìš”. ì‹œì›í•œ ë¬¼ í•œ ì” ìŠì§€ ë§ˆì„¸ìš”! ğŸ’§",
      75: "75% ëŒíŒŒ! ê±°ì˜ ë‹¤ ì™”ìŠµë‹ˆë‹¤. ì¡°ê¸ˆë§Œ ë” í˜ë‚´ì„¸ìš”!",
      90: "90% ëŒíŒŒ! ëª©í‘œê°€ ë°”ë¡œ ëˆˆì•ì— ìˆì–´ìš”. í™”ì´íŒ…! ğŸ’§",
      110: "110% ì´ˆê³¼ ë‹¬ì„±! ëª¸ì´ ë³´ë‚´ëŠ” ì‹ í˜¸ì— ê·€ë¥¼ ê¸°ìš¸ì—¬ ì£¼ì„¸ìš”.",
      120: "120% ì´ˆê³¼ ë‹¬ì„±! ì •ë§ ëŒ€ë‹¨í•œ ì˜ì§€ì…ë‹ˆë‹¤!",
      150: "150% ì´ˆê³¼ ë‹¬ì„±! ìƒˆë¡œìš´ ê¸°ë¡ì„ ì“°ê³  ê³„ì‹œëŠ”êµ°ìš”!",
      200: "200% ë‹¬ì„±! ì»¨ë””ì…˜ ì¡°ì ˆì€ í•„ìˆ˜ì…ë‹ˆë‹¤. ì¶©ë¶„í•œ íœ´ì‹ì„ ìŠì§€ ë§ˆì„¸ìš”."
    };

    // [ìˆ˜ì •] ì´ì œ progressê°€ ì•„ë‹Œ ì‹¤ì œ ê²½ê³¼ ì‹œê°„ ë¹„ìœ¨ë¡œ ê³„ì‚°í•©ë‹ˆë‹¤.
    const now = new Date();
    const elapsed = now - selectedStartTime;
    const target  = parseFloat(targetHours) * 3600000;
    const actualProgress = (elapsed / target) * 100;

    Object.keys(milestones).forEach((p) => {
      const pi = parseInt(p, 10);
      if (actualProgress >= pi && !milestones[p]) {
        showToast(messages[p]);
        milestones[p] = true;
      }
    });
}


  function handleModelChange(e) {
    const newTarget = parseInt(e.target.value, 10);
    if (fastingState === 'running' && newTarget !== targetHours) {
      pendingTargetHours = newTarget;
      if (confirmChangeModal && confirmMessage) {
        confirmMessage.textContent = `ë‹¨ì‹ ëª©í‘œë¥¼ ${targetHours}ì‹œê°„ì—ì„œ ${newTarget}ì‹œê°„ìœ¼ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
        confirmChangeModal.style.display = 'flex';
      }
      e.target.value = targetHours;
    } else if (fastingState !== 'running') {
      targetHours = newTarget;
      updateTimeDisplays();
    }
  }


// ì„ íƒì°½ UIë¥¼ 'ë‹¨ì‹ì¤‘' ìƒíƒœë¡œ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
function updateSelectOptions() {
    modelSelect.classList.add('is-fasting');
    const options = modelSelect.options;
    for (let i = 0; i < options.length; i++) {
        const option = options[i];
        // ì›ë˜ í…ìŠ¤íŠ¸ë¥¼ ì €ì¥í•´ë‘  (ì˜ˆ: "16:8 (16ì‹œê°„ ë‹¨ì‹)")
        if (!option.dataset.originalText) {
            option.dataset.originalText = option.textContent;
        }
        if (option.value == targetHours) {
            option.textContent = `${option.dataset.originalText} (ì§„í–‰ì¤‘)`;
            option.classList.add('is-running');
        } else {
            option.textContent = option.dataset.originalText;
            option.classList.remove('is-running');
        }
    }
}



// ì„ íƒì°½ UIë¥¼ ì´ˆê¸° ìƒíƒœë¡œ ë˜ëŒë¦¬ëŠ” í•¨ìˆ˜
function resetSelectOptions() {
    modelSelect.classList.remove('is-fasting');
    const options = modelSelect.options;
    for (let i = 0; i < options.length; i++) {
        const option = options[i];
        if (option.dataset.originalText) {
            option.textContent = option.dataset.originalText;
        }
        option.classList.remove('is-running');
    }
}



function initializeTime() {
    selectedStartTime = new Date();
    updateTimeDisplays();
}


});
</script>
