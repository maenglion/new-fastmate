<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Fastmate - ê´€ë¦¬í•˜ëŠ” ë‹¨ì‹ </title>
    <link rel="icon" href="/favicon.ico" sizes="any">
     
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="manifest" href="/manifest.json">
    <!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="/firebase-init.js?v=2026.01.29-v9"></script>

<link rel="stylesheet" href="./styles.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">

</head>
<body>
  <script>
if (sessionStorage.getItem('oauthBusy') === '1') {
  document.body.classList.add('oauth-busy');
}
</script>
  <div id="splash-screen">
    <div class="splash-content">
      <h1 class="splash-title">fastmate</h1>
      <div class="spinner"></div>
    </div>
  </div>
  <main class="page-content">
    </main>
    <!-- ì•± ë©”ì¸ ì»¨í…ì¸  -->
<div class="container">

    <div class="main-content">
        <h1 class="main-title">fastmate</h1>
        
        <div class="ring-wrap">
            <svg class="ring" viewBox="0 0 120 120">
                <defs>
                    <linearGradient id="trackGrad"><stop stop-color="var(--gauge-track-color)"/></linearGradient>
                    <linearGradient id="progGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" stop-color="var(--gauge-start-color)"/>
                        <stop offset="100%" stop-color="var(--primary-color)"/>
                    </linearGradient>
                    <linearGradient id="overtimeGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" stop-color="#FF690B"/>
                        <stop offset="100%" stop-color="var(--gauge-start-color)"/>
                    </linearGradient>
                </defs>
                <circle cx="60" cy="60" r="54" stroke="url(#trackGrad)" stroke-width="12" fill="none"/>
                <circle id="progressArc" cx="60" cy="60" r="54" stroke="url(#progGrad)" stroke-width="12" fill="none" stroke-linecap="round" pathLength="100" stroke-dasharray="0 100" transform="rotate(-90 60 60)"/>
            </svg>
            <div class="timer-display">
                <div class="label">ë‚¨ì€ ì‹œê°„</div>
                <div id="remainingTime" class="time">00:00:00</div>
            </div>
        </div>

        <div id="status-message" class="status-message">ë‹¨ì‹ ê³„íšì„ ì„ íƒí•˜ê³  ì‹œì‘í•˜ì„¸ìš”.</div>

        <div class="time-info">
            <div id="startTimeBox" class="time-box" title="í´ë¦­í•˜ì—¬ ì‹œê°„ ë³€ê²½">
                <span class="label">ì‹œì‘ ì‹œê°„</span>
                <span id="startTimeValue" class="value">-</span>
                <svg class="edit-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
            </div>
            <div class="time-box">
                <span class="label">ì¢…ë£Œ ì˜ˆì •</span>
                <span id="endTimeValue" class="value">-</span>
            </div>
        </div>
           

<div id="salt-tip" class="salt-tip">
    <span>ğŸ’¡ <strong>íŒ:</strong> 48ì‹œê°„ ì´ìƒ ì¥ê¸° ë‹¨ì‹ ì‹œì—ëŠ” ë¯¸ë„¤ë„ ë³´ì¶©ì„ ìœ„í•´ ì•½ê°„ì˜ ì†Œê¸ˆì„ ì„­ì·¨í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.</span>
    <label style="display: block; font-size: 0.8rem; margin-top: 8px; cursor: pointer;">
        <input type="checkbox" id="hideTipCheckbox"> ë‹¤ì‹œ ë³´ì§€ ì•Šê¸°
    </label>
</div>

        <div class="controls">
            <select id="fastingModelSelect">
                <option value="8">8:16 (8ì‹œê°„ ë‹¨ì‹,ì•¼ì‹ëŠê¸°)</option>  
                <option value="12">12:12 (12ì‹œê°„ ë‹¨ì‹,ì´ˆë³´)</option>  
                <option value="16">16:8 (16ì‹œê°„ ë‹¨ì‹,ì¸ê¸°)</option>
                <option value="18">18:6 (18ì‹œê°„ ë‹¨ì‹,ì¸ê¸°)</option>
                <option value="20">20:4 (20ì‹œê°„ ë‹¨ì‹,ê³ ê¸‰)</option>
                <option value="24">24ì‹œê°„ (1ì¼ ë‹¨ì‹,ê³ ê¸‰)</option>
                <option value="36">36ì‹œê°„(1.5ì¼ ë‹¨ì‹,ê³ ê¸‰)</option>
                <option value="48">48ì‹œê°„ (2ì¼ ë‹¨ì‹,ê³ ê¸‰)</option>
                <option value="72">72ì‹œê°„ (3ì¼ ë‹¨ì‹,ê³ ê¸‰)</option>
            </select>
            <div class="button-group">
                <button id="startBtn" class="start-btn">ë‹¨ì‹ ì‹œì‘</button>
                <button id="stopBtn" class="stop-btn">ë‹¨ì‹ ì¢…ë£Œ</button>
            </div>
        </div>


    <div class="side-menu">
       
        <div class="bottom-nav">
            <button class="nav-btn" id="weightBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 3L2 9l10 6 10-6-10-6zM2 15l10 6 10-6"></path><path d="M2 9v6"></path><path d="M22 9v6"></path><path d="M12 21v-6"></path>
                </svg>
                <span>ì²´ì¤‘</span>
            </button>
            <button class="nav-btn" id="bloodSugarBtn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>
                <span>í˜ˆë‹¹</span>
            </button>
            <button class="nav-btn" id="ketoneBtn">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M12 2v20"/><path d="M7 7h10"/><path d="M7 17h10"/></svg>
                <span>ì¼€í†¤</span>
            </button>
            <button class="nav-btn" id="exerciseBtn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M6 6v12M18 6v12"/>
                    <path d="M3 10v4M21 10v4"/>
                    <path d="M6 12h12"/>
                </svg>
                <span>ìš´ë™</span>
            </button>
            <button class="nav-btn" id="challengeBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                    <path d="m9 12 2 2 4-4"></path>
                </svg>
                <span>ì±Œë¦°ì§€</span>
            </button>
              </div>
         <div id="userChip" class="user-chip" style="display:none">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            <span id="userChipName">-</span>ë‹˜
            </div>
  </div>


  <footer class="app-footer">
            <a href="#" id="privacyPolicyLink">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
            <p>Â© 2025 2e-studio. All rights reserved.</p>
            <p class="faq-link">
              <a href="https://www.notion.so/maenglionworld/FASTMATE-FAQ-256bcdc037cd80de887dfb24a7cae5a1?source=copy_link" target="_blank" rel="noopener noreferrer">
                ì´ìš©ì´ ì–´ë ¤ìš°ì‹ ê°€ìš”? (FAQ)
              </a>
            </p>
        
        </footer>


    <div id="timePickerModal" style="display:none; position:fixed; inset:0; z-index:1900; background:rgba(0,0,0,.5); align-items:center; justify-content:center; padding:20px; box-sizing:border-box;">
        <div class="time-picker-content" style="background: var(--card-bg); border-radius: 16px; padding: 24px; box-shadow: 0 16px 60px rgba(0,0,0,.2); text-align: center; width:100%; max-width: 320px;">
            <h3 class="onb-title" style="margin-top: 0;">ì‹œê°„ ì„ íƒ</h3>
            
            <input type="date" id="datePickerInput" class="onb-input" style="margin-bottom: 20px; text-align: center;">

            <div class="time-selector" style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 25px;">
                <select id="ampmSelect" class="onb-input" style="width: auto; flex-grow: 1;">
                    <option>AM</option>
                    <option>PM</option>
                </select>
                <select id="hourSelect" class="onb-input" style="width: auto; flex-grow: 1;"></select>
                <span>:</span>
                <select id="minuteSelect" class="onb-input" style="width: auto; flex-grow: 1;"></select>
            </div>
            
            <div class="onb-actions" style="display: flex; gap: 10px; margin-top: 24px;">
                <button type="button" data-close="timePickerModal" class="onb-btn onb-ghost">ì·¨ì†Œ</button>
                <button id="saveTimeBtn" type="button" class="onb-btn onb-primary">í™•ì¸</button>
            </div>
        </div>
    </div>

       
        <!-- ì²´ì¤‘ ê¸°ë¡ ëª¨ë‹¬ -->
<div id="weightModal" style="display:none; position:fixed; inset:0; z-index:1900; background:rgba(0,0,0,.5); align-items:center; justify-content:center; padding:20px; box-sizing:border-box;">
  <div style="width:100%; max-width:420px; background:var(--card-bg); border:1px solid var(--border-color); border-radius:16px; box-shadow:0 16px 60px rgba(0,0,0,.2); padding:24px;">
    <h3 class="onb-title" style="margin-bottom:8px;">ì²´ì¤‘ ê¸°ë¡</h3>
    <p class="onb-desc">í˜„ì¬ ì²´ì¤‘(kg)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
    <input id="weightInput" class="onb-input" type="number" step="0.1" min="0" placeholder="ì˜ˆ. 65.5" />
    <div class="onb-actions" style="margin-top:20px;">
      <button type="button" data-close="weightModal" class="onb-btn onb-ghost">ì·¨ì†Œ</button>
      <button id="saveWeightBtn" type="button" class="onb-btn onb-primary">ì €ì¥</button>
    </div>
  </div>
</div>

       
       
        <!-- ì¼€í†¤ ê¸°ë¡ ëª¨ë‹¬ -->
<div id="ketoneModal" style="display:none; position:fixed; inset:0; z-index:1900; background:rgba(0,0,0,.5); align-items:center; justify-content:center; padding:20px; box-sizing:border-box;">
  <div style="width:100%; max-width:420px; background:var(--card-bg); border:1px solid var(--border-color); border-radius:16px; box-shadow:0 16px 60px rgba(0,0,0,.2); padding:24px;">
    <h3 class="onb-title" style="margin-bottom:8px;">ì¼€í†¤ ê¸°ë¡</h3>
    <p class="onb-desc">ì¼€í†¤ ìˆ˜ì¹˜(mmOL/L)ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
    <input id="ketoneInput" class="onb-input" type="number" step="0.1" min="0" placeholder="ì˜ˆ. 1.2" />
    <div class="onb-actions" style="margin-top:20px;">
      <button type="button" data-close="ketoneModal" class="onb-btn onb-ghost">ì·¨ì†Œ</button>
      <button id="saveKetoneBtn" type="button" class="onb-btn onb-primary">ì €ì¥</button>
    </div>
  </div>
</div>


    <!-- í˜ˆë‹¹ ê¸°ë¡ ëª¨ë‹¬ -->
<div id="bloodSugarModal" style="display:none; position:fixed; inset:0; z-index:1900; background:rgba(0,0,0,.5); align-items:center; justify-content:center; padding:20px; box-sizing:border-box;">
  <div style="width:100%; max-width:420px; background:var(--card-bg); border:1px solid var(--border-color); border-radius:16px; box-shadow:0 16px 60px rgba(0,0,0,.2); padding:24px;">
    <h3 class="onb-title" style="margin-bottom:8px;">í˜ˆë‹¹ ê¸°ë¡</h3>
    <p class="onb-desc">í˜ˆë‹¹ ìˆ˜ì¹˜ì™€ ì¸¡ì • ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
    
    <label class="onb-label" style="margin-top:20px; margin-bottom: 5px; text-align: left;">í˜ˆë‹¹ (mg/dL)</label>
    <input id="bloodSugarInput" class="onb-input" type="number" step="1" min="1" placeholder="ì˜ˆ. 92" />

    <label class="onb-label" style="margin-top:15px; margin-bottom: 5px; text-align: left;">ì¸¡ì • ì‹œê°„</label>
    <input id="bloodSugarTimestampInput" class="onb-input" type="datetime-local" />

    <div class="onb-actions" style="margin-top:20px;">
      <button type="button" data-close="bloodSugarModal" class="onb-btn onb-ghost">ì·¨ì†Œ</button>
      <button id="saveBloodSugarBtn" type="button" class="onb-btn onb-primary">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- ìš´ë™ ê¸°ë¡ ëª¨ë‹¬ -->
<div id="exerciseModal" style="display:none; position:fixed; inset:0; z-index:1900; background:rgba(0,0,0,.5); align-items:center; justify-content:center; padding:20px; box-sizing:border-box;">
  <div style="width:100%; max-width:420px; background:var(--card-bg); border:1px solid var(--border-color); border-radius:16px; box-shadow:0 16px 60px rgba(0,0,0,.2); padding:24px;">
    <h3 class="onb-title" style="margin-bottom:8px;">ìš´ë™ ê¸°ë¡</h3>
    <p class="onb-desc">ìš´ë™ ì¢…ë¥˜ì™€ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>

    <!-- ê¸°ì¡´ íƒœê·¸ ìŠ¤íƒ€ì¼ ì¬ì‚¬ìš© -->
    <div id="exerciseType" class="tag-cloud" style="margin-bottom:12px;">
      <button type="button" class="tag" data-value="ê±·ê¸°">ê±·ê¸°</button>
      <button type="button" class="tag" data-value="ë‹¬ë¦¬ê¸°">ë‹¬ë¦¬ê¸°</button>
      <button type="button" class="tag" data-value="ìš”ê°€">ìš”ê°€</button>
      <button type="button" class="tag" data-value="ê·¼ë ¥ìš´ë™">ê·¼ë ¥ìš´ë™</button>
      <button type="button" class="tag" data-value="ìˆ˜ì˜">ìˆ˜ì˜</button>
      <button type="button" class="tag" data-value="ìì „ê±°">ìì „ê±°</button>
      <button type="button" class="tag" data-value="ë“±ì‚°">ë“±ì‚°</button>
      <button type="button" class="tag" data-value="ì¤„ë„˜ê¸°">ì¤„ë„˜ê¸°</button>
      <button type="button" class="tag" data-value="í•„ë¼í…ŒìŠ¤">í•„ë¼í…ŒìŠ¤</button>
      <button type="button" class="tag" data-value="ëŒ„ìŠ¤">ëŒ„ìŠ¤</button>
      <button type="button" class="tag" data-value="ë“±ì‚°">ë“±ì‚°</button>
      <button type="button" class="tag" data-value="íƒ€ë°”íƒ€">íƒ€ë°”íƒ€</button>
      <button type="button" class="tag" data-value="ê³„ë‹¨">ê³„ë‹¨ìš´ë™</button>
      <button type="button" class="tag" data-value="ë°œë ˆ">ë°œë ˆ</button>
      <button type="button" class="tag" data-value="í…Œë‹ˆìŠ¤">í…Œë‹ˆìŠ¤</button>
      <button type="button" class="tag" data-value="ê¸°íƒ€">ê¸°íƒ€</button>
    </div>

    <input id="exerciseDuration" class="onb-input" type="number" min="1" placeholder="ìš´ë™ ì‹œê°„(ë¶„)" style="margin-bottom:10px;" />
    <input id="exerciseCalories" class="onb-input" type="number" min="0" placeholder="ì†Œëª¨ ì¹¼ë¡œë¦¬(kcal, ì„ íƒ)" />

    <div class="onb-actions" style="margin-top:20px;">
      <button type="button" data-close="exerciseModal" class="onb-btn onb-ghost">ì·¨ì†Œ</button>
      <button id="saveExerciseBtn" type="button" class="onb-btn onb-primary">ì €ì¥</button>
    </div>
  </div>
</div>


    <!-- ì˜¨ë³´ë”© ëª¨ë‹¬ (í™”ë©´ ì „ì²´ë¥¼ ë®ëŠ” ë°°ê²½ í¬í•¨) -->
    <div id="appShield">
        <div id="onboardingModal">
            <h3 class="onb-title">ì²˜ìŒ ì˜¤ì…¨êµ°ìš”! ğŸ‘‹</h3>
            <p class="onb-desc">fastmateì˜ ëª¨ë“  ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ë‹‰ë„¤ì„ê³¼ ê°€ì… ëª©ì ì„ ì•Œë ¤ì£¼ì„¸ìš”.</p>
    
            <label class="onb-label" for="onbNickname">ë‹‰ë„¤ì„</label>
            <input id="onbNickname" class="onb-input" type="text" placeholder="ì˜ˆ.ê±´ê°•í•œ ë¼ì´ì–¸" />
    
            <label class="onb-label" style="margin-top: 20px;">ê°€ì… ëª©ì  (1ê°œ ì´ìƒ ì„ íƒ)</label>
            <div id="onbGoals" class="tag-cloud">
                <button type="button" class="tag" data-value="ì²´ì¤‘ê´€ë¦¬">ì²´ì¤‘ê´€ë¦¬</button>
                <button type="button" class="tag" data-value="í˜ˆë‹¹ ê´€ë¦¬">í˜ˆë‹¹ê´€ë¦¬</button>
                <button type="button" class="tag" data-value="ìê°€í¬ì‹(ì˜¤í† íŒŒì§€)">ìê°€í¬ì‹(ì˜¤í† íŒŒì§€)</button>
                <button type="button" class="tag" data-value="ìœ„ì¥íœ´ì‹Â·ì†Œí™”ê°œì„ ">ìœ„ì¥íœ´ì‹Â·ì†Œí™”ê°œì„ </button>
                <button type="button" class="tag" data-value="ì—ë„ˆì§€Â·ì§‘ì¤‘ë ¥ ê°œì„ ">ì—ë„ˆì§€Â·ì§‘ì¤‘ë ¥ ê°œì„ </button>
                <button type="button" class="tag" data-value="ê¸°íƒ€">ê¸°íƒ€</button>
            </div>
    
            <div class="onb-actions">
                <button id="onbCancel" type="button" class="onb-btn onb-ghost">ë‚˜ì¤‘ì— í• ê²Œìš”</button>
                <button id="onbSave" type="button" class="onb-btn onb-primary">ì €ì¥í•˜ê³  ì‹œì‘</button>
            </div>
        </div>
    </div>

    <!-- Toast Alert -->
    <div id="toast"></div>



<script> 
document.addEventListener('DOMContentLoaded', () => {
    // ========================================
    // ===== 0) Firebase ë° ì „ì—­ í•¸ë“¤
    // ========================================
    const app = window.fastmateApp || {};
    const auth = app.auth;
    const db = app.db;
    const getUserDoc = app.getUserDoc || (async () => null);

    // ========================================
    // ===== 1) DOM ìš”ì†Œ ìºì‹œ
    // ========================================
    const userChip = document.getElementById('userChip');
    const userChipName = document.getElementById('userChipName');
    const progressArc = document.getElementById('progressArc');
    const completionOverlay = document.getElementById('completionOverlay');
    const remainingTimeEl = document.getElementById('remainingTime');
    const statusMessage = document.getElementById('status-message');
    const saltTip = document.getElementById('salt-tip');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const modelSelect = document.getElementById('fastingModelSelect');
    const startTimeBox = document.getElementById('startTimeBox');
    const startTimeValue = document.getElementById('startTimeValue');
    const endTimeValue = document.getElementById('endTimeValue');
    const timePickerModal = document.getElementById('timePickerModal');
    const timePickerTitle = timePickerModal?.querySelector('.onb-title');
    const dayBeforeBtn = document.getElementById('dayBeforeBtn');
    const todayBtn = document.getElementById('todayBtn');
    const hourSelect = document.getElementById('hourSelect');
    const minuteSelect = document.getElementById('minuteSelect');
    const ampmSelect = document.getElementById('ampmSelect');
    const saveTimeBtn = document.getElementById('saveTimeBtn');
    const confirmChangeModal = document.getElementById('confirmChangeModal');
    const confirmMessage = document.getElementById('confirmMessage');
    const confirmYesBtn = document.getElementById('confirmYesBtn');
    const confirmNoBtn = document.getElementById('confirmNoBtn');
    const weightBtn = document.getElementById('weightBtn');
    const weightModal = document.getElementById('weightModal');
    const saveWeightBtn = document.getElementById('saveWeightBtn');
    const weightInput = document.getElementById('weightInput');
    const bloodSugarBtn = document.getElementById('bloodSugarBtn');
    const bloodSugarModal = document.getElementById('bloodSugarModal');
    const saveBloodSugarBtn = document.getElementById('saveBloodSugarBtn');
    const bloodSugarInput = document.getElementById('bloodSugarInput');
    const ketoneBtn = document.getElementById('ketoneBtn');
    const ketoneModal = document.getElementById('ketoneModal');
    const saveKetoneBtn = document.getElementById('saveKetoneBtn');
    const ketoneInput = document.getElementById('ketoneInput');
    const exerciseBtn = document.getElementById('exerciseBtn');
    const exerciseModal = document.getElementById('exerciseModal');
    const exerciseTypeWrap = document.getElementById('exerciseType');
    const exerciseDuration = document.getElementById('exerciseDuration');
    const exerciseCalories = document.getElementById('exerciseCalories');
    const saveExerciseBtn = document.getElementById('saveExerciseBtn');
    const privacyPolicyLink = document.getElementById('privacyPolicyLink');
    const toast = document.getElementById('toast');
    const datePickerInput = document.getElementById('datePickerInput');
    const hideTipCheckbox = document.getElementById('hideTipCheckbox');

    // ========================================
    // ===== 2) ìƒíƒœ ë³€ìˆ˜ (State)
    // ========================================
    let currentUser = null;
    let fastingState = 'idle'; // 'idle' | 'running'
    let targetHours = 16;
    let selectedStartTime = new Date();
    let pendingTargetHours = null;
    let completionFired = false;
    let toastTimeout = null;
    let timePickerMode = null; // 'start' | 'end' | null
    let timePickerUsed = false;
    let eventsWired = false;
    let timePickerWired = false; 
    let activeChallengeId = null; 
    
    // ìƒˆ íƒ€ì´ë¨¸ ì‹œìŠ¤í…œ ë³€ìˆ˜
    let __fastTimer = null;
    let __fastEndMs = 0;
    let __fastTotalMs = 0;

    // ë§ˆì¼ìŠ¤í†¤ ê´€ë ¨ ë³€ìˆ˜
    const milestones = { 10: false, 25: false, 50: false, 75: false, 90: false, 110: false, 120: false, 150: false, 200: false };
    const milestoneMessages = {
        10: "ì‹œì‘ì´ ë°˜! ë¬¼ í•œ ì”ìœ¼ë¡œ ëª¸ì„ ê¹¨ì›Œì£¼ì„¸ìš”. ğŸ’§",
        25: "25% ë‹¬ì„±! ìˆœì¡°ë¡­ê²Œ ì§„í–‰ ì¤‘ì´ì—ìš”.",
        50: "ì ˆë°˜ì´ë‚˜ ì™”ì–´ìš”! ì •ë§ ëŒ€ë‹¨í•´ìš”. ì‹œì›í•œ ë¬¼ í•œ ì” ìŠì§€ ë§ˆì„¸ìš”! ğŸ’§",
        75: "75% ëŒíŒŒ! ê±°ì˜ ë‹¤ ì™”ìŠµë‹ˆë‹¤. ì¡°ê¸ˆë§Œ ë” í˜ë‚´ì„¸ìš”!",
        90: "90% ëŒíŒŒ! ëª©í‘œê°€ ë°”ë¡œ ëˆˆì•ì— ìˆì–´ìš”. í™”ì´íŒ…! ğŸ’§",
        110: "110% ì´ˆê³¼ ë‹¬ì„±! ëª¸ì´ ë³´ë‚´ëŠ” ì‹ í˜¸ì— ê·€ë¥¼ ê¸°ìš¸ì—¬ ì£¼ì„¸ìš”.",
        120: "120% ì´ˆê³¼ ë‹¬ì„±! ì •ë§ ëŒ€ë‹¨í•œ ì˜ì§€ì…ë‹ˆë‹¤!",
        150: "150% ì´ˆê³¼ ë‹¬ì„±! ìƒˆë¡œìš´ ê¸°ë¡ì„ ì“°ê³  ê³„ì‹œëŠ”êµ°ìš”!",
        200: "200% ë‹¬ì„±! ì»¨ë””ì…˜ ì¡°ì ˆì€ í•„ìˆ˜ì…ë‹ˆë‹¤. ì¶©ë¶„í•œ íœ´ì‹ì„ ìŠì§€ ë§ˆì„¸ìš”."
    };

    // ========================================
    // ===== 3) í•µì‹¬ íƒ€ì´ë¨¸ ë¡œì§
    // ========================================

    window.hydrateFastingTimer = function(saved) {
        const startMs = typeof saved.startAt === 'number' ? saved.startAt : Date.parse(saved.startAt);
        const endMs = typeof saved.endAt === 'number' ? saved.endAt : Date.parse(saved.endAt);
        __fastTotalMs = Math.max(0, endMs - startMs);
        __fastEndMs = endMs;
        clearInterval(__fastTimer);
        tickOnce();
        __fastTimer = setInterval(tickOnce, 1000);
    };

function tickOnce() {
        const now = Date.now();
        const diffMs = __fastEndMs - now; // ë‚¨ì€ ì‹œê°„ (ìŒìˆ˜ì¼ ìˆ˜ ìˆìŒ)
        const remainForProgress = Math.max(0, diffMs); // ì§„í–‰ë¥  ê³„ì‚°ìš© (0 ì´í•˜ë¡œ ì•ˆë‚´ë ¤ê°)
        const displayMs = Math.abs(diffMs); // í™”ë©´ í‘œì‹œìš© (í•­ìƒ ì–‘ìˆ˜)

        renderRemain(displayMs); // í™”ë©´ì—ëŠ” ì ˆëŒ€ê°’ìœ¼ë¡œ ë³€í™˜ëœ ì‹œê°„ì„ í‘œì‹œ

        if (__fastTotalMs > 0) {
            // ì§„í–‰ë¥ ì€ ê¸°ì¡´ ë¡œì§ëŒ€ë¡œ 100%ë¥¼ ë„˜ì§€ ì•Šë„ë¡ ê³„ì‚°
            const ratio = 1 - (remainForProgress / __fastTotalMs);
            const progressPercent = ratio * 100;
            renderProgress(ratio);
            checkMilestones(progressPercent);
        }
    }

    function renderRemain(ms) {
        const s = Math.floor(ms / 1000);
        const hh = String(Math.floor(s / 3600)).padStart(2, '0');
        const mm = String(Math.floor((s % 3600) / 60)).padStart(2, '0');
        const ss = String(s % 60).padStart(2, '0');
        if (remainingTimeEl) remainingTimeEl.textContent = `${hh}:${mm}:${ss}`;
    }

    function renderProgress(ratio) {
        if (!progressArc) return;
        const progress = Math.min(ratio * 100, 100);
        progressArc.style.strokeDasharray = `${progress} 100`;
        const timerLabel = document.querySelector('.timer-display .label');
        if (ratio < 1) {
            if (timerLabel) timerLabel.textContent = 'ë‚¨ì€ ì‹œê°„';
            progressArc.setAttribute('stroke', 'url(#progGrad)');
            if (statusMessage) statusMessage.innerHTML = `<span style="color: var(--primary-color); font-weight: 700;">${targetHours}ì‹œê°„</span> ë‹¨ì‹ ì§„í–‰ì¤‘...`;
        } else {
            if (timerLabel) timerLabel.textContent = 'ì´ˆê³¼ ì‹œê°„';
            progressArc.setAttribute('stroke', 'url(#overtimeGrad)');
            if (statusMessage) statusMessage.textContent = 'ëª©í‘œ ë‹¬ì„±! ëŒ€ë‹¨í•´ìš”!';
        }
    }

    // ========================================
    // ===== 4) ë§ˆì¼ìŠ¤í†¤ ë¡œì§
    // ========================================

    function resetMilestones() {
        completionFired = false;
        for (const key in milestones) {
            milestones[key] = false;
        }
    }

    function checkMilestones(progressPercent) {
        Object.keys(milestones).forEach(p => {
            const milestonePercent = parseInt(p, 10);
            if (progressPercent >= milestonePercent && !milestones[p]) {
                showToast(milestoneMessages[p]);
                milestones[p] = true;
            }
        });
        if (progressPercent >= 100 && !completionFired) {
            completionFired = true;
            if (completionOverlay) {
                completionOverlay.classList.add('show');
                setTimeout(() => completionOverlay.classList.remove('show'), 4000);
            }
        }
    }
    
    // ========================================
    // ===== 5) UI ë° í—¬í¼ ìœ í‹¸ë¦¬í‹°
    // ========================================
    
    function showToast(msg) {
        if (!toast) return;
        clearTimeout(toastTimeout);
        toast.textContent = msg;
        toast.classList.add('show');
        toastTimeout = setTimeout(() => toast.classList.remove('show'), 1800);
    }

    function setUserChip(name) {
        if (!userChip || !userChipName) return;
        userChipName.textContent = (name && String(name).trim()) || 'ì‚¬ìš©ì';
        userChip.style.display = 'flex';
    }

    function getSignedInUser() {
        return currentUser || auth?.currentUser || null;
    }
    
    function updateUIState() {
        const running = fastingState === 'running';
        if (startBtn) startBtn.disabled = running;
        if (stopBtn) stopBtn.disabled = !running;
    }

    function updateSelectOptions() {
        if (!modelSelect) return;
        const running = fastingState === 'running';
        modelSelect.classList.toggle('is-fasting', running);
        const options = modelSelect.options;
        for (let i = 0; i < options.length; i++) {
            const opt = options[i];
            if (!opt.dataset.originalText) opt.dataset.originalText = opt.textContent;
            if (running && opt.value == targetHours) {
                opt.textContent = `${opt.dataset.originalText} (ì§„í–‰ì¤‘)`;
                opt.classList.add('is-running');
            } else {
                opt.textContent = opt.dataset.originalText;
                opt.classList.remove('is-running');
            }
        }
    }
    
    function resetSelectOptions() {
        fastingState = 'idle';
        updateSelectOptions();
    }

function updateTimeDisplays() {
    const start = selectedStartTime;
    const duration = parseInt(targetHours, 10); // í•­ìƒ ìƒíƒœ ë³€ìˆ˜ì—ì„œ ì§ì ‘ ê°’ì„ ì½ë„ë¡ ìˆ˜ì •
    const end = new Date(start.getTime() + duration * 3600000);
    const fmt = (d) => `${d.getMonth() + 1}/${d.getDate()} ${d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true })}`;
    
    if (startTimeValue) startTimeValue.textContent = fmt(start);
    if (endTimeValue) endTimeValue.textContent = fmt(end);
}
    
    // ========================================
    // ===== 6) ë©”ì¸ ê¸°ëŠ¥ í•¨ìˆ˜
    // ========================================

    async function startFasting() {
        if (fastingState === 'running') return showToast('ì´ë¯¸ ë‹¨ì‹ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.');
        if (!getSignedInUser()) return showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        resetMilestones();
        fastingState = 'running';
        targetHours = parseFloat(modelSelect.value || targetHours);
        if (!timePickerUsed) {
            selectedStartTime = new Date();
        }
        const startMs = selectedStartTime.getTime();
        const endMs = startMs + (targetHours * 3600000);
        window.hydrateFastingTimer({ startAt: startMs, endAt: endMs });
        try {
            await db.collection('users').doc(currentUser.uid).set({
                currentFasting: { startTime: selectedStartTime, targetHours: targetHours }
            }, { merge: true });
            showToast(`${targetHours}ì‹œê°„ ë‹¨ì‹ì„ ì‹œì‘í•©ë‹ˆë‹¤!`);
            updateTimeDisplays();
            updateUIState();
            updateSelectOptions();
        } catch (err) {
            console.error('Firestore ì €ì¥ ì‹¤íŒ¨:', err);
            showToast('ë‹¨ì‹ ì‹œì‘ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            clearInterval(__fastTimer);
            fastingState = 'idle';
            updateUIState();
            resetSelectOptions();
        } finally {
            timePickerUsed = false;
        }
    }

    async function finalizeStopFasting(endDate) {
        if (fastingState === 'idle') return showToast('ì‹œì‘ëœ ë‹¨ì‹ì´ ì—†ìŠµë‹ˆë‹¤.');
        clearInterval(__fastTimer);
        fastingState = 'idle';
        const finalEndDate = endDate || new Date();
        const record = {
            startTime: selectedStartTime,
            endTime: finalEndDate,
            targetHours: parseFloat(targetHours),
            actualDurationHours: (finalEndDate - selectedStartTime) / 3600000,
            challengeId: activeChallengeId || null // â­ challengeId ì¶”ê°€
        };
        if (currentUser) {
            try {
                await db.collection('users').doc(currentUser.uid).collection('fastingHistory').add(record);
                await db.collection('users').doc(currentUser.uid).update({ currentFasting: firebase.firestore.FieldValue.delete() });
            } catch (e) {
                console.error('ë‹¨ì‹ ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨:', e);
                showToast('ê¸°ë¡ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }
        if (progressArc) progressArc.style.strokeDasharray = '0 100';
        if (remainingTimeEl) remainingTimeEl.textContent = '00:00:00';
        if (statusMessage) statusMessage.textContent = 'ë‹¨ì‹ ê³„íšì„ ì„ íƒí•˜ê³  ì‹œì‘í•˜ì„¸ìš”.';
        if (saltTip) saltTip.style.display = 'none';
        initializeTime();
        updateUIState();
        resetSelectOptions();
        showToast('ë‹¨ì‹ì„ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤. ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤!');
    }

   // ===== 6) ë©”ì¸ ê¸°ëŠ¥ í•¨ìˆ˜ ===== ì„¹ì…˜ì— ìˆëŠ”
// ê¸°ì¡´ applyDurationChange í•¨ìˆ˜ë¥¼ ì•„ë˜ ì½”ë“œë¡œ êµì²´í•˜ì„¸ìš”.

async function applyDurationChange(newHours) {
    if (!currentUser) {
        showToast('ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ì–´ ë³€ê²½ì‚¬í•­ì„ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        modelSelect.value = targetHours;
        return;
    }

    // 1. ìƒˆë¡œìš´ ëª©í‘œ ì‹œê°„ì„ ìˆ«ì í˜•íƒœë¡œ ëª…í™•íˆ ì„¤ì •
    targetHours = parseInt(newHours, 10);
    
    // 2. ê´€ë ¨ëœ ëª¨ë“  UIë¥¼ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
    updateTimeDisplays();
    updateSelectOptions();
    if (saltTip) {
    const hideTip = localStorage.getItem('hideSaltTip') === 'true';
    saltTip.style.display = (targetHours >= 48 && !hideTip) ? 'block' : 'none';
}

    // 3. ìƒˆë¡œìš´ ëª©í‘œ ì‹œê°„ìœ¼ë¡œ íƒ€ì´ë¨¸ë¥¼ ì¬ì‹œì‘
    const startMs = selectedStartTime.getTime();
    const endMs = startMs + (targetHours * 3600000);
    window.hydrateFastingTimer({ startAt: startMs, endAt: endMs });

    // 4. ë³€ê²½ëœ ë‚´ìš©ì„ DBì— ì €ì¥
    try {
        await db.collection('users').doc(currentUser.uid).set({
            currentFasting: {
                startTime: selectedStartTime,
                targetHours: targetHours
            }
        }, { merge: true });
        showToast('ë‹¨ì‹ ëª©í‘œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } catch (err) {
        console.error('Error updating target hours:', err);
        showToast('ëª©í‘œ ë³€ê²½ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}
    
    function initializeTime() {
        selectedStartTime = new Date();
        updateTimeDisplays();
    }
    
    // ========================================
    // ===== 7) íƒ€ì„í”¼ì»¤ ë¡œì§
    // ========================================

    function initializeTimePicker() {
        if (timePickerWired) return;
        timePickerWired = true;

        ensureTimepickerOptions();

        startTimeBox?.addEventListener('click', () => openTimePicker('start'));
        dayBeforeBtn?.addEventListener('click', () => {
            dayBeforeBtn.classList.add('active');
            todayBtn.classList.remove('active');
        });
        todayBtn?.addEventListener('click', () => {
            todayBtn.classList.add('active');
            dayBeforeBtn.classList.remove('active');
        });

        saveTimeBtn?.addEventListener('click', async () => {
            const h12 = parseInt(hourSelect?.value ?? '', 10);
            const mm = parseInt(minuteSelect?.value ?? '', 10);
            const ampm = ampmSelect?.value;
            if (isNaN(h12) || isNaN(mm) || !ampm) return showToast('ì‹œê°„ì„ ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.');
            
            let hour = h12 % 12;
            if (ampm === 'PM') hour += 12;
         // ...
if (!datePickerInput || !datePickerInput.value) {
    return showToast('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
}

// datePickerInputì—ì„œ ë…„, ì›”, ì¼ì„ ê°€ì ¸ì˜´
const [year, month, day] = datePickerInput.value.split('-').map(Number);

// ìƒˆë¡œìš´ Date ê°ì²´ë¥¼ ë§Œë“¤ê³  ì‹œê°„ ì„¤ì •
const picked = new Date();
picked.setFullYear(year, month - 1, day); // monthëŠ” 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ 1ì„ ë¹¼ì¤ë‹ˆë‹¤.
picked.setHours(hour, mm, 0, 0);
// ...
            timePickerModal.style.display = 'none';

            if (timePickerMode === 'start') {
                timePickerUsed = true;
                selectedStartTime = picked;
                updateTimeDisplays();

                if (fastingState === 'running') {
                    if (!currentUser) return showToast('ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    const startMs = selectedStartTime.getTime();
                    const endMs = startMs + (targetHours * 3600000);
                    window.hydrateFastingTimer({ startAt: startMs, endAt: endMs });
                    try {
                        await db.collection('users').doc(currentUser.uid).set({
                            currentFasting: { startTime: selectedStartTime, targetHours: targetHours }
                        }, { merge: true });
                        showToast('ì§„í–‰ ì¤‘ì¸ ë‹¨ì‹ì˜ ì‹œì‘ ì‹œê°„ì„ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.');
                    } catch (err) {
                        console.error('Error updating start time:', err);
                        showToast('ì‹œê°„ ë³€ê²½ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                }
            } else if (timePickerMode === 'end') {
                if (picked < selectedStartTime) return showToast('ì¢…ë£Œ ì‹œê°„ì€ ì‹œì‘ ì‹œê°„ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                finalizeStopFasting(picked);
            }
        });

        timePickerModal?.addEventListener('click', (e) => {
            if (e.target === timePickerModal) timePickerModal.style.display = 'none';
        });
    }

    function openTimePicker(mode) {
        if (!timePickerModal) return;
        timePickerMode = mode;
        timePickerModal.style.display = 'flex';
        const title = (mode === 'start') ? 'ì‹œì‘ ì‹œê°„ ì„ íƒ' : 'ì¢…ë£Œ ì‹œê°„ ì„ íƒ';
        if(timePickerTitle) timePickerTitle.textContent = title;

            // â–¼â–¼â–¼ ì´ ë¶€ë¶„ì„ ì¶”ê°€í•˜ì„¸ìš” â–¼â–¼â–¼
    if (datePickerInput) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        datePickerInput.value = `${year}-${month}-${day}`;
    }

        const base = (mode === 'start') ? (selectedStartTime || new Date()) : new Date();
        let h = base.getHours();
        const ampm = h >= 12 ? 'PM' : 'AM';
        h = h % 12;
        h = h ? h : 12;
        if (ampmSelect) ampmSelect.value = ampm;
        if (hourSelect) hourSelect.value = String(h);
        if (minuteSelect) minuteSelect.value = String(base.getMinutes());
        todayBtn?.classList.add('active');
        dayBeforeBtn?.classList.remove('active');
    }

    function ensureTimepickerOptions() {
        if (hourSelect && hourSelect.options.length === 0) {
            for (let i = 1; i <= 12; i++) {
                const o = document.createElement('option');
                o.value = String(i);
                o.textContent = String(i);
                hourSelect.appendChild(o);
            }
        }
        if (minuteSelect && minuteSelect.options.length === 0) {
            for (let i = 0; i < 60; i++) {
                const o = document.createElement('option');
                o.value = String(i);
                o.textContent = String(i).padStart(2, '0');
                minuteSelect.appendChild(o);
            }
        }
    }
    
    // ========================================
    // ===== 8) ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë° ì—°ê²°
    // ========================================

    function handleModelChange(e) {
        const newTarget = parseInt(e.target.value, 10);
        if (fastingState === 'running' && newTarget !== targetHours) {
            pendingTargetHours = newTarget;
            const msg = `ë‹¨ì‹ ëª©í‘œë¥¼ ${targetHours}ì‹œê°„ì—ì„œ ${newTarget}ì‹œê°„ìœ¼ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
            if (confirmChangeModal && confirmMessage) {
                confirmMessage.textContent = msg;
                confirmChangeModal.style.display = 'flex';
            } else {
                if (confirm(msg)) {
                    applyDurationChange(newTarget);
                } else {
                    modelSelect.value = targetHours;
                }
            }
        } else if (fastingState !== 'running') {
            targetHours = newTarget;
            updateTimeDisplays();
        }
    }

    function wireEventsOnce() {
        if (eventsWired) return;
        eventsWired = true;

        startBtn?.addEventListener('click', startFasting);
        stopBtn?.addEventListener('click', () => openTimePicker('end'));
        modelSelect?.addEventListener('change', handleModelChange);
        userChip?.addEventListener('click', () => { window.location.href = 'mypage.html'; });

        confirmYesBtn?.addEventListener('click', () => {
            if (pendingTargetHours !== null) {
                applyDurationChange(pendingTargetHours);
                pendingTargetHours = null;
            }
            if(confirmChangeModal) confirmChangeModal.style.display = 'none';
        });

    // ê³µí†µ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('click', (e) => {
      const closeId = e.target?.getAttribute?.('data-close');
      if (closeId) {
        const el = document.getElementById(closeId);
        if (el) el.style.display = 'none';
      }
    });

    hideTipCheckbox?.addEventListener('click', () => {
    if (hideTipCheckbox.checked) {
        // ì²´í¬ë°•ìŠ¤ê°€ ì„ íƒë˜ë©´, ë¸Œë¼ìš°ì € ì €ì¥ì†Œì— 'true' ê°’ì„ ì €ì¥í•©ë‹ˆë‹¤.
        localStorage.setItem('hideSaltTip', 'true');
        // ì¦‰ì‹œ íŒì„ ìˆ¨ê¹ë‹ˆë‹¤.
        if (saltTip) saltTip.style.display = 'none';
    } else {
        // ì²´í¬ë¥¼ í•´ì œí•˜ë©´, ì €ì¥ëœ ê°’ì„ ì œê±°í•©ë‹ˆë‹¤.
        localStorage.removeItem('hideSaltTip');
    }
});


    window.addEventListener('click', (e) => {
      [bloodSugarModal, ketoneModal, exerciseModal, weightModal]
        .filter(Boolean)
        .forEach(m => { if (e.target === m) m.style.display = 'none'; });
    });

    // ===== ê¸°ë¡: ì²´ì¤‘ =====
    weightBtn?.addEventListener('click', () => weightModal && (weightModal.style.display='flex'));
    saveWeightBtn?.addEventListener('click', async () => {
      const v = parseFloat(weightInput?.value);
      if (!v || v <= 0) return showToast('ì˜¬ë°”ë¥¸ ì²´ì¤‘ì„ ì…ë ¥í•˜ì„¸ìš”.');
      const user = getSignedInUser(); if (!user) return showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
      try {
    const weightData = {
        date: new Date(),
        value: v,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        challengeId: activeChallengeId || null
    };

    await db.collection('users').doc(user.uid)
        .collection('measurements').doc('weight')
        .collection('items').add(weightData);

    // ìë™ ëŒ“ê¸€ ìƒì„± (postAutoComment í•¨ìˆ˜ê°€ ì•Œì•„ì„œ ì´ì „ ê¸°ë¡ê³¼ ë¹„êµí•´ì¤ë‹ˆë‹¤)
    postAutoComment('weight', { value: v });

} catch (e) {
    console.error('save weight failed:', e);
    showToast('ì„œë²„ ì €ì¥ ì‹¤íŒ¨(ì²´ì¤‘)â€¦ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
}
      weightInput.value = '';
      weightModal.style.display = 'none';
      showToast('ì²´ì¤‘ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    });

    // ===== ê¸°ë¡: í˜ˆë‹¹ =====
    bloodSugarBtn?.addEventListener('click', () => {
      if (!bloodSugarModal) return;
      bloodSugarModal.style.display = 'flex';
      const t = document.getElementById('bloodSugarTimestampInput');
      if (t) {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        t.value = now.toISOString().slice(0, 16);
      }
    });

    saveBloodSugarBtn?.addEventListener('click', async () => {
      const v = parseFloat(bloodSugarInput?.value);
      if (!v || v <= 0) return showToast('ì˜¬ë°”ë¥¸ í˜ˆë‹¹ ìˆ˜ì¹˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
      const t = document.getElementById('bloodSugarTimestampInput');
      if (!t?.value) return showToast('ì¸¡ì • ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      const recordDate = new Date(t.value);
      const user = getSignedInUser(); if (!user) return showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
      saveLocalList('bloodSugarData', { date: recordDate.toISOString(), value: v });
      try {
    const bloodSugarData = {
        date: recordDate,
        value: v,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        challengeId: activeChallengeId || null
    };
    
    await db.collection('users').doc(user.uid)
        .collection('measurements').doc('bloodSugar')
        .collection('items').add(bloodSugarData);

    // ìë™ ëŒ“ê¸€ ìƒì„±
    postAutoComment('bloodSugar', { value: v });

} catch (e) {
    console.error('save blood sugar failed:', e);
    showToast('ì„œë²„ ì €ì¥ ì‹¤íŒ¨(í˜ˆë‹¹)â€¦ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
}
      bloodSugarInput.value = '';
      bloodSugarModal.style.display = 'none';
      showToast('í˜ˆë‹¹ ìˆ˜ì¹˜ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    });

    // ===== ê¸°ë¡: ì¼€í†¤ =====
    ketoneBtn?.addEventListener('click', () => ketoneModal && (ketoneModal.style.display='flex'));
    saveKetoneBtn?.addEventListener('click', async () => {
      const v = parseFloat(ketoneInput?.value);
      if (v == null || isNaN(v) || v < 0) return showToast('ì˜¬ë°”ë¥¸ ì¼€í†¤ ìˆ˜ì¹˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
      const user = getSignedInUser(); if (!user) return showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
      saveLocalList('ketoneData', { date: new Date().toISOString(), value: v });
      try {
    const ketoneData = {
        date: new Date(),
        value: v,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        challengeId: activeChallengeId || null
    };

    await db.collection('users').doc(user.uid)
        .collection('measurements').doc('ketone')
        .collection('items').add(ketoneData);

    // ìë™ ëŒ“ê¸€ ìƒì„±
    postAutoComment('ketone', { value: v });

} catch (e) {
    console.error('save ketone failed:', e);
    showToast('ì„œë²„ ì €ì¥ ì‹¤íŒ¨(ì¼€í†¤)â€¦ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
}
      ketoneInput.value = '';
      ketoneModal.style.display = 'none';
      showToast('ì¼€í†¤ ìˆ˜ì¹˜ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    });

    // ===== ê¸°ë¡: ìš´ë™ =====
    exerciseBtn?.addEventListener('click', () => exerciseModal && (exerciseModal.style.display='flex'));
    exerciseTypeWrap?.addEventListener('click', (e) => {
      if (!e.target.classList.contains('tag')) return;
      const prev = exerciseTypeWrap.querySelector('.tag.active');
      if (prev) prev.classList.remove('active');
      e.target.classList.add('active');
    });
    saveExerciseBtn?.addEventListener('click', async () => {
      const sel = exerciseTypeWrap?.querySelector('.tag.active');
      const duration = parseInt(exerciseDuration?.value,10);
      const calories = exerciseCalories?.value === '' ? null : parseInt(exerciseCalories.value,10);
      if (!sel) return showToast('ìš´ë™ ì¢…ë¥˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
      if (!duration || duration<=0) return showToast('ì˜¬ë°”ë¥¸ ìš´ë™ ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš”.');
      if (calories !== null && calories < 0) return showToast('ì¹¼ë¡œë¦¬ëŠ” 0 ì´ìƒìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”.');
      const user = getSignedInUser(); if (!user) return showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
      const rec = { date:new Date().toISOString(), type: sel.dataset.value, duration, calories };
      saveLocalList('exerciseData', rec);
     try {
    // 1. ì €ì¥í•  'ìš´ë™ ë°ì´í„°'ë¥¼ ì˜¬ë°”ë¥´ê²Œ ë§Œë“­ë‹ˆë‹¤.
    const exerciseData = {
        date: new Date(),
        type: sel.dataset.value, // sel (ì„ íƒëœ íƒœê·¸)ì—ì„œ ìš´ë™ ì¢…ë¥˜ ê°€ì ¸ì˜¤ê¸°
        duration: duration,      // duration ë³€ìˆ˜ ì‚¬ìš©
        calories: calories ?? 0, // calories ë³€ìˆ˜ ì‚¬ìš©
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        challengeId: activeChallengeId || null
    };

    // 2. ì˜¬ë°”ë¥¸ 'ìš´ë™ ë°ì´í„°'ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
    await db.collection('users').doc(user.uid)
        .collection('measurements').doc('exercise')
        .collection('items').add(exerciseData);

    // 3. 'ìš´ë™ ë°ì´í„°'ë¡œ ìë™ ëŒ“ê¸€ì„ ìƒì„±í•©ë‹ˆë‹¤.
    postAutoComment('exercise', { type: exerciseData.type, duration: exerciseData.duration });

      } catch (e) {
        console.error('save exercise failed:', e);
        showToast('ì„œë²„ ì €ì¥ ì‹¤íŒ¨(ìš´ë™)â€¦ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }
      sel.classList.remove('active');
      exerciseDuration.value = '';
      exerciseCalories.value = '';
      exerciseModal.style.display = 'none';
      showToast('ìš´ë™ ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    });

    privacyPolicyLink?.addEventListener('click', (e) => {
      e.preventDefault();
      showToast('ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤. (ê°œë°œ ì¤‘)');
    });
  }


    // â–¼â–¼â–¼ ì´ì „ì— ìƒëµë˜ì—ˆë˜ ê¸°ë¡ ëª¨ë‹¬ ê´€ë ¨ ì½”ë“œ â–¼â–¼â–¼

    // --- ê³µí†µ ëª¨ë‹¬ ë‹«ê¸° ë¡œì§ ---
    document.addEventListener('click', (e) => {
        const closeId = e.target?.getAttribute?.('data-close');
        if (closeId) {
            const el = document.getElementById(closeId);
            if (el) el.style.display = 'none';
        }
    });

    window.addEventListener('click', (e) => {
        [bloodSugarModal, ketoneModal, exerciseModal, weightModal]
            .filter(Boolean)
            .forEach(m => { if (e.target === m) m.style.display = 'none'; });
    });
     
  
  // ===== 8) ê¸°íƒ€ í—¬í¼ =====
  function saveLocalList(key, data) {
    const arr = JSON.parse(localStorage.getItem(key) || '[]');
    arr.unshift(data);
    localStorage.setItem(key, JSON.stringify(arr));
  }


  /**
 * ì±Œë¦°ì§€ì— ìë™ ëŒ“ê¸€ì„ í¬ìŠ¤íŠ¸í•˜ëŠ” í•¨ìˆ˜
 * @param {string} type - 'weight', 'exercise', 'bloodSugar', 'ketone' ë“± ê¸°ë¡ì˜ ì¢…ë¥˜
 * @param {object} data - ëŒ“ê¸€ ë‚´ìš© ìƒì„±ì— í•„ìš”í•œ ë°ì´í„°
 */
async function postAutoComment(type, data) {
    if (!activeChallengeId || !currentUser) return; //

    let commentText = ''; //
    const currentNickname = userChipName.textContent || currentUser.displayName || 'ì‚¬ìš©ì'; // ì¹© ì´ë¦„ ìš°ì„  ì‚¬ìš©

    switch (type) { //
        case 'weight':
            const weightRef = db.collection('users').doc(currentUser.uid)
                .collection('measurements').doc('weight').collection('items')
                .orderBy('date', 'desc').limit(2);
            
            const weightSnap = await weightRef.get();
            if (weightSnap.docs.length > 1) {
                const latest = weightSnap.docs[0].data().value;
                const previous = weightSnap.docs[1].data().value;
                const diff = Math.abs(latest - previous).toFixed(1);

                if (latest < previous) {
                    commentText = `${currentNickname}ë‹˜ì´ ${diff}kg ê°ëŸ‰ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤! ğŸ‰`;
                } else if (latest > previous) {
                    commentText = `${currentNickname}ë‹˜ì´ ${diff}kg ì¦ëŸ‰í–ˆìŠµë‹ˆë‹¤.`;
                }
            } else {
                commentText = `${currentNickname}ë‹˜ì´ ì²« ì²´ì¤‘(${data.value}kg)ì„ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤!`;
            }
            break;

        case 'exercise':
            commentText = `${currentNickname}ë‹˜ì´ '${data.type}' ${data.duration}ë¶„ ê¸°ë¡ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.`;
            break;

        case 'bloodSugar':
            commentText = `${currentNickname}ë‹˜ì´ í˜ˆë‹¹ ${data.value} (mg/dL)ì„ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤.`;
            break;
        
        case 'ketone':
             commentText = `${currentNickname}ë‹˜ì´ ì¼€í†¤ ${data.value} (mmol/L)ì„ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤.`;
            break;
    }

    if (commentText) { //
        try {
            await db.collection('challenges').doc(activeChallengeId).collection('comments').add({
                uid: currentUser.uid,
                nickname: currentNickname,
                photoURL: currentUser.photoURL || null, // ì•„ë°”íƒ€ í‘œì‹œë¥¼ ìœ„í•´ ì¶”ê°€
                text: commentText,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                isAutoComment: true, //
                parentId: null       //
            });
            console.log("ì±Œë¦°ì§€ íƒ€ì„ë¼ì¸ ì „ì†¡ ì„±ê³µ!");
        } catch (error) {
            console.error("ìë™ ëŒ“ê¸€ ìƒì„± ì‹¤íŒ¨:", error);
        }
    }
}

// 3. ì¸ì¦ ë¦¬ìŠ¤ë„ˆ ë‚´ì—ì„œ ì±Œë¦°ì§€ ID ê°€ì ¸ì˜¤ê¸°
auth.onAuthStateChanged(async (user) => {
    if (user) {
        currentUser = user;
        
        // ì‚¬ìš©ìê°€ ì°¸ì—¬ ì¤‘ì¸ í™œì„±í™”ëœ ì±Œë¦°ì§€ 1ê°œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        try {
            const snap = await db.collection('challenges')
                .where('participantUids', 'array-contains', user.uid)
                .limit(1)
                .get();
            
            if (!snap.empty) {
                activeChallengeId = snap.docs[0].id; // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
            }
        } catch (e) {
            console.error("ì±Œë¦°ì§€ ID ë¡œë“œ ì‹¤íŒ¨:", e);
        }
    }
});

   // ========================================
    // ===== 9) ì•± ì´ˆê¸°í™” ë° ì¸ì¦ ë¦¬ìŠ¤ë„ˆ
    // ========================================

    if (!window.__PAGE_AUTH_WIRED__) {
        window.__PAGE_AUTH_WIRED__ = true;

        if (!auth) {
            initializeTime();
            updateUIState();
            resetSelectOptions();
        } else {
            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    currentUser = null;
                    fastingState = 'idle';
                    clearInterval(__fastTimer);
                    initializeTime();
                    updateUIState();
                    resetSelectOptions();
                    if (userChip) userChip.style.display = 'none';
                    if (progressArc) progressArc.style.strokeDasharray = '0 100';
                    if (remainingTimeEl) remainingTimeEl.textContent = '00:00:00';
                    return;
                }

                currentUser = user;
try {
    const profile = await getUserDoc(user.uid);
    
    // ========================================
    // [ì¶”ê°€] ì˜¨ë³´ë”© ë¯¸ì™„ë£Œ ì‹œ signupìœ¼ë¡œ ë¦¬ë””ë ‰ì…˜
    // ========================================
    const completed = !!profile?.onboarding?.completed;
    const hasNickname = !!profile?.nickname;
    const hasGoals = Array.isArray(profile?.onboarding?.reasons) && profile.onboarding.reasons.length > 0;

    if (!completed || !hasNickname || !hasGoals) {
        // ë¬´í•œ ë£¨í”„ ë°©ì§€ìš© ë½
        if (sessionStorage.getItem('onboardingLock') !== '1') {
            sessionStorage.setItem('onboardingLock', '1');
            window.location.href = './signup.html?step=2&from=fastmate';
            return;
        }
    } else {
        // ì˜¨ë³´ë”© ì™„ë£Œë¨ â†’ ë½ í•´ì œ
        sessionStorage.removeItem('onboardingLock');
    }
    // ========================================

    const nickname = profile?.nickname || user.displayName || 'ì‚¬ìš©ì';
    setUserChip(nickname);

/* 
challengesRef = db.collection('challenges');
    const query = challengesRef
        .where('participantUids', 'array-contains', user.uid)
        .where('status', '==', 'active');
    
    const challengeSnap = await query.get();
    if (!challengeSnap.empty) {
        // ì§„í–‰ì¤‘ì¸ ì±Œë¦°ì§€ê°€ ìˆë‹¤ë©´, ì²« ë²ˆì§¸ ì±Œë¦°ì§€ IDë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
        const challengeDoc = challengeSnap.docs[0];
        activeChallengeId = challengeDoc.id;
        console.log("Active challenge found:", activeChallengeId);
    } else {
        activeChallengeId = null;
    }  
        */


                    const savedFasting = profile?.currentFasting;
                    if (savedFasting?.startTime && savedFasting.targetHours) {
                        fastingState = 'running';
                        selectedStartTime = savedFasting.startTime.toDate();
                        targetHours = Number(savedFasting.targetHours) || 16;
                        if (modelSelect) modelSelect.value = String(targetHours);
                        
                        const startMs = selectedStartTime.getTime();
                        const endMs = startMs + (targetHours * 3600000);
                        window.hydrateFastingTimer({ startAt: startMs, endAt: endMs });
                        
                        updateTimeDisplays();
                        updateSelectOptions();
                    } else {
                        fastingState = 'idle';
                        initializeTime();
                        updateTimeDisplays();
                        resetSelectOptions();
                    }

                    updateUIState();
                    if (saltTip) {
    const hideTip = localStorage.getItem('hideSaltTip') === 'true';
    saltTip.style.display = (fastingState === 'running' && targetHours >= 48 && !hideTip) ? 'block' : 'none';
}

                    const splashScreen = document.getElementById('splash-screen');
                    if (splashScreen) splashScreen.style.display = 'none';
                    
                    initializeTimePicker();
                    wireEventsOnce();

                } catch (e) {
                    console.error('ì•± ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜:', e);
                    alert('ì•± ì´ˆê¸°í™” ì‹¤íŒ¨. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.');
                }
            });
        }
    }
});
</script>