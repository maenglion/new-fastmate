<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Fastmate - 회원가입</title>

  <!-- PWA -->
  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="manifest" href="/manifest.json">

  <!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script defer src="/firebase-init.js?v=2025.09.06-v8"></script>


  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');

    :root{
      color-scheme: light;
      --bg-color:#f0f2f5;
      --card-bg:#fff;
      --text-color:#333;
      --text-light:#777;
      --border-color:#e0e0e0;
      --primary-color:#1c8e3e;
      --primary-hover:#156a2f;
    }

    body{
      font-family:'Noto Sans KR',sans-serif;
      background:var(--bg-color);
      margin:0;
      padding:20px;
      min-height:100vh;
      box-sizing:border-box;
      display:flex;justify-content:center;align-items:center;
    }

    .container{
      width:100%;max-width:500px;
      background:var(--card-bg);
      border-radius:16px;
      box-shadow:0 8px 30px rgba(0,0,0,.1);
      padding:30px 40px;
      box-sizing:border-box;
    }

    .progress-bar{width:100%;height:8px;background:var(--border-color);border-radius:4px;margin-bottom:20px;overflow:hidden}
    .progress{width:25%;height:100%;background:var(--primary-color);border-radius:4px;transition:width .3s ease-in-out}

    .signup-step{display:none}
    .signup-step.active{display:block}

    h2{margin:0 0 10px;text-align:center;color:var(--text-color);font-weight:700}
    .step-description{text-align:center;color:var(--text-light);margin-bottom:30px}

    .input-group{margin-bottom:20px}
    .input-group input{
      width:100%;padding:12px 15px;border:1px solid var(--border-color);
      border-radius:8px;font-size:1rem;box-sizing:border-box;
    }

    .button-group{display:flex;gap:10px;margin-top:30px}
    .button-group .btn{flex:1}
    .btn{width:100%;padding:15px;border:none;border-radius:8px;font-size:1.1rem;font-weight:700;cursor:pointer;transition:background-color .2s}
    .btn-primary{background:var(--primary-color);color:#fff}
    .btn-primary:hover{background:var(--primary-hover)}
    .btn-secondary{background:#f8f9fa;color:var(--text-color);border:1px solid var(--border-color)}

    .tag-cloud{display:flex;flex-wrap:wrap;justify-content:center;gap:12px}
    .tag{background:#f8f9fa;border:1px solid var(--border-color);border-radius:20px;padding:10px 20px;font-size:1rem;font-weight:500;color:#495057;cursor:pointer;transition:all .2s}
    .tag.active{background:var(--primary-color);color:#fff;border-color:var(--primary-color)}

    .terms-container{margin-top:20px;text-align:left}
    .term-item{display:flex;align-items:center;margin-bottom:15px}
    .term-item input[type="checkbox"]{margin-right:10px}
    .term-item label{flex-grow:1}
    .term-item a{color:var(--primary-color);text-decoration:none;font-size:.9rem}
    .term-item a:hover{text-decoration:underline}

    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background:rgba(0,0,0,.5);justify-content:center;align-items:center}
    .modal-content{background:#fff;margin:auto;padding:25px;border:1px solid #888;width:90%;max-width:500px;border-radius:16px;box-shadow:0 5px 15px rgba(0,0,0,.3)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border-color);padding-bottom:10px;margin-bottom:20px}
    .modal-header h3{margin:0}
    .close-btn{font-size:1.5rem;border:none;background:none;cursor:pointer}
    .modal-body{text-align:left;max-height:60vh;overflow-y:auto;font-size:.9rem;line-height:1.6}
    .modal-body h4{margin:20px 0 10px}
    .modal-body p,.modal-body li{margin-bottom:10px}
    .modal-body ul{padding-left:20px}
  </style>
</head>
<body>
  <div class="container">
    <div class="progress-bar"><div class="progress" id="progressBar"></div></div>

    <!-- step 1 -->
    <div id="step1" class="signup-step active">
      <h2>회원가입</h2>
      <p class="step-description">fastmate에서 사용할 계정 정보를 입력해주세요.</p>
      <div class="input-group"><input type="email" id="email" placeholder="이메일 주소"></div>
      <div class="input-group"><input type="password" id="password" placeholder="비밀번호 (6자 이상)"></div>
      <div class="input-group"><input type="password" id="confirmPassword" placeholder="비밀번호 확인"></div>
      <div class="button-group">
        <button class="btn btn-secondary" id="googleSignupBtn">Google로 간편가입</button>
        <button class="btn btn-primary" id="nextToStep2">다음</button>
      </div>
    </div>

    <!-- step 2 -->
    <div id="step2" class="signup-step">
      <h2>닉네임 설정</h2>
      <p class="step-description">단식 목표를 이룰 멋진 닉네임을 설정해 주세요!</p>
      <div class="input-group"><input type="text" id="nickname" placeholder="닉네임"></div>
      <div class="button-group">
        <button class="btn btn-secondary" id="backToStep1">이전</button>
        <button class="btn btn-primary" id="nextToStep3">다음</button>
      </div>
    </div>

    <!-- step 3 -->
    <div id="step3" class="signup-step">
      <h2>목표 설정</h2>
      <p class="step-description">단식을 통해 이루고 싶은 목표를 모두 선택해주세요.</p>
      <div class="tag-cloud" id="tagCloud">
        <button type="button" class="tag" data-value="체중관리">체중관리</button>
        <button type="button" class="tag" data-value="혈당 관리">혈당관리</button>
        <button type="button" class="tag" data-value="자가포식(오토파지)">자가포식(오토파지)</button>
        <button type="button" class="tag" data-value="위장휴식·소화개선">위장휴식·소화개선</button>
        <button type="button" class="tag" data-value="에너지·집중력 개선">에너지·집중력 개선</button>
        <button type="button" class="tag" data-value="기타">기타</button>
      </div>
      <div class="button-group">
        <button class="btn btn-secondary" id="backToStep2">이전</button>
        <button class="btn btn-primary" id="nextToStep4">다음</button>
      </div>
    </div>

    <!-- step 4 -->
    <div id="step4" class="signup-step">
      <h2>약관 동의</h2>
      <p class="step-description">서비스 이용을 위해 약관에 동의해주세요.</p>

      <div class="terms-container">
        <div class="term-item">
          <input type="checkbox" id="termsOfService">
          <label for="termsOfService">서비스 이용약관 동의 (필수)</label>
          <a href="#" data-modal="termsModal">내용 보기</a>
        </div>
        <div class="term-item">
          <input type="checkbox" id="privacyPolicy">
          <label for="privacyPolicy">개인정보처리방침 동의 (필수)</label>
          <a href="#" data-modal="privacyModal">내용 보기</a>
        </div>
        <div class="term-item">
          <input type="checkbox" id="sensitiveData">
          <label for="sensitiveData">건강 정보 수집 및 이용 동의 (필수)</label>
        </div>
        <p style="font-size:.85rem;color:#777;margin-left:28px;margin-top:-10px;line-height:1.5">
          서비스 제공을 위해 단식 기록, 체중, 혈당, 케톤, 운동 기록 등의 건강 정보가 수집됩니다.
        </p>
      </div>

      <div class="button-group">
        <button class="btn btn-secondary" id="backToStep3">이전</button>
        <button class="btn btn-primary" id="finishSignup">가입 완료</button>
      </div>
    </div>
  </div>

  <!-- 약관 모달들 -->
  <div id="termsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>서비스 이용약관</h3>
        <button class="close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <h4>제1조 (목적)</h4>
        <p>이 약관은 2e-studio(이하 "회사")가 제공하는 fastmate 애플리케이션(이하 "서비스")의 이용과 관련하여 회사와 회원 간의 권리, 의무 및 책임사항, 기타 필요한 사항을 규정함을 목적으로 합니다.</p>
        <h4>제2조 (용어의 정의)</h4>
        <ul>
          <li>"서비스"라 함은 회사가 제공하는 단식 추적, 건강 데이터(체중, 혈당, 케톤, 운동) 기록 등 제반 서비스를 의미합니다.</li>
          <li>"회원"이라 함은 서비스에 접속하여 이 약관에 따라 회사와 이용계약을 체결하고 회사가 제공하는 서비스를 이용하는 고객을 말합니다.</li>
        </ul>
        <h4>제3조 (서비스의 내용 및 변경)</h4>
        <p>회사는 서비스의 내용, 운영상 또는 기술상의 필요에 따라 제공하고 있는 서비스의 전부 또는 일부를 변경할 수 있습니다. 서비스의 내용이 변경되는 경우, 회사는 회원에게 공지합니다.</p>
        <h4>제4조 (면책조항)</h4>
        <ol>
          <li>본 서비스에서 제공하는 모든 정보와 기능은 건강 관리의 보조 수단이며, 전문적인 의학적 진단이나 처방을 대체할 수 없습니다.</li>
          <li>회사는 회원의 건강 상태나 질병에 대한 어떠한 책임도 지지 않으며, 모든 의학적 결정은 반드시 전문 의료인과 상담하여야 합니다.</li>
          <li>회사는 회원이 서비스를 이용하여 기대하는 수익을 상실한 것이나 서비스를 통하여 얻은 자료로 인한 손해에 관하여 책임을 지지 않습니다.</li>
        </ol>
        <h4>제5조 (준거법 및 재판관할)</h4>
        <p>회사와 회원 간 제기된 소송은 대한민국법을 준거법으로 합니다. 회사와 회원간 발생한 분쟁에 관한 소송은 민사소송법 상의 관할법원에 제소합니다.</p>
        <p><strong>시행일자: 2025년 8월 16일</strong></p>
      </div>
    </div>
  </div>

  <div id="privacyModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>개인정보처리방침</h3>
        <button class="close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <p>2e-studio(이하 '회사')는 「개인정보 보호법」에 따라 정보주체의 개인정보를 보호하고 이와 관련한 고충을 신속하고 원활하게 처리할 수 있도록 하기 위하여 다음과 같이 개인정보 처리방침을 수립·공개합니다.</p>
        <h4>제1조 (개인정보의 수집 항목 및 처리 목적)</h4>
        <p>회사는 다음의 목적을 위하여 개인정보를 처리합니다. 처리하고 있는 개인정보는 다음의 목적 이외의 용도로는 이용되지 않으며, 이용 목적이 변경되는 경우에는 별도의 동의를 받는 등 필요한 조치를 이행할 예정입니다.</p>
        <ul>
          <li><strong>회원가입 및 관리:</strong> 이메일 주소, 비밀번호, 닉네임, 단식 목표</li>
          <li><strong>서비스 제공:</strong> 단식 기록(시작/종료 시간), 체중, 혈당, 케톤, 운동 기록(종류, 시간, 칼로리) 등 회원이 직접 입력하는 민감 건강 정보</li>
        </ul>
        <h4>제2조 (개인정보의 처리 및 보유 기간)</h4>
        <p>원칙적으로, 개인정보 수집 및 이용목적이 달성된 후에는 해당 정보를 지체 없이 파기합니다. (단, 회원 탈퇴 시까지 보유)</p>
        <h4>제3조 (개인정보의 제3자 제공)</h4>
        <p>회사는 원칙적으로 외부에 제공하지 않습니다. 다만 아래의 경우 예외로 합니다.</p>
        <ul>
          <li>정보주체의 별도 동의가 있는 경우</li>
          <li>법률에 특별한 규정이 있거나 법령상 의무를 준수하기 위해 불가피한 경우</li>
        </ul>
        <h4>제4조 (개인정보 보호책임자)</h4>
        <ul>
          <li><strong>성명:</strong> 맹난영</li>
          <li><strong>이메일:</strong> maengnanyoung@gmail.com</li>
        </ul>
        <h4>제5조 (개인정보 처리방침 변경)</h4>
        <p>이 개인정보처리방침은 시행일로부터 적용됩니다.</p>
        <p><strong>시행일자: 2025년 8월 16일</strong></p>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      /* ===== DOM 캐시 ===== */
      const steps = document.querySelectorAll('.signup-step');
      const progressBar = document.getElementById('progressBar');

      const googleBtn = document.getElementById('googleSignupBtn');

      const emailInput = document.getElementById('email');
      const passwordInput = document.getElementById('password');
      const confirmPwInput = document.getElementById('confirmPassword');

      const nicknameInput = document.getElementById('nickname');
      const tagCloud = document.getElementById('tagCloud');

      const nextToStep2Btn = document.getElementById('nextToStep2');
      const backToStep1Btn = document.getElementById('backToStep1');
      const nextToStep3Btn = document.getElementById('nextToStep3');
      const backToStep2Btn = document.getElementById('backToStep2');
      const nextToStep4Btn = document.getElementById('nextToStep4');
      const backToStep3Btn = document.getElementById('backToStep3');
      const finishSignupBtn = document.getElementById('finishSignup');

      const termsCheckbox = document.getElementById('termsOfService');
      const privacyCheckbox = document.getElementById('privacyPolicy');
      const sensitiveDataCheckbox = document.getElementById('sensitiveData');

      /* ===== 공용 헬퍼(초기화는 firebase-init.js에서) ===== */
      const auth = firebase.auth();

      /* ===== 네비게이션 ===== */
      function navigateTo(step){
        steps.forEach(s => s.classList.remove('active'));
        const target = document.getElementById(`step${step}`);
        if (target) target.classList.add('active');
        if (progressBar) progressBar.style.width = `${(step / steps.length) * 100}%`;

        const url = new URL(location.href);
        if (url.searchParams.get('step') !== String(step)) {
          url.searchParams.set('step', step);
          history.replaceState(null, '', url.toString());
        }
      }

      /* ===== 태그 토글 ===== */
      tagCloud?.addEventListener('click', (e) => {
        if (e.target.classList.contains('tag')) e.target.classList.toggle('active');
      });

      function collectGoals(){
        return Array.from(document.querySelectorAll('#tagCloud .tag.active'))
          .map(t => t.dataset.value || t.textContent.trim());
      }

      /* ===== 에러 한국어 매핑 ===== */
      function alertKoreanAuthError(err, fallback='문제가 발생했습니다.'){
        const code = err?.code || '';
        if (code === 'auth/email-already-in-use') return alert('이미 가입된 이메일입니다. 로그인 해주세요.');
        if (code === 'auth/invalid-email') return alert('이메일 형식이 올바르지 않습니다.');
        if (code === 'auth/weak-password') return alert('비밀번호는 최소 6자 이상이어야 합니다.');
        if (code === 'auth/operation-not-allowed') return alert('이메일/비밀번호 가입이 비활성화되어 있음. Firebase 콘솔에서 Email/Password 제공자를 켜주세요.');
        if (code === 'auth/popup-blocked' || code === 'auth/popup-closed-by-user') return alert('팝업이 차단되었습니다. 팝업 허용 후 다시 시도해주세요.');
        alert(fallback);
      }

      /* ===== 구글 간편가입(한 번만 바인딩) ===== */
      googleBtn?.addEventListener('click', async () => {
        if (googleBtn.disabled) return;
        googleBtn.disabled = true;
        try {
          await signInWithGoogle(); // firebase-init.js 제공
        } catch (e) {
          if (e.code !== 'auth/popup-closed-by-user' && e.code !== 'auth/cancelled-popup-request') {
            alertKoreanAuthError(e, 'Google 로그인에 실패했습니다.');
          }
        } finally {
          googleBtn.disabled = false;
        }
      });

      /* ===== 단계 이동 버튼 ===== */
      nextToStep2Btn?.addEventListener('click', () => {
        if (auth.currentUser) return navigateTo(2);
        const email = emailInput?.value.trim();
        const pw = passwordInput?.value || '';
        const cpw = confirmPwInput?.value || '';
        if (!email || pw.length < 6 || pw !== cpw) {
          return alert('이메일/비밀번호(6자 이상) 및 비밀번호 확인을 점검해주세요.');
        }
        navigateTo(2);
      });
      backToStep1Btn?.addEventListener('click', () => navigateTo(1));

      nextToStep3Btn?.addEventListener('click', () => {
        if (!nicknameInput?.value.trim()) return alert('닉네임을 입력해주세요.');
        navigateTo(3);
      });
      backToStep2Btn?.addEventListener('click', () => navigateTo(2));

      nextToStep4Btn?.addEventListener('click', () => {
        if (!collectGoals().length) return alert('하나 이상의 목표를 선택해주세요.');
        navigateTo(4);
      });
      backToStep3Btn?.addEventListener('click', () => navigateTo(3));

      /* ===== 최종 가입 ===== */
      async function onFinishSignup(){
        if (finishSignupBtn.disabled) return;
        finishSignupBtn.disabled = true;
        try{
          // 필수 약관
          const agreedAll = [termsCheckbox, privacyCheckbox, sensitiveDataCheckbox].every(el => el && el.checked === true);
          if (!agreedAll) { alert('필수 약관에 모두 동의해주세요.'); return; }

          // 닉네임/목표
          const nickname = (nicknameInput?.value || '').trim();
          const goals = collectGoals();
          if (!nickname) { alert('닉네임을 입력해주세요.'); return; }
          if (!goals.length) { alert('하나 이상의 목표를 선택해주세요.'); return; }

          // 이메일 가입이면 계정 생성
          let user = auth.currentUser;
          if (!user){
            const email = (emailInput?.value || '').trim();
            const password = passwordInput?.value || '';
            if (!email || password.length < 6) { alert('이메일/비밀번호(6자 이상)를 다시 확인해주세요.'); return; }
            const cred = await auth.createUserWithEmailAndPassword(email, password);
            user = cred.user;
          }

          // 프로필 저장 (firebase-init.js의 ensureUserProfile 사용)
          await ensureUserProfile({ nickname, onboarding: { reasons: goals, completed: true } });

          alert('회원가입이 완료되었습니다!');
          location.href = './fastmate.html';
        }catch(e){
          console.error('[finishSignup]', e?.code, e?.message, e);
          alertKoreanAuthError(e, '회원가입에 실패했습니다.');
        }finally{
          finishSignupBtn.disabled = false;
        }
      }
      finishSignupBtn?.addEventListener('click', onFinishSignup);

      /* ===== 리다이렉트 에러 관찰(구글) ===== */
  auth.getRedirectResult()
  .then((res) => {
    if (!res || !res.user) return;
    const isNew = res.additionalUserInfo?.isNewUser === true;

    if (!isNew) {
      // 기존 가입자: 회원가입 1단계에 남겨두지 말고 바로 로그인 플로우로
      alert('이미 가입된 계정임. 로그인으로 이동함');
      location.replace('./fastmate.html'); // 필요시 로그인 페이지로 바꿔도 됨
      return;
    }

    // 신규 가입자라도 1단계에 머물 필요 없음 → 2단계부터
    const url = new URL(location.href);
    url.searchParams.set('step', '2');
    history.replaceState(null, '', url.toString());
  })
  .catch(e => {
    console.warn('[redirectError]', e?.code, e?.message);
  });

  
  auth.onAuthStateChanged(async (user) => {
  try{
    const params = new URL(location.href).searchParams;
    const stepParam = params.get('step');

    if (user){
      // 이메일 UI 반영
      if (emailInput && user.email){
        emailInput.value = user.email;
        emailInput.readOnly = true;
      }

      // 온보딩 완료 여부
      const profile = await getUserDoc(); // firebase-init.js 제공
      const completed = !!profile?.onboarding?.completed;
      if (completed){
        return location.replace('./fastmate.html');
      }

      // ✅ 로그인 사용자는 1단계를 절대 보여주지 않음
      // URL 파라미터가 2~4면 그걸 존중, 없거나 1이면 2단계로 강제
      let target = 2;
      if (['2','3','4'].includes(stepParam)) {
        target = parseInt(stepParam, 10);
      }
      navigateTo(target);
    } else {
      // 미로그인 → 1단계
      navigateTo(1);
    }
  }catch(e){
    console.warn('[onAuthStateChanged]', e);
    navigateTo(1);
  }
});

      /* ===== 모달 열기/닫기 ===== */
      document.querySelectorAll('a[data-modal]').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const id = e.currentTarget.dataset.modal;
          const modal = document.getElementById(id);
          if (modal) modal.style.display = 'flex';
        });
      });
      document.querySelectorAll('.modal .close-btn').forEach(btn => {
        btn.addEventListener('click', (e) => e.target.closest('.modal').style.display = 'none');
      });
      window.addEventListener('click', (e) => {
        if (e.target.classList?.contains('modal')) e.target.style.display = 'none';
      });
    });
  </script>
</body>
</html>
