<!DOCTYPE html>
<html lang="ko">
<head>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    
    <title>Fastmate - 챌린지 초대</title>
    <link rel="canonical" href="https://fastmate.kr/challenge-invite.html">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Fastmate 단식 챌린지에 초대합니다!">
    <meta property="og:description" content="친구와 함께 건강한 단식을 시작해보세요!">
    <meta property="og:image" content="https://res.cloudinary.com/dnswboo5z/image/upload/v1757365249/%EB%A9%94%ED%83%80%ED%83%9C%EA%B7%B8%EC%9D%B4%EB%AF%B8%EC%A%A7%80_yfsysr.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:url" content="https://fastmate.kr/challenge-invite.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Fastmate 단식 챌린지에 초대합니다!">
    <meta name="twitter:description" content="친구와 함께 건강한 단식을 시작해보세요!">
    <meta name="twitter:image" content="https://res.cloudinary.com/dnswboo5z/image/upload/v1757365249/%EB%A9%94%ED%83%80%ED%83%9C%EA%B7%B8%EC%9D%B4%EB%AF%B8%EC%AA%A7%80_yfsysr.png">
    <link rel="stylesheet" href="./styles.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script defer src="/firebase-init.js?v=2025.09.06-v8"></script>
    <style>
        /* 초대 페이지 전용 스타일 */
        body {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        #invite-card {
            text-align: center;
            padding: 30px;
            max-width: 420px;
            width: 100%;
        }
        #invite-card h2 {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-light);
        }
        #invite-card .challenge-name {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 10px 0 20px;
        }
        #invite-card p {
            font-size: 1rem;
            margin-bottom: 25px;
        }
        .loader {
            width: 40px;
            height: 40px;
            border: 4px solid var(--gauge-track-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="invite-card" class="card">
        <div class="loader"></div>
        <p>챌린지 정보를 불러오는 중...</p>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Firebase 객체와 DOM 요소 가져오기
    const auth = window.fastmateApp.auth;
    const db = window.fastmateApp.db;
    const inviteCard = document.getElementById('invite-card');
    
    // 1. URL에서 챌린지 ID 가져오기
    const urlParams = new URLSearchParams(window.location.search);
    const challengeId = urlParams.get('id');

    if (!challengeId) {
        inviteCard.innerHTML = '<h2>오류</h2><p>잘못된 초대 링크입니다.</p>';
        return;
    }

    // 2. 로그인 상태가 확인되면 로직 실행
    auth.onAuthStateChanged(async (user) => {
        try {
            const challengeRef = db.collection('challenges').doc(challengeId);
            const challengeDoc = await challengeRef.get();

            if (!challengeDoc.exists) {
                inviteCard.innerHTML = '<h2>오류</h2><p>삭제되었거나 존재하지 않는 챌린지입니다.</p>';
                return;
            }

            const challenge = challengeDoc.data();
            // 챌린지 정보를 먼저 화면에 표시합니다.
            const cardHeader = `<h2>${challenge.hostNickname}님이 초대합니다</h2><p class="challenge-name">${challenge.challengeName}</p>`;
            inviteCard.innerHTML = cardHeader; // 기본 헤더를 먼저 설정

            // 3. 로그인 상태에 따라 다른 버튼을 보여줍니다.
            if (user) {
                // --- 3A. 로그인 된 경우 ---
                if (challenge.participantUids.includes(user.uid)) {
                    // 이미 참여중인 경우
                    inviteCard.innerHTML += '<p>이미 참여중인 챌린지입니다.</p><button id="goToChallengeBtn" class="onb-btn onb-primary">챌린지 목록 보기</button>';
                    document.getElementById('goToChallengeBtn').addEventListener('click', () => window.location.href = `challenge.html`);
                } else {
                    // 새로 참여하는 경우
                    inviteCard.innerHTML += '<p>이 챌린지에 참여하시겠습니까?</p><button id="acceptInviteBtn" class="onb-btn onb-primary">참여하기</button>';
                    
                    // ▼▼▼ '참여하기' 버튼에 대한 이벤트 리스너는 이 안에서 설정해야 합니다. ▼▼▼
                    document.getElementById('acceptInviteBtn').addEventListener('click', async (e) => {
                        e.target.disabled = true;
                        e.target.textContent = '참여하는 중...';
                        
                        const participantRef = challengeRef.collection('participants').doc(user.uid);
                        const batch = db.batch();

                        // 1. participantUids 배열에 ID 추가 (목록 조회를 위해 필요)
                        batch.update(challengeRef, {
                            participantUids: firebase.firestore.FieldValue.arrayUnion(user.uid)
                        });
                        // 2. participants 하위 컬렉션에 참여자 문서 추가
                        batch.set(participantRef, { joinedAt: firebase.firestore.FieldValue.serverTimestamp() });
                        
                        await batch.commit(); // 두 작업을 동시에 실행

                        alert('챌린지에 참여했습니다!');
                        window.location.href = 'challenge.html';
                    });
                }
            } else {
                // --- 3B. 로그아웃 상태인 경우 ---
                inviteCard.innerHTML += '<p>챌린지에 참여하려면 로그인이 필요합니다.</p><button id="loginToJoinBtn" class="onb-btn onb-primary">로그인하고 참여하기</button>';
                document.getElementById('loginToJoinBtn').addEventListener('click', () => {
                    sessionStorage.setItem('pendingChallengeId', challengeId);
                    window.location.href = 'login.html';
                });
            }
        } catch (error) {
            console.error("초대 처리 중 오류:", error);
            inviteCard.innerHTML = '<h2>오류</h2><p>챌린지 정보를 불러오는 데 실패했습니다.</p>';
        }
    });
});
</script>
</body>
</html>