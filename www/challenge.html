<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Fastmate - 챌린지</title>
   <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="/firebase-init.js?v=2025.09.06-v8"></script>
  <style>
    /* --- 기본 & 다크모드 색상 변수 --- */
    :root {
      --primary-color: #1c8e3e; /* 초록색 */
      --primary-light: #e8f5e9;
      --bg-color: #f8f9fa;
      --card-bg: #FFFFFF;
      --text-color: #212529;
      --text-light: #6c757d;
      --border-color: #e9ecef;
      --yellow-color: #ffc107;
      --yellow-bg-color: #fff3cd;
    }

    /* 다크모드 스타일 (필요시 body에 'dark-mode' 클래스 추가) */
    body.dark-mode {
      --primary-color: #4caf50;
      --primary-light: #2c3e50;
      --bg-color: #121212;
      --card-bg: #1e1e1e;
      --text-color: #e0e0e0;
      --text-light: #9e9e9e;
      --border-color: #333333;
    }

    /* --- 기본 레이아웃 --- */
    body { 
      background-color: var(--bg-color); 
      font-family: 'Noto Sans KR', sans-serif; 
      margin: 0; 
      color: var(--text-color);
    }
    .container { 
      max-width: 800px; /* fastmate.html과 동일한 폭 */
      margin: 0 auto; 
      padding: 20px; 
    }

    /* --- 헤더 --- */
    .page-header { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      margin-bottom: 25px; 
    }
    .page-title-group { 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }
    .page-title { 
      font-size: 1.5rem; 
      font-weight: 700; 
      color: var(--primary-color); 
      margin: 0; 
    }
    .beta-tag { 
      background-color: var(--yellow-bg-color); 
      color: #664d03;
      font-size: 0.75rem; 
      font-weight: bold; 
      padding: 4px 8px; 
      border-radius: 8px; 
      border: 1px solid var(--yellow-color);
    }
    .header-actions { display: flex; align-items: center; gap: 10px; }
    .header-btn { 
      background: none; 
      border: none; 
      cursor: pointer; 
      padding: 0; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      width: 40px; 
      height: 40px; 
      color: var(--text-light); 
      transition: color 0.2s; 
    }
    .header-btn:hover { color: var(--primary-color); }
    .create-challenge-btn {
      background-color: var(--primary-color);
      color: white;
      border-radius: 8px;
      font-weight: bold;
      font-size: 0.9rem;
      padding: 0 16px;
      height: 40px;
      border: none;
      cursor: pointer;
    }

    /* --- 필터 --- */
    .filter-bar { margin-bottom: 20px; display: flex; gap: 10px; }
    .filter-btn { 
      background: var(--card-bg); 
      border: 1px solid var(--border-color); 
      color: var(--text-light); 
      padding: 8px 16px; 
      border-radius: 20px; 
      cursor: pointer; 
      font-weight: 500; 
    }
    .filter-btn.active { 
      background-color: var(--primary-light); 
      color: var(--primary-color); 
      border-color: var(--primary-color); 
      font-weight: bold; 
    }
        
    /* --- 챌린지 리스트 카드 --- */
    .challenge-card {
      background: var(--card-bg); 
      border-radius: 12px; 
      padding: 20px; 
      margin-bottom: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); /* 음영 효과 */
      cursor: pointer; 
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex; 
      align-items: center; 
      gap: 16px;
    }
    .challenge-card:hover { transform: translateY(-3px); box-shadow: 0 6px 16px rgba(0,0,0,0.12); }
    .challenge-icon { width: 32px; height: 32px; flex-shrink: 0; } /* 아이콘 크기 32x32 */
    .challenge-content h3 { margin: 0 0 8px; font-size: 1.1rem; }
    .challenge-meta { font-size: 0.85rem; color: var(--text-light); }
    
    /* --- 페이징 --- */
    .pagination { text-align: center; margin-top: 30px; display: flex; gap: 8px; justify-content: center; align-items: center;}
    .pagination button { 
      background-color: var(--card-bg);
      border: 1px solid var(--border-color); 
      color: var(--text-color);
      padding: 8px 12px; 
      border-radius: 8px; 
      cursor: pointer; 
      font-weight:500;
    }
    .pagination button:disabled { cursor: not-allowed; opacity: 0.5; background: var(--bg-color); }
    .pagination .page-number { font-weight: bold; padding: 0 10px; }

    /* --- 챌린지 상세 정보 --- */
    .challenge-info-card {
      background: var(--card-bg); 
      border-radius: 12px; 
      padding: 20px;
      margin-bottom: 30px; 
      border: 1px solid var(--border-color); 
      position: relative;
    }
    .delete-challenge-btn {
      position: absolute; top: 15px; right: 15px; background: var(--border-color); color: var(--text-light);
      border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 20px;
      line-height: 28px; text-align: center; cursor: pointer; transition: all 0.2s;
    }
    .delete-challenge-btn:hover { background-color: #ced4da; color: var(--text-color); }
    body.dark-mode .delete-challenge-btn { background-color: #333; }
    body.dark-mode .delete-challenge-btn:hover { background-color: #555; }
    
    /* --- 댓글 (Threads UI) --- */
    .comment-section { padding-top: 20px; }
    .comment { display: flex; gap: 12px; margin-bottom: 20px; position: relative; }
    .comment-avatar-column { display: flex; flex-direction: column; align-items: center; }
    .comment-avatar {
      width: 32px; height: 32px; border-radius: 50%; /* 작고 동그란 프로필 */
      background-color: var(--primary-light); color: var(--primary-color);
      display: flex; align-items: center; justify-content: center;
      font-weight: bold; flex-shrink: 0; object-fit: cover;
    }
    .thread-line { /* 답글 연결선 */
      width: 2px; 
      background-color: var(--border-color); 
      flex-grow: 1; 
      margin-top: 8px; 
    }
    .comment-main { flex-grow: 1; }
    .comment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .comment-author-info { display: flex; align-items: center; gap: 8px; }
    .comment-author { font-weight: bold; font-size: 0.95rem; color: var(--text-color);}
    .comment-timestamp { font-size: 0.85rem; color: var(--text-light); }
    .comment-options-btn { background: none; border:none; cursor: pointer; padding: 5px; color: var(--text-light); }
    
    .comment-text { margin: 0 0 8px; white-space: pre-wrap; word-break: break-word; line-height: 1.6; }
    .comment-actions { display: flex; align-items: center; justify-content: space-between; }
    .reply-info { display: flex; align-items: center; gap: 8px; color: var(--text-light); font-size: 0.85rem; }
    .reply-info-item { display: flex; align-items: center; gap: 4px; }
    .reply-info-item svg { width: 16px; height: 16px; }
    .reply-btn { background: none; border: none; color: var(--text-light); font-weight: 600; font-size: 0.85rem; cursor: pointer; padding: 4px; }
    
    /* 내 댓글 옵션(...) 메뉴 */
    .comment-options { position: relative; }
    .options-menu {
      display: none;
      position: absolute;
      right: 0;
      top: 24px;
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      z-index: 10;
      width: 100px;
      overflow: hidden;
    }
    .options-menu button {
      display: block;
      width: 100%;
      padding: 10px 12px;
      background: none;
      border: none;
      color: var(--text-color);
      text-align: left;
      cursor: pointer;
    }
    .options-menu button:hover { background-color: var(--bg-color); }
  </style>
</head>
<body>

  <div class="container">
    <header id="pageHeader" class="page-header"></header>
    
    <div id="challengeListView" style="display: none;">
      <div class="filter-bar">
        <button class="filter-btn active" data-filter="public">공개</button>
        <button class="filter-btn" data-filter="private">비공개</button>
      </div>
      <div id="challengeList"></div>
      <div id="paginationControls" class="pagination"></div>
    </div>
    
    <div id="challengeDetailView" style="display: none;">
      <div id="challengeInfo" class="challenge-info-card">
        <!-- 챌린지 정보가 여기에 렌더링됩니다. -->
      </div>

        <!-- ✅ 댓글 섹션 추가 -->
  <section class="card comment-section">
    <div id="commentFeed"></div>
  </section>
</div>

   
  <!-- 생성 모달 -->
<div id="createChallengeModal" class="modal" style="display:none;">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="cc-title">
    <div class="modal-header">
      <h3 id="cc-title">챌린지 만들기</h3>
      <button id="closeCreateChallengeModalBtn" class="icon-btn" aria-label="닫기">✕</button>
    </div>

    <form id="createChallengeForm" class="modal-body" autocomplete="off">
      <div class="form-row">
        <label for="cc-name">챌린지 이름</label>
        <input id="cc-name" name="name" type="text" required placeholder="예: 18:6 간헐적 단식"/>
      </div>

      <div class="form-row">
        <label for="cc-desc">설명</label>
        <textarea id="cc-desc" name="desc" rows="3" placeholder="간단한 설명을 적어주세요"></textarea>
      </div>

      <div class="form-row">
        <label for="cc-start">시작일</label>
        <input id="cc-start" name="startDate" type="date"/>
      </div>

      <!-- 공개 범위: 기본값 '비공개' -->
      <fieldset class="form-row" style="margin-top:8px;">
        <legend>공개 범위</legend>
        <label class="radio">
          <input type="radio" name="visibility" value="private" checked>
          비공개
        </label>
        <label class="radio" style="margin-left:16px;">
          <input type="radio" name="visibility" value="public">
          공개
        </label>
      </fieldset>

      <div class="modal-footer">
        <button type="button" class="onb-btn" id="cc-cancel">취소</button>
        <button type="submit" class="onb-btn onb-primary">생성</button>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // --- 전역 변수 ---
  const auth = window.fastmateApp.auth;
  const db   = window.fastmateApp.db;
  let currentUser = null;
  let stopListeningToChallenge = null;
  let allChallenges = []; // 전체 챌린지 데이터 캐시
  let currentPage = 1;
  let currentUserProfile = null;    // ✅ 추가
let currentChallengeId = null;    // ✅ 추가
  const ITEMS_PER_PAGE = 20; // 페이지 당 20개씩

  // --- DOM 요소 ---
  const pageHeader = document.getElementById('pageHeader');
  const challengeListView = document.getElementById('challengeListView');
  const challengeListDiv = document.getElementById('challengeList');
  const paginationControls = document.getElementById('paginationControls');
  const challengeDetailView = document.getElementById('challengeDetailView');
  const challengeInfoDiv = document.getElementById('challengeInfo');
  const commentFeed = document.getElementById('commentFeed');

  // --- 뷰 관리 ---
  
  
function showView(viewName, challengeId = null) {
  challengeListView.style.display = 'none';
  challengeDetailView.style.display = 'none';
  if (stopListeningToChallenge) stopListeningToChallenge();

  if (viewName === 'list') {
    currentChallengeId = null;                // ✅ 리셋
    challengeListView.style.display = 'block';
    renderListHeader();
    loadAndRenderChallenges();
  } else if (viewName === 'detail' && challengeId) {
    currentChallengeId = challengeId;         // ✅ 보관
    challengeDetailView.style.display = 'block';
    listenToChallengeDetails(challengeId);
  }
}


  // --- 헤더 렌더링 ---
  function renderListHeader() {
    pageHeader.innerHTML = `
      <button class="header-btn" title="메인으로" onclick="location.href='fastmate.html'">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
      </button>
      <div class="page-title-group">
        <h1 class="page-title">챌린지</h1>
        <span class="beta-tag">BETA</span>
      </div>
      <button class="create-challenge-btn" id="createChallengeBtnHeader">챌린지 만들기</button>
    `;

  // ✅ 모달 오픈 연결
  document.getElementById('createChallengeBtnHeader')?.addEventListener('click', () => {
    document.getElementById('createChallengeModal').style.display = 'flex';
  });
  document.getElementById('closeCreateChallengeModalBtn')?.addEventListener('click', () => {
    document.getElementById('createChallengeModal').style.display = 'none';
  });
}

// 모달 핸들러 바인딩
(function bindCreateModal() {
  const modal = document.getElementById('createChallengeModal');
  const openBtn = () => document.getElementById('createChallengeBtnHeader');
  const closeBtn = document.getElementById('closeCreateChallengeModalBtn');
  const cancelBtn = document.getElementById('cc-cancel');
  const form = document.getElementById('createChallengeForm');

  // 헤더가 렌더될 때마다 버튼이 다시 생기므로, open은 renderListHeader() 쪽에서 addEventListener를 이미 붙임함
  // 여기서는 닫기/취소/submit만 바인딩함
  closeBtn?.addEventListener('click', () => modal.style.display = 'none');
  cancelBtn?.addEventListener('click', () => modal.style.display = 'none');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentUser) {
      alert('로그인이 필요합니다');
      return;
    }

    const name = (document.getElementById('cc-name').value || '').trim();
    const desc = (document.getElementById('cc-desc').value || '').trim();
    const startDateVal = document.getElementById('cc-start').value || null;
    const visibility = (document.querySelector('input[name="visibility"]:checked')?.value) || 'private'; // ✅ 기본값 비공개

    if (!name) {
      alert('챌린지 이름을 입력해주세요');
      return;
    }

    try {
const startTs = startDateVal
  ? firebase.firestore.Timestamp.fromDate(new Date(startDateVal))
  : firebase.firestore.FieldValue.serverTimestamp();

// 표시용 닉네임/사진
const ownerName = currentUserProfile?.nickname || currentUser.displayName || '사용자';
const ownerPhotoURL = currentUserProfile?.photoURL || currentUser.photoURL || null;

// 날짜/시간 분리 문자열(아이콘과 함께 쓸 용도)
function fmtDate(d) {
  try { return d.toLocaleDateString('ko-KR', { year:'numeric', month:'2-digit', day:'2-digit' }); }
  catch(e){ return '-'; }
}
function fmtTime(d) {
  try { return d.toLocaleTimeString('ko-KR', { hour:'2-digit', minute:'2-digit' }); }
  catch(e){ return '-'; }
}

let startDateStr = '-', startTimeStr = '-';
if (startDateVal) {
  const d = new Date(startDateVal);
  startDateStr = fmtDate(d);
  startTimeStr = fmtTime(d); // date input만 있으면 시간은 '-'로 두어도 됨
}

const payload = {
  // 쿼리/권한용
  startTime: startTs,
  participantUids: [currentUser.uid],
  hostUid: currentUser.uid,

  // 표시용(닉네임/사진)
  hostName: ownerName,
  ownerName,
  ownerPhotoURL,

  // UI/필터
  visibility,                 // 'private' | 'public'
  isBeta: true,

  // 메타
  challengeName: name,
  description: desc,
  createdAt: firebase.firestore.FieldValue.serverTimestamp(),
  updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
  memberCount: 1,

  // 날짜/시간 분리(아이콘 표시용 캐시)
  startDateStr,               // 예: 2025.09.12
  startClockStr: startTimeStr // 예: 09:30
};

      const docRef = await db.collection('challenges').add(payload);

      // 생성자 자신을 참여자로 기록하고 싶으면(선택):
      await db.collection('challenges').doc(docRef.id)
        .collection('members').doc(currentUser.uid)
        .set({
          uid: currentUser.uid,
          nickname: payload.ownerName,
          photoURL: payload.ownerPhotoURL || null,
          role: 'owner',
          joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
        });

      modal.style.display = 'none';
      // 목록 새로고침
      showView('list');
    } catch (err) {
      console.error('챌린지 생성 오류:', err);
      alert('챌린지 생성 중 오류가 발생했습니다');
    }
  });
})();


  // --- 챌린지 목록 (페이징 적용) ---
  async function loadAndRenderChallenges() {
    if (!currentUser) return;
    challengeListDiv.innerHTML = "<p>챌린지 목록을 불러오는 중...</p>";
    
    try {
      const query = db.collection('challenges')
        .where('participantUids', 'array-contains', currentUser.uid)
        .orderBy('startTime', 'desc');
      const snapshot = await query.get();
      
      allChallenges = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      
      currentPage = 1;
      renderChallengePage();

    } catch (error) {
      console.error("챌린지 목록 로딩 실패:", error);
      challengeListDiv.innerHTML = '<p>목록을 불러오는 데 실패했습니다.</p>';
    }
  }

function renderChallengePage() {
  if (allChallenges.length === 0) {
    challengeListDiv.innerHTML = '<div class="challenge-card" style="text-align:center;"><p>아직 참여한 챌린지가 없습니다.</p></div>';
    paginationControls.innerHTML = '';
    return;
  }

  challengeListDiv.innerHTML = '';
  const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
  const endIndex = startIndex + ITEMS_PER_PAGE;
  const pageItems = allChallenges.slice(startIndex, endIndex);

  // --- 아이콘 경로 ---
  const peopleIcon = "https://res.cloudinary.com/dnswboo5z/image/upload/v1757491598/people_qhprqx.png";
  const dateIcon   = "https://res.cloudinary.com/dnswboo5z/image/upload/v1757491598/date_dqqkwp.png";
  const timeIcon   = "https://res.cloudinary.com/dnswboo5z/image/upload/v1757491598/time_t4ooih.png";

  pageItems.forEach(ch => {
    const card = document.createElement('div');
    card.className = 'challenge-card';

    const hostName = ch.hostName || ch.ownerName || '방장';
    const memberCount = Array.isArray(ch.participantUids) ? ch.participantUids.length : (ch.memberCount || 1);

    const d = ch.startTime?.toDate?.();
    const dateStr = ch.startDateStr || (d ? d.toLocaleDateString('ko-KR') : '-');
    const timeStr = ch.startClockStr || (d ? d.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'}) : '-');

    card.innerHTML = `
      <div class="challenge-content">
        <h3>${escapeHTML(ch.challengeName)}</h3>
        <div class="challenge-meta">
          <div class="meta-row">
            <img src="${peopleIcon}" alt="참여자" width="32" height="32" />
            <span>${memberCount}명 · 방장: ${escapeHTML(hostName)}</span>
          </div>
          <div class="meta-row">
            <img src="${dateIcon}" alt="날짜" width="32" height="32" />
            <span>${dateStr}</span>
          </div>
          <div class="meta-row">
            <img src="${timeIcon}" alt="시간" width="32" height="32" />
            <span>${timeStr}</span>
          </div>
        </div>
      </div>
    `;

    card.addEventListener('click', () => showView('detail', ch.id));
    challengeListDiv.appendChild(card);
  });

  renderPagination();
}


  function renderPagination() {
    const totalPages = Math.ceil(allChallenges.length / ITEMS_PER_PAGE);
    if (totalPages <= 1) {
      paginationControls.innerHTML = '';
      return;
    }

    paginationControls.innerHTML = `
      <button id="prevPageBtn" ${currentPage === 1 ? 'disabled' : ''}>이전</button>
      <span class="page-number">${currentPage} / ${totalPages}</span>
      <button id="nextPageBtn" ${currentPage === totalPages ? 'disabled' : ''}>다음</button>
    `;

    document.getElementById('prevPageBtn')?.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        renderChallengePage();
      }
    });
    document.getElementById('nextPageBtn')?.addEventListener('click', () => {
      if (currentPage < totalPages) {
        currentPage++;
        renderChallengePage();
      }
    });
  }


  // --- 챌린지 상세 및 댓글 ---
  function listenToChallengeDetails(challengeId) {
    const challengeRef = db.collection('challenges').doc(challengeId);
    stopListeningToChallenge = challengeRef.onSnapshot(doc => {
      if (!doc.exists) {
        alert("삭제되었거나 존재하지 않는 챌린지입니다.");
        return showView('list');
      }
      const challenge = { id: doc.id, ...doc.data() };
 
            // 상세 정보 카드 렌더링 (시작일/시간 분리 적용)
            const detailCard = document.querySelector('.challenge-details');
            const startTime = challenge.startTime.toDate();
            detailCard.innerHTML = `
                <p><b>목표:</b> <span>${challenge.detailedGoal || '없음'}</span></p>
                <p><b>참여자:</b> <span>${challenge.participantUids.length}명</span></p>
                <p><b>시작일:</b> <span>${startTime.toLocaleDateString('ko-KR')}</span></p>
                <p><b>시작 시간:</b> <span>${startTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute:'2-digit' })}</span></p>
            `;
            
           // ✅ 상단 헤더
    renderDetailHeader(challenge);

    // ✅ 상세 정보 카드 채우기
    renderChallengeInfo(challenge);

    // ✅ 댓글 렌더
    renderComments(challengeId);
  });
} 
 
function renderDetailHeader(challenge) {
  pageHeader.innerHTML = `
    <button class="header-btn" id="backToListBtn">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
    </button>
    <div class="page-title-group">
      <h1 class="page-title" style="font-size: 1.2rem;">${escapeHTML(challenge.challengeName)}</h1>
      <span class="beta-tag">BETA</span>
    </div>
    <div style="width: 40px;"></div>
  `;
  document.getElementById('backToListBtn')?.addEventListener('click', () => showView('list'));
}  


function renderChallengeInfo(ch) {
  const $info = document.getElementById('challengeInfo');
  if (!$info) return;

  const peopleIcon = 'https://res.cloudinary.com/dnswboo5z/image/upload/v1757491598/people_qhprqx.png';
  const dateIcon   = 'https://res.cloudinary.com/dnswboo5z/image/upload/v1757491598/date_dqqkwp.png';
  const goalIcon   = 'https://res.cloudinary.com/dnswboo5z/image/upload/v1757491598/goal_icon_jlglbt.png';
  const linkIcon   = 'https://res.cloudinary.com/dnswboo5z/image/upload/v1757491598/link_zjdsqa.png';
  const timeIcon   = 'https://res.cloudinary.com/dnswboo5z/image/upload/v1757491598/time_t4ooih.png';

  // 보조 포맷(백업)
  const d = ch.startTime?.toDate?.();
  const backupDate = d ? d.toLocaleDateString('ko-KR', { year:'numeric', month:'2-digit', day:'2-digit' }) : '-';
  const backupTime = d ? d.toLocaleTimeString('ko-KR', { hour:'2-digit', minute:'2-digit' }) : '-';

  const dateStr = ch.startDateStr || backupDate;
  const timeStr = ch.startClockStr || backupTime;

  const memberCount = Array.isArray(ch.participantUids) ? ch.participantUids.length : (ch.memberCount || 1);
  const hostName = ch.hostName || ch.ownerName || '방장';

  $info.innerHTML = `
    <div class="card challenge-details">
      <div class="challenge-title-row">
        <h2 class="challenge-title">${escapeHTML(ch.challengeName || '-')}</h2>
        <span class="beta-tag">BETA</span>
      </div>

      <p class="challenge-desc">${escapeHTML(ch.description || '')}</p>

      <ul class="challenge-meta-list">
        <li class="meta-item">
          <img src="${peopleIcon}" alt="참여자" width="32" height="32" />
          <div class="meta-text">
            <div class="meta-label">참여자</div>
            <div class="meta-value">${memberCount}명 · 방장: ${escapeHTML(hostName)}</div>
          </div>
        </li>

        <li class="meta-item">
          <img src="${dateIcon}" alt="날짜" width="32" height="32" />
          <div class="meta-text">
            <div class="meta-label">날짜</div>
            <div class="meta-value">${dateStr}</div>
          </div>
        </li>

        <li class="meta-item">
          <img src="${timeIcon}" alt="시작시간" width="32" height="32" />
          <div class="meta-text">
            <div class="meta-label">시작시간</div>
            <div class="meta-value">${timeStr}</div>
          </div>
        </li>

        <li class="meta-item">
          <img src="${goalIcon}" alt="목표" width="32" height="32" />
          <div class="meta-text">
            <div class="meta-label">목표</div>
            <div class="meta-value">-</div>
          </div>
        </li>

        <li class="meta-item">
          <img src="${linkIcon}" alt="링크 공유" width="32" height="32" />
          <div class="meta-text">
            <div class="meta-label">링크 공유</div>
            <div class="meta-value">
              <button class="onb-btn" id="shareLinkBtn">복사</button>
            </div>
          </div>
        </li>
      </ul>
    </div>
  `;

  // 링크 복사(상세 URL)
  document.getElementById('shareLinkBtn')?.addEventListener('click', async () => {
    const url = `${location.origin}${location.pathname}?c=${encodeURIComponent(ch.id)}`;
    try { await navigator.clipboard.writeText(url); alert('링크 복사됨'); }
    catch { prompt('아래 링크를 복사하세요', url); }
  });
}

  async function renderComments(challengeId) {
    const snapshot = await db.collection('challenges').doc(challengeId)
      .collection('comments').orderBy('timestamp', 'asc').get();

    commentFeed.innerHTML = ''; // 댓글 피드 초기화
    
    const comments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    const commentTree = {}; // { parentId: [child, child] }
    const commentMap = {}; // { commentId: commentData }

    comments.forEach(c => {
        commentMap[c.id] = c;
        if (c.parentId) {
            if (!commentTree[c.parentId]) commentTree[c.parentId] = [];
            commentTree[c.parentId].push(c);
        }
    });

    comments.filter(c => !c.parentId).forEach(comment => {
        const replies = commentTree[comment.id] || [];
        const commentDiv = createCommentElement(comment, replies);
        commentFeed.appendChild(commentDiv);

        // 자식 댓글 렌더링
        const repliesContainer = commentDiv.querySelector('.replies-container');
        if (repliesContainer) {
            replies.forEach(reply => {
                repliesContainer.appendChild(createCommentElement(reply, [], true));
            });
        }
    });
  }

  function createCommentElement(comment, replies = [], isReply = false) {
  const div = document.createElement('div');
  div.className = 'comment';
  const isMyComment = currentUser && currentUser.uid === comment.uid;

  const avatarHtml = comment.photoURL
    ? `<img src="${comment.photoURL}" alt="${escapeHTML(comment.nickname)}" class="comment-avatar">`
    : `<div class="comment-avatar" style="background-color: var(--primary-light);">
         <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--primary-color);"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
       </div>`;

  const ts = comment.timestamp?.toDate()?.toLocaleString('ko-KR', { hour: '2-digit', minute: '2-digit' }) || '';

  div.innerHTML = `
    <div class="comment-avatar-column">
      ${avatarHtml}
      ${!isReply && replies.length > 0 ? '<div class="thread-line"></div>' : ''}
    </div>
    <div class="comment-main">
      <div class="comment-header">
        <div class="comment-author-info">
          <span class="comment-author">${escapeHTML(comment.nickname)}</span>
          <span class="comment-timestamp">${ts}</span>
        </div>
        ${isMyComment ? `
        <div class="comment-options">
          <button class="comment-options-btn">•••</button>
          <div class="options-menu">
            <button class="edit-comment-btn" data-id="${comment.id}">수정</button>
            <button class="delete-comment-btn" data-id="${comment.id}">삭제</button>
          </div>
        </div>` : ``}
      </div>

      <div class="comment-text">${linkify(comment.text)}</div>

      <div class="comment-actions">
        <div class="reply-info">
          <div class="reply-info-item">
            <!-- 말풍선 아이콘 + 답글 수 -->
            <svg viewBox="0 0 24 24"><path d="M21 15a4 4 0 0 1-4 4H7l-4 4V5a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"/></svg>
            <span>${replies.length}</span>
          </div>
        </div>
        ${!isReply ? `<button class="reply-btn" data-target="${comment.id}">reply</button>` : ``}
      </div>

      ${!isReply ? `
      <div class="reply-form" id="rf-${comment.id}" style="display:none; gap:8px; margin-top:8px;">
        <textarea class="reply-text" placeholder="답글 입력..." rows="1" style="flex:1;"></textarea>
        <button class="onb-btn onb-primary reply-submit" data-target="${comment.id}">등록</button>
      </div>` : ``}

      ${!isReply ? `<div class="replies-container" style="margin-left:12px; margin-top:10px;"></div>` : ``}
    </div>
  `;

  // 내 댓글 옵션 토글
  const optionsBtn = div.querySelector('.comment-options-btn');
  if (optionsBtn) {
    optionsBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      const menu = optionsBtn.nextElementSibling;
      menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
    });
  }
  return div;
}

  
 commentFeed.addEventListener('click', async (e) => {
        const replyBtn = e.target.closest('.reply-btn');
        const submitBtn = e.target.closest('.reply-submit');

        if (replyBtn) {
            const parentId = replyBtn.dataset.target;
            const form = document.getElementById(`rf-${parentId}`);
            if (form) {
                document.querySelectorAll('.reply-form').forEach(f => {
                    if (f.id !== `rf-${parentId}`) f.style.display = 'none';
                });
                form.style.display = form.style.display === 'none' ? 'flex' : 'none';
            }
            return;
        }

        if (submitBtn) {
            const parentId = submitBtn.dataset.target;
            const form = document.getElementById(`rf-${parentId}`);
            const textarea = form?.querySelector('.reply-text');
            const text = textarea?.value.trim();

            if (!text || !currentUser || !currentChallengeId) return;

            submitBtn.disabled = true;
            try {
                await db.collection('challenges').doc(currentChallengeId).collection('comments').add({
                    uid: currentUser.uid,
                    nickname: currentUserProfile.nickname || currentUser.displayName || '사용자',
                    photoURL: currentUser.photoURL || null,
                    text,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    isAutoComment: false,
                    parentId: parentId
                });
                textarea.value = '';
                form.style.display = 'none';
            } catch (err) {
                console.error('답글 등록 오류:', err);
                alert('답글 등록에 실패했습니다.');
            } finally {
                submitBtn.disabled = false;
            }
        }
    });

  // --- 헬퍼 함수 ---
  function escapeHTML(s) { return String(s || '').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }
  function linkify(text) {
    const safe = escapeHTML(text);
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    return safe.replace(urlRegex, url => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
  }

  // --- 초기화 ---
  auth.onAuthStateChanged(user => {
      if (user) {
    currentUser = user;
    // 닉네임/사진 기본값 준비
    currentUserProfile = {
      nickname: user.displayName || '사용자',
      photoURL: user.photoURL || null,
    };
    showView('list');
  } else {
    currentUser = null;
    document.body.innerHTML = `<div class="container" style="text-align:center; padding-top: 50px;">챌린지 기능을 사용하려면 로그인이 필요합니다.</div>`;
  }
});

  // 클릭 시 열려있는 ... 메뉴 닫기
  document.addEventListener('click', () => {
    document.querySelectorAll('.options-menu').forEach(menu => menu.style.display = 'none');
  });

});
</script>

</body>
</html>
