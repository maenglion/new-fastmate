<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Fastmate - 챌린지</title>
   <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="/firebase-init.js?v=2025.09.06-v8"></script>
  <style>
    /* --- 기본 & 다크모드 색상 변수 --- */
    :root {
      --primary-color: #1c8e3e; /* 초록색 */
      --primary-light: #e8f5e9;
      --bg-color: #f8f9fa;
      --card-bg: #FFFFFF;
      --text-color: #212529;
      --text-light: #6c757d;
      --border-color: #e9ecef;
      --yellow-color: #ffc107;
      --yellow-bg-color: #fff3cd;
    }

    /* 다크모드 스타일 (필요시 body에 'dark-mode' 클래스 추가) */
    body.dark-mode {
      --primary-color: #4caf50;
      --primary-light: #2c3e50;
      --bg-color: #121212;
      --card-bg: #1e1e1e;
      --text-color: #e0e0e0;
      --text-light: #9e9e9e;
      --border-color: #333333;
    }

    /* --- 기본 레이아웃 --- */
    body {
      background-color: var(--bg-color);
      font-family: 'Noto Sans KR', sans-serif;
      margin: 0;
      color: var(--text-color);
    }
    .container {
      max-width: 800px; /* fastmate.html과 동일한 폭 */
      margin: 0 auto;
      padding: 20px;
    }

    /* --- 헤더 --- */
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 25px;
    }
    .page-title-group {
      display: flex;
      align-items: center;
      gap: 10px;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }
    .page-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-color);
      margin: 0;
    }
    .beta-tag {
      background-color: var(--yellow-bg-color);
      color: #664d03;
      font-size: 0.75rem;
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 8px;
      border: 1px solid var(--yellow-color);
    }
    .header-actions { display: flex; align-items: center; gap: 10px; }
    .header-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      color: var(--text-light);
      transition: color 0.2s;
    }
    .header-btn:hover { color: var(--primary-color); }
    .create-challenge-btn {
      background-color: var(--primary-color);
      color: white;
      border-radius: 8px;
      font-weight: bold;
      font-size: 0.9rem;
      padding: 0 16px;
      height: 40px;
      border: none;
      cursor: pointer;
    }

    /* --- 필터 --- */
    .filter-bar { margin-bottom: 20px; display: flex; gap: 10px; }
    .filter-btn {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      color: var(--text-light);
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 500;
    }
    .filter-btn.active {
      background-color: var(--primary-light);
      color: var(--primary-color);
      border-color: var(--primary-color);
      font-weight: bold;
    }

    /* --- 챌린지 리스트 카드 (수정됨) --- */
    .challenge-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex;
      align-items: flex-start; /* 콘텐츠 상단 정렬 */
      gap: 16px;
    }
    .challenge-card:hover { transform: translateY(-3px); box-shadow: 0 6px 16px rgba(0,0,0,0.12); }
    .challenge-content { flex-grow: 1; }
    .challenge-content h3 { margin: 0 0 10px; font-size: 1.1rem; }
    .challenge-meta {
      font-size: 0.85rem;
      color: var(--text-light);
      display: flex;
      flex-direction: column;
      gap: 8px; /* 각 정보 행 사이의 간격 */
    }
    .challenge-meta .meta-row {
      display: flex;
      align-items: center; /* 아이콘과 텍스트 수직 중앙 정렬 (핵심 수정) */
      gap: 8px; /* 아이콘과 텍스트 사이 간격 */
    }
    .challenge-meta .meta-row img {
      width: 16px; /* 아이콘 크기를 텍스트와 어울리게 조정 */
      height: 16px;
    }

    /* --- 페이징 --- */
    .pagination { text-align: center; margin-top: 30px; display: flex; gap: 8px; justify-content: center; align-items: center;}
    .pagination button {
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight:500;
    }
    .pagination button:disabled { cursor: not-allowed; opacity: 0.5; background: var(--bg-color); }
    .pagination .page-number { font-weight: bold; padding: 0 10px; }

    /* --- 챌린지 상세 정보 (수정됨) --- */
    .challenge-info-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      border: 1px solid var(--border-color);
      position: relative;
    }
    .challenge-details .challenge-title-row { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
    .challenge-details .challenge-title { margin: 0; font-size: 1.4rem; }
    .challenge-details .challenge-desc { margin: 0 0 24px; color: var(--text-light); line-height: 1.6; }
    .challenge-meta-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 16px; }
    .meta-item { display: flex; align-items: center; gap: 12px; } /* 아이콘, 텍스트 정렬 */
    .meta-item img { width: 24px; height: 24px; }
    .meta-label { font-size: 0.9rem; color: var(--text-light); margin-bottom: 2px; }
    .meta-value { font-size: 0.95rem; font-weight: 500; }
    .meta-value button { font-size: 0.9rem; padding: 6px 12px; }

    .delete-challenge-btn {
      position: absolute; top: 15px; right: 15px; background: var(--border-color); color: var(--text-light);
      border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 20px;
      line-height: 28px; text-align: center; cursor: pointer; transition: all 0.2s;
    }
    .delete-challenge-btn:hover { background-color: #ced4da; color: var(--text-color); }
    body.dark-mode .delete-challenge-btn { background-color: #333; }
    body.dark-mode .delete-challenge-btn:hover { background-color: #555; }

    /* --- 댓글 (Threads UI) --- */
    .comment-section { padding-top: 20px; }
    .comment { display: flex; gap: 12px; margin-bottom: 20px; position: relative; }
    .comment-avatar-column { display: flex; flex-direction: column; align-items: center; }
    .comment-avatar {
      width: 32px; height: 32px; border-radius: 50%; /* 작고 동그란 프로필 */
      background-color: var(--primary-light); color: var(--primary-color);
      display: flex; align-items: center; justify-content: center;
      font-weight: bold; flex-shrink: 0; object-fit: cover;
    }
    .thread-line { /* 답글 연결선 */
      width: 2px;
      background-color: var(--border-color);
      flex-grow: 1;
      margin-top: 8px;
    }
    .comment-main { flex-grow: 1; }
    .comment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .comment-author-info { display: flex; align-items: center; gap: 8px; }
    .comment-author { font-weight: bold; font-size: 0.95rem; color: var(--text-color);}
    .comment-timestamp { font-size: 0.85rem; color: var(--text-light); }
    .comment-options-btn { background: none; border:none; cursor: pointer; padding: 5px; color: var(--text-light); }

    .comment-text { margin: 0 0 8px; white-space: pre-wrap; word-break: break-word; line-height: 1.6; }
    .comment-actions { display: flex; align-items: center; justify-content: space-between; }
    .reply-info { display: flex; align-items: center; gap: 8px; color: var(--text-light); font-size: 0.85rem; }
    .reply-info-item { display: flex; align-items: center; gap: 4px; }
    .reply-info-item svg { width: 16px; height: 16px; }
    .reply-btn { background: none; border: none; color: var(--text-light); font-weight: 600; font-size: 0.85rem; cursor: pointer; padding: 4px; }

    /* 내 댓글 옵션(...) 메뉴 */
    .comment-options { position: relative; }
    .options-menu {
      display: none;
      position: absolute;
      right: 0;
      top: 24px;
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      z-index: 10;
      width: 100px;
      overflow: hidden;
    }
    .options-menu button {
      display: block;
      width: 100%;
      padding: 10px 12px;
      background: none;
      border: none;
      color: var(--text-color);
      text-align: left;
      cursor: pointer;
    }
    .options-menu button:hover { background-color: var(--bg-color); }
  </style>
</head>
<body>

  <div class="container">
  <!-- 상단 헤더 -->
  <header id="pageHeader" class="page-header"></header>

  <!-- 목록 뷰 -->
  <div id="challengeListView" style="display: none;">
    <div class="filter-bar">
      <button class="filter-btn active" data-filter="public">공개</button>
      <button class="filter-btn" data-filter="private">비공개</button>
    </div>
    <div id="challengeList"></div>
    <div id="paginationControls" class="pagination"></div>
  </div><!-- /#challengeListView -->

  <!-- 상세 뷰(단 하나만 유지) -->
  <div id="challengeDetailView" style="display:none;">
    <div id="challengeInfo" class="challenge-info-card"><!-- JS가 채움 --></div>

    <!-- 댓글 섹션 -->
    <section class="card comment-section">
      <h4>챌린지 타임라인</h4>
      <div class="comment-form">
        <textarea id="newCommentText" placeholder="응원 댓글을 남겨보세요." rows="1"></textarea>
        <button id="submitCommentBtn" class="onb-btn onb-primary">등록</button>
      </div>
      <div id="commentFeed"></div>
    </section>
  </div><!-- /#challengeDetailView -->

  <!-- 생성 모달(목록/상세와 '형제' 위치) -->
  <div id="createChallengeModal"
       class="modal"
       style="
         display:none; position:fixed; inset:0; z-index:9999;
         background:rgba(0,0,0,.45);
         align-items:center; justify-content:center; padding:20px;">
    <div class="modal-content"
         role="dialog" aria-modal="true" aria-labelledby="cc-title"
         style="background:var(--card-bg, #fff); padding:24px; border-radius:12px; max-width:720px; width:100%;">

      <!-- 모달 헤더 -->
      <div class="modal-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <h3 id="cc-title" style="margin:0;">챌린지 만들기</h3>
        <button id="closeCreateChallengeModalBtn" class="icon-btn" aria-label="닫기">✕</button>
      </div><!-- /.modal-header -->

      <!-- 모달 바디(폼) -->
      <form id="createChallengeForm" class="modal-body" autocomplete="off" style="margin-top:16px;">
        <!-- 단식 모델 -->
        <div class="form-row">
          <label for="fastingModelSelect">단식 모델</label>
          <div class="controls">
            <select id="fastingModelSelect" required>
              <option value="8">8:16 (8시간 단식,야식끊기)</option>
              <option value="12">12:12 (12시간 단식,초보)</option>
              <option value="16">16:8 (16시간 단식,인기)</option>
              <option value="18">18:6 (18시간 단식,인기)</option>
              <option value="20">20:4 (20시간 단식,고급)</option>
              <option value="24">24시간 (1일 단식,고급)</option>
              <option value="36">36시간(1.5일 단식,고급)</option>
              <option value="48">48시간 (2일 단식,고급)</option>
              <option value="72">72시간 (3일 단식,고급)</option>
            </select>
          </div><!-- /.controls -->
        </div><!-- /.form-row -->

        <!-- 목표 -->
        <div class="form-row">
          <label for="cc-desc">목표</label>
          <textarea id="cc-desc" name="desc" rows="3" placeholder="간단한 설명을 적어주세요"></textarea>
        </div><!-- /.form-row -->

        <!-- 시작일 -->
        <div class="form-row">
          <label for="cc-start">시작일</label>
          <input id="cc-start" name="startDate" type="date" />
        </div><!-- /.form-row -->

        <!-- 공개 범위 -->
        <fieldset class="form-row" style="margin-top:8px;">
          <legend>공개 범위</legend>
          <label class="radio">
            <input type="radio" name="visibility" value="private" checked>
            비공개
          </label>
          <label class="radio" style="margin-left:16px;">
            <input type="radio" name="visibility" value="public">
            공개
          </label>
        </fieldset><!-- /fieldset.form-row -->

        <!-- 푸터 버튼 -->
        <div class="modal-footer" style="margin-top:16px; display:flex; justify-content:flex-end; gap:8px;">
          <button type="button" class="onb-btn" id="cc-cancel">취소</button>
          <button type="submit" class="onb-btn onb-primary">생성</button>
        </div><!-- /.modal-footer -->
      </form><!-- /#createChallengeForm -->
    </div><!-- /.modal-content -->
  </div><!-- /#createChallengeModal -->
</div><!-- /.container -->

<script>
document.addEventListener('DOMContentLoaded', () => {
  // --- 전역 변수 ---
  const auth = window.fastmateApp.auth;
  const db   = window.fastmateApp.db;
  let currentUser = null;
  let stopListeningToChallenge = null;
  let allChallenges = []; // 전체 챌린지 데이터 캐시
  let currentPage = 1;
  let currentUserProfile = null;    // ✅ 추가
let currentChallengeId = null;    // ✅ 추가
  const ITEMS_PER_PAGE = 20; // 페이지 당 20개씩

  // --- DOM 요소 ---
  const pageHeader = document.getElementById('pageHeader');
  const challengeListView = document.getElementById('challengeListView');
  const challengeListDiv = document.getElementById('challengeList');
  const paginationControls = document.getElementById('paginationControls');
  const challengeDetailView = document.getElementById('challengeDetailView');
  const challengeInfoDiv = document.getElementById('challengeInfo');
  const commentFeed = document.getElementById('commentFeed');

  // --- 뷰 관리 ---
  
  
function showView(viewName, challengeId = null) {
  challengeListView.style.display = 'none';
  challengeDetailView.style.display = 'none';
  if (stopListeningToChallenge) stopListeningToChallenge();

  if (viewName === 'list') {
    currentChallengeId = null;                // ✅ 리셋
    challengeListView.style.display = 'block';
    renderListHeader();
    loadAndRenderChallenges();
  } else if (viewName === 'detail' && challengeId) {
    currentChallengeId = challengeId;         // ✅ 보관
    challengeDetailView.style.display = 'block';
    listenToChallengeDetails(challengeId);
  }
}


  // --- 헤더 렌더링 ---
  function renderListHeader() {
    pageHeader.innerHTML = `
      <button class="header-btn" title="메인으로" onclick="location.href='fastmate.html'">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
      </button>
      <div class="page-title-group">
        <h1 class="page-title">챌린지</h1>
        <span class="beta-tag">BETA</span>
      </div>
      <button class="create-challenge-btn" id="createChallengeBtnHeader">챌린지 만들기</button>
    `;

  // ✅ 모달 오픈 연결
  document.getElementById('createChallengeBtnHeader')?.addEventListener('click', () => {
    document.getElementById('createChallengeModal').style.display = 'flex';
  });
  document.getElementById('closeCreateChallengeModalBtn')?.addEventListener('click', () => {
    document.getElementById('createChallengeModal').style.display = 'none';
  });
}

// 모달 핸들러 바인딩
// ===== 모달(열기/닫기) + 폼 제출: 단일 위임 버전 =====
(function bindCreateModalOnce () {
  if (window.__BIND_CREATE_MODAL__) return;
  window.__BIND_CREATE_MODAL__ = true;

  // 클릭 위임: 어디서든 동작
  document.addEventListener('click', (e) => {
    const modal = document.getElementById('createChallengeModal');
    if (!modal) return;

    const openBtn  = e.target.closest('#createChallengeBtnHeader');
    const closeBtn = e.target.closest('#closeCreateChallengeModalBtn, #cc-cancel');

    if (openBtn) {
      modal.style.display = 'flex';
      const sel = document.getElementById('fastingModelSelect');
      if (sel) sel.value = localStorage.getItem('fm_model') || '16';
      return;
    }
    if (closeBtn) { modal.style.display = 'none'; return; }
    if (e.target === modal) modal.style.display = 'none'; // 오버레이 클릭 닫기
  });

  // 제출 위임: 생성 폼만 가로챔
  document.addEventListener('submit', async (e) => {
    const form = e.target.closest('#createChallengeForm');
    if (!form) return;
    e.preventDefault();

    if (!currentUser) { alert('로그인이 필요합니다'); return; }

    const desc         = (document.getElementById('cc-desc').value || '').trim();
    const startDateVal = document.getElementById('cc-start').value || null;
    const visibility   = (document.querySelector('input[name="visibility"]:checked')?.value) || 'private';

    // 단식 모델
    const sel          = document.getElementById('fastingModelSelect');
    const modelMinutes = parseInt(sel?.value || '16', 10);
    let modelLabel     = sel?.selectedOptions?.[0]?.textContent || '16:8';
    modelLabel         = modelLabel.split('(')[0].trim();
    try { localStorage.setItem('fm_model', String(modelMinutes)); } catch {}

    // 호스트 닉네임/프로필
    const ownerName     = currentUserProfile?.nickname || currentUser.displayName || '사용자';
    const ownerPhotoURL = currentUserProfile?.photoURL || currentUser.photoURL || null;

    // 제목: <호스트닉네임 + 단식모델>
    const finalName = `${ownerName} ${modelLabel}`;

    // Timestamp
    const startTs = startDateVal
      ? firebase.firestore.Timestamp.fromDate(new Date(startDateVal))
      : firebase.firestore.FieldValue.serverTimestamp();

    // 날짜/시간 캐시
    const fmtDate = (d) => { try { return d.toLocaleDateString('ko-KR', {year:'numeric',month:'2-digit',day:'2-digit'});} catch { return '-'; } };
    const fmtTime = (d) => { try { return d.toLocaleTimeString('ko-KR', {hour:'2-digit',minute:'2-digit'});} catch { return '-'; } };
    let startDateStr = '-', startTimeStr = '-';
    if (startDateVal) {
      const d = new Date(startDateVal);
      startDateStr = fmtDate(d);
      startTimeStr = fmtTime(d);
    }

    try {
      // Firestore payload
      const payload = {
        // 쿼리/권한
        startTime: startTs,
        participantUids: [currentUser.uid],
        hostUid: currentUser.uid,

        // 표시/메타
        challengeName: finalName,
        description: desc,
        hostName: ownerName,
        ownerName,
        ownerPhotoURL,
        visibility,
        isBeta: true,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        memberCount: 1,

        // 모델
        fastingModelMinutes: modelMinutes,
        fastingModelLabel: modelLabel,

        // 날짜/시간 캐시
        startDateStr,
        startClockStr: startTimeStr
      };

      const docRef = await db.collection('challenges').add(payload);

      // 멤버(호스트) 등록
      await db.collection('challenges').doc(docRef.id)
        .collection('members').doc(currentUser.uid)
        .set({
          uid: currentUser.uid,
          nickname: ownerName,
          photoURL: ownerPhotoURL || null,
          role: 'owner',
          joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
        });

      // (선택) 개인 단식 → 그룹단식 전환
      if (typeof switchToGroupFasting === 'function') {
        try { await switchToGroupFasting(currentUser.uid, docRef.id, modelMinutes, startTs); } catch {}
      }

      // 닫기 + 목록 갱신
      const modal = document.getElementById('createChallengeModal');
      if (modal) modal.style.display = 'none';
      showView('list');
    } catch (err) {
      console.error('챌린지 생성 오류:', err);
      alert('챌린지 생성 중 오류가 발생했습니다');
    }
  });
})();

  // --- 챌린지 목록 (페이징 적용) ---
  async function loadAndRenderChallenges() {
    if (!currentUser) return;
    challengeListDiv.innerHTML = "<p>챌린지 목록을 불러오는 중...</p>";
    
    try {
      const query = db.collection('challenges')
        .where('participantUids', 'array-contains', currentUser.uid)
        .orderBy('startTime', 'desc');
      const snapshot = await query.get();
      
      allChallenges = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      
      currentPage = 1;
      renderChallengePage();

    } catch (error) {
      console.error("챌린지 목록 로딩 실패:", error);
      challengeListDiv.innerHTML = '<p>목록을 불러오는 데 실패했습니다.</p>';
    }
  }

function renderChallengePage() {
  if (allChallenges.length === 0) {
    challengeListDiv.innerHTML = '<div class="challenge-card" style="text-align:center;"><p>아직 참여한 챌린지가 없습니다.</p></div>';
    paginationControls.innerHTML = '';
    return;
  }

  challengeListDiv.innerHTML = '';
  const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
  const endIndex   = startIndex + ITEMS_PER_PAGE;
  const pageItems  = allChallenges.slice(startIndex, endIndex);

  // --- 아이콘 경로 ---
  const peopleIcon = "https://res.cloudinary.com/dnswboo5z/image/upload/v1757595393/people_fh71ri.png";
  const dateIcon   = "https://res.cloudinary.com/dnswboo5z/image/upload/v1757595328/date_w4uttj.png";
  const timeIcon   = "https://res.cloudinary.com/dnswboo5z/image/upload/v1757595327/time-dark_auvyve.png";
  const goalIcon   = "https://res.cloudinary.com/dnswboo5z/image/upload/v1757595329/goal_icon_ldahyt.png"; // 네가 준 링크

pageItems.forEach(challenge => {
    const card = document.createElement('div');
    card.className = 'challenge-card';

    const memberCount = Array.isArray(challenge.participantUids)
      ? challenge.participantUids.length
      : (challenge.memberCount || 1);

    const d = challenge.startTime?.toDate?.();
    const dateStr = challenge.startDateStr || (d ? d.toLocaleDateString('ko-KR') : '-');
    const timeStr = challenge.startClockStr || (d ? d.toLocaleTimeString('ko-KR', {hour:'2-digit', minute:'2-digit'}) : '-');
    const goalStr = challenge.detailedGoal ? escapeHTML(challenge.detailedGoal) : '-';

    card.innerHTML = `
      <div class="challenge-content">
        <h3>${escapeHTML(challenge.challengeName || '-')}</h3>
        <div class="challenge-meta">
          <div class="meta-row" style="display:flex;align-items:center;gap:0.6em;">
            <img src="${dateIcon}" alt="날짜" width="32" height="32" />
            <span>${dateStr}</span>
          </div>
          <div class="meta-row" style="display:flex;align-items:center;gap:0.6em;">
            <img src="${timeIcon}" alt="시간" width="32" height="32" />
            <span>${timeStr}</span>
          </div>
          <div class="meta-row" style="display:flex;align-items:center;gap:0.6em;">
            <img src="${peopleIcon}" alt="참여자" width="32" height="32" />
            <span>${memberCount}명</span>
          </div>
          <div class="meta-row" style="display:flex;align-items:center;gap:0.6em;">
            <img src="${goalIcon}" alt="목표" width="32" height="32" />
            <span>${goalStr}</span>
          </div>
        </div>
      </div>
    `;

    if (challenge && challenge.id) {
      card.addEventListener('click', () => showView('detail', challenge.id));
    }
    challengeListDiv.appendChild(card);
  });

  renderPagination();
}

  function renderPagination() {
    const totalPages = Math.ceil(allChallenges.length / ITEMS_PER_PAGE);
    if (totalPages <= 1) {
      paginationControls.innerHTML = '';
      return;
    }

    paginationControls.innerHTML = `
      <button id="prevPageBtn" ${currentPage === 1 ? 'disabled' : ''}>이전</button>
      <span class="page-number">${currentPage} / ${totalPages}</span>
      <button id="nextPageBtn" ${currentPage === totalPages ? 'disabled' : ''}>다음</button>
    `;

    document.getElementById('prevPageBtn')?.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        renderChallengePage();
      }
    });
    document.getElementById('nextPageBtn')?.addEventListener('click', () => {
      if (currentPage < totalPages) {
        currentPage++;
        renderChallengePage();
      }
    });
  }


  // --- 챌린지 상세 및 댓글 ---
function listenToChallengeDetails(challengeId) {
  const ref = db.collection('challenges').doc(challengeId);
  stopListeningToChallenge = ref.onSnapshot(doc => {
    if (!doc.exists) {
      alert("삭제되었거나 존재하지 않는 챌린지입니다.");
      return showView('list');
    }
    const challenge = { id: doc.id, ...doc.data() };
    currentChallengeId = challenge.id;
    renderDetailHeader(challenge);
    renderChallengeInfo(challenge);
    renderComments(challenge.id);
  });
}

function renderDetailHeader(challenge) {
  pageHeader.innerHTML = `
    <button class="header-btn" id="backToListBtn">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
    </button>
    <div class="page-title-group">
      <h1 class="page-title" style="font-size: 1.2rem;">${escapeHTML(challenge.challengeName)}</h1>
      <span class="beta-tag">BETA</span>
    </div>
    <div style="width: 40px;"></div>
  `;
  document.getElementById('backToListBtn')?.addEventListener('click', () => showView('list'));
}  


function renderChallengeInfo(ch) {
  const $info = document.getElementById('challengeInfo');
  if (!$info) return;

  const peopleIcon = 'https://res.cloudinary.com/dnswboo5z/image/upload/v1757491598/people_qhprqx.png';
  const dateIcon   = 'https://res.cloudinary.com/dnswboo5z/image/upload/v1757491598/date_dqqkwp.png';
  const goalIcon   = 'https://res.cloudinary.com/dnswboo5z/image/upload/v1757491598/goal_icon_jlglbt.png';
  const linkIcon   = 'https://res.cloudinary.com/dnswboo5z/image/upload/v1757595328/link2_r0oqsl.png';
  const timeIcon   = 'https://res.cloudinary.com/dnswboo5z/image/upload/v1757491598/time_t4ooih.png';

  // 보조 포맷(백업)
  const d = ch.startTime?.toDate?.();
  const backupDate = d ? d.toLocaleDateString('ko-KR', { year:'numeric', month:'2-digit', day:'2-digit' }) : '-';
  const backupTime = d ? d.toLocaleTimeString('ko-KR', { hour:'2-digit', minute:'2-digit' }) : '-';

  const dateStr = ch.startDateStr || backupDate;
  const timeStr = ch.startClockStr || backupTime;

  const memberCount = Array.isArray(ch.participantUids) ? ch.participantUids.length : (ch.memberCount || 1);
  const hostName = ch.hostName || ch.ownerName || '방장';

  $info.innerHTML = `
    <div class="card challenge-details">
      <div class="challenge-title-row">
        <h2 class="challenge-title">${escapeHTML(ch.challengeName || '-')}</h2>
        <span class="beta-tag">BETA</span>
      </div>

      <p class="challenge-desc">${escapeHTML(ch.description || '')}</p>

      <ul class="challenge-meta-list">
        <li class="meta-item">
          <img src="${peopleIcon}" alt="참여자" width="32" height="32" />
          <div class="meta-text">
            <div class="meta-label">참여자</div>
            <div class="meta-value">${memberCount}명 · 방장: ${escapeHTML(hostName)}</div>
          </div>
        </li>

        <li class="meta-item">
          <img src="${dateIcon}" alt="날짜" width="32" height="32" />
          <div class="meta-text">
            <div class="meta-label">날짜</div>
            <div class="meta-value">${dateStr}</div>
          </div>
        </li>

        <li class="meta-item">
          <img src="${timeIcon}" alt="시작시간" width="32" height="32" />
          <div class="meta-text">
            <div class="meta-label">시작시간</div>
            <div class="meta-value">${timeStr}</div>
          </div>
        </li>

        <li class="meta-item">
          <img src="${goalIcon}" alt="목표" width="32" height="32" />
          <div class="meta-text">
            <div class="meta-label">목표</div>
            <div class="meta-value">-</div>
          </div>
        </li>

        <li class="meta-item">
          <img src="${linkIcon}" alt="링크 공유" width="32" height="32" />
          <div class="meta-text">
            <div class="meta-label">링크 공유</div>
            <div class="meta-value">
              <button class="onb-btn" id="shareLinkBtn">복사</button>
            </div>
          </div>
        </li>
      </ul>
    </div>
  `;


 allChallenges = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

  // 링크 복사(상세 URL)
  document.getElementById('shareLinkBtn')?.addEventListener('click', async () => {
    const url = `${location.origin}${location.pathname}?c=${encodeURIComponent(ch.id)}`;
    try { await navigator.clipboard.writeText(url); alert('링크 복사됨'); }
    catch { prompt('아래 링크를 복사하세요', url); }
  });
}

  async function renderComments(challengeId) {
    const snapshot = await db.collection('challenges').doc(challengeId)
      .collection('comments').orderBy('timestamp', 'asc').get();

    commentFeed.innerHTML = ''; // 댓글 피드 초기화
    
    const comments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    const commentTree = {}; // { parentId: [child, child] }
    const commentMap = {}; // { commentId: commentData }

    comments.forEach(c => {
        commentMap[c.id] = c;
        if (c.parentId) {
            if (!commentTree[c.parentId]) commentTree[c.parentId] = [];
            commentTree[c.parentId].push(c);
        }
    });

    comments.filter(c => !c.parentId).forEach(comment => {
        const replies = commentTree[comment.id] || [];
        const commentDiv = createCommentElement(comment, replies);
        commentFeed.appendChild(commentDiv);

        // 자식 댓글 렌더링
        const repliesContainer = commentDiv.querySelector('.replies-container');
        if (repliesContainer) {
            replies.forEach(reply => {
                repliesContainer.appendChild(createCommentElement(reply, [], true));
            });
        }
    });
  }

  function createCommentElement(comment, replies = [], isReply = false) {
  const div = document.createElement('div');
  div.className = 'comment';
  const isMyComment = currentUser && currentUser.uid === comment.uid;

  const avatarHtml = comment.photoURL
    ? `<img src="${comment.photoURL}" alt="${escapeHTML(comment.nickname)}" class="comment-avatar">`
    : `<div class="comment-avatar" style="background-color: var(--primary-light);">
         <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--primary-color);"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
       </div>`;

  const ts = comment.timestamp?.toDate()?.toLocaleString('ko-KR', { hour: '2-digit', minute: '2-digit' }) || '';

  div.innerHTML = `
    <div class="comment-avatar-column">
      ${avatarHtml}
      ${!isReply && replies.length > 0 ? '<div class="thread-line"></div>' : ''}
    </div>
    <div class="comment-main">
      <div class="comment-header">
        <div class="comment-author-info">
          <span class="comment-author">${escapeHTML(comment.nickname)}</span>
          <span class="comment-timestamp">${ts}</span>
        </div>
        ${isMyComment ? `
        <div class="comment-options">
          <button class="comment-options-btn">•••</button>
          <div class="options-menu">
            <button class="edit-comment-btn" data-id="${comment.id}">수정</button>
            <button class="delete-comment-btn" data-id="${comment.id}">삭제</button>
          </div>
        </div>` : ``}
      </div>

      <div class="comment-text">${linkify(comment.text)}</div>

      <div class="comment-actions">
        <div class="reply-info">
          <div class="reply-info-item">
            <!-- 말풍선 아이콘 + 답글 수 -->
            <svg viewBox="0 0 24 24"><path d="M21 15a4 4 0 0 1-4 4H7l-4 4V5a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"/></svg>
            <span>${replies.length}</span>
          </div>
        </div>
        ${!isReply ? `<button class="reply-btn" data-target="${comment.id}">reply</button>` : ``}
      </div>

      ${!isReply ? `
      <div class="reply-form" id="rf-${comment.id}" style="display:none; gap:8px; margin-top:8px;">
        <textarea class="reply-text" placeholder="답글 입력..." rows="1" style="flex:1;"></textarea>
        <button class="onb-btn onb-primary reply-submit" data-target="${comment.id}">등록</button>
      </div>` : ``}

      ${!isReply ? `<div class="replies-container" style="margin-left:12px; margin-top:10px;"></div>` : ``}
    </div>
  `;

  // 내 댓글 옵션 토글
  const optionsBtn = div.querySelector('.comment-options-btn');
  if (optionsBtn) {
    optionsBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      const menu = optionsBtn.nextElementSibling;
      menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
    });
  }
  return div;
}

  
 commentFeed.addEventListener('click', async (e) => {
        const replyBtn = e.target.closest('.reply-btn');
        const submitBtn = e.target.closest('.reply-submit');

        if (replyBtn) {
            const parentId = replyBtn.dataset.target;
            const form = document.getElementById(`rf-${parentId}`);
            if (form) {
                document.querySelectorAll('.reply-form').forEach(f => {
                    if (f.id !== `rf-${parentId}`) f.style.display = 'none';
                });
                form.style.display = form.style.display === 'none' ? 'flex' : 'none';
            }
            return;
        }

        if (submitBtn) {
            const parentId = submitBtn.dataset.target;
            const form = document.getElementById(`rf-${parentId}`);
            const textarea = form?.querySelector('.reply-text');
            const text = textarea?.value.trim();

            if (!text || !currentUser || !currentChallengeId) return;

            submitBtn.disabled = true;
            try {
                await db.collection('challenges').doc(currentChallengeId).collection('comments').add({
                    uid: currentUser.uid,
                    nickname: currentUserProfile.nickname || currentUser.displayName || '사용자',
                    photoURL: currentUser.photoURL || null,
                    text,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    isAutoComment: false,
                    parentId: parentId
                });
                textarea.value = '';
                form.style.display = 'none';
            } catch (err) {
                console.error('답글 등록 오류:', err);
                alert('답글 등록에 실패했습니다.');
            } finally {
                submitBtn.disabled = false;
            }
        }
    });
  

  // --- 헬퍼 함수 ---
  function escapeHTML(s) { return String(s || '').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }
  function linkify(text) {
    const safe = escapeHTML(text);
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    return safe.replace(urlRegex, url => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
  }

  // --- 초기화 ---
  auth.onAuthStateChanged(user => {
      if (user) {
    currentUser = user;
    // 닉네임/사진 기본값 준비
    currentUserProfile = {
      nickname: user.displayName || '사용자',
      photoURL: user.photoURL || null,
    };
    showView('list');
  } else {
    currentUser = null;
    document.body.innerHTML = `<div class="container" style="text-align:center; padding-top: 50px;">챌린지 기능을 사용하려면 로그인이 필요합니다.</div>`;
  }
});

  // 클릭 시 열려있는 ... 메뉴 닫기
  document.addEventListener('click', () => {
    document.querySelectorAll('.options-menu').forEach(menu => menu.style.display = 'none');
  });
})
</script>

</body>
</html>
