<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Fastmate - ì±Œë¦°ì§€</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="/firebase-init.js?v=2025.09.06-v8"></script>
  <style>
    /* --- ê¸°ë³¸ & ë‹¤í¬ëª¨ë“œ ìƒ‰ìƒ ë³€ìˆ˜ --- */
    :root {
      --primary-color: #1c8e3e; /* ì´ˆë¡ìƒ‰ */
      --primary-light: #e8f5e9;
      --bg-color: #f8f9fa;
      --card-bg: #FFFFFF;
      --text-color: #212529;
      --text-light: #6c757d;
      --border-color: #e9ecef;
      --yellow-color: #ffc107;
      --yellow-bg-color: #fff3cd;
    }

    /* ë‹¤í¬ëª¨ë“œ ìŠ¤íƒ€ì¼ (í•„ìš”ì‹œ bodyì— 'dark-mode' í´ë˜ìŠ¤ ì¶”ê°€) */
    body.dark-mode {
      --primary-color: #4caf50;
      --primary-light: #2c3e50;
      --bg-color: #121212;
      --card-bg: #1e1e1e;
      --text-color: #e0e0e0;
      --text-light: #9e9e9e;
      --border-color: #333333;
    }

    /* --- ê¸°ë³¸ ë ˆì´ì•„ì›ƒ --- */
    body { 
      background-color: var(--bg-color); 
      font-family: 'Noto Sans KR', sans-serif; 
      margin: 0; 
      color: var(--text-color);
    }
    .container { 
      max-width: 800px; /* fastmate.htmlê³¼ ë™ì¼í•œ í­ */
      margin: 0 auto; 
      padding: 20px; 
    }

    /* --- í—¤ë” --- */
    .page-header { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      margin-bottom: 25px; 
    }
    .page-title-group { 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }
    .page-title { 
      font-size: 1.5rem; 
      font-weight: 700; 
      color: var(--primary-color); 
      margin: 0; 
    }
    .beta-tag { 
      background-color: var(--yellow-bg-color); 
      color: #664d03;
      font-size: 0.75rem; 
      font-weight: bold; 
      padding: 4px 8px; 
      border-radius: 8px; 
      border: 1px solid var(--yellow-color);
    }
    .header-actions { display: flex; align-items: center; gap: 10px; }
    .header-btn { 
      background: none; 
      border: none; 
      cursor: pointer; 
      padding: 0; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      width: 40px; 
      height: 40px; 
      color: var(--text-light); 
      transition: color 0.2s; 
    }
    .header-btn:hover { color: var(--primary-color); }
    .create-challenge-btn {
      background-color: var(--primary-color);
      color: white;
      border-radius: 8px;
      font-weight: bold;
      font-size: 0.9rem;
      padding: 0 16px;
      height: 40px;
      border: none;
      cursor: pointer;
    }

    /* --- í•„í„° --- */
    .filter-bar { margin-bottom: 20px; display: flex; gap: 10px; }
    .filter-btn { 
      background: var(--card-bg); 
      border: 1px solid var(--border-color); 
      color: var(--text-light); 
      padding: 8px 16px; 
      border-radius: 20px; 
      cursor: pointer; 
      font-weight: 500; 
    }
    .filter-btn.active { 
      background-color: var(--primary-light); 
      color: var(--primary-color); 
      border-color: var(--primary-color); 
      font-weight: bold; 
    }
        
    /* --- ì±Œë¦°ì§€ ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ --- */
    .challenge-card {
      background: var(--card-bg); 
      border-radius: 12px; 
      padding: 20px; 
      margin-bottom: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); /* ìŒì˜ íš¨ê³¼ */
      cursor: pointer; 
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex; 
      align-items: center; 
      gap: 16px;
    }
    .challenge-card:hover { transform: translateY(-3px); box-shadow: 0 6px 16px rgba(0,0,0,0.12); }
    .challenge-icon { width: 32px; height: 32px; flex-shrink: 0; } /* ì•„ì´ì½˜ í¬ê¸° 32x32 */
    .challenge-content h3 { margin: 0 0 8px; font-size: 1.1rem; }
    .challenge-meta { font-size: 0.85rem; color: var(--text-light); }
    
    /* --- í˜ì´ì§• --- */
    .pagination { text-align: center; margin-top: 30px; display: flex; gap: 8px; justify-content: center; align-items: center;}
    .pagination button { 
      background-color: var(--card-bg);
      border: 1px solid var(--border-color); 
      color: var(--text-color);
      padding: 8px 12px; 
      border-radius: 8px; 
      cursor: pointer; 
      font-weight:500;
    }
    .pagination button:disabled { cursor: not-allowed; opacity: 0.5; background: var(--bg-color); }
    .pagination .page-number { font-weight: bold; padding: 0 10px; }

    /* --- ì±Œë¦°ì§€ ìƒì„¸ ì •ë³´ --- */
    .challenge-info-card {
      background: var(--card-bg); 
      border-radius: 12px; 
      padding: 20px;
      margin-bottom: 30px; 
      border: 1px solid var(--border-color); 
      position: relative;
    }
    .challenge-info-card p { display: flex; align-items: center; } /* ì•„ì´ì½˜ê³¼ í…ìŠ¤íŠ¸ ì •ë ¬ */
    .delete-challenge-btn {
      position: absolute; top: 15px; right: 15px; background: var(--border-color); color: var(--text-light);
      border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 20px;
      line-height: 28px; text-align: center; cursor: pointer; transition: all 0.2s;
    }
    .delete-challenge-btn:hover { background-color: #ced4da; color: var(--text-color); }
    body.dark-mode .delete-challenge-btn { background-color: #333; }
    body.dark-mode .delete-challenge-btn:hover { background-color: #555; }
    
    /* --- ëŒ“ê¸€ (Threads UI) --- */
    .comment-section { padding-top: 20px; }
    .comment { display: flex; gap: 12px; margin-bottom: 20px; position: relative; }
    .comment-avatar-column { display: flex; flex-direction: column; align-items: center; }
    .comment-avatar {
      width: 32px; height: 32px; border-radius: 50%; /* ì‘ê³  ë™ê·¸ë€ í”„ë¡œí•„ */
      background-color: var(--primary-light); color: var(--primary-color);
      display: flex; align-items: center; justify-content: center;
      font-weight: bold; flex-shrink: 0; object-fit: cover;
    }
    .thread-line { /* ë‹µê¸€ ì—°ê²°ì„  */
      width: 2px; 
      background-color: var(--border-color); 
      flex-grow: 1; 
      margin-top: 8px; 
    }
    .comment-main { flex-grow: 1; }
    .comment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .comment-author-info { display: flex; align-items: center; gap: 8px; }
    .comment-author { font-weight: bold; font-size: 0.95rem; color: var(--text-color);}
    .comment-timestamp { font-size: 0.85rem; color: var(--text-light); }
    .comment-options-btn { background: none; border:none; cursor: pointer; padding: 5px; color: var(--text-light); }
    
    .comment-text { margin: 0 0 8px; white-space: pre-wrap; word-break: break-word; line-height: 1.6; }
    .comment-actions { display: flex; align-items: center; justify-content: space-between; }
    .reply-info { display: flex; align-items: center; gap: 8px; color: var(--text-light); font-size: 0.85rem; }
    .reply-info-item { display: flex; align-items: center; gap: 4px; }
    .reply-info-item svg { width: 16px; height: 16px; }
    .reply-btn { background: none; border: none; color: var(--text-light); font-weight: 600; font-size: 0.85rem; cursor: pointer; padding: 4px; }
    
    /* ë‚´ ëŒ“ê¸€ ì˜µì…˜(...) ë©”ë‰´ */
    .comment-options { position: relative; }
    .options-menu {
      display: none;
      position: absolute;
      right: 0;
      top: 24px;
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      z-index: 10;
      width: 100px;
      overflow: hidden;
    }
    .options-menu button {
      display: block;
      width: 100%;
      padding: 10px 12px;
      background: none;
      border: none;
      color: var(--text-color);
      text-align: left;
      cursor: pointer;
    }
    .options-menu button:hover { background-color: var(--bg-color); }
    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .onb-input, .onb-btn { /* ê°„ë‹¨í•œ ìŠ¤íƒ€ì¼, í•„ìš”ì‹œ fastmate.css ì°¸ì¡° */
        width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 8px; border: 1px solid var(--border-color);
    }
    .onb-btn.onb-primary { background-color: var(--primary-color); color: white; border: none; }
  </style>
</head>
<body>

  <div class="container">
    <header id="pageHeader" class="page-header"></header>
    
    <div id="challengeListView" style="display: none;">
      <div class="filter-bar">
        <button class="filter-btn active" data-filter="public">ê³µê°œ</button>
        <button class="filter-btn" data-filter="private">ë¹„ê³µê°œ</button>
      </div>
      <div id="challengeList"></div>
      <div id="paginationControls" class="pagination"></div>
    </div>
    
    <div id="challengeDetailView" style="display: none;">
      <div id="challengeInfo" class="challenge-info-card">
        <!-- ì±Œë¦°ì§€ ì •ë³´ê°€ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤. -->
      </div>

      <div class="comment-section">
        <div id="commentFeed"></div>
      </div>
    </div>
  </div>

  <!-- ì±Œë¦°ì§€ ìƒì„± ëª¨ë‹¬ -->
  <div id="createChallengeModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center; padding:20px; display: none;">
    <div style="background: var(--card-bg); padding:25px; border-radius:16px; width:100%; max-width:420px; box-sizing: border-box;">
      <h3 style="margin-top:0;">ìƒˆë¡œìš´ ì±Œë¦°ì§€ ë§Œë“¤ê¸°</h3>
      <label>ë‹¨ì‹ ê³„íš</label>
      <select id="challengeModelSelect" class="onb-input">
        <option value="16">16:8 (16ì‹œê°„ ë‹¨ì‹,ì¸ê¸°)</option>
        <option value="18">18:6 (18ì‹œê°„ ë‹¨ì‹,ì¸ê¸°)</option>
        <option value="20">20:4 (20ì‹œê°„ ë‹¨ì‹,ê³ ê¸‰)</option>
        <option value="12">12:12 (12ì‹œê°„ ë‹¨ì‹,ì´ˆë³´)</option>
      </select>
      <label>ì‹œì‘ ë‚ ì§œ</label>
      <input type="date" id="challengeDatePicker" class="onb-input">
      <label>ì‹œì‘ ì‹œê°„</label>
      <input type="time" id="challengeTimePicker" class="onb-input">
      <label>ì„¸ë¶€ ëª©í‘œ (ì„ íƒ)</label>
      <textarea id="challengeDetailedGoal" class="onb-input" placeholder="ì˜ˆ: ë§¤ì¼ 30ë¶„ ìš´ë™í•˜ê¸°"></textarea>
      <div>
        <button type="button" id="closeCreateChallengeModalBtn" class="onb-btn">ì·¨ì†Œ</button>
        <button type="button" id="saveChallengeBtn" class="onb-btn onb-primary">ì €ì¥í•˜ê³  ì¹œêµ¬ ì´ˆëŒ€í•˜ê¸°</button>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // --- ì „ì—­ ë³€ìˆ˜ ---
  const auth = window.fastmateApp.auth;
  const db   = window.fastmateApp.db;
  let currentUser = null;
  let stopListeningToChallenge = null;
  let allChallenges = []; // ì „ì²´ ì±Œë¦°ì§€ ë°ì´í„° ìºì‹œ
  let currentPage = 1;
  const ITEMS_PER_PAGE = 20; // í˜ì´ì§€ ë‹¹ 20ê°œì”©

  // --- DOM ìš”ì†Œ ---
  const pageHeader = document.getElementById('pageHeader');
  const challengeListView = document.getElementById('challengeListView');
  const challengeListDiv = document.getElementById('challengeList');
  const paginationControls = document.getElementById('paginationControls');
  const challengeDetailView = document.getElementById('challengeDetailView');
  const challengeInfoDiv = document.getElementById('challengeInfo');
  const commentFeed = document.getElementById('commentFeed');
  // ëª¨ë‹¬ DOM ìš”ì†Œ ì¶”ê°€
  const createChallengeModal = document.getElementById('createChallengeModal');
  const closeCreateChallengeModalBtn = document.getElementById('closeCreateChallengeModalBtn');
  const saveChallengeBtn = document.getElementById('saveChallengeBtn');
  const challengeModelSelect = document.getElementById('challengeModelSelect');
  const challengeDatePicker = document.getElementById('challengeDatePicker');
  const challengeTimePicker = document.getElementById('challengeTimePicker');
  const challengeDetailedGoal = document.getElementById('challengeDetailedGoal');


  // --- ë·° ê´€ë¦¬ ---
  function showView(viewName, challengeId = null) {
    challengeListView.style.display = 'none';
    challengeDetailView.style.display = 'none';
    if (stopListeningToChallenge) stopListeningToChallenge();

    if (viewName === 'list') {
      challengeListView.style.display = 'block';
      renderListHeader();
      loadAndRenderChallenges();
    } else if (viewName === 'detail' && challengeId) {
      challengeDetailView.style.display = 'block';
      listenToChallengeDetails(challengeId);
    }
  }

  // --- í—¤ë” ë Œë”ë§ ---
  function renderListHeader() {
    pageHeader.innerHTML = `
      <button class="header-btn" title="ë©”ì¸ìœ¼ë¡œ" onclick="location.href='fastmate.html'">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
      </button>
      <div class="page-title-group">
        <h1 class="page-title">ì±Œë¦°ì§€</h1>
        <span class="beta-tag">BETA</span>
      </div>
      <button class="create-challenge-btn" id="createChallengeBtnHeader">ì±Œë¦°ì§€ ë§Œë“¤ê¸°</button>
    `;
    // ìƒì„± ë²„íŠ¼ì— ëª¨ë‹¬ ì—¬ëŠ” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    document.getElementById('createChallengeBtnHeader').addEventListener('click', () => {
        createChallengeModal.style.display = 'flex';
    });
  }

  function renderDetailHeader(challenge) {
    const canShare = new Date() < challenge.startTime.toDate();
    const inviteUrl = `${location.origin}/challenge-invite.html?id=${challenge.id}&autojoin=1`;

     pageHeader.innerHTML = `
      <button class="header-btn" id="backToListBtn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
      </button>
      <div class="page-title-group">
        <h1 class="page-title" style="font-size: 1.2rem;">${escapeHTML(challenge.challengeName)}</h1>
      </div>
      ${canShare ? `
        <button id="shareBtn" class="header-btn" title="ì´ˆëŒ€ ë§í¬ ë³µì‚¬">
            <img src="https://res.cloudinary.com/dnswboo5z/image/upload/v1757491598/date_dqqkwp.png" style="width:24px; height:24px;" alt="Share">
        </button>` : `<div style="width: 40px;"></div>`}
    `;
    document.getElementById('backToListBtn').addEventListener('click', () => showView('list'));

    if (canShare) {
        document.getElementById('shareBtn').addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(inviteUrl);
                alert('ì´ˆëŒ€ ë§í¬ë¥¼ ë³µì‚¬í–ˆì–´ìš”!');
            } catch (err) {
                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
            }
        });
    }
  }

  // --- ì±Œë¦°ì§€ ëª©ë¡ (í˜ì´ì§• ì ìš©) ---
  async function loadAndRenderChallenges() {
    if (!currentUser) return;
    challengeListDiv.innerHTML = "<p>ì±Œë¦°ì§€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>";
    
    try {
      const query = db.collection('challenges')
        .where('participantUids', 'array-contains', currentUser.uid)
        .orderBy('startTime', 'desc');
      const snapshot = await query.get();
      
      allChallenges = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      
      currentPage = 1;
      renderChallengePage();

    } catch (error) {
      console.error("ì±Œë¦°ì§€ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:", error);
      challengeListDiv.innerHTML = '<p>ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
    }
  }

  function renderChallengePage() {
    if (allChallenges.length === 0) {
      challengeListDiv.innerHTML = '<div class="challenge-card" style="text-align:center;"><p>ì•„ì§ ì°¸ì—¬í•œ ì±Œë¦°ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>';
      paginationControls.innerHTML = '';
      return;
    }
    
    challengeListDiv.innerHTML = '';
    const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
    const endIndex = startIndex + ITEMS_PER_PAGE;
    const pageItems = allChallenges.slice(startIndex, endIndex);

    pageItems.forEach(challenge => {
        const card = document.createElement('div');
        card.className = 'challenge-card';
        card.innerHTML = `
            <img src="https://placehold.co/32x32/e8f5e9/1c8e3e?text=ğŸ†" class="challenge-icon" alt="ì±Œë¦°ì§€ ì•„ì´ì½˜">
            <div class="challenge-content">
              <h3>${escapeHTML(challenge.challengeName)}</h3>
              <div class="challenge-meta">
                <span>ì°¸ì—¬ ${challenge.participantUids.length}ëª…</span> | 
                <span>ì‹œì‘ ${challenge.startTime.toDate().toLocaleDateString()}</span>
              </div>
            </div>
        `;
        card.addEventListener('click', () => showView('detail', challenge.id));
        challengeListDiv.appendChild(card);
    });

    renderPagination();
  }

  function renderPagination() {
    const totalPages = Math.ceil(allChallenges.length / ITEMS_PER_PAGE);
    if (totalPages <= 1) {
      paginationControls.innerHTML = '';
      return;
    }

    paginationControls.innerHTML = `
      <button id="prevPageBtn" ${currentPage === 1 ? 'disabled' : ''}>ì´ì „</button>
      <span class="page-number">${currentPage} / ${totalPages}</span>
      <button id="nextPageBtn" ${currentPage === totalPages ? 'disabled' : ''}>ë‹¤ìŒ</button>
    `;

    document.getElementById('prevPageBtn')?.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        renderChallengePage();
      }
    });
    document.getElementById('nextPageBtn')?.addEventListener('click', () => {
      if (currentPage < totalPages) {
        currentPage++;
        renderChallengePage();
      }
    });
  }


  // --- ì±Œë¦°ì§€ ìƒì„¸ ë° ëŒ“ê¸€ ---
  function listenToChallengeDetails(challengeId) {
    const challengeRef = db.collection('challenges').doc(challengeId);
    stopListeningToChallenge = challengeRef.onSnapshot(doc => {
      if (!doc.exists) {
        alert("ì‚­ì œë˜ì—ˆê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì±Œë¦°ì§€ì…ë‹ˆë‹¤.");
        return showView('list');
      }
      const challenge = { id: doc.id, ...doc.data() };
      renderDetailHeader(challenge);
      renderChallengeInfo(challenge);
      renderComments(challengeId);
    }, (error) => {
      console.error("ì‹¤ì‹œê°„ ì±Œë¦°ì§€ ê°ì§€ ì˜¤ë¥˜:", error);
      showView('list');
    });
  }
  
  function renderChallengeInfo(challenge) {
    const isHost = currentUser && currentUser.uid === challenge.hostUid;
    const iconStyle = "width:20px; height:20px; vertical-align:middle; margin-right:8px;";
    challengeInfoDiv.innerHTML = `
      ${isHost ? '<button class="delete-challenge-btn" title="ì±Œë¦°ì§€ ì‚­ì œ">&times;</button>' : ''}
      <p><img src="https://res.cloudinary.com/dnswboo5z/image/upload/v1757491598/date_dqqkwp.png" style="${iconStyle}" alt="ëª©í‘œ ì•„ì´ì½˜"><b>ëª©í‘œ:</b> ${escapeHTML(challenge.detailedGoal || 'ì—†ìŒ')}</p>
      <p><img src="https://res.cloudinary.com/dnswboo5z/image/upload/v1757491598/people_qhprqx.png" style="${iconStyle}" alt="ì°¸ì—¬ì ì•„ì´ì½˜"><b>ì°¸ì—¬ì:</b> ${challenge.participantUids.length}ëª…</p>
      <p><img src="https://res.cloudinary.com/dnswboo5z/image/upload/v1757491598/date_dqqkwp.png" style="${iconStyle}" alt="ì‹œì‘ì¼ ì•„ì´ì½˜"><b>ì‹œì‘ì¼:</b> ${challenge.startTime.toDate().toLocaleString()}</p>
    `;

    if (isHost) {
      challengeInfoDiv.querySelector('.delete-challenge-btn').addEventListener('click', async () => {
        // Firebase ê·œì¹™ìƒ confirm ì‚¬ìš© ë¶ˆê°€. ì‹¤ì œ ì•±ì—ì„œëŠ” ëª¨ë‹¬ UIë¡œ ëŒ€ì²´í•´ì•¼ í•©ë‹ˆë‹¤.
        console.log("Delete button clicked. Confirmation needed.");
        // await db.collection('challenges').doc(challenge.id).delete();
      });
    }
  }

  async function renderComments(challengeId) {
    const snapshot = await db.collection('challenges').doc(challengeId)
      .collection('comments').orderBy('timestamp', 'asc').get();

    commentFeed.innerHTML = ''; // ëŒ“ê¸€ í”¼ë“œ ì´ˆê¸°í™”
    
    const comments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    const commentTree = {}; // { parentId: [child, child] }
    const commentMap = {}; // { commentId: commentData }

    comments.forEach(c => {
        commentMap[c.id] = c;
        if (c.parentId) {
            if (!commentTree[c.parentId]) commentTree[c.parentId] = [];
            commentTree[c.parentId].push(c);
        }
    });

    comments.filter(c => !c.parentId).forEach(comment => {
        const replies = commentTree[comment.id] || [];
        const commentDiv = createCommentElement(comment, replies);
        commentFeed.appendChild(commentDiv);

        // ìì‹ ëŒ“ê¸€ ë Œë”ë§
        const repliesContainer = commentDiv.querySelector('.replies-container');
        if (repliesContainer) {
            replies.forEach(reply => {
                repliesContainer.appendChild(createCommentElement(reply, [], true));
            });
        }
    });
  }

  function createCommentElement(comment, replies = [], isReply = false) {
    const div = document.createElement('div');
    div.className = 'comment';
    const isMyComment = currentUser && currentUser.uid === comment.uid;

    let avatarHtml;
    if (comment.photoURL) {
      avatarHtml = `<img src="${comment.photoURL}" alt="${escapeHTML(comment.nickname)}" class="comment-avatar">`;
    } else {
      avatarHtml = `<div class="comment-avatar" style="background-color: var(--primary-light);">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--primary-color);"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
      </div>`;
    }
    
    const timestamp = comment.timestamp?.toDate()?.toLocaleString('ko-KR', { hour: '2-digit', minute: '2-digit' }) || '';

    div.innerHTML = `
      <div class="comment-avatar-column">
        ${avatarHtml}
        ${replies.length > 0 ? '<div class="thread-line"></div>' : ''}
      </div>
      <div class="comment-main">
        <div class="comment-header">
          <div class="comment-author-info">
            <span class="comment-author">${escapeHTML(comment.nickname)}</span>
            <span class="comment-timestamp">${timestamp}</span>
          </div>
          ${isMyComment ? `
          <div class="comment-options">
            <button class="comment-options-btn">â€¢â€¢â€¢</button>
            <div class="options-menu">
              <button class="edit-comment-btn">ìˆ˜ì •</button>
              <button class="delete-comment-btn">ì‚­ì œ</button>
            </div>
          </div>
          ` : ''}
        </div>
        <div class="comment-text">${linkify(comment.text)}</div>
        <div class="comment-actions">
          <div class="reply-info">
            ${!isReply ? `
            <div class="reply-info-item">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18zM18 14H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"></path></svg>
              <span>${replies.length}</span>
            </div>` : ''}
          </div>
          ${!isReply ? `<button class="reply-btn">Reply</button>` : ''}
        </div>
        ${!isReply && replies.length > 0 ? '<div class="replies-container"></div>' : ''}
      </div>
    `;

    const optionsBtn = div.querySelector('.comment-options-btn');
    if (optionsBtn) {
      optionsBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const menu = optionsBtn.nextElementSibling;
        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
      });
    }
    return div;
  }
  
  // --- í—¬í¼ í•¨ìˆ˜ ---
  function escapeHTML(s) { return String(s || '').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }
  function linkify(text) {
    const safe = escapeHTML(text);
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    return safe.replace(urlRegex, url => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
  }

  // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ëª¨ë‹¬) ---
  closeCreateChallengeModalBtn.addEventListener('click', () => {
    createChallengeModal.style.display = 'none';
  });

  saveChallengeBtn.addEventListener('click', async () => {
    const fastingHours = parseInt(challengeModelSelect.value, 10);
    const dateString = challengeDatePicker.value;
    const timeString = challengeTimePicker.value;
    const detailedGoal = challengeDetailedGoal.value.trim();

    if (!dateString || !timeString) return alert('ì‹œì‘ ë‚ ì§œì™€ ì‹œê°„ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
    const startTimeDate = new Date(`${dateString}T${timeString}`);
    if (startTimeDate < new Date()) return alert('ì‹œì‘ ì‹œê°„ì€ í˜„ì¬ ì‹œê°„ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤.');

    saveChallengeBtn.disabled = true;
    saveChallengeBtn.textContent = 'ì €ì¥ ì¤‘...';

    try {
        const user = auth.currentUser;
        if (!user) throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');

        const challengeData = {
          hostUid: user.uid,
          hostNickname: user.displayName || 'ì‚¬ìš©ì',
          challengeName: `${user.displayName || 'ì‚¬ìš©ì'}ë‹˜ì˜ ${fastingHours}ì‹œê°„ ë‹¨ì‹`,
          fastingHours,
          detailedGoal: detailedGoal || '',
          startTime: firebase.firestore.Timestamp.fromDate(startTimeDate),
          status: 'upcoming',
          participantUids: [user.uid],
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          publicInvite: true
        };
        const docRef = await db.collection('challenges').add(challengeData);
        alert('ì±Œë¦°ì§€ ìƒì„± ì™„ë£Œ!');
        createChallengeModal.style.display = 'none';
        showView('list');
    } catch(error) {
        console.error("ì±Œë¦°ì§€ ìƒì„± ì˜¤ë¥˜:", error);
        alert("ì±Œë¦°ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    } finally {
        saveChallengeBtn.disabled = false;
        saveChallengeBtn.textContent = 'ì €ì¥í•˜ê³  ì¹œêµ¬ ì´ˆëŒ€í•˜ê¸°';
    }
  });


  // --- ì´ˆê¸°í™” ---
  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      showView('list');
    } else {
      currentUser = null;
      document.body.innerHTML = `<div class="container" style="text-align:center; padding-top: 50px;">ì±Œë¦°ì§€ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>`;
    }
  });

  document.addEventListener('click', () => {
    document.querySelectorAll('.options-menu').forEach(menu => menu.style.display = 'none');
  });

});
</script>

</body>
</html>

