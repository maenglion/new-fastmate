<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Fastmate - ì±Œë¦°ì§€</title>
   <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="/firebase-init.js?v=2025.09.06-v8"></script>
  <style>
    /* --- ê¸°ë³¸ & ë‹¤í¬ëª¨ë“œ ìƒ‰ìƒ ë³€ìˆ˜ --- */
    :root {
      --primary-color: #1c8e3e; /* ì´ˆë¡ìƒ‰ */
      --primary-light: #e8f5e9;
      --bg-color: #f8f9fa;
      --card-bg: #FFFFFF;
      --text-color: #212529;
      --text-light: #6c757d;
      --border-color: #e9ecef;
      --yellow-color: #ffc107;
      --yellow-bg-color: #fff3cd;
    }

    /* ë‹¤í¬ëª¨ë“œ ìŠ¤íƒ€ì¼ (í•„ìš”ì‹œ bodyì— 'dark-mode' í´ë˜ìŠ¤ ì¶”ê°€) */
    body.dark-mode {
      --primary-color: #4caf50;
      --primary-light: #2c3e50;
      --bg-color: #121212;
      --card-bg: #1e1e1e;
      --text-color: #e0e0e0;
      --text-light: #9e9e9e;
      --border-color: #333333;
    }

     /* ë‹¤í¬/ë¼ì´íŠ¸ ì•„ì´ì½˜ (fastmate ê¸°ë³¸ ë‹¤í¬ëª¨ë“œì™€ í•¨ê»˜ ë™ì‘) */
  :root{
    --icon-people: url("https://res.cloudinary.com/dnswboo5z/image/upload/v1757595393/people_fh71ri.png");
    --icon-date:   url("https://res.cloudinary.com/dnswboo5z/image/upload/v1757595328/date_w4uttj.png");
    --icon-time:   url("https://res.cloudinary.com/dnswboo5z/image/upload/v1757595327/time-dark_auvyve.png");
    --icon-goal:   url("https://res.cloudinary.com/dnswboo5z/image/upload/v1757595329/goal_icon_ldahyt.png");
    --icon-link:   url("https://res.cloudinary.com/dnswboo5z/image/upload/v1757595328/link2_r0oqsl.png");
    --icon-public:  url("https://res.cloudinary.com/dnswboo5z/image/upload/v1757647503/unlock_gvi917.png");
    --icon-private: url("https://res.cloudinary.com/dnswboo5z/image/upload/v1757647503/lock_j6pf7l.png");
  }
  @media (prefers-color-scheme: dark){
    :root{
      --icon-people: url("https://res.cloudinary.com/dnswboo5z/image/upload/v1757595393/people-dark_onohwu.png");
      --icon-date:   url("https://res.cloudinary.com/dnswboo5z/image/upload/v1757595328/date-dark_ntcjc4.png");
      --icon-time:   url("https://res.cloudinary.com/dnswboo5z/image/upload/v1757595327/time-dark_auvyve.png");
      --icon-goal:   url("https://res.cloudinary.com/dnswboo5z/image/upload/v1757595328/goal_icon-dark_c8xyn6.png");
      --icon-link:   url("https://res.cloudinary.com/dnswboo5z/image/upload/v1757595327/link2-dark_rwt5ya.png");
    }
  }

    /* --- ê¸°ë³¸ ë ˆì´ì•„ì›ƒ --- */
    body {
      background-color: var(--bg-color);
      font-family: 'Noto Sans KR', sans-serif;
      margin: 0;
      color: var(--text-color);
    }
    .container {
      max-width: 800px; /* fastmate.htmlê³¼ ë™ì¼í•œ í­ */
      margin: 0 auto;
      padding: 20px;
    }

    /* --- í—¤ë” --- */
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 25px;
    }
    .page-title-group {
      display: flex;
      align-items: center;
      gap: 10px;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }
    .page-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-color);
      margin: 0;
    }
    .beta-tag {
      background-color: var(--yellow-bg-color);
      color: #664d03;
      font-size: 0.75rem;
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 8px;
      border: 1px solid var(--yellow-color);
    }
    .header-actions { display: flex; align-items: center; gap: 10px; }
    .header-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      color: var(--text-light);
      transition: color 0.2s;
    }
    .header-btn:hover { color: var(--primary-color); }
    .create-challenge-btn {
      background-color: var(--primary-color);
      color: white;
      border-radius: 8px;
      font-weight: bold;
      font-size: 0.9rem;
      padding: 0 16px;
      height: 40px;
      border: none;
      cursor: pointer;
    }

    /* --- í•„í„° --- */
    .filter-bar { margin-bottom: 20px; display: flex; gap: 10px; }
    .filter-btn {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      color: var(--text-light);
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 500;
    }
    .filter-btn.active {
      background-color: var(--primary-light);
      color: var(--primary-color);
      border-color: var(--primary-color);
      font-weight: bold;
    }

    /* --- ì±Œë¦°ì§€ ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ (ìˆ˜ì •ë¨) --- */
    .challenge-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex;
      align-items: flex-start; /* ì½˜í…ì¸  ìƒë‹¨ ì •ë ¬ */
      gap: 16px;
    }
    .challenge-card:hover { transform: translateY(-3px); box-shadow: 0 6px 16px rgba(0,0,0,0.12); }
    .challenge-content { flex-grow: 1; }
    .challenge-content h3 { margin: 0 0 10px; font-size: 1.1rem; }
    .challenge-meta {
      font-size: 0.85rem;
      color: var(--text-light);
      display: flex;
      flex-direction: column;
      gap: 8px; /* ê° ì •ë³´ í–‰ ì‚¬ì´ì˜ ê°„ê²© */
    }
    .challenge-meta .meta-row {
      display: flex;
      align-items: center; /* ì•„ì´ì½˜ê³¼ í…ìŠ¤íŠ¸ ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬ (í•µì‹¬ ìˆ˜ì •) */
      gap: 8px; /* ì•„ì´ì½˜ê³¼ í…ìŠ¤íŠ¸ ì‚¬ì´ ê°„ê²© */
    }
    .challenge-meta .meta-row img {
      width: 16px; /* ì•„ì´ì½˜ í¬ê¸°ë¥¼ í…ìŠ¤íŠ¸ì™€ ì–´ìš¸ë¦¬ê²Œ ì¡°ì • */
      height: 16px;
    }

    /* --- í˜ì´ì§• --- */
    .pagination { text-align: center; margin-top: 30px; display: flex; gap: 8px; justify-content: center; align-items: center;}
    .pagination button {
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight:500;
    }
    .pagination button:disabled { cursor: not-allowed; opacity: 0.5; background: var(--bg-color); }
    .pagination .page-number { font-weight: bold; padding: 0 10px; }

    /* --- ì±Œë¦°ì§€ ìƒì„¸ ì •ë³´ (ìˆ˜ì •ë¨) --- */
    .challenge-info-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      border: 1px solid var(--border-color);
      position: relative;
    }
    .challenge-details .challenge-title-row { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
    .challenge-details .challenge-title { margin: 0; font-size: 1.4rem; }
    .challenge-details .challenge-desc { margin: 0 0 24px; color: var(--text-light); line-height: 1.6; }
    .challenge-meta-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 16px; }
    .meta-item { display: flex; align-items: center; gap: 12px; } /* ì•„ì´ì½˜, í…ìŠ¤íŠ¸ ì •ë ¬ */
    .meta-item img { width: 24px; height: 24px; }
    .meta-label { font-size: 0.9rem; color: var(--text-light); margin-bottom: 2px; }
    .meta-value { font-size: 0.95rem; font-weight: 500; }
    .meta-value button { font-size: 0.9rem; padding: 6px 12px; }

    .delete-challenge-btn {
      position: absolute; top: 15px; right: 15px; background: var(--border-color); color: var(--text-light);
      border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 20px;
      line-height: 28px; text-align: center; cursor: pointer; transition: all 0.2s;
    }
    .delete-challenge-btn:hover { background-color: #ced4da; color: var(--text-color); }
    body.dark-mode .delete-challenge-btn { background-color: #333; }
    body.dark-mode .delete-challenge-btn:hover { background-color: #555; }

     /* íƒ€ì„ë¼ì¸(í˜ì´ìŠ¤ë¶í’) */
  .comment-section { margin-top: 20px; }
  .comment-section h4 { margin: 0 0 12px; font-weight: 700; }
  #commentFeed { position: relative; }
  .comment { display:flex; gap:10px; margin: 10px 0; }
  .comment.reply { margin-left: 44px; } /* ëŒ€ëŒ“ê¸€ ë“¤ì—¬ì“°ê¸° */
  .comment-avatar-column { position: relative; width: 34px; display:flex; justify-content:center; }
  .comment-avatar {
    width: 32px; height: 32px; border-radius: 999px; background:#ddd; object-fit:cover;
  }
  .comment.reply .comment-avatar { width: 19px; height: 19px; } /* ëŒ€ëŒ“ê¸€ 60% */
  .thread-line{ position:absolute; top:32px; bottom:-8px; left:50%; width:2px; background: var(--border-color); transform:translateX(-50%); }
  .comment-main { flex:1; }
  .comment-bubble{
    background: var(--bg-color);
    border:1px solid var(--border-color);
    color: var(--text-color);
    border-radius: 12px;
    padding: 10px 12px;
  }
  .comment-header{ display:flex; align-items:center; gap:8px; margin-bottom:6px; }
  .comment-author{ font-weight: 700; }
  .comment-timestamp{ color: var(--text-light); font-size: .85rem; }
  .comment-text{ white-space: pre-wrap; word-break: break-word; }
  .comment-actions{ display:flex; justify-content:flex-end; margin-top:6px; }
  .comment-actions .reply-btn{ background: none; border: none; color: var(--text-light); cursor:pointer; }
  .replies-container{ margin-top:6px; }
  .auto-log{ color: var(--primary-color); font-weight:700; }  /* ìë™ ìˆ˜ì§‘(ì¼€í†¤/ì²´ì¤‘/í˜ˆë‹¹/ìš´ë™) */
  .mention{ color: var(--primary-color); font-weight:700; }   /* @ì•„ì´ë”” í‘œì‹œ */

  /* ì…ë ¥ì°½(í˜ë¶ì²˜ëŸ¼ placeholder í´ë¦­ â†’ ëª¨ë‹¬) */
  .add-comment-bar{
    display:flex; align-items:center; gap:10px; margin-top: 12px;
    border:1px solid var(--border-color); border-radius: 999px; padding:10px 14px; background: var(--card-bg);
  }
  .add-comment-bar input{
    flex:1; border:none; outline:none; background:transparent; color:var(--text-light);
  }

  /* ìƒì„¸ ì¹´ë“œ ìš°ì¸¡ ì•„ì´ì½˜ ë²„íŠ¼ */
  .detail-actions { position:absolute; top:12px; right:12px; display:flex; gap:8px; }
  .icon-ghost-btn {
    width:36px; height:36px; border-radius:8px; border:1px solid var(--border-color);
    background:var(--card-bg); display:flex; align-items:center; justify-content:center; cursor:pointer;
  }
  .icon-ghost-btn .icon { width:20px; height:20px; display:block; background-size:contain; background-repeat:no-repeat; }

  .card-visibility .lock{ width:18px; height:18px; display:inline-block; background-size:contain; background-repeat:no-repeat; }


/* ë©”íƒ€ ì•„ì´ì½˜ ê³µí†µ ê·œê²© */
.meta-item .icon, .challenge-meta .meta-row .icon {
  width: 20px; height: 20px; display:inline-block; background-size:contain; background-repeat:no-repeat;
}

/* ì¹´ë“œ ì œëª©ì¤„ ì˜¤ë¥¸ìª½ ì ê¸ˆ ì•„ì´ì½˜ */
.card-visibility {
  display:flex; align-items:center; gap:6px;
  font-size:.85rem; color:var(--text-light);
}
.card-visibility .lock {
  width:18px; height:18px; display:inline-block; background-size:contain; background-repeat:no-repeat;
}

/* ëŒ“ê¸€: ëŒ€ëŒ“ê¸€ ì•„ë°”íƒ€ 60% */
.comment.reply .comment-avatar { width: 19px; height: 19px; }

/* ìš°ì¸¡ ìƒë‹¨ action ë²„íŠ¼ ë˜í¼ */
.detail-actions { position:absolute; top:12px; right:12px; display:flex; gap:8px; }
.icon-ghost-btn {
  width:36px; height:36px; border-radius:8px; border:1px solid var(--border-color);
  background:var(--card-bg); display:flex; align-items:center; justify-content:center; cursor:pointer;
}
.icon-ghost-btn .icon { width:20px; height:20px; display:block; background-size:contain; background-repeat:no-repeat; }

  </style>
</head>
<body>

  <div class="container">
  <!-- ìƒë‹¨ í—¤ë” -->
  <header id="pageHeader" class="page-header"></header>

  <!-- ëª©ë¡ ë·° -->
  <div id="challengeListView" style="display: none;">
      <div id="challengeList"></div>
    <div id="paginationControls" class="pagination"></div>
  </div><!-- /#challengeListView -->

  <!-- ìƒì„¸ ë·°(ë‹¨ í•˜ë‚˜ë§Œ ìœ ì§€) -->
  <div id="challengeDetailView" style="display:none;">
    <div id="challengeInfo" class="challenge-info-card"><!-- JSê°€ ì±„ì›€ --></div>

    <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
    <section class="card comment-section">
      <h4>ì±Œë¦°ì§€ íƒ€ì„ë¼ì¸</h4>
      <div class="comment-form">
        <textarea id="newCommentText" placeholder="ì‘ì› ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”." rows="1"></textarea>
        <button id="submitCommentBtn" class="onb-btn onb-primary">ë“±ë¡</button>
      </div>
      <div id="commentFeed"></div>
      <!-- ì…ë ¥ì°½ placeholder (í´ë¦­í•˜ë©´ ëª¨ë‹¬ ì˜¤í”ˆ) -->
  <div class="add-comment-bar">
    <img id="myAvatar" class="comment-avatar" alt="me">
    <input id="openCommentModal" type="text" placeholder="ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”" readonly>
  </div>
</section>
  </div><!-- /#challengeDetailView -->

  <!-- ìƒì„± ëª¨ë‹¬(ëª©ë¡/ìƒì„¸ì™€ 'í˜•ì œ' ìœ„ì¹˜) -->
  <div id="createChallengeModal"
       class="modal"
       style="
         display:none; position:fixed; inset:0; z-index:9999;
         background:rgba(0,0,0,.45);
         align-items:center; justify-content:center; padding:20px;">
    <div class="modal-content"
         role="dialog" aria-modal="true" aria-labelledby="cc-title"
         style="background:var(--card-bg, #fff); padding:24px; border-radius:12px; max-width:720px; width:100%;">

      <!-- ëª¨ë‹¬ í—¤ë” -->
      <div class="modal-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <h3 id="cc-title" style="margin:0;">ì±Œë¦°ì§€ ë§Œë“¤ê¸°</h3>
        <button id="closeCreateChallengeModalBtn" class="icon-btn" aria-label="ë‹«ê¸°">âœ•</button>
      </div><!-- /.modal-header -->

      <!-- ëª¨ë‹¬ ë°”ë””(í¼) -->
      <form id="createChallengeForm" class="modal-body" autocomplete="off" style="margin-top:16px;">
        <!-- ë‹¨ì‹ ëª¨ë¸ -->
        <div class="form-row">
          <label for="fastingModelSelect">ë‹¨ì‹ ëª¨ë¸</label>
          <div class="controls">
            <select id="fastingModelSelect" required>
              <option value="8">8:16 (8ì‹œê°„ ë‹¨ì‹,ì•¼ì‹ëŠê¸°)</option>
              <option value="12">12:12 (12ì‹œê°„ ë‹¨ì‹,ì´ˆë³´)</option>
              <option value="16">16:8 (16ì‹œê°„ ë‹¨ì‹,ì¸ê¸°)</option>
              <option value="18">18:6 (18ì‹œê°„ ë‹¨ì‹,ì¸ê¸°)</option>
              <option value="20">20:4 (20ì‹œê°„ ë‹¨ì‹,ê³ ê¸‰)</option>
              <option value="24">24ì‹œê°„ (1ì¼ ë‹¨ì‹,ê³ ê¸‰)</option>
              <option value="36">36ì‹œê°„(1.5ì¼ ë‹¨ì‹,ê³ ê¸‰)</option>
              <option value="48">48ì‹œê°„ (2ì¼ ë‹¨ì‹,ê³ ê¸‰)</option>
              <option value="72">72ì‹œê°„ (3ì¼ ë‹¨ì‹,ê³ ê¸‰)</option>
            </select>
          </div><!-- /.controls -->
        </div><!-- /.form-row -->

        <!-- ëª©í‘œ -->
        <div class="form-row">
          <label for="cc-desc">ëª©í‘œ</label>
          <textarea id="cc-desc" name="desc" rows="3" placeholder="ê°„ë‹¨í•œ ì„¤ëª…ì„ ì ì–´ì£¼ì„¸ìš”"></textarea>
        </div><!-- /.form-row -->

        <!-- ì‹œì‘ì¼ -->
        <div class="form-row">
          <label for="cc-start">ì‹œì‘ì¼</label>
          <input id="cc-start" name="startDate" type="date" />
        </div><!-- /.form-row -->

        <!-- ê³µê°œ ë²”ìœ„ -->
        <fieldset class="form-row" style="margin-top:8px;">
          <legend>ê³µê°œ ë²”ìœ„</legend>
          <label class="radio">
            <input type="radio" name="visibility" value="private" checked>
            ë¹„ê³µê°œ
          </label>
          <label class="radio" style="margin-left:16px;">
            <input type="radio" name="visibility" value="public">
            ê³µê°œ
          </label>
        </fieldset><!-- /fieldset.form-row -->


        <!-- ìˆ˜ì • ëª¨ë‹¬ -->
<div id="editChallengeModal"
     class="modal"
     style="display:none; position:fixed; inset:0; z-index:9999; background:rgba(0,0,0,.45); align-items:center; justify-content:center; padding:20px;">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="ec-title"
       style="background:var(--card-bg, #fff); padding:24px; border-radius:12px; max-width:720px; width:100%;">
    <div class="modal-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <h3 id="ec-title" style="margin:0;">ì±Œë¦°ì§€ ìˆ˜ì •</h3>
      <button id="closeEditChallengeModalBtn" class="icon-btn" aria-label="ë‹«ê¸°">âœ•</button>
    </div>
    <form id="editChallengeForm" class="modal-body" autocomplete="off" style="margin-top:16px;">
      <div class="form-row">
        <label for="ec-desc">ëª©í‘œ/ì„¤ëª…</label>
        <textarea id="ec-desc" rows="3"></textarea>
      </div>
      <div class="form-row">
        <label for="ec-start">ì‹œì‘ì¼</label>
        <input id="ec-start" type="datetime-local" />
      </div>
      <fieldset class="form-row" style="margin-top:8px;">
        <legend>ê³µê°œ ë²”ìœ„</legend>
        <label class="radio"><input type="radio" name="ec-visibility" value="private"> ë¹„ê³µê°œ</label>
        <label class="radio" style="margin-left:16px;"><input type="radio" name="ec-visibility" value="public"> ê³µê°œ</label>
      </fieldset>
      <div class="modal-footer" style="margin-top:16px; display:flex; justify-content:flex-end; gap:8px;">
        <button type="button" class="onb-btn" id="ec-cancel">ì·¨ì†Œ</button>
        <button type="submit" class="onb-btn onb-primary">ì €ì¥</button>
      </div>
    </form>
  </div>
</div>

<!-- ë‹µê¸€ ëª¨ë‹¬ -->
<div id="replyModal" class="modal"
     style="display:none; position:fixed; inset:0; z-index:9999; background:rgba(0,0,0,.45); align-items:center; justify-content:center; padding:20px;">
  <div class="modal-content" style="background:var(--card-bg); padding:20px; border-radius:12px; width:100%; max-width:520px;">
    <h3 style="margin-top:0;">ë‹µê¸€ ë‹¬ê¸°</h3>
    <div id="replyTargetInfo" style="font-size:.9rem; color:var(--text-light); margin-bottom:8px;"></div>
    <textarea id="replyText" rows="3" style="width:100%;" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:10px;">
      <button id="replyCancel" class="onb-btn">ì·¨ì†Œ</button>
      <button id="replySubmit" class="onb-btn onb-primary">ë“±ë¡</button>
    </div>
  </div>
</div>



        <!-- í‘¸í„° ë²„íŠ¼ -->
        <div class="modal-footer" style="margin-top:16px; display:flex; justify-content:flex-end; gap:8px;">
          <button type="button" class="onb-btn" id="cc-cancel">ì·¨ì†Œ</button>
          <button type="submit" class="onb-btn onb-primary">ìƒì„±</button>
        </div><!-- /.modal-footer -->
      </form><!-- /#createChallengeForm -->
    </div><!-- /.modal-content -->
  </div><!-- /#createChallengeModal -->
</div><!-- /.container -->

<script>
document.addEventListener('DOMContentLoaded', () => {
  // --- ì „ì—­ ë³€ìˆ˜ ---
  const auth = window.fastmateApp.auth;
  const db   = window.fastmateApp.db;
  let currentUser = null;
  let stopListeningToChallenge = null;
  let allChallenges = []; // ì „ì²´ ì±Œë¦°ì§€ ë°ì´í„° ìºì‹œ
  let currentPage = 1;
  let currentUserProfile = null;    // âœ… ì¶”ê°€
let currentChallengeId = null;    // âœ… ì¶”ê°€
let replyingParentId = null;  // âœ… ì¶”ê°€
let modalMode = 'comment';   // 'comment' | 'reply'

  const ITEMS_PER_PAGE = 20; // í˜ì´ì§€ ë‹¹ 20ê°œì”©

  // --- DOM ìš”ì†Œ ---
  const pageHeader = document.getElementById('pageHeader');
  const challengeListView = document.getElementById('challengeListView');
  const challengeListDiv = document.getElementById('challengeList');
  const paginationControls = document.getElementById('paginationControls');
  const challengeDetailView = document.getElementById('challengeDetailView');
  const challengeInfoDiv = document.getElementById('challengeInfo');
  const commentFeed = document.getElementById('commentFeed');

  // --- ë·° ê´€ë¦¬ ---
  
  
function showView(viewName, challengeId = null) {
  challengeListView.style.display = 'none';
  challengeDetailView.style.display = 'none';
  if (stopListeningToChallenge) stopListeningToChallenge();

  if (viewName === 'list') {
    currentChallengeId = null;                // âœ… ë¦¬ì…‹
    challengeListView.style.display = 'block';
    renderListHeader();
    loadAndRenderChallenges();
  } else if (viewName === 'detail' && challengeId) {
    currentChallengeId = challengeId;         // âœ… ë³´ê´€
    challengeDetailView.style.display = 'block';
    listenToChallengeDetails(challengeId);
  }
}


  // --- í—¤ë” ë Œë”ë§ ---
  function renderListHeader() {
    pageHeader.innerHTML = `
      <button class="header-btn" title="ë©”ì¸ìœ¼ë¡œ" onclick="location.href='fastmate.html'">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
      </button>
      <div class="page-title-group">
        <h1 class="page-title">ì±Œë¦°ì§€</h1>
        <span class="beta-tag">BETA</span>
      </div>
      <button class="create-challenge-btn" id="createChallengeBtnHeader">ì±Œë¦°ì§€ ë§Œë“¤ê¸°</button>
    `;

  // âœ… ëª¨ë‹¬ ì˜¤í”ˆ ì—°ê²°
  document.getElementById('createChallengeBtnHeader')?.addEventListener('click', () => {
    document.getElementById('createChallengeModal').style.display = 'flex';
  });
  document.getElementById('closeCreateChallengeModalBtn')?.addEventListener('click', () => {
    document.getElementById('createChallengeModal').style.display = 'none';
  });
}

// ëª¨ë‹¬ í•¸ë“¤ëŸ¬ ë°”ì¸ë”©
// ===== ëª¨ë‹¬(ì—´ê¸°/ë‹«ê¸°) + í¼ ì œì¶œ: ë‹¨ì¼ ìœ„ì„ ë²„ì „ =====
(function bindCreateModalOnce () {
  if (window.__BIND_CREATE_MODAL__) return;
  window.__BIND_CREATE_MODAL__ = true;

  // í´ë¦­ ìœ„ì„: ì–´ë””ì„œë“  ë™ì‘
  document.addEventListener('click', (e) => {
    const modal = document.getElementById('createChallengeModal');
    if (!modal) return;

    const openBtn  = e.target.closest('#createChallengeBtnHeader');
    const closeBtn = e.target.closest('#closeCreateChallengeModalBtn, #cc-cancel');

    if (openBtn) {
      modal.style.display = 'flex';
      const sel = document.getElementById('fastingModelSelect');
      if (sel) sel.value = localStorage.getItem('fm_model') || '16';
      return;
    }
    if (closeBtn) { modal.style.display = 'none'; return; }
    if (e.target === modal) modal.style.display = 'none'; // ì˜¤ë²„ë ˆì´ í´ë¦­ ë‹«ê¸°
  });

  // ì œì¶œ ìœ„ì„: ìƒì„± í¼ë§Œ ê°€ë¡œì±”
  document.addEventListener('submit', async (e) => {
    const form = e.target.closest('#createChallengeForm');
    if (!form) return;
    e.preventDefault();

    if (!currentUser) { alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤'); return; }

    const desc         = (document.getElementById('cc-desc').value || '').trim();
    const startDateVal = document.getElementById('cc-start').value || null;
    const visibility   = (document.querySelector('input[name="visibility"]:checked')?.value) || 'private';

    // ë‹¨ì‹ ëª¨ë¸
    const sel          = document.getElementById('fastingModelSelect');
    const modelMinutes = parseInt(sel?.value || '16', 10);
    let modelLabel     = sel?.selectedOptions?.[0]?.textContent || '16:8';
    modelLabel         = modelLabel.split('(')[0].trim();
    try { localStorage.setItem('fm_model', String(modelMinutes)); } catch {}

    // í˜¸ìŠ¤íŠ¸ ë‹‰ë„¤ì„/í”„ë¡œí•„
    const ownerName     = currentUserProfile?.nickname || currentUser.displayName || 'ì‚¬ìš©ì';
    const ownerPhotoURL = currentUserProfile?.photoURL || currentUser.photoURL || null;

    // ì œëª©: <í˜¸ìŠ¤íŠ¸ë‹‰ë„¤ì„ + ë‹¨ì‹ëª¨ë¸>
    const finalName = `${ownerName} ${modelLabel}`;

    // Timestamp
    const startTs = startDateVal
      ? firebase.firestore.Timestamp.fromDate(new Date(startDateVal))
      : firebase.firestore.FieldValue.serverTimestamp();

    // ë‚ ì§œ/ì‹œê°„ ìºì‹œ
    const fmtDate = (d) => { try { return d.toLocaleDateString('ko-KR', {year:'numeric',month:'2-digit',day:'2-digit'});} catch { return '-'; } };
    const fmtTime = (d) => { try { return d.toLocaleTimeString('ko-KR', {hour:'2-digit',minute:'2-digit'});} catch { return '-'; } };
    let startDateStr = '-', startTimeStr = '-';
    if (startDateVal) {
      const d = new Date(startDateVal);
      startDateStr = fmtDate(d);
      startTimeStr = fmtTime(d);
    }

    try {
      // Firestore payload
      const payload = {
        // ì¿¼ë¦¬/ê¶Œí•œ
        startTime: startTs,
        participantUids: [currentUser.uid],
        hostUid: currentUser.uid,

        // í‘œì‹œ/ë©”íƒ€
        challengeName: finalName,
        description: desc,
        hostName: ownerName,
        ownerName,
        ownerPhotoURL,
        visibility,
        isBeta: true,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        memberCount: 1,

        // ëª¨ë¸
        fastingModelMinutes: modelMinutes,
        fastingModelLabel: modelLabel,

        // ë‚ ì§œ/ì‹œê°„ ìºì‹œ
        startDateStr,
        startClockStr: startTimeStr
      };

      const docRef = await db.collection('challenges').add(payload);

      // ë©¤ë²„(í˜¸ìŠ¤íŠ¸) ë“±ë¡
      await db.collection('challenges').doc(docRef.id)
        .collection('members').doc(currentUser.uid)
        .set({
          uid: currentUser.uid,
          nickname: ownerName,
          photoURL: ownerPhotoURL || null,
          role: 'owner',
          joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
        });

      // (ì„ íƒ) ê°œì¸ ë‹¨ì‹ â†’ ê·¸ë£¹ë‹¨ì‹ ì „í™˜
      if (typeof switchToGroupFasting === 'function') {
        try { await switchToGroupFasting(currentUser.uid, docRef.id, modelMinutes, startTs); } catch {}
      }

      // ë‹«ê¸° + ëª©ë¡ ê°±ì‹ 
      const modal = document.getElementById('createChallengeModal');
      if (modal) modal.style.display = 'none';
      showView('list');
    } catch (err) {
      console.error('ì±Œë¦°ì§€ ìƒì„± ì˜¤ë¥˜:', err);
      alert('ì±Œë¦°ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
  });
})();

  // --- ì±Œë¦°ì§€ ëª©ë¡ (í˜ì´ì§• ì ìš©) ---
  async function loadAndRenderChallenges() {
    if (!currentUser) return;
    challengeListDiv.innerHTML = "<p>ì±Œë¦°ì§€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>";
    
    try {
      const query = db.collection('challenges')
        .where('participantUids', 'array-contains', currentUser.uid)
        .orderBy('startTime', 'desc');
      const snapshot = await query.get();
      
      allChallenges = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      
      currentPage = 1;
      renderChallengePage();

    } catch (error) {
      console.error("ì±Œë¦°ì§€ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:", error);
      challengeListDiv.innerHTML = '<p>ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
    }
  }

function renderChallengePage() {
  if (allChallenges.length === 0) {
    challengeListDiv.innerHTML = '<div class="challenge-card" style="text-align:center;"><p>ì•„ì§ ì°¸ì—¬í•œ ì±Œë¦°ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>';
    paginationControls.innerHTML = '';
    return;
  }

  challengeListDiv.innerHTML = '';
  const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
  const endIndex   = startIndex + ITEMS_PER_PAGE;
  const pageItems  = allChallenges.slice(startIndex, endIndex);

  // --- ì•„ì´ì½˜ ê²½ë¡œ ---
  const peopleIcon = "https://res.cloudinary.com/dnswboo5z/image/upload/v1757595393/people_fh71ri.png";
  const dateIcon   = "https://res.cloudinary.com/dnswboo5z/image/upload/v1757595328/date_w4uttj.png";
  const timeIcon   = "https://res.cloudinary.com/dnswboo5z/image/upload/v1757595327/time-dark_auvyve.png";
  const goalIcon   = "https://res.cloudinary.com/dnswboo5z/image/upload/v1757595329/goal_icon_ldahyt.png"; // ë„¤ê°€ ì¤€ ë§í¬

pageItems.forEach(challenge => {
  const card = document.createElement('div');
  card.className = 'challenge-card';

  const memberCount = Array.isArray(challenge.participantUids)
    ? challenge.participantUids.length
    : (challenge.memberCount || 1);

  const d = challenge.startTime?.toDate?.();
  const dateStr = challenge.startDateStr || (d ? d.toLocaleDateString('ko-KR') : '-');
  const timeStr = challenge.startClockStr || (d ? d.toLocaleTimeString('ko-KR', {hour:'2-digit', minute:'2-digit'}) : '-');
  const goalStr = challenge.detailedGoal ? escapeHTML(challenge.detailedGoal) : '-';
  const isPrivate = (challenge.visibility || 'private') === 'private';

  card.innerHTML = `
    <div class="challenge-content">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
        <h3>${escapeHTML(challenge.challengeName || '-')}</h3>
        <div class="card-visibility" title="${isPrivate ? 'ë¹„ê³µê°œ' : 'ê³µê°œ'}">
          <span class="lock" style="background-image: var(${isPrivate ? '--icon-private' : '--icon-public'});"></span>
        </div>
      </div>

      <div class="challenge-meta">
        <div class="meta-row">
          <span class="icon" style="background-image: var(--icon-date);"></span>
          <span>${dateStr}</span>
        </div>
        <div class="meta-row">
          <span class="icon" style="background-image: var(--icon-time);"></span>
          <span>${timeStr}</span>
        </div>
        <div class="meta-row">
          <span class="icon" style="background-image: var(--icon-people);"></span>
          <span>${memberCount}ëª…</span>
        </div>
        <div class="meta-row">
          <span class="icon" style="background-image: var(--icon-goal);"></span>
          <span>${goalStr}</span>
        </div>
      </div>
    </div>
  `;
  card.addEventListener('click', () => showView('detail', challenge.id));
  challengeListDiv.appendChild(card);
});


  renderPagination();
}

  function renderPagination() {
    const totalPages = Math.ceil(allChallenges.length / ITEMS_PER_PAGE);
    if (totalPages <= 1) {
      paginationControls.innerHTML = '';
      return;
    }

    paginationControls.innerHTML = `
      <button id="prevPageBtn" ${currentPage === 1 ? 'disabled' : ''}>ì´ì „</button>
      <span class="page-number">${currentPage} / ${totalPages}</span>
      <button id="nextPageBtn" ${currentPage === totalPages ? 'disabled' : ''}>ë‹¤ìŒ</button>
    `;

    document.getElementById('prevPageBtn')?.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        renderChallengePage();
      }
    });
    document.getElementById('nextPageBtn')?.addEventListener('click', () => {
      if (currentPage < totalPages) {
        currentPage++;
        renderChallengePage();
      }
    });
  }


  // --- ì±Œë¦°ì§€ ìƒì„¸ ë° ëŒ“ê¸€ ---
function listenToChallengeDetails(challengeId) {
  const ref = db.collection('challenges').doc(challengeId);
  stopListeningToChallenge = ref.onSnapshot(doc => {
    if (!doc.exists) {
      alert("ì‚­ì œë˜ì—ˆê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì±Œë¦°ì§€ì…ë‹ˆë‹¤.");
      return showView('list');
    }
    const challenge = { id: doc.id, ...doc.data() };
    currentChallengeId = challenge.id;
    renderDetailHeader(challenge);
    renderChallengeInfo(challenge);
    renderComments(challenge.id);
  });
}

function renderDetailHeader(challenge) {
  pageHeader.innerHTML = `
    <button class="header-btn" id="backToListBtn">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
    </button>
    <div class="page-title-group">
      <h1 class="page-title" style="font-size: 1.2rem;">${escapeHTML(challenge.challengeName)}</h1>
     </div>
    <div style="width: 40px;"></div>
  `;
  document.getElementById('backToListBtn')?.addEventListener('click', () => showView('list'));
}  


function renderChallengeInfo(ch){
  const $info = document.getElementById('challengeInfo'); if(!$info) return;
  const isPrivate = (ch.visibility||'private')==='private';
  const d = ch.startTime?.toDate?.();
  const dateStr = d ? d.toLocaleDateString('ko-KR',{year:'numeric',month:'2-digit',day:'2-digit'}) : '-';
  const timeStr = d ? d.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}) : '-';
  const memberCount = Array.isArray(ch.participantUids)? ch.participantUids.length : (ch.memberCount||1);
  const desc = (ch.description||'').trim();
  const goal = (ch.detailedGoal||'').trim();

  $info.innerHTML = `
    <div class="card challenge-details" style="position:relative;">
      <div class="detail-actions">
        <button id="shareLinkBtn" class="icon-ghost-btn" title="ë§í¬ ê³µìœ ">
          <span class="icon" style="background-image:var(--icon-link)"></span>
        </button>
        <button id="editChallengeBtn" class="icon-ghost-btn" title="ìˆ˜ì •">ğŸ–Šï¸</button>
        <button id="deleteChallengeBtn" class="icon-ghost-btn" title="ì‚­ì œ">ğŸ—‘ï¸</button>
      </div>

      <div class="challenge-title-row" style="display:flex;align-items:center;gap:8px;justify-content:space-between;">
        <h2 class="challenge-title" style="margin:0;">${escapeHTML(ch.challengeName||'-')}</h2>
        <div class="card-visibility" title="${isPrivate?'ë¹„ê³µê°œ':'ê³µê°œ'}">
          <span class="lock" style="background-image:var(${isPrivate?'--icon-private':'--icon-public'})"></span>
        </div>
      </div>

      ${desc ? `<p class="challenge-desc">${escapeHTML(desc)}</p>` : ``}

      <ul class="challenge-meta-list">
        <li class="meta-item"><span class="icon" style="background-image:var(--icon-people)"></span><div class="meta-text"><div class="meta-label">ì°¸ì—¬ì</div><div class="meta-value">${memberCount}ëª…</div></div></li>
        <li class="meta-item"><span class="icon" style="background-image:var(--icon-date)"></span><div class="meta-text"><div class="meta-label">ë‚ ì§œ</div><div class="meta-value">${dateStr}</div></div></li>
        <li class="meta-item"><span class="icon" style="background-image:var(--icon-time)"></span><div class="meta-text"><div class="meta-label">ì‹œì‘ì‹œê°„</div><div class="meta-value">${timeStr}</div></div></li>
        ${goal ? `<li class="meta-item"><span class="icon" style="background-image:var(--icon-goal)"></span><div class="meta-text"><div class="meta-label">ëª©í‘œ</div><div class="meta-value">${escapeHTML(goal)}</div></div></li>` : ``}
      </ul>
    </div>
  `;

  // ë§í¬ ê³µìœ 
  document.getElementById('shareLinkBtn')?.addEventListener('click', async ()=>{
    const url = `${location.origin}/challenge-invite.html?id=${encodeURIComponent(ch.id)}`;
    try{ await navigator.clipboard.writeText(url); toast('ë§í¬ë¥¼ ë³µì‚¬í–ˆì–´ìš”'); }
    catch{ prompt('ì•„ë˜ ë§í¬ë¥¼ ë³µì‚¬í•˜ì„¸ìš”', url); }
  });

  // ìˆ˜ì •: ì‹œì‘ 30ë¶„ ì „ê¹Œì§€ë§Œ
  document.getElementById('editChallengeBtn')?.addEventListener('click', ()=>{
    const startMs = ch.startTime?.toDate?.()?.getTime?.() || 0;
    if (startMs - Date.now() < 30*60*1000) return toast('ì±Œë¦°ì§€ëŠ” ì‹œì‘ 30ë¶„ì „ê¹Œì§€ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    openEditChallengeModal(ch);
  });

  // ì‚­ì œ
  document.getElementById('deleteChallengeBtn')?.addEventListener('click', async ()=>{
    if(!confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”?')) return;
    await db.collection('challenges').doc(ch.id).delete();
    toast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); showView('list');
  });
}



/* ===== ìœ í‹¸ ===== */
const $ = s => document.querySelector(s);
function toast(msg){
  const t=document.createElement('div');
  t.textContent=msg;
  t.style.cssText='position:fixed;left:50%;bottom:40px;transform:translateX(-50%);background:#000a;color:#fff;padding:10px 14px;border-radius:8px;z-index:99999';
  document.body.appendChild(t); setTimeout(()=>t.remove(), 1600);
}
function initials2(name='ì‚¬ìš©ì'){ const s=String(name).trim().replace(/\s+/g,''); return s.slice(0,2)||'ìœ ì €'; }
function ymdhm(d){ const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`; }
function relativeOrDate(ts){
  const d = ts?.toDate?.(); if(!d) return '';
  const diffH = (Date.now()-d.getTime())/36e5;
  if (diffH < 1) { const m=Math.max(1, Math.floor(diffH*60)); return `${m}ë¶„ ì „`; }
  if (diffH < 24) { const h=Math.max(1, Math.floor(diffH)); return `${h}ì‹œê°„ ì „`; }
  return ymdhm(d);
}
function linkify(s=''){ return String(s).replace(/(https?:\/\/[^\s]+)/g,'<a href="$1" target="_blank" rel="noopener">$1</a>'); }

/* ìë™ ìˆ˜ì§‘ ë¡œê·¸ â†’ ì´ˆë¡ êµµê²Œ */
function renderCommentText(text='', isAuto){
  const safe = text.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const html = linkify(safe);
  return isAuto ? `<span class="auto-log">${html}</span>` : html;
}


/* ë‚´ ì•„ë°”íƒ€ ê¸°ë³¸ ì„¸íŒ… (êµ¬ê¸€ ì´ë¯¸ì§€) */
auth.onAuthStateChanged(u=>{
  currentUser=u||null;
  const avatar = $('#myAvatar');
  if (avatar) {
    if (u?.photoURL) avatar.src = u.photoURL;
    else {
      avatar.removeAttribute('src');
      avatar.style.background='#ddd';
    }
  }
});

/* ===== íƒ€ì„ë¼ì¸ ë Œë” ===== */
async function renderComments(chId){
  currentChallengeId = chId;
  const snap = await db.collection('challenges').doc(chId)
    .collection('comments').orderBy('timestamp','asc').get();

  const docs = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  const feed = $('#commentFeed'); feed.innerHTML='';

  // íŠ¸ë¦¬ êµ¬ì„± + ì´í•©(ëŒ“ê¸€+ëŒ€ëŒ“ê¸€)
  const childrenMap = {};
  docs.forEach(c=>{ if(c.parentId){ (childrenMap[c.parentId] ||= []).push(c); } });
  const total = docs.length;
  $('#commentTitle').textContent = `ì±Œë¦°ì§€ íƒ€ì„ë¼ì¸ (${total})`;

  // ìµœìƒìœ„ ëŒ“ê¸€ë¶€í„° ë Œë”
  docs.filter(c=>!c.parentId).forEach(c=>{
    const replies = childrenMap[c.id] || [];
    feed.appendChild(createCommentEl(c, replies, false));
  });
}

/* ì½”ë©˜íŠ¸ ì—˜ë¦¬ë¨¼íŠ¸ (í˜ì´ìŠ¤ë¶í’) */
function createCommentEl(c, replies=[], isReply=false){
  const wrap = document.createElement('div');
  wrap.className = 'comment' + (isReply?' reply':'');

  const nick = c.nickname || 'ì‚¬ìš©ì';
  const ts = relativeOrDate(c.timestamp);

  // ì•„ë°”íƒ€(êµ¬ê¸€ ì´ë¯¸ì§€, ì—†ìœ¼ë©´ ì´ë‹ˆì…œ 2ê¸€ì)
  let avatarHtml = '';
  if (c.photoURL) avatarHtml = `<img src="${c.photoURL}" alt="${nick}" class="comment-avatar">`;
  else avatarHtml = `<div class="comment-avatar" style="background:#e5e5e5;display:flex;align-items:center;justify-content:center;color:#555;font-weight:700;">${initials2(nick)}</div>`;

  // ë³¸ë¬¸ (ìë™ ë¡œê·¸ëŠ” ì´ˆë¡ êµµê²Œ)
  let textHtml = renderCommentText(c.text||'', !!c.isAutoComment);

  // ëŒ€ëŒ“ê¸€ì´ë©´ @ë¶€ëª¨ ë‹‰ë„¤ì„ì´ ì—†ì„ ë•Œ ìë™ í”„ë¦¬í”½ìŠ¤
  if (isReply && !/^@\S+/.test(c.text||'')) {
    textHtml = `<span class="mention">@${c.parentNickname || c.parentId || ''}</span> ` + textHtml;
  }

  wrap.innerHTML = `
    <div class="comment-avatar-column">
      ${avatarHtml}
      ${!isReply && replies.length>0 ? '<div class="thread-line"></div>': ''}
    </div>
    <div class="comment-main">
      <div class="comment-bubble">
        <div class="comment-header">
          <span class="comment-author">${nick}</span>
          <span class="comment-timestamp">${ts}</span>
        </div>
        <div class="comment-text">${textHtml}</div>
        <div class="comment-actions">
          ${!isReply ? `<button class="reply-btn" data-target="${c.id}" data-nick="${nick}">ë‹µê¸€ë‹¬ê¸°</button>` : ''}
        </div>

        ${!isReply && replies.length>0 ? `
          <button class="onb-btn" data-toggle="${c.id}" style="margin-top:6px;">â–½ ë‹µê¸€ ${replies.length}ê°œ ë³´ê¸°</button>
          <div class="replies-container" id="rc-${c.id}" style="display:none;"></div>
        `: (!isReply ? `<div class="replies-container" id="rc-${c.id}" style="display:none;"></div>` : ``)}
      </div>
    </div>
  `;

  // ë‹µê¸€ í† ê¸€
  wrap.querySelector(`[data-toggle="${c.id}"]`)?.addEventListener('click', (e)=>{
    const box = wrap.querySelector(`#rc-${c.id}`);
    if (box && box.childElementCount===0){
      replies.forEach(r=>{
        // ë¶€ëª¨ ë‹‰ë„¤ì„ ì „ë‹¬(ëŒ€ëŒ“ê¸€ @í‘œì‹œìš©)
        r.parentNickname = nick;
        box.appendChild(createCommentEl(r, [], true));
      });
    }
    const opened = box.style.display!=='none';
    box.style.display = opened ? 'none':'block';
    e.target.textContent = opened ? `â–½ ë‹µê¸€ ${replies.length}ê°œ ë³´ê¸°` : 'â–² ë‹µê¸€ ì ‘ê¸°';
  });

  return wrap;
}

/* ===== ëª¨ë‹¬: ëŒ“ê¸€/ë‹µê¸€ ê³µìš© ===== */

function openCmtModal(mode='comment', targetId=null, targetNick=''){
  modalMode = mode; replyingParentId = targetId;
  $('#cmtModalTitle').textContent = mode==='reply' ? 'ë‹µê¸€ ë‹¬ê¸°' : 'ëŒ“ê¸€ ë‹¬ê¸°';
  if (mode==='reply'){
    $('#cmtTargetInfo').style.display='block';
    $('#cmtTargetInfo').textContent = `ëŒ€ìƒ: @${targetNick} (${targetId})`;
  } else {
    $('#cmtTargetInfo').style.display='none';
    $('#cmtTargetInfo').textContent='';
  }
  $('#cmtText').value='';
  $('#cmtModal').style.display='flex';
}
function closeCmtModal(){ $('#cmtModal').style.display='none'; }

$('#openCommentModal').addEventListener('click', ()=> openCmtModal('comment'));
$('#cmtCancel').addEventListener('click', closeCmtModal);

// ë‹µê¸€ ë²„íŠ¼(ì´ë²¤íŠ¸ ìœ„ì„)
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('.reply-btn');
  if (!btn) return;
  openCmtModal('reply', btn.dataset.target, btn.dataset.nick);
});

// ë“±ë¡
$('#cmtSubmit').addEventListener('click', async ()=>{
  const text = ($('#cmtText').value || '').trim();
  if (!text || !currentUser || !currentChallengeId) return;

  const base = {
    uid: currentUser.uid,
    nickname: currentUser.displayName || (currentUserProfile?.nickname) || 'ì‚¬ìš©ì',
    photoURL: currentUser.photoURL || null,
    text,
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    isAutoComment: false
  };

  // replyëŠ” @ë©˜ì…˜ ìë™ í”„ë¦¬í”½ìŠ¤
  if (modalMode==='reply' && replyingParentId){
    // UIì—ëŠ” @í‘œì‹œë˜ì§€ë§Œ, ì €ì¥ ë°ì´í„°ì—ë„ ë‚¨ê¸°ë ¤ë©´ ë‹¤ìŒ ì¤„ ìœ ì§€
    base.text = /^@\S+/.test(text) ? text : `@${$('#cmtTargetInfo').textContent.replace(/^ëŒ€ìƒ:\s*@/,'').split(' ')[0]} ${text}`;
    base.parentId = replyingParentId;
  }

  try{
    await db.collection('challenges').doc(currentChallengeId).collection('comments').add(base);
    closeCmtModal(); toast('ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
    renderComments(currentChallengeId);
  }catch(e){ console.error(e); toast('ë“±ë¡ ì‹¤íŒ¨'); }
});

/* ===== ìƒì„¸ ì§„ì… ì‹œ í˜¸ì¶œ ì˜ˆì‹œ =====
   showView('detail', id) ê°™ì€ ê³³ì—ì„œ renderComments(id) í˜¸ì¶œë§Œ ë³´ì¥í•´ì¤˜.
   ë˜í•œ ë¹ ë¥¸ ì²´í—˜ì„ ìœ„í•´ ì•„ë˜ì²˜ëŸ¼ currentChallengeId ì„¸íŒ… ìœ„ì¹˜ë§Œ í™•ì¸í•˜ë©´ ë¨.
*/


  // --- í—¬í¼ í•¨ìˆ˜ ---
  function escapeHTML(s) { return String(s || '').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }
  function linkify(text) {
    const safe = escapeHTML(text);
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    return safe.replace(urlRegex, url => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
  }

  // ìˆ˜ì •ëª¨ë‹¬ 
  function openEditChallengeModal(ch) {
  const modal = document.getElementById('editChallengeModal');
  const descEl = document.getElementById('ec-desc');
  const startEl = document.getElementById('ec-start');

  descEl.value = ch.description || '';
  // datetime-local ISO ì±„ìš°ê¸°
  const d = ch.startTime?.toDate?.();
  if (d) {
    const pad = n => String(n).padStart(2,'0');
    const iso = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    startEl.value = iso;
  } else {
    startEl.value = '';
  }
  document.querySelectorAll('input[name="ec-visibility"]').forEach(r => {
    r.checked = (r.value === (ch.visibility || 'private'));
  });

  modal.style.display = 'flex';

  const close = () => { modal.style.display = 'none'; };
  document.getElementById('closeEditChallengeModalBtn').onclick = close;
  document.getElementById('ec-cancel').onclick = close;

  const form = document.getElementById('editChallengeForm');
  form.onsubmit = async (e) => {
    e.preventDefault();
    try {
      const visibility = document.querySelector('input[name="ec-visibility"]:checked')?.value || 'private';
      const desc = (descEl.value || '').trim();
      const startVal = startEl.value; // 'YYYY-MM-DDTHH:mm'
      let startTs = ch.startTime || null;

      if (startVal) {
        startTs = firebase.firestore.Timestamp.fromDate(new Date(startVal));
      }

      await db.collection('challenges').doc(ch.id).update({
        description: desc,
        visibility,
        startTime: startTs,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      });

      toast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
      close();
    } catch (err) {
      console.error(err);
      toast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  };
}

// ìœ í‹¸ì¶”ê°€ 

function toast(msg) {
  // ì‹¬í”Œ í† ìŠ¤íŠ¸
  const t = document.createElement('div');
  t.textContent = msg;
  t.style.cssText = 'position:fixed;left:50%;bottom:40px;transform:translateX(-50%);background:#000a;color:#fff;padding:10px 14px;border-radius:8px;z-index:99999';
  document.body.appendChild(t);
  setTimeout(()=>{ t.remove(); }, 1800);
}

function formatRelativeOrDate(ts) {
  const d = ts?.toDate?.();
  if (!d) return '';
  const diff = (Date.now() - d.getTime()) / (1000*60*60); // hours
  if (diff < 1) {
    const m = Math.max(1, Math.floor(diff*60));
    return `${m}ë¶„ ì „`;
  }
  if (diff < 24) {
    const h = Math.max(1, Math.floor(diff));
    return `${h}ì‹œê°„ ì „`;
  }
  // 24h ì´í›„ëŠ” ë‚ ì§œ+ì‹œê°„
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
}

function initials2(name='ì‚¬ìš©ì') {
  const s = String(name).trim();
  // í•œê¸€ 2ê¸€ì ë˜ëŠ” ì˜ë¬¸ ì´ë‹ˆì…œ 2ì
  const two = s.replace(/\s+/g,'').slice(0,2);
  if (two) return two;
  return 'ìœ ì €';
}




  // --- ì´ˆê¸°í™” ---
  auth.onAuthStateChanged(user => {
      if (user) {
    currentUser = user;
    // ë‹‰ë„¤ì„/ì‚¬ì§„ ê¸°ë³¸ê°’ ì¤€ë¹„
    currentUserProfile = {
      nickname: user.displayName || 'ì‚¬ìš©ì',
      photoURL: user.photoURL || null,
    };
    showView('list');
  } else {
    currentUser = null;
    document.body.innerHTML = `<div class="container" style="text-align:center; padding-top: 50px;">ì±Œë¦°ì§€ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>`;
  }
});

  // í´ë¦­ ì‹œ ì—´ë ¤ìˆëŠ” ... ë©”ë‰´ ë‹«ê¸°
  document.addEventListener('click', () => {
    document.querySelectorAll('.options-menu').forEach(menu => menu.style.display = 'none');
  });
})
</script>
<!-- ëŒ“ê¸€/ë‹µê¸€ ê³µìš© ëª¨ë‹¬ -->
<div id="cmtModal"
     style="display:none; position:fixed; inset:0; z-index:9999; background:rgba(0,0,0,.45); align-items:center; justify-content:center; padding:20px;">
  <div style="background:var(--card-bg); padding:20px; border-radius:12px; width:100%; max-width:520px;">
    <h3 id="cmtModalTitle" style="margin:0 0 8px 0;">ëŒ“ê¸€ ë‹¬ê¸°</h3>
    <div id="cmtTargetInfo" style="font-size:.9rem; color:var(--text-light); margin-bottom:8px; display:none;"></div>
    <textarea id="cmtText" rows="4" class="onb-input" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:10px;">
      <button id="cmtCancel" class="onb-btn">ì·¨ì†Œ</button>
      <button id="cmtSubmit" class="onb-btn onb-primary">ë“±ë¡</button>
    </div>
  </div>
</div>

</body>
</html>