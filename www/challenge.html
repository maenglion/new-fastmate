<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Fastmate - 챌린지</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="/firebase-init.js?v=2026.01.29-v9"></script>
  <style>
    /* --- 기본 & 다크모드 색상 변수 --- */
    :root {
      --primary-color: #1c8e3e;
      --primary-light: #e8f5e9;
      --bg-color: #f8f9fa;
      --card-bg: #FFFFFF;
      --text-color: #212529;
      --text-light: #6c757d;
      --border-color: #e9ecef;
      --yellow-color: #ffc107;
      --yellow-bg-color: #fff3cd;
    }

    body.dark-mode {
      --primary-color: #4caf50;
      --primary-light: #2c3e50;
      --bg-color: #121212;
      --card-bg: #1e1e1e;
      --text-color: #e0e0e0;
      --text-light: #9e9e9e;
      --border-color: #333333;
    }

    :root {
      --icon-people: url("https://res.cloudinary.com/dnswboo5z/image/upload/v1757595393/people_fh71ri.png");
      --icon-date: url("https://res.cloudinary.com/dnswboo5z/image/upload/v1757595328/date_w4uttj.png");
      --icon-time: url("https://res.cloudinary.com/dnswboo5z/image/upload/v1757595327/time-dark_auvyve.png");
      --icon-goal: url("https://res.cloudinary.com/dnswboo5z/image/upload/v1757595329/goal_icon_ldahyt.png");
      --icon-link: url("https://res.cloudinary.com/dnswboo5z/image/upload/v1757595328/link2_r0oqsl.png");
      --icon-public: url("https://res.cloudinary.com/dnswboo5z/image/upload/v1757647503/unlock_gvi917.png");
      --icon-private: url("https://res.cloudinary.com/dnswboo5z/image/upload/v1757647503/lock_j6pf7l.png");
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --icon-people: url("https://res.cloudinary.com/dnswboo5z/image/upload/v1757595393/people-dark_onohwu.png");
        --icon-date: url("https://res.cloudinary.com/dnswboo5z/image/upload/v1757595328/date-dark_ntcjc4.png");
        --icon-time: url("https://res.cloudinary.com/dnswboo5z/image/upload/v1757595327/time-dark_auvyve.png");
        --icon-goal: url("https://res.cloudinary.com/dnswboo5z/image/upload/v1757595328/goal_icon-dark_c8xyn6.png");
        --icon-link: url("https://res.cloudinary.com/dnswboo5z/image/upload/v1757595327/link2-dark_rwt5ya.png");
      }
    }

    /* --- 기본 레이아웃 --- */
    body {
      background-color: var(--bg-color);
      font-family: 'Noto Sans KR', sans-serif;
      margin: 0;
      color: var(--text-color);
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    /* --- 헤더 --- */
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 25px;
    }

    .page-title-group {
      display: flex;
      align-items: center;
      gap: 10px;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }

    .page-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-color);
      margin: 0;
    }

    .beta-tag {
      background-color: var(--yellow-bg-color);
      color: #664d03;
      font-size: 0.75rem;
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 8px;
      border: 1px solid var(--yellow-color);
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      color: var(--text-light);
      transition: color 0.2s;
    }

    .header-btn:hover {
      color: var(--primary-color);
    }

    .create-challenge-btn {
      background-color: var(--primary-color);
      color: white;
      border-radius: 8px;
      font-weight: bold;
      font-size: 0.9rem;
      padding: 0 16px;
      height: 40px;
      border: none;
      cursor: pointer;
    }

    /* --- 필터 --- */
    .filter-bar {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
    }

    .filter-btn {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      color: var(--text-light);
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 500;
    }

    .filter-btn.active {
      background-color: var(--primary-light);
      color: var(--primary-color);
      border-color: var(--primary-color);
      font-weight: bold;
    }

    /* --- 챌린지 리스트 카드 --- */
    .challenge-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex;
      align-items: flex-start;
      gap: 16px;
    }

    .challenge-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
    }

    .challenge-content {
      flex-grow: 1;
    }

    .challenge-content h3 {
      margin: 0 0 10px;
      font-size: 1.1rem;
    }

    .challenge-meta {
      font-size: 0.85rem;
      color: var(--text-light);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .challenge-meta .meta-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .challenge-meta .meta-row img {
      width: 18px;
      height: 18px;
    }

    /* --- 페이징 --- */
    .pagination {
      text-align: center;
      margin-top: 30px;
      display: flex;
      gap: 8px;
      justify-content: center;
      align-items: center;
    }

    .pagination button {
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
    }

    .pagination button:disabled {
      cursor: not-allowed;
      opacity: 0.5;
      background: var(--bg-color);
    }

    .pagination .page-number {
      font-weight: bold;
      padding: 0 10px;
    }

    /* --- 챌린지 상세 정보 --- */
    .challenge-info-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      border: 1px solid var(--border-color);
      position: relative;
    }

    .challenge-details .challenge-title-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .challenge-details .challenge-title {
      margin: 0;
      font-size: 1.4rem;
    }

    .challenge-details .challenge-desc {
      margin: 0 0 24px;
      color: var(--text-light);
      line-height: 1.6;
    }

    .challenge-meta-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .meta-item img {
      width: 24px;
      height: 24px;
    }

    .meta-label {
      font-size: 0.9rem;
      color: var(--text-light);
      margin-bottom: 2px;
    }

    .meta-value {
      font-size: 0.95rem;
      font-weight: 500;
    }

    .meta-value button {
      font-size: 0.9rem;
      padding: 6px 12px;
    }

    .delete-challenge-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: var(--border-color);
      color: var(--text-light);
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      font-size: 20px;
      line-height: 28px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .delete-challenge-btn:hover {
      background-color: #ced4da;
      color: var(--text-color);
    }

    body.dark-mode .delete-challenge-btn {
      background-color: #333;
    }

    body.dark-mode .delete-challenge-btn:hover {
      background-color: #555;
    }

    /* 타임라인(페이스북풍) */
    .comment-section {
      margin-top: 20px;
    }

    .comment-section h4 {
      margin: 0 0 12px;
      font-weight: 700;
    }

    #commentFeed {
      position: relative;
    }

    .comment {
      display: flex;
      gap: 10px;
      margin: 10px 0;
    }

    .comment.reply {
      margin-left: 44px;
    }

    .comment-avatar-column {
      position: relative;
      width: 34px;
      display: flex;
      justify-content: center;
    }

    .comment-avatar {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: #ddd;
      object-fit: cover;
    }

    .comment.reply .comment-avatar {
      width: 19px;
      height: 19px;
    }

    .thread-line {
      position: absolute;
      top: 32px;
      bottom: -8px;
      left: 50%;
      width: 2px;
      background: var(--border-color);
      transform: translateX(-50%);
    }

    .comment-main {
      flex: 1;
    }

    .comment-bubble {
      background: var(--bg-color);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      border-radius: 12px;
      padding: 10px 12px;
    }

    .comment-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .comment-author {
      font-weight: 700;
    }

    .comment-timestamp {
      color: var(--text-light);
      font-size: .85rem;
    }

    .comment-text {
      white-space: pre-wrap;
      word-break: break-word;
    }

    .comment-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 6px;
    }

    .comment-actions .reply-btn {
      background: none;
      border: none;
      color: var(--text-light);
      cursor: pointer;
    }

    .replies-container {
      margin-top: 6px;
    }

    .auto-log {
      color: var(--primary-color);
      font-weight: 700;
    }

    .mention {
      color: var(--primary-color);
      font-weight: 700;
    }

    /* 입력창 */
    .add-comment-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 12px;
      border: 1px solid var(--border-color);
      border-radius: 999px;
      padding: 10px 14px;
      background: var(--card-bg);
    }

    .add-comment-bar input {
      flex: 1;
      border: none;
      outline: none;
      background: transparent;
      color: var(--text-light);
    }

    /* 상세 카드 우측 아이콘 버튼 */
    .detail-actions {
      position: absolute;
      top: 12px;
      right: 12px;
      display: flex;
      gap: 8px;
    }

    .icon-ghost-btn {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .icon-ghost-btn .icon {
      width: 20px;
      height: 20px;
      display: block;
      background-size: contain;
      background-repeat: no-repeat;
    }

    .card-visibility .lock {
      width: 18px;
      height: 18px;
      display: inline-block;
      background-size: contain;
      background-repeat: no-repeat;
    }

    /* 메타 아이콘 공통 규격 */
    .meta-item .icon,
    .challenge-meta .meta-row .icon {
      width: 22px;
      height: 22px;
      display: inline-block;
      background-size: contain;
      background-repeat: no-repeat;
      flex-shrink: 0;
    }

    /* 카드 제목줄 오른쪽 잠금 아이콘 */
    .card-visibility {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: .85rem;
      color: var(--text-light);
    }

    /* --- 챌린지 만들기 모달 전용 스타일 --- */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 9999;
      background: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-content {
      background: var(--card-bg);
      padding: 24px;
      border-radius: 16px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .form-row {
      margin-bottom: 20px;
    }

    .form-row label {
      display: block;
      font-weight: 700;
      margin-bottom: 8px;
      font-size: 0.95rem;
    }

    .form-row legend {
      font-weight: 700;
      margin-bottom: 8px;
      font-size: 0.95rem;
    }

    /* 입력창 스타일 */
    .onb-input,
    .form-row input[type="text"],
    .form-row input[type="date"],
    .form-row input[type="datetime-local"],
    .form-row textarea,
    .form-row select {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      background: var(--bg-color);
      color: var(--text-color);
      font-size: 1rem;
      box-sizing: border-box;
      outline: none;
      transition: border-color 0.2s;
    }

    .onb-input:focus,
    .form-row input:focus,
    .form-row textarea:focus,
    .form-row select:focus {
      border-color: var(--primary-color);
    }

    /* 버튼 스타일 */
    .onb-btn {
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      border: none;
      font-size: 1rem;
      transition: opacity 0.2s;
      background-color: var(--border-color);
      color: var(--text-color);
    }

    .onb-primary {
      background-color: var(--primary-color);
      color: white;
    }

    .onb-ghost {
      background-color: var(--border-color);
      color: var(--text-color);
    }

    .onb-btn:hover {
      opacity: 0.9;
    }

    /* 라디오 버튼 정렬 */
    .radio {
      display: inline-flex;
      align-items: center;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .radio input {
      margin-right: 6px;
    }

    /* 텍스트 버튼 스타일 (공유, 수정, 삭제) */
    .text-action-btn {
      background: none;
      border: none;
      color: var(--text-light);
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      padding: 4px 8px;
      transition: color 0.2s;
    }

    .text-action-btn:hover {
      color: var(--primary-color);
    }

    .text-action-btn.delete:hover {
      color: #dc3545;
    }

    /* 제목 앞 비공개 텍스트 스타일 */
    .private-badge {
      color: var(--text-light);
      font-weight: 500;
      margin-right: 6px;
      font-size: 1.1rem;
    }

    /* 상세 카드 내 버튼 정렬 */
    .detail-actions-text {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 12px;
    }

    /* 닫기 버튼 스타일 */
    .icon-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-light);
      padding: 0;
      line-height: 1;
    }

    .icon-btn:hover {
      color: var(--text-color);
    }

    /* 하단 댓글 바 스타일 */
    .add-comment-bar {
      position: sticky;
      bottom: 0;
      background: var(--card-bg);
      padding: 12px;
      border-top: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 10;
    }

    .add-comment-bar input {
      flex: 1;
      padding: 10px 16px;
      border: 1px solid var(--border-color);
      border-radius: 20px;
      background: var(--bg-color);
    }

    .send-comment-btn {
      background: none;
      border: none;
      color: var(--primary-color);
      font-weight: bold;
      cursor: pointer;
    }
    /* 댓글 입력창 - 타임라인 밑 고정 스타일 */
.comment-section .add-comment-bar {
  position: relative;
  bottom: auto;
  left: auto;
  right: auto;
  border: 1px solid var(--border-color);
  border-radius: 25px;
  padding: 8px 12px;
  background: var(--card-bg);
  display: flex;
  align-items: center;
  gap: 10px;
}

.comment-section .add-comment-bar input {
  flex: 1;
  border: none;
  outline: none;
  background: transparent;
  font-size: 0.95rem;
  padding: 8px;
}

.send-comment-btn {
  background: none;
  border: none;
  color: var(--primary-color);
  font-weight: bold;
  cursor: pointer;
  padding: 8px 12px;
}
  </style>
</head>
<body>

  <div class="container">
    <!-- 상단 헤더 -->
    <header id="pageHeader" class="page-header"></header>

    <!-- 목록 뷰 -->
    <div id="challengeListView" style="display: none;">
      <div id="challengeList"></div>
      <div id="paginationControls" class="pagination"></div>
    </div>

    <!-- 상세 뷰 -->
<div id="challengeDetailView" style="display:none;">
    <div id="challengeInfo" class="challenge-info-card"></div>

    <section class="card comment-section">
      <h4 id="commentTitle">챌린지 타임라인</h4>
      
      <!-- ✅ 타임라인 제목 바로 밑에 댓글 입력창 -->
      <div class="add-comment-bar" style="margin-bottom: 16px; position:relative; border-radius:25px;">
        <img id="myAvatar" class="comment-avatar" style="width: 34px; height: 34px; border-radius: 50%;" alt="me">
        <input id="directCommentInput" type="text" placeholder="댓글을 남겨보세요...">
        <button id="directSubmitBtn" class="send-comment-btn">게시</button>
      </div>
      
      <div id="commentFeed"></div>
    </section>
</div>

<!-- ✅ 답글 모달 (body 끝에) -->
<div id="replyModal" class="modal">
  <div class="modal-content" style="max-width:480px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
      <h3 style="margin:0;">답글 달기</h3>
      <button id="closeReplyModal" class="icon-btn">✕</button>
    </div>
    <div id="replyTargetInfo" style="font-size:.9rem; color:var(--text-light); margin-bottom:12px; padding:10px; background:var(--bg-color); border-radius:8px;"></div>
    <textarea id="replyText" rows="3" placeholder="답글을 입력하세요..." style="width:100%; padding:12px; border:1px solid var(--border-color); border-radius:8px; resize:none;"></textarea>
    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px;">
      <button id="replyCancel" class="onb-btn onb-ghost">취소</button>
      <button id="replySubmit" class="onb-btn onb-primary">등록</button>
    </div>
  </div>
</div>

    <!-- 생성 모달 -->
    <div id="createChallengeModal" class="modal">
      <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="cc-title">
        <!-- 모달 헤더 -->
        <div class="modal-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
          <h3 id="cc-title" style="margin:0;">챌린지 만들기</h3>
          <button id="closeCreateChallengeModalBtn" class="icon-btn" aria-label="닫기">✕</button>
        </div>

        <!-- 모달 바디(폼) -->
        <form id="createChallengeForm" class="modal-body" autocomplete="off" style="margin-top:16px;">
          <!-- 단식 모델 -->
          <div class="form-row">
            <label for="fastingModelSelect">단식 모델</label>
            <select id="fastingModelSelect" required>
              <option value="8">8:16 (8시간 단식, 야식끊기)</option>
              <option value="12">12:12 (12시간 단식, 초보)</option>
              <option value="16">16:8 (16시간 단식, 인기)</option>
              <option value="18">18:6 (18시간 단식, 인기)</option>
              <option value="20">20:4 (20시간 단식, 고급)</option>
              <option value="24">24시간 (1일 단식, 고급)</option>
              <option value="36">36시간 (1.5일 단식, 고급)</option>
              <option value="48">48시간 (2일 단식, 고급)</option>
              <option value="72">72시간 (3일 단식, 고급)</option>
            </select>
          </div>

          <!-- 목표 -->
          <div class="form-row">
            <label for="cc-desc">목표</label>
            <textarea id="cc-desc" name="desc" rows="3" placeholder="간단한 설명을 적어주세요"></textarea>
          </div>

          <!-- 시작일 -->
          <div class="form-row">
            <label for="cc-start">시작일</label>
            <input id="cc-start" name="startDate" type="date" />
          </div>

          <!-- 공개 범위 -->
          <fieldset class="form-row" style="margin-top:8px; border:none; padding:0;">
            <legend>공개 범위</legend>
            <label class="radio">
              <input type="radio" name="visibility" value="private" checked>
              비공개
            </label>
            <label class="radio" style="margin-left:16px;">
              <input type="radio" name="visibility" value="public">
              공개
            </label>
          </fieldset>

          <!-- 푸터 버튼 -->
          <div class="modal-footer" style="margin-top:16px; display:flex; justify-content:flex-end; gap:8px;">
            <button type="button" class="onb-btn onb-ghost" id="cc-cancel">취소</button>
            <button type="submit" class="onb-btn onb-primary">생성</button>
          </div>
        </form>
      </div>
    </div>

    <!-- 수정 모달 -->
    <div id="editChallengeModal" class="modal">
      <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="ec-title">
        <div class="modal-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
          <h3 id="ec-title" style="margin:0;">챌린지 수정</h3>
          <button id="closeEditChallengeModalBtn" class="icon-btn" aria-label="닫기">✕</button>
        </div>
        <form id="editChallengeForm" class="modal-body" autocomplete="off" style="margin-top:16px;">
          <div class="form-row">
            <label for="ec-desc">목표/설명</label>
            <textarea id="ec-desc" rows="3"></textarea>
          </div>
          <div class="form-row">
            <label for="ec-start">시작일</label>
            <input id="ec-start" type="datetime-local" />
          </div>
          <fieldset class="form-row" style="margin-top:8px; border:none; padding:0;">
            <legend>공개 범위</legend>
            <label class="radio"><input type="radio" name="ec-visibility" value="private"> 비공개</label>
            <label class="radio" style="margin-left:16px;"><input type="radio" name="ec-visibility" value="public"> 공개</label>
          </fieldset>
          <div class="modal-footer" style="margin-top:16px; display:flex; justify-content:flex-end; gap:8px;">
            <button type="button" class="onb-btn onb-ghost" id="ec-cancel">취소</button>
            <button type="submit" class="onb-btn onb-primary">저장</button>
          </div>
        </form>
      </div>
    </div>

    <!-- 답글 모달 -->
    <div id="replyModal" class="modal">
      <div class="modal-content" style="max-width:520px;">
        <h3 style="margin-top:0;">답글 달기</h3>
        <div id="replyTargetInfo" style="font-size:.9rem; color:var(--text-light); margin-bottom:8px;"></div>
        <textarea id="replyText" rows="3" style="width:100%;" placeholder="내용을 입력하세요"></textarea>
        <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:10px;">
          <button id="replyCancel" class="onb-btn onb-ghost">취소</button>
          <button id="replySubmit" class="onb-btn onb-primary">등록</button>
        </div>
      </div>
    </div>

  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // --- 전역 변수 ---
  const auth = window.fastmateApp.auth;
  const db = window.fastmateApp.db;
  let currentUser = null;
  let stopListeningToChallenge = null;
  let allChallenges = [];
  let currentPage = 1;
  let currentUserProfile = null;
  let currentChallengeId = null;
  let replyingParentId = null;
  let modalMode = 'comment';

  const ITEMS_PER_PAGE = 20;

  // --- DOM 요소 ---
  const pageHeader = document.getElementById('pageHeader');
  const challengeListView = document.getElementById('challengeListView');
  const challengeListDiv = document.getElementById('challengeList');
  const paginationControls = document.getElementById('paginationControls');
  const challengeDetailView = document.getElementById('challengeDetailView');
  const challengeInfoDiv = document.getElementById('challengeInfo');
  const commentFeed = document.getElementById('commentFeed');

  // --- 유틸리티 함수 ---
  function escapeHTML(s) {
    return String(s || '').replace(/[&<>"']/g, ch => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    }[ch]));
  }

  function toast(msg) {
    const t = document.createElement('div');
    t.textContent = msg;
    t.style.cssText = 'position:fixed;left:50%;bottom:40px;transform:translateX(-50%);background:#000a;color:#fff;padding:10px 14px;border-radius:8px;z-index:99999';
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 1800);
  }

  function initials2(name = '사용자') {
    const s = String(name).trim().replace(/\s+/g, '');
    return s.slice(0, 2) || '유저';
  }

  function ymdhm(d) {
    const p = n => String(n).padStart(2, '0');
    return `${d.getFullYear()}-${p(d.getMonth() + 1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;
  }

  function relativeOrDate(ts) {
    const d = ts?.toDate?.();
    if (!d) return '';
    const diffH = (Date.now() - d.getTime()) / 36e5;
    if (diffH < 1) {
      const m = Math.max(1, Math.floor(diffH * 60));
      return `${m}분 전`;
    }
    if (diffH < 24) {
      const h = Math.max(1, Math.floor(diffH));
      return `${h}시간 전`;
    }
    return ymdhm(d);
  }

  function linkify(text) {
    const safe = escapeHTML(text);
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    return safe.replace(urlRegex, url => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
  }

  function renderCommentText(text = '', isAuto) {
    const html = linkify(text);
    return isAuto ? `<span class="auto-log">${html}</span>` : html;
  }

  // --- 뷰 관리 ---
  function showView(viewName, challengeId = null) {
    challengeListView.style.display = 'none';
    challengeDetailView.style.display = 'none';
    if (stopListeningToChallenge) stopListeningToChallenge();

    if (viewName === 'list') {
      currentChallengeId = null;
      challengeListView.style.display = 'block';
      renderListHeader();
      loadAndRenderChallenges();
    } else if (viewName === 'detail' && challengeId) {
      currentChallengeId = challengeId;
      challengeDetailView.style.display = 'block';
      listenToChallengeDetails(challengeId);
    }
  }

  // --- 헤더 렌더링 ---
  function renderListHeader() {
    pageHeader.innerHTML = `
      <button class="header-btn" title="메인으로" onclick="location.href='fastmate.html'">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
      </button>
      <div class="page-title-group">
        <h1 class="page-title">챌린지</h1>
        <span class="beta-tag">BETA</span>
      </div>
      <button class="create-challenge-btn" id="createChallengeBtnHeader">챌린지 만들기</button>
    `;

    document.getElementById('createChallengeBtnHeader')?.addEventListener('click', () => {
      document.getElementById('createChallengeModal').style.display = 'flex';
    });
  }

  function renderDetailHeader(challenge) {
    const isPrivate = (challenge.visibility || 'private') === 'private';
    const visibilityLabel = isPrivate ? '[비공개]' : '[공개]';
    
    pageHeader.innerHTML = `
      <button class="header-btn" id="backToListBtn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
      </button>
      <div class="page-title-group">
        <h1 class="page-title" style="font-size: 1.1rem;">
          <span style="color: var(--text-light); font-weight: 500;">${visibilityLabel}</span> ${escapeHTML(challenge.challengeName)}
        </h1>
      </div>
      <div style="width: 40px;"></div>
    `;
    document.getElementById('backToListBtn')?.addEventListener('click', () => showView('list'));
  }

  // --- 챌린지 목록 ---
  async function loadAndRenderChallenges() {
    if (!currentUser) return;
    challengeListDiv.innerHTML = "<p>챌린지 목록을 불러오는 중...</p>";

    try {
      const query = db.collection('challenges')
        .where('participantUids', 'array-contains', currentUser.uid)
        .orderBy('startTime', 'desc');
      const snapshot = await query.get();

      allChallenges = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      currentPage = 1;
      renderChallengePage();
    } catch (error) {
      console.error("챌린지 목록 로딩 실패:", error);
      challengeListDiv.innerHTML = '<p>목록을 불러오는 데 실패했습니다.</p>';
    }
  }

  function renderChallengePage() {
    const start = (currentPage - 1) * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;
    const pageItems = allChallenges.slice(start, end);

    if (pageItems.length === 0) {
      challengeListDiv.innerHTML = '<p style="text-align:center; color:var(--text-light);">참여 중인 챌린지가 없습니다.</p>';
      paginationControls.innerHTML = '';
      return;
    }

    challengeListDiv.innerHTML = pageItems.map(ch => {
      const d = ch.startTime?.toDate?.();
      const dateStr = d ? d.toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' }) : '-';
      const memberCount = Array.isArray(ch.participantUids) ? ch.participantUids.length : (ch.memberCount || 1);

      return `
        <div class="challenge-card" data-id="${ch.id}">
          <div class="challenge-content">
            <h3>${escapeHTML(ch.challengeName || '챌린지')}</h3>
            <div class="challenge-meta">
              <div class="meta-row">
                <span class="icon" style="background-image:var(--icon-people);"></span>
                <span>${memberCount}명 참여</span>
              </div>
              <div class="meta-row">
                <span class="icon" style="background-image:var(--icon-date);"></span>
                <span>${dateStr}</span>
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');

    // 카드 클릭 이벤트
    challengeListDiv.querySelectorAll('.challenge-card').forEach(card => {
      card.addEventListener('click', () => {
        const id = card.dataset.id;
        if (id) showView('detail', id);
      });
    });

    renderPagination();
  }

  function renderPagination() {
    const totalPages = Math.ceil(allChallenges.length / ITEMS_PER_PAGE);
    if (totalPages <= 1) {
      paginationControls.innerHTML = '';
      return;
    }

    paginationControls.innerHTML = `
      <button id="prevPageBtn" ${currentPage === 1 ? 'disabled' : ''}>이전</button>
      <span class="page-number">${currentPage} / ${totalPages}</span>
      <button id="nextPageBtn" ${currentPage === totalPages ? 'disabled' : ''}>다음</button>
    `;

    document.getElementById('prevPageBtn')?.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        renderChallengePage();
      }
    });
    document.getElementById('nextPageBtn')?.addEventListener('click', () => {
      if (currentPage < totalPages) {
        currentPage++;
        renderChallengePage();
      }
    });
  }

  // --- 챌린지 상세 ---
  function listenToChallengeDetails(challengeId) {
    const ref = db.collection('challenges').doc(challengeId);
    stopListeningToChallenge = ref.onSnapshot(doc => {
      if (!doc.exists) {
        alert("삭제되었거나 존재하지 않는 챌린지입니다.");
        return showView('list');
      }
      const challenge = { id: doc.id, ...doc.data() };
      currentChallengeId = challenge.id;
      renderDetailHeader(challenge);
      renderChallengeInfo(challenge);
      renderComments(challenge.id);
    });
  }

  function renderChallengeInfo(ch) {
    const $info = document.getElementById('challengeInfo');
    if (!$info) return;

    const isPrivate = (ch.visibility || 'private') === 'private';
    const hostName = ch.hostName || ch.ownerName || '사용자';
    const d = ch.startTime?.toDate?.();
    const dateStr = d ? d.toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' }) : '-';
    const timeStr = d ? d.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }) : '-';
    
    // 끝나는 시간 계산 (단식 모델 시간 더하기)
    const fastingMinutes = ch.fastingModelMinutes || 16 * 60; // 기본 16시간
    let endTimeStr = '-';
    if (d) {
      const endDate = new Date(d.getTime() + fastingMinutes * 60 * 1000);
      endTimeStr = endDate.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
    }
    
    const memberCount = Array.isArray(ch.participantUids) ? ch.participantUids.length : (ch.memberCount || 1);
    const desc = (ch.description || '').trim();
    const goal = (ch.detailedGoal || '').trim();

    $info.innerHTML = `
      <div class="card challenge-details" style="position:relative; padding: 24px; margin-bottom: 20px;">
        <div class="detail-actions-text">
          <button id="shareLinkBtn" class="text-action-btn">공유</button>
          <button id="editChallengeBtn" class="text-action-btn">수정</button>
          <button id="deleteChallengeBtn" class="text-action-btn delete">삭제</button>
        </div>

        <div class="challenge-title-row" style="margin-bottom: 15px; margin-top: 10px;">
          <h2 class="challenge-title" style="margin:0; font-size: 1.35rem; display: flex; align-items: center; gap: 6px;">
            ${isPrivate ? '<span class="private-badge">[비공개]</span>' : '<span class="private-badge">[공개]</span>'}
            <span style="color: var(--primary-color); font-weight: 700;">${escapeHTML(hostName)}</span>님의 ${escapeHTML(ch.fastingModelLabel || '')} 단식
          </h2>
        </div>

        ${desc ? `<p class="challenge-desc" style="color: var(--text-light); line-height: 1.6; margin-bottom: 24px;">${escapeHTML(desc)}</p>` : ''}

        <ul class="challenge-meta-list">
          <li class="meta-item">
            <span class="icon" style="background-image:var(--icon-people); width:22px; height:22px;"></span>
            <span>참여자: ${memberCount}명</span>
          </li>
          <li class="meta-item">
            <span class="icon" style="background-image:var(--icon-date); width:22px; height:22px;"></span>
            <span>날짜: ${dateStr}</span>
          </li>
          <li class="meta-item">
            <span class="icon" style="background-image:var(--icon-time); width:22px; height:22px;"></span>
            <span>시작시간: ${timeStr}</span>
          </li>
          <li class="meta-item">
            <span class="icon" style="background-image:var(--icon-time); width:22px; height:22px;"></span>
            <span>종료시간: ${endTimeStr}</span>
          </li>
          ${goal ? `
          <li class="meta-item">
            <span class="icon" style="background-image:var(--icon-goal); width:22px; height:22px;"></span>
            <span>목표: ${escapeHTML(goal)}</span>
          </li>` : ''}
        </ul>
      </div>
    `;

    // 이벤트 리스너
    document.getElementById('shareLinkBtn')?.addEventListener('click', async () => {
      const url = `${location.origin}/challenge-invite.html?id=${encodeURIComponent(ch.id)}`;
      try {
        await navigator.clipboard.writeText(url);
        toast('링크를 복사했어요');
      } catch {
        prompt('아래 링크를 복사하세요', url);
      }
    });

    document.getElementById('editChallengeBtn')?.addEventListener('click', () => {
      const startMs = ch.startTime?.toDate?.()?.getTime?.() || 0;
      if (startMs - Date.now() < 30 * 60 * 1000) {
        return toast('챌린지는 시작 30분전까지 수정 가능합니다.');
      }
      openEditChallengeModal(ch);
    });

    document.getElementById('deleteChallengeBtn')?.addEventListener('click', async () => {
      if (!confirm('정말 삭제할까요?')) return;
      try {
        await db.collection('challenges').doc(ch.id).delete();
        toast('삭제되었습니다.');
        showView('list');
      } catch (e) {
        toast('삭제 실패');
      }
    });
  }

  // --- 댓글 ---
  async function renderComments(chId) {
    currentChallengeId = chId;
    const snap = await db.collection('challenges').doc(chId)
      .collection('comments').orderBy('timestamp', 'asc').get();

    const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    const feed = document.getElementById('commentFeed');
    feed.innerHTML = '';

    const childrenMap = {};
    docs.forEach(c => {
      if (c.parentId) {
        (childrenMap[c.parentId] ||= []).push(c);
      }
    });
    const total = docs.length;
    document.getElementById('commentTitle').textContent = `챌린지 타임라인 (${total})`;

    docs.filter(c => !c.parentId).forEach(c => {
      const replies = childrenMap[c.id] || [];
      feed.appendChild(createCommentEl(c, replies, false));
    });
  }

function createCommentEl(c, replies = [], isReply = false) {
    const wrap = document.createElement('div');
    wrap.className = 'comment' + (isReply ? ' reply' : '');
    const nick = c.nickname || '사용자';
    const ts = relativeOrDate(c.timestamp);

    let avatarHtml = c.photoURL
      ? `<img src="${c.photoURL}" alt="${nick}" class="comment-avatar">`
      : `<div class="comment-avatar" style="background:#e5e5e5;display:flex;align-items:center;justify-content:center;color:#555;font-weight:700;">${initials2(nick)}</div>`;

    let textHtml = renderCommentText(c.text || '', !!c.isAutoComment);
    if (isReply && !/^@\S+/.test(c.text || '')) {
      textHtml = `<span class="mention">@${c.parentNickname || ''}</span> ` + textHtml;
    }

    wrap.innerHTML = `
      <div class="comment-avatar-column">
        ${avatarHtml}
        ${!isReply && replies.length > 0 ? '<div class="thread-line"></div>' : ''}
      </div>
      <div class="comment-main">
        <div class="comment-bubble">
          <div class="comment-header">
            <span class="comment-author">${nick}</span>
            <span class="comment-timestamp">${ts}</span>
          </div>
          <div class="comment-text">${textHtml}</div>
          <div class="comment-actions">
            ${!isReply ? `<button class="reply-btn" data-target="${c.id}" data-nick="${nick}" data-text="${escapeHTML(c.text || '')}">답글달기</button>` : ''}
          </div>
          ${!isReply && replies.length > 0 ? `
            <button class="onb-btn toggle-replies" data-toggle="${c.id}" style="margin-top:6px; font-size:0.8rem; background:none; color:var(--primary-color);">▽ 답글 ${replies.length}개 보기</button>
            <div class="replies-container" id="rc-${c.id}" style="display:none;"></div>
          ` : `<div class="replies-container" id="rc-${c.id}" style="display:none;"></div>`}
        </div>
      </div>`;

    // ✅ 답글 버튼 → 모달 열기
    wrap.querySelector('.reply-btn')?.addEventListener('click', (e) => {
      const targetId = e.target.dataset.target;
      const targetNick = e.target.dataset.nick;
      const targetText = e.target.dataset.text || '';

      replyingParentId = targetId;
      
      const infoEl = document.getElementById('replyTargetInfo');
      if (infoEl) {
        infoEl.innerHTML = `<strong>@${targetNick}</strong>에게 답글<br><span style="color:var(--text-light);">${targetText.slice(0, 50)}${targetText.length > 50 ? '...' : ''}</span>`;
      }
      
      const textEl = document.getElementById('replyText');
      if (textEl) textEl.value = '';
      
      const modal = document.getElementById('replyModal');
      if (modal) {
        modal.style.display = 'flex';
        textEl?.focus();
      }
    });

    // ✅ 답글 토글
    wrap.querySelector('.toggle-replies')?.addEventListener('click', (e) => {
      const box = wrap.querySelector(`#rc-${c.id}`);
      if (box && box.childElementCount === 0) {
        replies.forEach(r => {
          r.parentNickname = nick;
          box.appendChild(createCommentEl(r, [], true));
        });
      }
      const opened = box.style.display !== 'none';
      box.style.display = opened ? 'none' : 'block';
      e.target.textContent = opened ? `▽ 답글 ${replies.length}개 보기` : '▲ 답글 접기';
    });

    return wrap;
}

// --- 수정 모달 ---
function openEditChallengeModal(ch) {
    const modal = document.getElementById('editChallengeModal');
    const descEl = document.getElementById('ec-desc');
    const startEl = document.getElementById('ec-start');

    descEl.value = ch.description || '';

    const d = ch.startTime?.toDate?.();
    if (d) {
      const pad = n => String(n).padStart(2, '0');
      const iso = `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
      startEl.value = iso;
    } else {
      startEl.value = '';
    }

    document.querySelectorAll('input[name="ec-visibility"]').forEach(r => {
      r.checked = (r.value === (ch.visibility || 'private'));
    });

    modal.style.display = 'flex';

    const close = () => { modal.style.display = 'none'; };
    document.getElementById('closeEditChallengeModalBtn').onclick = close;
    document.getElementById('ec-cancel').onclick = close;

    const form = document.getElementById('editChallengeForm');
    form.onsubmit = async (e) => {
      e.preventDefault();
      try {
        const visibility = document.querySelector('input[name="ec-visibility"]:checked')?.value || 'private';
        const desc = (descEl.value || '').trim();
        const startVal = startEl.value;
        let startTs = ch.startTime || null;

        if (startVal) {
          startTs = firebase.firestore.Timestamp.fromDate(new Date(startVal));
        }

        await db.collection('challenges').doc(ch.id).update({
          description: desc,
          visibility,
          startTime: startTs,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        });

        toast('저장되었습니다.');
        close();
      } catch (err) {
        console.error(err);
        toast('저장에 실패했습니다.');
      }
    };
}

// --- 모달 이벤트 바인딩 ---
(function bindCreateModalOnce() {
    if (window.__BIND_CREATE_MODAL__) return;
    window.__BIND_CREATE_MODAL__ = true;

    document.addEventListener('click', (e) => {
      const modal = document.getElementById('createChallengeModal');
      if (!modal) return;

      const openBtn = e.target.closest('#createChallengeBtnHeader');
      const closeBtn = e.target.closest('#closeCreateChallengeModalBtn, #cc-cancel');

      if (openBtn) {
        modal.style.display = 'flex';
        const sel = document.getElementById('fastingModelSelect');
        if (sel) sel.value = localStorage.getItem('fm_model') || '16';
        return;
      }
      if (closeBtn) {
        modal.style.display = 'none';
        return;
      }
      if (e.target === modal) modal.style.display = 'none';
    });

    document.addEventListener('submit', async (e) => {
      const form = e.target.closest('#createChallengeForm');
      if (!form) return;
      e.preventDefault();

      if (!currentUser) {
        alert('로그인이 필요합니다');
        return;
      }

      const desc = (document.getElementById('cc-desc').value || '').trim();
      const startDateVal = document.getElementById('cc-start').value || null;
      const visibility = (document.querySelector('input[name="visibility"]:checked')?.value) || 'private';

      const sel = document.getElementById('fastingModelSelect');
      const modelMinutes = parseInt(sel?.value || '16', 10);
      let modelLabel = sel?.selectedOptions?.[0]?.textContent || '16:8';
      modelLabel = modelLabel.split('(')[0].trim();
      try { localStorage.setItem('fm_model', String(modelMinutes)); } catch {}

      const ownerName = currentUserProfile?.nickname || currentUser.displayName || '사용자';
      const ownerPhotoURL = currentUserProfile?.photoURL || currentUser.photoURL || null;
      const finalName = `${ownerName} ${modelLabel}`;

      const startTs = startDateVal
        ? firebase.firestore.Timestamp.fromDate(new Date(startDateVal))
        : firebase.firestore.FieldValue.serverTimestamp();

      const fmtDate = (d) => {
        try { return d.toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' }); }
        catch { return '-'; }
      };
      const fmtTime = (d) => {
        try { return d.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }); }
        catch { return '-'; }
      };

      let startDateStr = '-', startTimeStr = '-';
      if (startDateVal) {
        const d = new Date(startDateVal);
        startDateStr = fmtDate(d);
        startTimeStr = fmtTime(d);
      }

      try {
        const payload = {
          startTime: startTs,
          participantUids: [currentUser.uid],
          hostUid: currentUser.uid,
          challengeName: finalName,
          description: desc,
          hostName: ownerName,
          ownerName,
          ownerPhotoURL,
          visibility,
          isBeta: true,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          memberCount: 1,
          fastingModelMinutes: modelMinutes,
          fastingModelLabel: modelLabel,
          startDateStr,
          startClockStr: startTimeStr
        };

        const docRef = await db.collection('challenges').add(payload);

        await db.collection('challenges').doc(docRef.id)
          .collection('members').doc(currentUser.uid)
          .set({
            uid: currentUser.uid,
            nickname: ownerName,
            photoURL: ownerPhotoURL || null,
            role: 'owner',
            joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
          });

        if (typeof switchToGroupFasting === 'function') {
          try { await switchToGroupFasting(currentUser.uid, docRef.id, modelMinutes, startTs); } catch {}
        }

        const modal = document.getElementById('createChallengeModal');
        if (modal) modal.style.display = 'none';
        showView('list');
      } catch (err) {
        console.error('챌린지 생성 오류:', err);
        alert('챌린지 생성 중 오류가 발생했습니다');
      }
    });
})();

// --- 댓글 등록 (일반) ---
document.getElementById('directSubmitBtn')?.addEventListener('click', async () => {
    const input = document.getElementById('directCommentInput');
    const text = input.value.trim();

    if (!text || !currentUser || !currentChallengeId) return;

    const payload = {
      uid: currentUser.uid,
      nickname: currentUserProfile?.nickname || '사용자',
      photoURL: currentUser.photoURL || null,
      text: text,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      isAutoComment: false,
      parentId: null  // 일반 댓글은 parentId 없음
    };

    try {
      await db.collection('challenges').doc(currentChallengeId).collection('comments').add(payload);
      input.value = '';
      renderComments(currentChallengeId);
      toast('댓글이 등록되었습니다.');
    } catch (e) {
      console.error(e);
      toast('등록 실패');
    }
});

// --- 답글 모달 이벤트 (1회만 바인딩) ---
(function bindReplyModalOnce() {
    if (window.__BIND_REPLY_MODAL__) return;
    window.__BIND_REPLY_MODAL__ = true;

    // 닫기 버튼
    document.getElementById('closeReplyModal')?.addEventListener('click', () => {
      document.getElementById('replyModal').style.display = 'none';
      replyingParentId = null;
    });

    // 취소 버튼
    document.getElementById('replyCancel')?.addEventListener('click', () => {
      document.getElementById('replyModal').style.display = 'none';
      replyingParentId = null;
    });

    // 배경 클릭
    document.getElementById('replyModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'replyModal') {
        e.target.style.display = 'none';
        replyingParentId = null;
      }
    });

    // 답글 등록
    document.getElementById('replySubmit')?.addEventListener('click', async () => {
      const text = document.getElementById('replyText').value.trim();
      if (!text || !currentUser || !currentChallengeId || !replyingParentId) return;

      const payload = {
        uid: currentUser.uid,
        nickname: currentUserProfile?.nickname || '사용자',
        photoURL: currentUser.photoURL || null,
        text: text,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        isAutoComment: false,
        parentId: replyingParentId
      };

      try {
        await db.collection('challenges').doc(currentChallengeId).collection('comments').add(payload);
        document.getElementById('replyModal').style.display = 'none';
        document.getElementById('replyText').value = '';
        replyingParentId = null;
        renderComments(currentChallengeId);
        toast('답글이 등록되었습니다.');
      } catch (e) {
        console.error(e);
        toast('등록 실패');
      }
    });
})();

  // --- 초기화 ---
  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      currentUserProfile = {
        nickname: user.displayName || '사용자',
        photoURL: user.photoURL || null,
      };

      const avatar = document.getElementById('myAvatar');
      if (avatar) {
        if (user.photoURL) avatar.src = user.photoURL;
        else {
          avatar.removeAttribute('src');
          avatar.style.background = '#ddd';
        }
      }

      showView('list');
    } else {
      currentUser = null;
      document.body.innerHTML = `<div class="container" style="text-align:center; padding-top: 50px;">챌린지 기능을 사용하려면 로그인이 필요합니다.</div>`;
    }
  });

  // 열린 메뉴 닫기
  document.addEventListener('click', () => {
    document.querySelectorAll('.options-menu').forEach(menu => menu.style.display = 'none');
  });
});
</script>

</body>
</html>