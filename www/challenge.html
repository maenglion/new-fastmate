<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Fastmate - ì±Œë¦°ì§€</title>
    <link rel="stylesheet" href="./styles.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script defer src="/firebase-init.js?v=2025.09.06-v8"></script>
    <style>
        /* challenge.html ì „ìš© ìŠ¤íƒ€ì¼ */
        body { background-color: var(--bg-color); font-family: 'Noto Sans KR', sans-serif; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .page-title { font-size: 1.8rem; font-weight: 700; color: var(--primary-color); margin: 0; }
        .header-btn { background: none; border: none; cursor: pointer; padding: 8px; }
        .challenge-card { background: var(--card-bg); border-radius: 16px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .challenge-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .challenge-card h3 { margin: 0 0 12px; font-size: 1.2rem; color: var(--text-color); }
        .challenge-info { font-size: 0.9rem; color: var(--text-light); display: flex; flex-wrap: wrap; gap: 5px 15px; }
        .challenge-info b { color: var(--text-color); }
        .create-challenge-fab { position: fixed; right: 25px; bottom: 25px; width: 56px; height: 56px; background-color: var(--primary-color); color: white; border-radius: 50%; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-size: 28px; line-height: 56px; text-align: center; cursor: pointer; transition: transform 0.2s; }
        .create-challenge-fab:hover { transform: scale(1.1); }
        .challenge-details p { margin: 4px 0; color: var(--text-light); font-size: 0.9rem; }
        .comment-form { display: flex; gap: 10px; margin: 20px 0; }
        .comment-form textarea { flex-grow: 1; border-radius: 12px; border: 1px solid var(--border-color); padding: 10px; font-family: inherit; resize: vertical; }
        .comment-form button { padding: 10px 15px; }
        .comment { display: flex; gap: 10px; margin-bottom: 15px; }
        .comment-avatar { width: 36px; height: 36px; border-radius: 50%; background: #eee; flex-shrink: 0; }
        .comment-content { font-size: 0.9rem; background: #f1f3f5; padding: 10px 12px; border-radius: 12px; width: 100%;}
        .comment-content strong { font-weight: 700; color: var(--text-color); }
        .comment-footer { font-size: 0.8rem; color: var(--text-light); margin-top: 8px; }
        .reply-btn { background: none; border: none; color: var(--text-light); font-weight: 700; cursor: pointer; margin-left: 10px; padding: 0; }
        .replies { margin-left: 46px; margin-top: 15px; }
        .reply-form { margin-left: 46px; margin-top: 10px; display: flex; gap: 10px; }
        .comment.is-auto .comment-content { background: #fffbe6; }
    </style>
</head>
<body>

    <div class="container">
        <header id="pageHeader" class="page-header">
            </header>

        <div id="challengeList"></div>
        
        <div id="challengeDetailView" style="display: none;">
            <div class="card challenge-details">
                <p>ğŸ¯ <b>ëª©í‘œ:</b> <span id="detailChallengeGoal">-</span></p>
                <p>ğŸ‘¥ <b>ì°¸ì—¬ì:</b> <span id="detailChallengeParticipants">-</span></p>
                <p>ğŸ“… <b>ì‹œì‘ì¼:</b> <span id="detailChallengeStartTime">-</span></p>
            </div>

            <div class="card comment-section">
                <h4>ì±Œë¦°ì§€ íƒ€ì„ë¼ì¸</h4>
                <div class="comment-form">
                    <textarea id="newCommentText" placeholder="ì‘ì› ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”..." rows="1"></textarea>
                    <button id="submitCommentBtn" class="onb-btn onb-primary">ë“±ë¡</button>
                </div>
                <div id="commentFeed"></div>
            </div>
        </div>

        <button id="createChallengeBtn" class="create-challenge-fab">+</button>
    </div>

    <div id="createChallengeModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 20px;">
        <div style="background: var(--card-bg); padding: 25px; border-radius: 16px; width: 100%; max-width: 420px;">
            <h3 class="onb-title" style="margin-top:0;">ìƒˆë¡œìš´ ì±Œë¦°ì§€ ë§Œë“¤ê¸°</h3>
            <label class="onb-label">ë‹¨ì‹ ê³„íš</label>
            <select id="challengeModelSelect" class="onb-input" style="margin-top:5px; margin-bottom:15px;">
                <option value="16">16:8 (16ì‹œê°„ ë‹¨ì‹,ì¸ê¸°)</option>
                <option value="24">24ì‹œê°„ (1ì¼ ë‹¨ì‹,ê³ ê¸‰)</option>
                <option value="36">36ì‹œê°„(1.5ì¼ ë‹¨ì‹,ê³ ê¸‰)</option>
                <option value="48">48ì‹œê°„ (2ì¼ ë‹¨ì‹,ê³ ê¸‰)</option>
                <option value="72">72ì‹œê°„ (3ì¼ ë‹¨ì‹,ê³ ê¸‰)</option>
            </select>
            <label class="onb-label">ì‹œì‘ ë‚ ì§œ</label>
            <input type="date" id="challengeDatePicker" class="onb-input" style="margin-top:5px; margin-bottom:15px;">
            <label class="onb-label">ì‹œì‘ ì‹œê°„</label>
            <input type="time" id="challengeTimePicker" class="onb-input" style="margin-top:5px; margin-bottom:15px;">
            <label class="onb-label">ì„¸ë¶€ ëª©í‘œ (ì„ íƒ)</label>
            <textarea id="challengeDetailedGoal" class="onb-input" placeholder="ì˜ˆ: ë§¤ì¼ 30ë¶„ ìš´ë™í•˜ê¸°" style="margin-top:5px; min-height: 80px;"></textarea>
            <div class="onb-actions">
                <button type="button" id="closeCreateChallengeModalBtn" class="onb-btn onb-ghost">ì·¨ì†Œ</button>
                <button type="button" id="saveChallengeBtn" class="onb-btn onb-primary">ì €ì¥í•˜ê³  ì¹œêµ¬ ì´ˆëŒ€í•˜ê¸°</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- 1. ì „ì—­ ë³€ìˆ˜ ë° ê°ì²´ ---
    const auth = window.fastmateApp.auth;
    const db = window.fastmateApp.db;
    let currentUser = null;
    let currentUserProfile = null; 
    let stopListeningToChallenge = null; // ì‹¤ì‹œê°„ ê°ì§€ ì¤‘ë‹¨ í•¨ìˆ˜

    // --- 2. DOM ìš”ì†Œ ìºì‹œ ---
    const challengeListDiv = document.getElementById('challengeList');
    const challengeDetailView = document.getElementById('challengeDetailView');
    const createChallengeBtn = document.getElementById('createChallengeBtn');
    const pageHeader = document.getElementById('pageHeader');
    const detailChallengeGoal = document.getElementById('detailChallengeGoal');
    const detailChallengeParticipants = document.getElementById('detailChallengeParticipants');
    const detailChallengeStartTime = document.getElementById('detailChallengeStartTime');
    const commentFeed = document.getElementById('commentFeed');
    const newCommentText = document.getElementById('newCommentText');
    const submitCommentBtn = document.getElementById('submitCommentBtn');
    const createChallengeModal = document.getElementById('createChallengeModal');
    const closeCreateChallengeModalBtn = document.getElementById('closeCreateChallengeModalBtn');
    const saveChallengeBtn = document.getElementById('saveChallengeBtn');
    const challengeModelSelect = document.getElementById('challengeModelSelect');
    const challengeDatePicker = document.getElementById('challengeDatePicker');
    const challengeTimePicker = document.getElementById('challengeTimePicker');
    const challengeDetailedGoal = document.getElementById('challengeDetailedGoal');

    // --- 3. í•µì‹¬ í•¨ìˆ˜ ---

    function showListView() {
        if (stopListeningToChallenge) stopListeningToChallenge();
        challengeListDiv.style.display = 'block';
        challengeDetailView.style.display = 'none';
        createChallengeBtn.style.display = 'block';
        
        pageHeader.innerHTML = `
            <h1 class="page-title">ë‚˜ì˜ ì±Œë¦°ì§€</h1>
            <button class="header-btn" title="ë©”ì¸ìœ¼ë¡œ" onclick="location.href='fastmate.html'">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
            </button>
        `;
        loadAndRenderChallenges();
    }

    function showDetailView(challengeId) {
        challengeListDiv.style.display = 'none';
        challengeDetailView.style.display = 'block';
        createChallengeBtn.style.display = 'none';
        listenToChallengeDetails(challengeId);
    }

    async function loadAndRenderChallenges() {
        if (!currentUser) return;
        challengeListDiv.innerHTML = "<p>ì±Œë¦°ì§€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>";
        try {
            const query = db.collection('challenges').where('participantUids', 'array-contains', currentUser.uid).orderBy('startTime', 'desc');
            const snapshot = await query.get();
            if (snapshot.empty) {
                challengeListDiv.innerHTML = '<div class="card" style="text-align:center;"><p>ì•„ì§ ì°¸ì—¬í•œ ì±Œë¦°ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>';
                return;
            }
            challengeListDiv.innerHTML = '';
            snapshot.forEach(doc => {
                const challenge = { id: doc.id, ...doc.data() };
                const card = document.createElement('div');
                card.className = 'challenge-card';
                const startTime = challenge.startTime.toDate();
                const formattedDate = `${startTime.getMonth()+1}/${startTime.getDate()} ${startTime.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true})}`;
                card.innerHTML = `<h3>${challenge.challengeName}</h3><div class="challenge-info"><span>ğŸ‘¥ ì°¸ì—¬: <b>${challenge.participantUids.length}</b>ëª…</span><span>ğŸ“… ì‹œì‘: ${formattedDate}</span><span>â­ ëª©í‘œ: ${challenge.detailedGoal || 'ì—†ìŒ'}</span></div>`;
                card.addEventListener('click', () => showDetailView(challenge.id));
                challengeListDiv.appendChild(card);
            });
        } catch (error) {
            console.error("ì±Œë¦°ì§€ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:", error);
            challengeListDiv.innerHTML = '<p>ì±Œë¦°ì§€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }

    function listenToChallengeDetails(challengeId) {
        if (stopListeningToChallenge) stopListeningToChallenge();

        const challengeRef = db.collection('challenges').doc(challengeId);
        stopListeningToChallenge = challengeRef.onSnapshot(doc => {
            if (doc.exists) {
                const challenge = doc.data();
                pageHeader.innerHTML = `
                    <button class="header-btn back-btn"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                    <h1 class="page-title">${challenge.challengeName}</h1>
                    <div style="width: 36px;"></div>
                `;
                pageHeader.querySelector('.back-btn').addEventListener('click', showListView);

                detailChallengeGoal.textContent = challenge.detailedGoal || 'ì—†ìŒ';
                detailChallengeParticipants.textContent = `${challenge.participantUids.length}ëª… ì°¸ì—¬ì¤‘`;
                const startTime = challenge.startTime.toDate();
                detailChallengeStartTime.textContent = `${startTime.getMonth()+1}/${startTime.getDate()} ${startTime.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true})}`;

                // ëŒ“ê¸€ ë Œë”ë§
                renderComments(challengeId);
            } else {
                showListView();
                alert("ì‚­ì œë˜ì—ˆê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì±Œë¦°ì§€ì…ë‹ˆë‹¤.");
            }
        });
    }

    function renderComments(challengeId) {
        db.collection('challenges').doc(challengeId).collection('comments').orderBy('timestamp', 'asc').onSnapshot(snapshot => {
            commentFeed.innerHTML = '';
            const comments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const commentElements = {};

            comments.filter(c => !c.parentId).forEach(comment => {
                const commentDiv = createCommentElement(comment);
                commentFeed.appendChild(commentDiv);
                commentElements[comment.id] = commentDiv;
            });
            comments.filter(c => c.parentId).forEach(reply => {
                const parentDiv = commentElements[reply.parentId];
                if (parentDiv) {
                    let repliesContainer = parentDiv.querySelector('.replies');
                    if (!repliesContainer) {
                        repliesContainer = document.createElement('div');
                        repliesContainer.className = 'replies';
                        parentDiv.appendChild(repliesContainer);
                    }
                    repliesContainer.appendChild(createCommentElement(reply, true));
                }
            });
        });
    }

    function createCommentElement(comment, isReply = false) {
        const div = document.createElement('div');
        div.className = 'comment' + (comment.isAutoComment ? ' is-auto' : '') + (isReply ? ' is-reply' : '');
        div.dataset.commentId = comment.id;
        const date = comment.timestamp?.toDate()?.toLocaleTimeString('ko-KR', { hour:'numeric', minute:'2-digit' }) || '';
        div.innerHTML = `
            <div class="comment-avatar"></div>
            <div class="comment-content">
                <strong>${comment.nickname}</strong>
                <p style="margin: 4px 0;">${comment.text}</p>
                <div class="comment-footer">
                    <span>${date}</span>
                    <button class="reply-btn">ë‹µê¸€ ë‹¬ê¸°</button>
                </div>
            </div>`;
        return div;
    }

    // --- 4. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
    
       createChallengeBtn?.addEventListener('click', () => {
        if (!currentUser) return alert('ì±Œë¦°ì§€ë¥¼ ë§Œë“¤ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        
        // ë‚ ì§œì™€ ì‹œê°„ ê¸°ë³¸ê°’ ì„¤ì • (í˜„ì¬ ì‹œê°„ + 1ì‹œê°„)
        const now = new Date(Date.now() + 3600 * 1000); // 1ì‹œê°„ í›„ë¡œ ê¸°ë³¸ ì„¤ì •
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        challengeDatePicker.value = `${year}-${month}-${day}`;
        challengeTimePicker.value = now.toTimeString().slice(0, 5);

        createChallengeModal.style.display = 'flex';
    });
    
    closeCreateChallengeModalBtn?.addEventListener('click', () => { createChallengeModal.style.display = 'none'; });
    saveChallengeBtn?.addEventListener('click', async () => {
    // [ìˆ˜ì •] currentUserProfileì´ ë¡œë“œë˜ì—ˆëŠ”ì§€ í•¨ê»˜ í™•ì¸í•©ë‹ˆë‹¤.
    if (!currentUser || !currentUserProfile) {
        return alert("ì‚¬ìš©ì ì •ë³´ê°€ ë¡œë”©ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    }

    const fastingHours = parseInt(challengeModelSelect.value, 10);
    const dateString = challengeDatePicker.value;
    const timeString = challengeTimePicker.value;
    const detailedGoal = challengeDetailedGoal.value.trim();

    if (!dateString || !timeString) {
        return alert('ì‹œì‘ ë‚ ì§œì™€ ì‹œê°„ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
    }

    const startTime = new Date(`${dateString}T${timeString}`);
    if (startTime < new Date()) {
        return alert('ì‹œì‘ ì‹œê°„ì€ í˜„ì¬ ì‹œê°„ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤.');
    }

    saveChallengeBtn.disabled = true;
    saveChallengeBtn.textContent = 'ì €ì¥ ì¤‘...';

    // [ìˆ˜ì •] ì‹¤ëª…(displayName) ëŒ€ì‹  ë‹‰ë„¤ì„(nickname)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
    const userNickname = currentUserProfile.nickname || currentUser.displayName || 'ì‚¬ìš©ì';

    const challengeData = {
        hostUid: currentUser.uid,
        hostNickname: userNickname,
        challengeName: `${userNickname}ë‹˜ì˜ ${fastingHours}ì‹œê°„ ë‹¨ì‹`,
        fastingHours: fastingHours,
        detailedGoal: detailedGoal,
        startTime: firebase.firestore.Timestamp.fromDate(startTime),
        status: "upcoming",
        participantUids: [currentUser.uid],
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
        const docRef = await db.collection('challenges').add(challengeData);
        const inviteLink = `${window.location.origin}/challenge-invite.html?id=${docRef.id}`;
        await navigator.clipboard.writeText(inviteLink);
        createChallengeModal.style.display = 'none';
        alert('ì±Œë¦°ì§€ ìƒì„± ì™„ë£Œ!\nì´ˆëŒ€ ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì¹œêµ¬ì—ê²Œ ê³µìœ í•´ì£¼ì„¸ìš”.');
        loadAndRenderChallenges();
    } catch (error) {
        console.error("ì±Œë¦°ì§€ ìƒì„± ì˜¤ë¥˜:", error);
        alert("ì±Œë¦°ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    } finally {
        saveChallengeBtn.disabled = false;
        saveChallengeBtn.textContent = 'ì €ì¥í•˜ê³  ì¹œêµ¬ ì´ˆëŒ€í•˜ê¸°';
    }
});
    submitCommentBtn?.addEventListener('click', async () => {
        const text = newCommentText.value.trim();
        if (!text || !currentUser) return;
    // [ìˆ˜ì •] URLì—ì„œ challengeIdë¥¼ ê°€ì ¸ì˜¤ëŠ” ë¶€ë¶„ì„ ì‚­ì œí•˜ê³ ,
    // ì „ì—­ ë³€ìˆ˜ì¸ currentChallengeIdë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½í•©ë‹ˆë‹¤.
    if(!currentChallengeId) return; 

    submitCommentBtn.disabled = true;
    try {
        await db.collection('challenges').doc(currentChallengeId).collection('comments').add({ // challengeId -> currentChallengeId
            uid: currentUser.uid, nickname: currentUser.displayName || 'ì‚¬ìš©ì',
            text, timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            isAutoComment: false, parentId: null
        });
        newCommentText.value = '';
    } catch (error) { console.error("ëŒ“ê¸€ ë“±ë¡ ì˜¤ë¥˜:", error); alert("ëŒ“ê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    } finally { submitCommentBtn.disabled = false; }
});

    // ë‹µê¸€ ì´ë²¤íŠ¸ ìœ„ì„
    commentFeed.addEventListener('click', async (e) => { /* ... ì´ì „ ë‹µë³€ì˜ ë‹µê¸€ ë“±ë¡ ë¡œì§ ... */ });
    
    // --- 5. ì•± ì´ˆê¸°í™” ---
   // challenge.html ìŠ¤í¬ë¦½íŠ¸ì˜ auth.onAuthStateChanged í•¨ìˆ˜ë¥¼ êµì²´í•˜ì„¸ìš”.
auth.onAuthStateChanged(async (user) => {
    const challengeListContainer = document.getElementById('challengeList');
    const createChallengeFAB = document.getElementById('createChallengeBtn');

    if (user) {
        currentUser = user;
        // â–¼â–¼â–¼ ì‚¬ìš©ì í”„ë¡œí•„ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì½”ë“œ ì¶”ê°€ â–¼â–¼â–¼
        currentUserProfile = await window.fastmateApp.getUserDoc(user.uid);

        createChallengeFAB.style.display = 'block';
        loadAndRenderChallenges();
    } else {
        currentUser = null;
        currentUserProfile = null; // ë¡œê·¸ì•„ì›ƒ ì‹œ í”„ë¡œí•„ë„ ì´ˆê¸°í™”
        createChallengeFAB.style.display = 'none';
        challengeListContainer.innerHTML = `
            <div class="card" style="text-align: center;">
                <p>ì±Œë¦°ì§€ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                <button onclick="window.location.href='login.html'" class="onb-btn onb-primary">ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™</button>
            </div>
        `;
    }
});
})
</script>
</body>
</html>