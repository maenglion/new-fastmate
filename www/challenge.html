<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Fastmate - 챌린지</title>
   <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="/firebase-init.js?v=2025.09.06-v8"></script>
<style>
    /* --- 기본 & 다크모드 색상 변수 --- */
    :root {
      --primary-color: #1c8e3e; --primary-light: #e8f5e9; --bg-color: #f8f9fa;
      --card-bg: #FFFFFF; --text-color: #212529; --text-light: #6c757d;
      --border-color: #e9ecef; --yellow-color: #ffc107; --yellow-bg-color: #fff3cd;
      --danger-color: #dc3545;
    }
    body.dark-mode {
      --primary-color: #4caf50; --primary-light: #2c3e50; --bg-color: #121212;
      --card-bg: #1e1e1e; --text-color: #e0e0e0; --text-light: #9e9e9e;
      --border-color: #3a3a3a;
    }

    /* --- 기본 레이아웃 --- */
    body { background-color: var(--bg-color); font-family: 'Noto Sans KR', sans-serif; margin: 0; color: var(--text-color); }
    .container { max-width: 800px; margin: 0 auto; padding: 20px; }

    /* --- 헤더 --- */
    .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px; }
    .page-title-group { display: flex; align-items: center; gap: 10px; position: absolute; left: 50%; transform: translateX(-50%); }
    .page-title { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); margin: 0; }
    .beta-tag { background-color: var(--yellow-bg-color); color: #664d03; font-size: 0.75rem; font-weight: bold; padding: 4px 8px; border-radius: 8px; border: 1px solid var(--yellow-color); }
    .header-btn, .icon-btn { background: none; border: none; cursor: pointer; padding: 0; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; color: var(--text-light); transition: color 0.2s; }
    .header-btn:hover { color: var(--primary-color); }
    .create-challenge-btn { background-color: var(--primary-color); color: white; border-radius: 8px; font-weight: bold; font-size: 0.9rem; padding: 0 16px; height: 40px; border: none; cursor: pointer; }

    /* --- 카드 공통 --- */
    .card { background: var(--card-bg); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color); }

    /* --- 챌린지 리스트 카드 (수정됨) --- */
    .challenge-card {
        margin-bottom: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s; display: flex; align-items: flex-start; gap: 16px;
        background-color: var(--card-bg); /* 라이트 모드 흰색 배경 명시 */
    }
    .challenge-card:hover { transform: translateY(-3px); box-shadow: 0 6px 16px rgba(0,0,0,0.1); }
    .challenge-content { flex-grow: 1; }
    .challenge-content h3 { margin: 0 0 12px; font-size: 1.1rem; } /* 제목 아래 마진 증가 */
    .challenge-meta {
        font-size: 0.9rem; /* 가독성을 위해 폰트 크기 약간 키움 */
        color: var(--text-light); display: flex; flex-direction: column;
        gap: 12px; /* 각 정보 행 사이의 간격 증가 */
    }
    .challenge-meta .meta-row { display: flex; align-items: center; gap: 8px; }

    /* --- 페이징 --- */
    .pagination { text-align: center; margin-top: 30px; display: flex; gap: 8px; justify-content: center; align-items: center; }
    .pagination button { background-color: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-color); padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 500; }
    .pagination button:disabled { cursor: not-allowed; opacity: 0.5; background: var(--bg-color); }
    .pagination .page-number { font-weight: bold; padding: 0 10px; }

    /* --- 챌린지 상세 정보 --- */
    .challenge-info-card { position: relative; margin-bottom:20px; }
    .challenge-details .challenge-title { margin: 0; font-size: 1.4rem; }
    .challenge-details .challenge-desc { margin: 12px 0 24px; color: var(--text-light); line-height: 1.6; }
    .challenge-meta-list { list-style: none; padding: 0; margin: 0; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
    .meta-item { display: flex; align-items: center; gap: 12px; }
    .meta-label { font-size: 0.9rem; color: var(--text-light); margin-bottom: 2px; }
    .meta-value { font-size: 0.95rem; font-weight: 500; }
    .detail-actions { position:absolute; top:12px; right:12px; display:flex; gap:8px; }
    .text-btn { font-size: 0.85rem; padding: 6px 12px; background-color: var(--bg-color); color: var(--text-light); border: 1px solid var(--border-color); border-radius: 6px; font-weight: 500; }
    .close-btn { background-color: var(--bg-color); color: var(--text-light); border: 1px solid var(--border-color); border-radius: 50%; width: 32px; height: 32px; font-size: 1.2rem; line-height: 1; }

    /* --- 댓글 --- */
    .comment-section { padding-top: 20px; }
    .comment { display: flex; gap: 12px; margin-bottom: 20px; position: relative; }
    .comment-avatar { width: 32px; height: 32px; border-radius: 50%; background-color: var(--primary-light); color: var(--primary-color); display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; object-fit: cover; font-size: .8rem; }
    .comment.reply .comment-avatar { width: 24px; height: 24px; font-size: .7rem; }
    .thread-line { width: 2px; background-color: var(--border-color); flex-grow: 1; margin-top: 8px; }
    .comment-main { flex-grow: 1; }
    .comment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .comment-author { font-weight: 700; font-size: 0.95rem; }
    .comment-timestamp { font-size: 0.85rem; color: var(--text-light); }
    .comment-text { margin: 0 0 8px; white-space: pre-wrap; word-break: break-word; line-height: 1.6; }
    .reply-btn { background: none; border: none; color: var(--text-light); font-weight: 600; font-size: 0.85rem; cursor: pointer; padding: 4px; }
    .replies-container { border-left: 2px solid var(--border-color); padding-left: 16px; }

    /* --- 댓글 입력창 --- */
    .comment-form { display: flex; gap: 10px; margin-bottom: 24px; }
    .comment-form textarea { flex-grow: 1; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-color); color: var(--text-color); padding: 10px; font-family: inherit; resize: vertical; min-height: 20px; }
    .comment-form textarea:focus { border-color: var(--primary-color); outline: none; background: var(--card-bg); }
    .comment-form button { flex-shrink: 0; }

    /* --- 모달 공통 스타일 (수정됨) --- */
    .modal { display:none; position:fixed; inset:0; z-index:9999; background:rgba(0,0,0,.45); align-items:center; justify-content:center; padding:20px; }
    .modal-content { background:var(--card-bg); padding:24px; border-radius:12px; max-width:520px; width:100%; border: 1px solid var(--border-color); box-shadow: 0 8px 30px rgba(0,0,0,.2); }
    .modal-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom: 24px; } /* 마진 증가 */
    .modal-header h3 { margin:0; font-size: 1.3rem; }
    .form-row { margin-bottom: 20px; } /* 간격 증가 */
    .form-row label { display: block; font-weight: 500; margin-bottom: 8px; font-size: .9rem; }
    .form-row input[type="text"], .form-row input[type="date"], .form-row input[type="datetime-local"], .form-row textarea, .form-row select {
        width: 100%; box-sizing: border-box; /* 너비 계산 기준 변경 */
        padding: 12px; border-radius: 6px; border: 1px solid var(--border-color);
        background-color: var(--bg-color); color: var(--text-color); font-family: inherit; font-size: 1rem;
    }
    .form-row input:focus, .form-row textarea:focus, .form-row select:focus { border-color: var(--primary-color); outline:none; background-color: var(--card-bg); }
    .modal-footer { margin-top:24px; display:flex; justify-content:flex-end; gap:8px; }
    fieldset.form-row { border: none; padding: 0; }
    fieldset.form-row legend { font-weight: 500; font-size: .9rem; margin-bottom: 10px; }
    fieldset.form-row label { display: inline-flex; align-items: center; margin-right: 16px; font-weight: normal; }


    /* --- 버튼 공통 (onboarding) --- */
    .onb-btn { border-radius: 8px; font-weight: bold; font-size: 0.9rem; padding: 10px 16px; border: none; cursor: pointer; }
    .onb-btn.onb-primary { background-color: var(--primary-color); color: white; }
    .onb-btn:not(.onb-primary) { background-color: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); }
    
    /* --- 아이콘 --- */
    .icon { width: 20px; height: 20px; display:inline-block; background-size:contain; background-repeat:no-repeat; background-position: center; }
  </style>
</head>
<body>

  <div class="container">
  <!-- 상단 헤더 -->
  <header id="pageHeader" class="page-header"></header>

  <!-- 목록 뷰 -->
  <div id="challengeListView" style="display: none;">
      <div id="challengeList"></div>
    <div id="paginationControls" class="pagination"></div>
  </div><!-- /#challengeListView -->

  <!-- 상세 뷰(단 하나만 유지) -->
  <div id="challengeDetailView" style="display:none;">
    <div id="challengeInfo" class="challenge-info-card"><!-- JS가 채움 --></div>

    <!-- 댓글 섹션 -->
    <section class="card comment-section">
      <h4>챌린지 타임라인</h4>
      <div class="comment-form">
        <textarea id="newCommentText" placeholder="응원 댓글을 남겨보세요." rows="1"></textarea>
        <button id="submitCommentBtn" class="onb-btn onb-primary">등록</button>
      </div>
      <div id="commentFeed"></div>
    </section>
  </div><!-- /#challengeDetailView -->

  <div id="createChallengeModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="cc-title">챌린지 만들기</h3>
        <button id="closeCreateChallengeModalBtn" class="icon-btn" aria-label="닫기">✕</button>
      </div>
      <form id="createChallengeForm" class="modal-body" autocomplete="off">
        <div class="form-row">
          <label for="cc-model">단식 모델</label>
          <select id="cc-model"><option value="16">16:8 (인기)</option> ... </select>
        </div>
        <div class="form-row">
          <label for="cc-desc">목표 (선택)</label>
          <textarea id="cc-desc" rows="3" placeholder="간단한 설명을 적어주세요"></textarea>
        </div>
        <div class="form-row">
          <label for="cc-start">시작일</label>
          <input id="cc-start" type="datetime-local" />
        </div>
        <fieldset class="form-row">
          <legend>공개 범위</legend>
          <label><input type="radio" name="cc-visibility" value="private" checked> 비공개</label>
          <label><input type="radio" name="cc-visibility" value="public"> 공개</label>
        </fieldset>
        <div class="modal-footer">
          <button type="button" class="onb-btn" id="cc-cancel">취소</button>
          <button type="submit" class="onb-btn onb-primary">생성</button>
        </div>
      </form>
    </div>
</div>
<div id="editChallengeModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="ec-title">챌린지 수정</h3>
      <button id="closeEditChallengeModalBtn" class="icon-btn" aria-label="닫기">✕</button>
    </div>
    <form id="editChallengeForm" class="modal-body" autocomplete="off">
        <div class="form-row">
            <label for="ec-desc">목표/설명</label>
            <textarea id="ec-desc" rows="3"></textarea>
        </div>
        <div class="form-row">
            <label for="ec-start">시작일</label>
            <input id="ec-start" type="datetime-local" />
        </div>
        <fieldset class="form-row">
            <legend>공개 범위</legend>
            <label><input type="radio" name="ec-visibility" value="private"> 비공개</label>
            <label><input type="radio" name="ec-visibility" value="public"> 공개</label>
        </fieldset>
        <div class="modal-footer">
            <button type="button" class="onb-btn" id="ec-cancel">취소</button>
            <button type="submit" class="onb-btn onb-primary">저장</button>
        </div>
    </form>
  </div>
</div>
<div id="replyModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
        <h3 style="margin-top:0;">답글 달기</h3>
        <button id="replyCancel" class="icon-btn">✕</button>
    </div>
    <div id="replyTargetInfo" style="font-size:.9rem; color:var(--text-light); margin-bottom:12px; border-left: 3px solid var(--border-color); padding-left: 10px;"></div>
    <textarea id="replyText" rows="3" placeholder="내용을 입력하세요"></textarea>
    <div class="modal-footer">
      <button id="replySubmit" class="onb-btn onb-primary">등록</button>
    </div>
  </div>
</div>



        <!-- 푸터 버튼 -->
        <div class="modal-footer" style="margin-top:16px; display:flex; justify-content:flex-end; gap:8px;">
          <button type="button" class="onb-btn" id="cc-cancel">취소</button>
          <button type="submit" class="onb-btn onb-primary">생성</button>
        </div><!-- /.modal-footer -->
      </form><!-- /#createChallengeForm -->
    </div><!-- /.modal-content -->
  </div><!-- /#createChallengeModal -->
</div><!-- /.container -->

<script>
document.addEventListener('DOMContentLoaded', () => {
  // --- 전역 변수 ---
  const auth = window.fastmateApp.auth;
  const db   = window.fastmateApp.db;

  let currentUser = null;
  let stopListeningToChallenge = null;
  let allChallenges = []; // 전체 챌린지 데이터 캐시
  let currentPage = 1;
  let currentUserProfile = null;    // ✅ 추가
let currentChallengeId = null;    // ✅ 추가
let replyingParentId = null;  // ✅ 추가
  const ITEMS_PER_PAGE = 20; // 페이지 당 20개씩

  // --- DOM 요소 ---
  const pageHeader = document.getElementById('pageHeader');
  const challengeListView = document.getElementById('challengeListView');
  const challengeListDiv = document.getElementById('challengeList');
  const paginationControls = document.getElementById('paginationControls');
  const challengeDetailView = document.getElementById('challengeDetailView');
  const challengeInfoDiv = document.getElementById('challengeInfo');
  const commentFeed = document.getElementById('commentFeed');


 //  아이콘 관리
const icons = {
      people: { light: "https://res.cloudinary.com/dnswboo5z/image/upload/v1757595393/people_fh71ri.png", dark: "https://res.cloudinary.com/dnswboo5z/image/upload/v1757595393/people-dark_onohwu.png" },
      date: { light: "https://res.cloudinary.com/dnswboo5z/image/upload/v1757595328/date_w4uttj.png", dark: "https://res.cloudinary.com/dnswboo5z/image/upload/v1757595328/date-dark_ntcjc4.png" },
      time: { light: "https://res.cloudinary.com/dnswboo5z/image/upload/v1757595327/time-dark_auvyve.png", dark: "https://res.cloudinary.com/dnswboo5z/image/upload/v1757595327/time-dark_auvyve.png" },
      goal: { light: "https://res.cloudinary.com/dnswboo5z/image/upload/v1757595329/goal_icon_ldahyt.png", dark: "https://res.cloudinary.com/dnswboo5z/image/upload/v1757595328/goal_icon-dark_c8xyn6.png" },
      link: { light: "https://res.cloudinary.com/dnswboo5z/image/upload/v1757595328/link2_r0oqsl.png", dark: "https://res.cloudinary.com/dnswboo5z/image/upload/v1757595327/link2-dark_rwt5ya.png" },
      lock: { common: "https://res.cloudinary.com/dnswboo5z/image/upload/v1757647503/lock_j6pf7l.png" },
      unlock: { common: "https://res.cloudinary.com/dnswboo5z/image/upload/v1757647503/unlock_gvi917.png" }
  };
    function getIcon(name) {
        const isDark = document.body.classList.contains('dark-mode');
        const iconSet = icons[name];
        return iconSet.common || (isDark ? iconSet.dark : iconSet.light);
    }


  // --- 뷰 관리 ---
  
function showView(viewName, challengeId = null) {
  challengeListView.style.display = 'none';
  challengeDetailView.style.display = 'none';
  if (stopListeningToChallenge) stopListeningToChallenge();

  if (viewName === 'list') {
    currentChallengeId = null;                // ✅ 리셋
    challengeListView.style.display = 'block';
    renderListHeader();
    loadAndRenderChallenges();
  } else if (viewName === 'detail' && challengeId) {
    currentChallengeId = challengeId;         // ✅ 보관
    challengeDetailView.style.display = 'block';
    listenToChallengeDetails(challengeId);
  }
}


  // --- 헤더 렌더링 ---
  function renderListHeader() {
    pageHeader.innerHTML = `
      <button class="header-btn" title="메인으로" onclick="location.href='fastmate.html'">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
      </button>
      <div class="page-title-group">
        <h1 class="page-title">챌린지</h1>
        <span class="beta-tag">BETA</span>
      </div>
      <button class="create-challenge-btn" id="createChallengeBtnHeader">챌린지 만들기</button>
    `;

  // ✅ 모달 오픈 연결
  document.getElementById('createChallengeBtnHeader')?.addEventListener('click', () => {
    document.getElementById('createChallengeModal').style.display = 'flex';
  });
  document.getElementById('closeCreateChallengeModalBtn')?.addEventListener('click', () => {
    document.getElementById('createChallengeModal').style.display = 'none';
  });
}

// 모달 핸들러 바인딩
// ===== 모달(열기/닫기) + 폼 제출: 단일 위임 버전 =====
(function bindCreateModalOnce () {
  if (window.__BIND_CREATE_MODAL__) return;
  window.__BIND_CREATE_MODAL__ = true;

  // 클릭 위임: 어디서든 동작
  document.addEventListener('click', (e) => {
    const modal = document.getElementById('createChallengeModal');
    if (!modal) return;

    const openBtn  = e.target.closest('#createChallengeBtnHeader');
    const closeBtn = e.target.closest('#closeCreateChallengeModalBtn, #cc-cancel');

    if (openBtn) {
      modal.style.display = 'flex';
      const sel = document.getElementById('fastingModelSelect');
      if (sel) sel.value = localStorage.getItem('fm_model') || '16';
      return;
    }
    if (closeBtn) { modal.style.display = 'none'; return; }
    if (e.target === modal) modal.style.display = 'none'; // 오버레이 클릭 닫기
  });

  // 제출 위임: 생성 폼만 가로챔
  document.addEventListener('submit', async (e) => {
    const form = e.target.closest('#createChallengeForm');
    if (!form) return;
    e.preventDefault();

    if (!currentUser) { alert('로그인이 필요합니다'); return; }

    const desc         = (document.getElementById('cc-desc').value || '').trim();
    const startDateVal = document.getElementById('cc-start').value || null;
    const visibility   = (document.querySelector('input[name="visibility"]:checked')?.value) || 'private';

    // 단식 모델
    const sel          = document.getElementById('fastingModelSelect');
    const modelMinutes = parseInt(sel?.value || '16', 10);
    let modelLabel     = sel?.selectedOptions?.[0]?.textContent || '16:8';
    modelLabel         = modelLabel.split('(')[0].trim();
    try { localStorage.setItem('fm_model', String(modelMinutes)); } catch {}

    // 호스트 닉네임/프로필
    const ownerName     = currentUserProfile?.nickname || currentUser.displayName || '사용자';
    const ownerPhotoURL = currentUserProfile?.photoURL || currentUser.photoURL || null;

    // 제목: <호스트닉네임 + 단식모델>
    const finalName = `${ownerName} ${modelLabel}`;

    // Timestamp
    const startTs = startDateVal
      ? firebase.firestore.Timestamp.fromDate(new Date(startDateVal))
      : firebase.firestore.FieldValue.serverTimestamp();

    // 날짜/시간 캐시
    const fmtDate = (d) => { try { return d.toLocaleDateString('ko-KR', {year:'numeric',month:'2-digit',day:'2-digit'});} catch { return '-'; } };
    const fmtTime = (d) => { try { return d.toLocaleTimeString('ko-KR', {hour:'2-digit',minute:'2-digit'});} catch { return '-'; } };
    let startDateStr = '-', startTimeStr = '-';
    if (startDateVal) {
      const d = new Date(startDateVal);
      startDateStr = fmtDate(d);
      startTimeStr = fmtTime(d);
    }

    try {
      // Firestore payload
      const payload = {
        // 쿼리/권한
        startTime: startTs,
        participantUids: [currentUser.uid],
        hostUid: currentUser.uid,

        // 표시/메타
        challengeName: finalName,
        description: desc,
        hostName: ownerName,
        ownerName,
        ownerPhotoURL,
        visibility,
        isBeta: true,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        memberCount: 1,

        // 모델
        fastingModelMinutes: modelMinutes,
        fastingModelLabel: modelLabel,

        // 날짜/시간 캐시
        startDateStr,
        startClockStr: startTimeStr
      };

      const docRef = await db.collection('challenges').add(payload);

      // 멤버(호스트) 등록
      await db.collection('challenges').doc(docRef.id)
        .collection('members').doc(currentUser.uid)
        .set({
          uid: currentUser.uid,
          nickname: ownerName,
          photoURL: ownerPhotoURL || null,
          role: 'owner',
          joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
        });

      // (선택) 개인 단식 → 그룹단식 전환
      if (typeof switchToGroupFasting === 'function') {
        try { await switchToGroupFasting(currentUser.uid, docRef.id, modelMinutes, startTs); } catch {}
      }

      // 닫기 + 목록 갱신
      const modal = document.getElementById('createChallengeModal');
      if (modal) modal.style.display = 'none';
      showView('list');
    } catch (err) {
      console.error('챌린지 생성 오류:', err);
      alert('챌린지 생성 중 오류가 발생했습니다');
    }
  });
})();

  // --- 챌린지 목록 (페이징 적용) ---
  async function loadAndRenderChallenges() {
    if (!currentUser) return;
    challengeListDiv.innerHTML = "<p>챌린지 목록을 불러오는 중...</p>";
    
    try {
      const query = db.collection('challenges')
        .where('participantUids', 'array-contains', currentUser.uid)
        .orderBy('startTime', 'desc');
      const snapshot = await query.get();
      
      allChallenges = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      
      currentPage = 1;
      renderChallengePage();

    } catch (error) {
      console.error("챌린지 목록 로딩 실패:", error);
      challengeListDiv.innerHTML = '<p>목록을 불러오는 데 실패했습니다.</p>';
    }
  }

function renderChallengePage() {
  if (allChallenges.length === 0) {
    challengeListDiv.innerHTML = '<div class="challenge-card" style="text-align:center;"><p>아직 참여한 챌린지가 없습니다.</p></div>';
    paginationControls.innerHTML = '';
    return;
  }

  challengeListDiv.innerHTML = '';
  const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
  const endIndex   = startIndex + ITEMS_PER_PAGE;
  const pageItems  = allChallenges.slice(startIndex, endIndex);

pageItems.forEach(challenge => {
  const card = document.createElement('div');
  card.className = 'challenge-card';

  const memberCount = Array.isArray(challenge.participantUids)
    ? challenge.participantUids.length
    : (challenge.memberCount || 1);

  const d = challenge.startTime?.toDate?.();
  const dateStr = challenge.startDateStr || (d ? d.toLocaleDateString('ko-KR') : '-');
  const timeStr = challenge.startClockStr || (d ? d.toLocaleTimeString('ko-KR', {hour:'2-digit', minute:'2-digit'}) : '-');
  const goalStr = challenge.detailedGoal ? escapeHTML(challenge.detailedGoal) : '-';
  const isPrivate = (challenge.visibility || 'private') === 'private';

  card.innerHTML = `
    <div class="challenge-content">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
        <h3>${escapeHTML(challenge.challengeName || '-')}</h3>
        <div class="card-visibility" title="${isPrivate ? '비공개' : '공개'}">
          <span class="lock" style="background-image: var(${isPrivate ? '--icon-private' : '--icon-public'});"></span>
        </div>
      </div>

      <div class="challenge-meta">
        <div class="meta-row">
          <span class="icon" style="background-image: var(--icon-date);"></span>
          <span>${dateStr}</span>
        </div>
        <div class="meta-row">
          <span class="icon" style="background-image: var(--icon-time);"></span>
          <span>${timeStr}</span>
        </div>
        <div class="meta-row">
          <span class="icon" style="background-image: var(--icon-people);"></span>
          <span>${memberCount}명</span>
        </div>
        <div class="meta-row">
          <span class="icon" style="background-image: var(--icon-goal);"></span>
          <span>${goalStr}</span>
        </div>
      </div>
    </div>
  `;
  card.addEventListener('click', () => showView('detail', challenge.id));
  challengeListDiv.appendChild(card);
});


  renderPagination();
}

  function renderPagination() {
    const totalPages = Math.ceil(allChallenges.length / ITEMS_PER_PAGE);
    if (totalPages <= 1) {
      paginationControls.innerHTML = '';
      return;
    }

    paginationControls.innerHTML = `
      <button id="prevPageBtn" ${currentPage === 1 ? 'disabled' : ''}>이전</button>
      <span class="page-number">${currentPage} / ${totalPages}</span>
      <button id="nextPageBtn" ${currentPage === totalPages ? 'disabled' : ''}>다음</button>
    `;

    document.getElementById('prevPageBtn')?.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        renderChallengePage();
      }
    });
    document.getElementById('nextPageBtn')?.addEventListener('click', () => {
      if (currentPage < totalPages) {
        currentPage++;
        renderChallengePage();
      }
    });
  }


  // --- 챌린지 상세 및 댓글 ---
function listenToChallengeDetails(challengeId) {
  const ref = db.collection('challenges').doc(challengeId);
  stopListeningToChallenge = ref.onSnapshot(doc => {
    if (!doc.exists) {
      alert("삭제되었거나 존재하지 않는 챌린지입니다.");
      return showView('list');
    }
    const challenge = { id: doc.id, ...doc.data() };
    currentChallengeId = challenge.id;
    renderDetailHeader(challenge);
    renderChallengeInfo(challenge);
    renderComments(challenge.id);
  });
}

function renderDetailHeader(challenge) {
  pageHeader.innerHTML = `
    <button class="header-btn" id="backToListBtn">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
    </button>
    <div class="page-title-group">
      <h1 class="page-title" style="font-size: 1.2rem;">${escapeHTML(challenge.challengeName)}</h1>
      <span class="beta-tag">BETA</span>
    </div>
    <div style="width: 40px;"></div>
  `;
  document.getElementById('backToListBtn')?.addEventListener('click', () => showView('list'));
}  

 // --- 상세 정보 렌더링 ---
    function renderChallengeInfo(ch) {
        const infoDiv = document.getElementById('challengeInfo');
        const d = ch.startTime?.toDate?.();
        const dateStr = d ? d.toLocaleDateString('ko-KR') : '-';
        const timeStr = d ? d.toLocaleTimeString('ko-KR', { hour:'2-digit', minute:'2-digit' }) : '-';
        const memberCount = ch.participantUids?.length || 1;
        const descStr = (ch.description || '').trim();

        infoDiv.innerHTML = `
            <div class="detail-actions">
                <button id="editChallengeBtn" class="onb-btn text-btn">수정</button>
                <button id="deleteChallengeBtn" class="icon-btn close-btn">✕</button>
            </div>
            <h2 class="challenge-title">${escapeHTML(ch.challengeName || '-')}</h2>
            ${descStr ? `<p class="challenge-desc">${escapeHTML(descStr)}</p>` : ''}
            <ul class="challenge-meta-list">
                <li class="meta-item">
                    <img src="${getIcon('people')}" class="icon" alt="참여자">
                    <div><div class="meta-label">참여자</div><div class="meta-value">${memberCount}명</div></div>
                </li>
                <li class="meta-item">
                    <img src="${getIcon('date')}" class="icon" alt="날짜">
                    <div><div class="meta-label">날짜</div><div class="meta-value">${dateStr}</div></div>
                </li>
                <li class="meta-item">
                    <img src="${getIcon('time')}" class="icon" alt="시간">
                    <div><div class="meta-label">시작시간</div><div class="meta-value">${timeStr}</div></div>
                </li>
                ${ch.detailedGoal ? `<li class="meta-item">...</li>` : ''}
            </ul>
        `;
        // 이벤트 리스너 연결
        infoDiv.querySelector('#editChallengeBtn').addEventListener('click', () => {
            const now = Date.now();
            const startMs = ch.startTime?.toDate?.()?.getTime?.() || now;
            if (startMs - now < 30 * 60 * 1000) {
                return alert('챌린지는 시작 30분전까지 수정 가능합니다.');
            }
            // 수정 모달 열기 로직
        });
        infoDiv.querySelector('#deleteChallengeBtn').addEventListener('click', async () => {
            if (!confirm('정말 삭제할까요?')) return;
            await db.collection('challenges').doc(ch.id).delete();
            showView('list');
        });
    }

 // --- 댓글 렌더링 ---
    async function renderComments(challengeId) {
        const snapshot = await db.collection('challenges').doc(challengeId).collection('comments').orderBy('timestamp', 'asc').get();
        const comments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        document.getElementById('commentTitle').textContent = `챌린지 타임라인 (${comments.length})`;
        commentFeed.innerHTML = ''; // 초기화
        
        const commentTree = {};
        comments.forEach(c => {
            if (c.parentId) {
                (commentTree[c.parentId] = commentTree[c.parentId] || []).push(c);
            }
        });

        comments.filter(c => !c.parentId).forEach(comment => {
            const replies = commentTree[comment.id] || [];
            commentFeed.appendChild(createCommentElement(comment, replies));
        });
    }


function createCommentElement(comment, replies = [], isReply = false) {
  const div = document.createElement('div');
  div.className = 'comment' + (isReply ? ' reply' : '');

  const isMyComment = currentUser && currentUser.uid === comment.uid;
  const nick = comment.nickname || '사용자';
  const tsText = formatRelativeOrDate(comment.timestamp);

  // 아바타: 사진 or 2글자 이니셜
  const avatarHtml = comment.photoURL
    ? `<img src="${comment.photoURL}" alt="${escapeHTML(nick)}" class="comment-avatar">`
    : `<div class="comment-avatar" style="background-color: var(--primary-light); color: var(--primary-color); font-weight:700; font-size:.8rem; display:flex; align-items:center; justify-content:center;">${escapeHTML(initials2(nick))}</div>`;

  div.innerHTML = `
    <div class="comment-avatar-column">
      ${avatarHtml}
      ${!isReply && replies.length > 0 ? '<div class="thread-line"></div>' : ''}
    </div>
    <div class="comment-main">
      <div class="comment-header">
        <div class="comment-author-info">
          <span class="comment-author" style="font-weight:700;">${escapeHTML(nick)}</span>
          <span class="comment-timestamp">${tsText}</span>
        </div>
        ${isMyComment ? `
        <div class="comment-options">
          <button class="comment-options-btn">•••</button>
          <div class="options-menu">
            <button class="edit-comment-btn" data-id="${comment.id}">수정</button>
            <button class="delete-comment-btn" data-id="${comment.id}">삭제</button>
          </div>
        </div>` : ``}
      </div>

      <div class="comment-text">${linkify(comment.text || '')}</div>

      <div class="comment-actions">
        <div class="reply-info" style="visibility:hidden;"></div>
        ${!isReply ? `<button class="reply-btn" data-target="${comment.id}">답글달기</button>` : ``}
      </div>

      ${!isReply && replies.length > 0 ? `
        <button class="onb-btn" data-toggle-replies="${comment.id}" style="margin-top:6px;">▽ 답글 ${replies.length}개 보기</button>
        <div class="replies-container" id="rc-${comment.id}" style="display:none; margin-left:12px; margin-top:10px;"></div>
      ` : (!isReply ? `<div class="replies-container" id="rc-${comment.id}" style="display:none; margin-left:12px; margin-top:10px;"></div>` : ``)}
    </div>
  `;

  // ... 토글
  div.querySelector(`[data-toggle-replies="${comment.id}"]`)?.addEventListener('click', (e) => {
    const box = div.querySelector(`#rc-${comment.id}`);
    if (!box) return;
    if (box.childElementCount === 0) {
      replies.forEach(r => box.appendChild(createCommentElement(r, [], true)));
    }
    const opened = box.style.display !== 'none';
    box.style.display = opened ? 'none' : 'block';
    e.target.textContent = opened ? `▽ 답글 ${replies.length}개 보기` : `▲ 답글 접기`;
  });

  // 내 댓글 옵션 토글
  const optionsBtn = div.querySelector('.comment-options-btn');
  if (optionsBtn) {
    optionsBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      const menu = optionsBtn.nextElementSibling;
      menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
    });
  }
  return div;
}


  
commentFeed.addEventListener('click', (e) => {
  const replyBtn = e.target.closest('.reply-btn');
  if (replyBtn) {
    replyingParentId = replyBtn.dataset.target;
    // 모달 표시 + 대상 아이디 표기
    document.getElementById('replyTargetInfo').textContent = `대상 댓글 ID: ${replyingParentId}`;
    document.getElementById('replyText').value = '';
    document.getElementById('replyModal').style.display = 'flex';
  }
});

// 모달 버튼
document.getElementById('replyCancel').addEventListener('click', () => {
  document.getElementById('replyModal').style.display = 'none';
});

document.getElementById('replySubmit').addEventListener('click', async () => {
  const text = (document.getElementById('replyText').value || '').trim();
  if (!text || !currentUser || !currentChallengeId || !replyingParentId) return;
  try {
    await db.collection('challenges').doc(currentChallengeId).collection('comments').add({
      uid: currentUser.uid,
      nickname: currentUserProfile?.nickname || currentUser.displayName || '사용자',
      photoURL: currentUser.photoURL || null,
      text,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      isAutoComment: false,
      parentId: replyingParentId
    });
    document.getElementById('replyModal').style.display = 'none';
    toast('등록되었습니다.');
    renderComments(currentChallengeId);
  } catch (err) {
    console.error(err);
    toast('등록에 실패했습니다.');
  }
});

  // --- 헬퍼 함수 ---
  function escapeHTML(s) { return String(s || '').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }
  function linkify(text) {
    const safe = escapeHTML(text);
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    return safe.replace(urlRegex, url => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
  }

  // 수정모달 
  function openEditChallengeModal(ch) {
  const modal = document.getElementById('editChallengeModal');
  const descEl = document.getElementById('ec-desc');
  const startEl = document.getElementById('ec-start');

  descEl.value = ch.description || '';
  // datetime-local ISO 채우기
  const d = ch.startTime?.toDate?.();
  if (d) {
    const pad = n => String(n).padStart(2,'0');
    const iso = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    startEl.value = iso;
  } else {
    startEl.value = '';
  }
  document.querySelectorAll('input[name="ec-visibility"]').forEach(r => {
    r.checked = (r.value === (ch.visibility || 'private'));
  });

  modal.style.display = 'flex';

  const close = () => { modal.style.display = 'none'; };
  document.getElementById('closeEditChallengeModalBtn').onclick = close;
  document.getElementById('ec-cancel').onclick = close;

  const form = document.getElementById('editChallengeForm');
  form.onsubmit = async (e) => {
    e.preventDefault();
    try {
      const visibility = document.querySelector('input[name="ec-visibility"]:checked')?.value || 'private';
      const desc = (descEl.value || '').trim();
      const startVal = startEl.value; // 'YYYY-MM-DDTHH:mm'
      let startTs = ch.startTime || null;

      if (startVal) {
        startTs = firebase.firestore.Timestamp.fromDate(new Date(startVal));
      }

      await db.collection('challenges').doc(ch.id).update({
        description: desc,
        visibility,
        startTime: startTs,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      });

      toast('저장되었습니다.');
      close();
    } catch (err) {
      console.error(err);
      toast('저장에 실패했습니다.');
    }
  };
}

// 유틸추가 

function toast(msg) {
  // 심플 토스트
  const t = document.createElement('div');
  t.textContent = msg;
  t.style.cssText = 'position:fixed;left:50%;bottom:40px;transform:translateX(-50%);background:#000a;color:#fff;padding:10px 14px;border-radius:8px;z-index:99999';
  document.body.appendChild(t);
  setTimeout(()=>{ t.remove(); }, 1800);
}

function formatRelativeOrDate(ts) {
  const d = ts?.toDate?.();
  if (!d) return '';
  const diff = (Date.now() - d.getTime()) / (1000*60*60); // hours
  if (diff < 1) {
    const m = Math.max(1, Math.floor(diff*60));
    return `${m}분 전`;
  }
  if (diff < 24) {
    const h = Math.max(1, Math.floor(diff));
    return `${h}시간 전`;
  }
  // 24h 이후는 날짜+시간
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
}

function initials2(name='사용자') {
  const s = String(name).trim();
  // 한글 2글자 또는 영문 이니셜 2자
  const two = s.replace(/\s+/g,'').slice(0,2);
  if (two) return two;
  return '유저';
}




  // --- 초기화 ---
  auth.onAuthStateChanged(user => {
      if (user) {
    currentUser = user;

 // 다크모드 감지 및 적용
            const darkModeMatcher = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
            const applyDarkMode = (matches) => document.body.classList.toggle('dark-mode', matches);
            applyDarkMode(darkModeMatcher.matches);
            darkModeMatcher.addEventListener('change', e => applyDarkMode(e.matches));
            
            showView('list');
   
    // 닉네임/사진 기본값 준비
    currentUserProfile = {
      nickname: user.displayName || '사용자',
      photoURL: user.photoURL || null,
    };
    showView('list');
  } else {
    currentUser = null;
    document.body.innerHTML = `<div class="container" style="text-align:center; padding-top: 50px;">챌린지 기능을 사용하려면 로그인이 필요합니다.</div>`;
  }
});

  // 클릭 시 열려있는 ... 메뉴 닫기
  document.addEventListener('click', () => {
    document.querySelectorAll('.options-menu').forEach(menu => menu.style.display = 'none');
  });
})
</script>

</body>
</html>
