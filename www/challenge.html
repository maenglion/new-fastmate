<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Fastmate - ì±Œë¦°ì§€</title>
  <link rel="stylesheet" href="./styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script defer src="/firebase-init.js?v=2025.09.06-v8"></script>
  <style>
    /* challenge.html ì „ìš© ìŠ¤íƒ€ì¼ */
/* ======================================== */
/* ===== 1. ê¸°ë³¸ ì„¤ì • & ìƒ‰ìƒ ë³€ìˆ˜ ===== */
/* ======================================== */
:root {
    /* --- í•µì‹¬ ì•„ì´ë´í‹°í‹° ì»¬ëŸ¬ --- */
    --primary-color: #1c8e3e;      /* [ìœ ì§€] ì‹ ë¢°ê°ì„ ì£¼ëŠ” ê¸°ë³¸ ë…¹ìƒ‰ */
    --accent-color: #ffd400;       /* [ìœ ì§€] í™œê¸°ë¥¼ ì£¼ëŠ” í¬ì¸íŠ¸ ë…¸ë€ìƒ‰ */

    /* --- ê·¸ë¼ë°ì´ì…˜ (ê°€ì¥ í° ë³€í™”!) --- */
    /* ë…¹ìƒ‰ ê³„ì—´ë¡œ ìì—°ìŠ¤ëŸ½ê³  ê¹Šì´ê° ìˆëŠ” ê·¸ë¼ë°ì´ì…˜ì„ ë§Œë“­ë‹ˆë‹¤. */
    --primary-gradient: linear-gradient(135deg, #2e9653 0%, #1c8e3e 100%);

    /* --- ë³´ì¡° ìƒ‰ìƒ (ì „ì²´ì ì¸ ì¡°í™”ë¥¼ ìœ„í•´ ìˆ˜ì •) --- */
    --primary-light: #e8f5e9;      /* [ë³€ê²½] ë§¤ìš° ì—°í•œ ë…¹ìƒ‰. ë²„íŠ¼ í˜¸ë²„, í¬ì»¤ìŠ¤ ë“±ì— ì‚¬ìš© */
    --bg-color: #f8f9fa;           /* [ìœ ì§€] ë¶€ë“œëŸ¬ìš´ ë°°ê²½ìƒ‰ */
    --card-bg: #FFFFFF;            /* [ìœ ì§€] ì¹´ë“œ ë°°ê²½ì€ ê¹¨ë—í•œ í°ìƒ‰ */
    --text-color: #212529;         /* [ìœ ì§€] ê¸°ë³¸ í…ìŠ¤íŠ¸ (ì™„ì „í•œ ê²€ì • X) */
    --text-light: #6c757d;        /* [ìœ ì§€] ë³´ì¡° í…ìŠ¤íŠ¸ */
    --border-color: #e9ecef;       /* [ìœ ì§€] ê²½ê³„ì„  ìƒ‰ìƒ */
    --auto-comment-bg: #fffce6;    /* [ë³€ê²½] ìë™ ëŒ“ê¸€ ë°°ê²½ (ì¡°ê¸ˆ ë” ë¶€ë“œëŸ½ê²Œ) */
}
/* ======================================== */
/* ===== 2. ê¸€ë¡œë²Œ & ë ˆì´ì•„ì›ƒ ===== */
/* ======================================== */
body {
    background-color: var(--bg-color);
    font-family: 'Noto Sans KR', sans-serif;
    color: var(--text-color);
    margin: 0;
    line-height: 1.6;
}

.container {
    max-width: 700px;
    margin: 0 auto;
    padding: 20px;
}

.page-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border-color);
}

.page-title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-color);
    margin: 0;
}

/* --- ë²„íŠ¼ --- */
.onb-btn.onb-primary,
.create-challenge-fab {
    background: var(--primary-gradient); /* ë‹¨ìƒ‰ ëŒ€ì‹  ê·¸ë¼ë°ì´ì…˜ ì ìš© */
    color: white;
    border: none;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    transition: transform 0.2s, box-shadow 0.2s;
}

.onb-btn.onb-primary:hover,
.create-challenge-fab:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
}

/* --- ì…ë ¥ì°½ í¬ì»¤ìŠ¤ --- */
.comment-form textarea:focus,
.onb-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px var(--primary-light); /* ì—°í•œ ë…¹ìƒ‰ìœ¼ë¡œ í¬ì»¤ìŠ¤ íš¨ê³¼ */
}

/* --- ì±Œë¦°ì§€ ì¹´ë“œ í˜¸ë²„ --- */
.challenge-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.08);
    border-color: var(--primary-color); /* í˜¸ë²„ ì‹œ ë…¹ìƒ‰ í…Œë‘ë¦¬ (ì„ íƒ ì‚¬í•­) */
}

.header-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
    color: var(--text-light);
    transition: color 0.2s;
}
.header-btn:hover {
    color: var(--primary-color);
}

/* ======================================== */
/* ===== 3. ì±Œë¦°ì§€ ì¹´ë“œ & FAB ===== */
/* ======================================== */
.challenge-card {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 20px;
    border: 1px solid var(--border-color);
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}

.challenge-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.08);
}

.challenge-card h3 {
    margin: 0 0 15px;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-color);
}

.challenge-info {
    font-size: 0.9rem;
    color: var(--text-light);
    display: flex;
    flex-wrap: wrap;
    gap: 10px 20px; /* ì—¬ë°± ì¦ê°€ */
}
.challenge-info b {
    color: var(--text-color);
    font-weight: 500;
}

.create-challenge-fab {
    position: fixed;
    right: 25px;
    bottom: 25px;
    width: 60px;
    height: 60px;
    background: var(--primary-color);
    color: white;
    border-radius: 50%;
    border: none;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    font-size: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.2s, background-color 0.2s;
}

.create-challenge-fab:hover {
    transform: scale(1.1);
    background-color: #8370b9;
}

/* ======================================== */
/* ===== 4. ì±Œë¦°ì§€ ìƒì„¸ & ëŒ“ê¸€ ì‹œìŠ¤í…œ ===== */
/* ======================================== */
.challenge-details {
    padding: 24px;
}
.challenge-details p {
    margin: 8px 0;
    color: var(--text-color);
    font-size: 1rem;
}
.challenge-details b {
    color: var(--primary-color);
    margin-right: 8px;
}

.comment-section {
    padding: 24px;
    margin-top: 20px;
}
.comment-section h4 {
    margin-top: 0;
    font-size: 1.3rem;
}

.comment-form {
    display: flex;
    gap: 10px;
    margin: 20px 0;
}

.comment-form textarea {
    flex-grow: 1;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    padding: 12px;
    font-family: inherit;
    resize: vertical;
    transition: border-color 0.2s, box-shadow 0.2s;
}
.comment-form textarea:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px var(--primary-light);
}

.comment {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
    align-items: flex-start;
}

.comment-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #eee;
    flex-shrink: 0;
    object-fit: cover; /* ì´ë¯¸ì§€ê°€ ì°Œê·¸ëŸ¬ì§€ì§€ ì•Šë„ë¡ */
}

.comment-content {
    font-size: 0.95rem;
    background: var(--bg-color); /* ë°°ê²½ìƒ‰ê³¼ í†µì¼ê° */
    padding: 12px 16px;
    border-radius: 12px;
    width: 100%;
    border: 1px solid var(--border-color);
}
.comment-content strong {
    font-weight: 600;
    color: var(--text-color);
}
.comment-content p {
    margin: 4px 0 0;
    white-space: pre-wrap; /* ì¤„ë°”ê¿ˆ ì ìš© */
    word-break: break-word; /* ê¸´ ë§í¬ê°€ ë°•ìŠ¤ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ */
}

.comment.is-auto .comment-content {
    background: var(--auto-comment-bg);
    border-color: #ffe58f;
}

.comment-footer {
    font-size: 0.8rem;
    color: var(--text-light);
    margin-top: 8px;
}

.reply-btn {
    background: none;
    border: none;
    color: var(--text-light);
    font-weight: 600;
    cursor: pointer;
    margin-left: 10px;
    padding: 0;
    font-size: 0.8rem;
}
.reply-btn:hover {
    color: var(--primary-color);
}

.replies {
    margin-left: 20px;
    padding-left: 26px;
    border-left: 2px solid var(--border-color);
    margin-top: 15px;
}
.comment.is-reply {
    margin-bottom: 12px;
}
.comment.is-reply .comment-avatar {
    width: 32px;
    height: 32px;
}
.reply-form {
    margin-left: 52px;
    margin-top: 10px;
    display: flex;
    gap: 10px;
}
  </style>
</head>
<body>

  <div class="container">
    <header id="pageHeader" class="page-header"></header>

    <div id="challengeList"></div>
    
    <div id="challengeDetailView" style="display: none;">
      <div class="card challenge-details">
        <p>ğŸ¯ <b>ëª©í‘œ:</b> <span id="detailChallengeGoal">-</span></p>
        <p>ğŸ‘¥ <b>ì°¸ì—¬ì:</b> <span id="detailChallengeParticipants">-</span></p>
        <p>ğŸ“… <b>ì‹œì‘ì¼:</b> <span id="detailChallengeStartTime">-</span></p>
      </div>

      <div class="card comment-section">
        <h4>ì±Œë¦°ì§€ íƒ€ì„ë¼ì¸</h4>
        <div class="comment-form">
          <textarea id="newCommentText" placeholder="ì‘ì› ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”..." rows="1"></textarea>
          <button id="submitCommentBtn" class="onb-btn onb-primary">ë“±ë¡</button>
        </div>
        <div id="commentFeed"></div>
      </div>
    </div>

    <button id="createChallengeBtn" class="create-challenge-fab">+</button>
  </div>

  <div id="createChallengeModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center; padding:20px;">
    <div style="background: var(--card-bg); padding:25px; border-radius:16px; width:100%; max-width:420px;">
      <h3 class="onb-title" style="margin-top:0;">ìƒˆë¡œìš´ ì±Œë¦°ì§€ ë§Œë“¤ê¸°</h3>
      <label class="onb-label">ë‹¨ì‹ ê³„íš</label>
      <select id="challengeModelSelect" class="onb-input" style="margin-top:5px; margin-bottom:15px;">
                <option value="8">8:16 (8ì‹œê°„ ë‹¨ì‹,ì•¼ì‹ëŠê¸°)</option>  
                <option value="12">12:12 (12ì‹œê°„ ë‹¨ì‹,ì´ˆë³´)</option>  
                <option value="16">16:8 (16ì‹œê°„ ë‹¨ì‹,ì¸ê¸°)</option>
                <option value="18">18:6 (18ì‹œê°„ ë‹¨ì‹,ì¸ê¸°)</option>
                <option value="20">20:4 (20ì‹œê°„ ë‹¨ì‹,ê³ ê¸‰)</option>
                <option value="24">24ì‹œê°„ (1ì¼ ë‹¨ì‹,ê³ ê¸‰)</option>
                <option value="36">36ì‹œê°„(1.5ì¼ ë‹¨ì‹,ê³ ê¸‰)</option>
                <option value="48">48ì‹œê°„ (2ì¼ ë‹¨ì‹,ê³ ê¸‰)</option>
                <option value="72">72ì‹œê°„ (3ì¼ ë‹¨ì‹,ê³ ê¸‰)</option>
      </select>
      <label class="onb-label">ì‹œì‘ ë‚ ì§œ</label>
      <input type="date" id="challengeDatePicker" class="onb-input" style="margin-top:5px; margin-bottom:15px;">
      <label class="onb-label">ì‹œì‘ ì‹œê°„</label>
      <input type="time" id="challengeTimePicker" class="onb-input" style="margin-top:5px; margin-bottom:15px;">
      <label class="onb-label">ì„¸ë¶€ ëª©í‘œ (ì„ íƒ)</label>
      <textarea id="challengeDetailedGoal" class="onb-input" placeholder="ì˜ˆ: ë§¤ì¼ 30ë¶„ ìš´ë™í•˜ê¸°" style="margin-top:5px; min-height:80px;"></textarea>
      <div class="onb-actions">
        <button type="button" id="closeCreateChallengeModalBtn" class="onb-btn onb-ghost">ì·¨ì†Œ</button>
        <button type="button" id="saveChallengeBtn" class="onb-btn onb-primary">ì €ì¥í•˜ê³  ì¹œêµ¬ ì´ˆëŒ€í•˜ê¸°</button>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // --- 1. ì „ì—­ ---
  const auth = window.fastmateApp.auth;
  const db   = window.fastmateApp.db;
  let currentUser = null;
  let currentUserProfile = null; 
  let stopListeningToChallenge = null;
  let currentChallengeId = null; 

  // --- 2. DOM ---
  const challengeListDiv = document.getElementById('challengeList');
  const challengeDetailView = document.getElementById('challengeDetailView');
  const createChallengeBtn = document.getElementById('createChallengeBtn');
  const pageHeader = document.getElementById('pageHeader');
  const detailChallengeGoal = document.getElementById('detailChallengeGoal');
  const detailChallengeParticipants = document.getElementById('detailChallengeParticipants');
  const detailChallengeStartTime = document.getElementById('detailChallengeStartTime');
  const commentFeed = document.getElementById('commentFeed');
  const newCommentText = document.getElementById('newCommentText');
  const submitCommentBtn = document.getElementById('submitCommentBtn');
  const createChallengeModal = document.getElementById('createChallengeModal');
  const closeCreateChallengeModalBtn = document.getElementById('closeCreateChallengeModalBtn');
  const saveChallengeBtn = document.getElementById('saveChallengeBtn');
  const challengeModelSelect = document.getElementById('challengeModelSelect');
  const challengeDatePicker = document.getElementById('challengeDatePicker');
  const challengeTimePicker = document.getElementById('challengeTimePicker');
  const challengeDetailedGoal = document.getElementById('challengeDetailedGoal');

  // --- 3. ë·° ì „í™˜ ---
function showListView() {
  if (stopListeningToChallenge) stopListeningToChallenge();
  currentChallengeId = null;

  challengeListDiv.style.display = 'block';
  challengeDetailView.style.display = 'none';
  createChallengeBtn.style.display = 'block';

 pageHeader.innerHTML = `
  <div style="width:36px;"></div>
  <h1 class="page-title" style="margin:0 auto; text-align:center;">ì±Œë¦°ì§€ BETA</h1>
  <button class="header-btn" title="ë©”ì¸ìœ¼ë¡œ" onclick="location.href='fastmate.html'">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a 2 2 0 0 1-2-2z"></path>
      <polyline points="9 22 9 12 15 12 15 22"></polyline>
    </svg>
  </button>
`;

  loadAndRenderChallenges();
}

  function showDetailView(challengeId) {
    currentChallengeId = challengeId; 
    challengeListDiv.style.display = 'none';
    challengeDetailView.style.display = 'block';
    createChallengeBtn.style.display = 'none';
    listenToChallengeDetails(challengeId);
  }

  // --- 4. ëª©ë¡ ë¡œë”© ---
  async function loadAndRenderChallenges() {
    if (!currentUser) return;
    challengeListDiv.innerHTML = "<p>ì±Œë¦°ì§€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>";
    try {
      const query = db.collection('challenges')
        .where('participantUids', 'array-contains', currentUser.uid)
        .orderBy('startTime', 'desc');
      const snapshot = await query.get();
      if (snapshot.empty) {
        challengeListDiv.innerHTML = '<div class="card" style="text-align:center;"><p>ì•„ì§ ì°¸ì—¬í•œ ì±Œë¦°ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>';
        return;
      }
      challengeListDiv.innerHTML = '';
      snapshot.forEach(doc => {
        const challenge = { id: doc.id, ...doc.data() };
        const card = document.createElement('div');
        card.className = 'challenge-card';
        const startTime = challenge.startTime.toDate();
        const formattedDate = `${startTime.getMonth()+1}/${startTime.getDate()} ${startTime.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true})}`;
        card.innerHTML = `
          <h3>${challenge.challengeName}</h3>
          <div class="challenge-info">
            <span>ğŸ‘¥ ì°¸ì—¬: <b>${challenge.participantUids.length}</b>ëª…</span>
            <span>ğŸ“… ì‹œì‘: ${formattedDate}</span>
            <span>â­ ëª©í‘œ: ${challenge.detailedGoal || 'ì—†ìŒ'}</span>
          </div>`;
        card.addEventListener('click', () => showDetailView(challenge.id));
        challengeListDiv.appendChild(card);
      });
    } catch (error) {
      console.error("ì±Œë¦°ì§€ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:", error);
      challengeListDiv.innerHTML = '<p>ì±Œë¦°ì§€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
    }
  }

  // --- 5. ìƒì„¸/ëŒ“ê¸€ ì‹¤ì‹œê°„ ---

  
function listenToChallengeDetails(challengeId) {
  if (stopListeningToChallenge) stopListeningToChallenge();

  const challengeRef = db.collection('challenges').doc(challengeId);

  stopListeningToChallenge = challengeRef.onSnapshot(async (doc) => {
   if (currentUser) {
  const myPartRef = db.collection('challenges').doc(challengeId)
    .collection('participants').doc(currentUser.uid);
  myPartRef.get().then(s => {
    if (!s.exists) {
      myPartRef.set({ joinedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
    }
  }).catch(console.warn);
}
    if (!doc.exists) {
      showListView();
      alert("ì‚­ì œë˜ì—ˆê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì±Œë¦°ì§€ì…ë‹ˆë‹¤.");
      return;
    }

    const challenge = doc.data();

    // (ì„ íƒ) ì‹œì‘ ì „ì—ëŠ” ê³µìœ  ë²„íŠ¼ ë³´ì´ê¸°
    const now = new Date();
    const st  = challenge.startTime.toDate();
    const canShare = now < st;
    const inviteUrl = `${location.origin}/challenge-invite.html?id=${challengeId}&autojoin=1`;

    pageHeader.innerHTML = `
      <button class="header-btn back-btn">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>
      <h1 class="page-title" style="margin:0 auto; text-align:center; flex:1;">${challenge.challengeName}</h1>
      ${canShare ? `<button id="shareBtn" class="header-btn" title="ì´ˆëŒ€ ë§í¬ ë³µì‚¬">ğŸ”—</button>` : `<div style="width:36px;"></div>`}
    `;
    pageHeader.querySelector('.back-btn').addEventListener('click', showListView);
    if (canShare) {
      document.getElementById('shareBtn').addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(inviteUrl);
          alert('ì´ˆëŒ€ ë§í¬ë¥¼ ë³µì‚¬í–ˆì–´ìš”. ì¹œêµ¬ì—ê²Œ ê³µìœ í•´ë³´ì„¸ìš”!');
        } catch {
          prompt('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆì–´ìš”. ì•„ë˜ ë§í¬ë¥¼ ì§ì ‘ ë³µì‚¬í•˜ì„¸ìš”.', inviteUrl);
        }
      });
    }

    detailChallengeGoal.textContent = challenge.detailedGoal || 'ì—†ìŒ';
    detailChallengeParticipants.textContent = `${challenge.participantUids.length}ëª… ì°¸ì—¬ì¤‘`;
    const startTime = challenge.startTime.toDate();
    detailChallengeStartTime.textContent = `${startTime.getMonth()+1}/${startTime.getDate()} ${startTime.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true})}`;

    renderComments(challengeId);
  }, (error) => {
    console.error("ì‹¤ì‹œê°„ ì±Œë¦°ì§€ ê°ì§€ ì˜¤ë¥˜:", error);
    showListView();
    alert("ì±Œë¦°ì§€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
  });
}


  function renderComments(challengeId) {
    db.collection('challenges').doc(challengeId)
      .collection('comments').orderBy('timestamp', 'asc')
      .onSnapshot(snapshot => {
        commentFeed.innerHTML = '';
        const comments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        const commentElements = {};

        comments.filter(c => !c.parentId).forEach(comment => {
          const commentDiv = createCommentElement(comment);
          commentFeed.appendChild(commentDiv);
          commentElements[comment.id] = commentDiv;
        });
        comments.filter(c => c.parentId).forEach(reply => {
          const parentDiv = commentElements[reply.parentId];
          if (parentDiv) {
            let repliesContainer = parentDiv.querySelector('.replies');
            if (!repliesContainer) {
              repliesContainer = document.createElement('div');
              repliesContainer.className = 'replies';
              parentDiv.appendChild(repliesContainer);
            }
            repliesContainer.appendChild(createCommentElement(reply, true));
          }
        });
      }, error => {
        console.error("ì‹¤ì‹œê°„ ëŒ“ê¸€ ê°ì§€ ì˜¤ë¥˜:", error);
        commentFeed.innerHTML = '<p>ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p>';
      });
  }


  // --- 6. í—¬í¼ ---
  function generateColorFromUid(uid) {
    if (!uid) return '#cccccc';
    const colors = ['#ffadad', '#ffd6a5', '#fdffb6', '#caffbf', '#9bf6ff', '#a0c4ff', '#bdb2ff', '#ffc6ff'];
    let hash = 0;
    for (let i = 0; i < uid.length; i++) hash = uid.charCodeAt(i) + ((hash << 5) - hash);
    return colors[Math.abs(hash) % colors.length];
  }

  // HTML escape + ë§í¬í™” (XSS-safe)
  function escapeHTML(s) {
    return String(s || '').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));
  }
  function linkify(text) {
    const safe = escapeHTML(text);
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    return safe.replace(urlRegex, url => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
  }

  function createCommentElement(comment, isReply = false) {
  const div = document.createElement('div');
  div.className = 'comment' + (comment.isAutoComment ? ' is-auto' : '') + (isReply ? ' is-reply' : '');
  div.dataset.commentId = comment.id;

  const date = comment.timestamp?.toDate()?.toLocaleTimeString('ko-KR', { hour: 'numeric', minute: '2-digit' }) || '';
  const nickname = comment.nickname || 'ì•Œ ìˆ˜ ì—†ëŠ” ì‚¬ìš©ì';

  // ì•„ë°”íƒ€ ì²˜ë¦¬
  let avatarHtml = '';
  const userCache = (window.fastmateApp && window.fastmateApp.userCache) || {};
  const fallbackPhoto = userCache[comment.uid]?.photoURL || null;

  if (comment.photoURL || fallbackPhoto) {
    const url = comment.photoURL || fallbackPhoto;
    avatarHtml = `<img src="${url}" alt="${nickname}" class="comment-avatar">`;
  } else {
    const bgColor = generateColorFromUid(comment.uid);
    const firstLetter = nickname.charAt(0).toUpperCase();
    avatarHtml = `<div class="comment-avatar" style="background-color:${bgColor};display:flex;align-items:center;justify-content:center;color:#fff;font-weight:bold;">${firstLetter}</div>`;
  }

  // ë‚´ìš© ë§í¬ ì²˜ë¦¬
  const linkedText = linkify(comment.text);

  div.innerHTML = `
    ${avatarHtml}
    <div class="comment-content">
      <strong>${nickname}</strong>
      <p style="margin:4px 0;">${linkedText}</p>
      <div class="comment-footer">
        <span>${date}</span>
        ${!isReply ? `<button class="reply-btn" data-target="${comment.id}">ë‹µê¸€ ë‹¬ê¸°</button>` : ''}
      </div>
      ${!isReply ? `
      <div class="reply-form" id="rf-${comment.id}" style="display:none; gap:10px; margin-top:8px;">
        <textarea class="reply-text" rows="1" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
        <button class="onb-btn onb-primary reply-submit" data-target="${comment.id}">ë“±ë¡</button>
      </div>` : ''}
    </div>
  `;
  return div;
}


  // --- 7. ì´ë²¤íŠ¸ ---
  createChallengeBtn?.addEventListener('click', () => {
    if (!currentUser) return alert('ì±Œë¦°ì§€ë¥¼ ë§Œë“¤ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
    const now = new Date(Date.now() + 3600 * 1000);
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    challengeDatePicker.value = `${year}-${month}-${day}`;
    challengeTimePicker.value = now.toTimeString().slice(0, 5);
    createChallengeModal.style.display = 'flex';
  });
  closeCreateChallengeModalBtn?.addEventListener('click', () => { createChallengeModal.style.display = 'none'; });

saveChallengeBtn?.addEventListener('click', async () => {
  if (!currentUser || !currentUserProfile) {
    return alert("ì‚¬ìš©ì ì •ë³´ê°€ ë¡œë”©ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
  }

  const fastingHours = parseInt(challengeModelSelect.value, 10);
  const dateString = challengeDatePicker.value;
  const timeString = challengeTimePicker.value;
  const detailedGoal = challengeDetailedGoal.value.trim();

  if (!dateString || !timeString) return alert('ì‹œì‘ ë‚ ì§œì™€ ì‹œê°„ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');

  const startTimeDate = new Date(`${dateString}T${timeString}`);
  if (startTimeDate < new Date()) return alert('ì‹œì‘ ì‹œê°„ì€ í˜„ì¬ ì‹œê°„ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤.');

  saveChallengeBtn.disabled = true;
  saveChallengeBtn.textContent = 'ì €ì¥ ì¤‘...';

  async function createChallenge({ fastingHours, detailedGoal, startTimeDate }) {
    const user = auth.currentUser;
    if (!user) throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');

    const profSnap = await db.collection('users').doc(user.uid).get();
    const nickname = profSnap.exists
      ? (profSnap.data().nickname || user.displayName || 'ì‚¬ìš©ì')
      : (user.displayName || 'ì‚¬ìš©ì');

    const challengeData = {
      hostUid: user.uid,
      hostNickname: nickname,
      challengeName: `${nickname}ë‹˜ì˜ ${fastingHours}ì‹œê°„ ë‹¨ì‹`,
      fastingHours,
      detailedGoal: detailedGoal || '',
      startTime: firebase.firestore.Timestamp.fromDate(startTimeDate),
      status: 'upcoming',
      participantUids: [user.uid],
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      publicInvite: true
    };

    const challengeRef = db.collection('challenges').doc();
    const myParticipantRef = challengeRef.collection('participants').doc(user.uid);

    const batch = db.batch();
    batch.set(challengeRef, challengeData);
    batch.set(myParticipantRef, { joinedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
    await batch.commit();

    return challengeRef.id;
  }

  try {
    const id = await createChallenge({ fastingHours, detailedGoal, startTimeDate });
    const inviteLink = `${window.location.origin}/challenge-invite.html?id=${id}&autojoin=1`;
    await navigator.clipboard.writeText(inviteLink);
    createChallengeModal.style.display = 'none';
    alert('ì±Œë¦°ì§€ ìƒì„± ì™„ë£Œ!\nì´ˆëŒ€ ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì¹œêµ¬ì—ê²Œ ê³µìœ í•´ì£¼ì„¸ìš”.');
    showListView();
  } catch (error) {
    console.error("ì±Œë¦°ì§€ ìƒì„± ì˜¤ë¥˜:", error);
    alert("ì±Œë¦°ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
  } finally {
    saveChallengeBtn.disabled = false;
    saveChallengeBtn.textContent = 'ì €ì¥í•˜ê³  ì¹œêµ¬ ì´ˆëŒ€í•˜ê¸°';
  }
});


  submitCommentBtn?.addEventListener('click', async () => {
    const text = newCommentText.value.trim();
    if (!text || !currentUser || !currentUserProfile) return;
    if (!currentChallengeId) {
      console.error("currentChallengeIdê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ ëŒ“ê¸€ì„ ë“±ë¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    submitCommentBtn.disabled = true;
    try {
      await db.collection('challenges').doc(currentChallengeId).collection('comments').add({
        uid: currentUser.uid,
        nickname: currentUserProfile.nickname || currentUser.displayName || 'ì‚¬ìš©ì',
        photoURL: currentUser.photoURL || null,
        text,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        isAutoComment: false,
        parentId: null
      });
      newCommentText.value = '';
    } catch (error) {
      console.error("ëŒ“ê¸€ ë“±ë¡ ì˜¤ë¥˜:", error);
      alert("ëŒ“ê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    } finally {
      submitCommentBtn.disabled = false;
    }
  });

  commentFeed.addEventListener('click', async (e) => {
  const btn = e.target.closest('.reply-btn');
  const submit = e.target.closest('.reply-submit');
  if (!currentUser || !currentUserProfile || !currentChallengeId) return;

  // í¼ ì—´ê¸°/ë‹«ê¸°
  if (btn) {
    const id = btn.dataset.target;
    const form = document.getElementById(`rf-${id}`);
    if (form) form.style.display = form.style.display === 'none' ? 'flex' : 'none';
    return;
  }

  // ë‹µê¸€ ë“±ë¡
  if (submit) {
    const parentId = submit.dataset.target;
    const form = document.getElementById(`rf-${parentId}`);
    if (!form) return;
    const textarea = form.querySelector('.reply-text');
    const text = (textarea?.value || '').trim();
    if (!text) return;

    submit.disabled = true;
    try {
      await db.collection('challenges').doc(currentChallengeId).collection('comments').add({
        uid: currentUser.uid,
        nickname: currentUserProfile.nickname || currentUser.displayName || 'ì‚¬ìš©ì',
        photoURL: currentUser.photoURL || null,
        text,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        isAutoComment: false,
        parentId
      });
      textarea.value = '';
      form.style.display = 'none';
    } catch (err) {
      console.error('ë‹µê¸€ ë“±ë¡ ì˜¤ë¥˜:', err);
      alert('ë‹µê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    } finally {
      submit.disabled = false;
    }
  }
});


  // --- 8. ì•± ì´ˆê¸°í™” ---
  auth.onAuthStateChanged(async (user) => {
    if (user) {
      currentUser = user;
      currentUserProfile = await window.fastmateApp.getUserDoc(user.uid);
      showListView();
    } else {
      currentUser = null;
      currentUserProfile = null;
      createChallengeBtn.style.display = 'none';
      challengeListDiv.innerHTML = `
        <div class="card" style="text-align: center;">
          <p>ì±Œë¦°ì§€ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
          <button onclick="window.location.href='login.html'" class="onb-btn onb-primary">ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™</button>
        </div>
      `;
    }
  });
});
</script>
</body>
</html>
