<script>
    // 1. 이메일/비밀번호 로그인 기능 (실제 Firebase 연동 코드 추가)
    async function loginWithEmail() {
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const email = emailInput.value;
        const password = passwordInput.value;

        if (!email || !password) {
            alert('이메일과 비밀번호를 모두 입력해주세요.');
            return;
        }

        try {
            await firebase.auth().signInWithEmailAndPassword(email, password);
            // 성공하면 아래 onAuthStateChanged가 페이지를 이동시킵니다.
        } catch (error) {
            console.error("로그인 실패:", error);
            if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-email') {
                alert('가입되지 않은 이메일이거나 이메일 형식이 올바르지 않습니다.');
            } else if (error.code === 'auth/wrong-password') {
                alert('비밀번호가 틀렸습니다.');
            } else {
                alert('로그인에 실패했습니다. 잠시 후 다시 시도해주세요.');
            }
        }
    }

    // 2. 페이지가 완전히 준비된 후에 Firebase 관련 코드를 실행하도록 수정
    document.addEventListener('DOMContentLoaded', () => {
        const googleLoginBtn = document.getElementById('googleLoginBtn');
        const kakaoLoginBtn  = document.getElementById('kakaoLoginBtn');
        const db = firebase.firestore();

        // 이미 로그인 상태면 바로 fastmate로 이동
        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                console.log('로그인 상태 확인, fastmate.html로 이동합니다.');
                // Firestore 쓰기 테스트 (이제 안전한 위치에 있습니다)
                try {
                    await db.collection('users').doc(user.uid)
                        .collection('smokeTest')
                        .add({ ok: true, at: firebase.firestore.FieldValue.serverTimestamp() });
                    console.log('Firestore 쓰기 테스트 성공.');
                } catch (e) {
                    console.error('Firestore 쓰기 테스트 실패:', e);
                }
                // 모든 확인 후 페이지 이동
                window.location.href = './fastmate.html';
            }
        });

        // ✅ 구글 로그인
        googleLoginBtn?.addEventListener('click', async () => {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await firebase.auth().signInWithPopup(provider);
                // 성공 → 위의 onAuthStateChanged가 감지하여 페이지 이동
            } catch (e) {
                alert('구글 로그인에 실패했습니다: ' + e.message);
            }
        });

        // ✅ 카카오는 계속 준비중
        kakaoLoginBtn?.addEventListener('click', () => {
            alert('카카오 로그인은 준비중입니다.');
        });
    });
</script>
